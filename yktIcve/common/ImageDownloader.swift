//
//  ImageDownloader.swift
//  T2
//
//  Created by hangge on 15/9/28.
//  Copyright © 2015年 hangge. All rights reserved.
//

import UIKit

//操作任务
class StringConversion: Operation {
   
    let htmlRecord: HtmlRecord
    
    init(htmlRecord: HtmlRecord) {
        self.htmlRecord = htmlRecord
    }
    
    //在子类中重载Operation的main方法来执行实际的任务。
    override func main() {
        //在开始执行前检查撤消状态。任务在试图执行繁重的工作前应该检查它是否已经被撤消。
        if self.isCancelled {
            return
        }

        
        let textHtml = try! NSAttributedString(
            data:  self.htmlRecord.content.data(using: String.Encoding(rawValue: String.Encoding.unicode.rawValue), allowLossyConversion: true)!,
            options:[NSAttributedString.DocumentReadingOptionKey.documentType: NSAttributedString.DocumentType.html], documentAttributes: nil)
        
        //再一次检查撤销状态。
        if self.isCancelled {
            return
        }

        self.htmlRecord.htmlAttributedString = textHtml
        self.htmlRecord.state = .done

    }
}
