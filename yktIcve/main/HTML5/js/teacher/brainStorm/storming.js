(function($M, $) {

    var storming = {

        /**
         * 设置总人数
         * @return {this}
         */
        charts: function(value, number) {
            var option = {
                backgroundColor: '#04ae84',
                tooltip: {
                    formatter: "{a} <br/>{b} : {c}%"
                },
                series: [{
                    name: '参与人数',
                    type: 'gauge',
                    detail: {
                        formatter: function(value) {
                            value = Math.round(value * number / 100);
                            return value + '/' + number;
                        },
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    radius: '90%',
                    data: [{
                        value: value,
                        rate: number,
                        name: ''
                    }],
                    title: {
                        textStyle: {
                            color: '#04ae84',
                            fontSize: 30
                        }
                    },
                    axisLine: { // 坐标轴线
                        lineStyle: { // 属性lineStyle控制线条样式
                            color: [
                                [0.2, '#0E8C6D'],
                                [0.8, '#82DBC5'],
                                [1, '#00FFC0']
                            ],
                            width: 8
                        }
                    },
                    axisTick: { // 坐标轴小标记
                        show: false
                    },
                    pointer: {
                        width: 5
                    }
                }]
            };

            var chart = echarts.init(document.getElementById('sign-list'));
            chart.setOption(option);

            return this;
        },
        /**
         * 弹幕
         * @return {this}
         */
        bulletScreen: function(name) {
            if (this.tempLines.length == 0) {
                return;
            }
            if (this.lines.length == 0) {
                this.lines = this.tempLines.concat();
            }

            var time = 4,
                timePlus = Math.random() * 8,
                lines = this.lines,
                n = Math.floor(Math.random() * lines.length),
                line = lines[n],
                lastTime = this.speeds[line] || 0,
                student = $('<div class="activity-student"></div>'),
                content = $('#show-info');

            student.html(name);

            //当这一行和上一次速度相差大于2时 结束
            while (Math.abs(timePlus - lastTime) < 5) {
                timePlus = Math.random() * 8;
            }

            time += timePlus;

            this.speeds[line] = timePlus;

            //删除这一行
            this.lines.splice(n, 1);
            content.append(student);

            student.css('top', line * 40);

            setTimeout(function() {
                student.css('transition', 'all ' + time + 's ' + 'cubic-bezier(0, 0, 1, 1)').css('transform', 'translateX(-' + (window.screen.width + student.width()) + 'px)');
            }, 0);

            setTimeout(function() {
                student.remove();
            }, time * 1000);

            return this;
        },
        Listenerstued: function(r) {
            var _this = this;
            _this.join++;
            _this.stuNames.push(r.displayName)
            _this.charts(_this.join / _this.total * 100, _this.total).bulletScreen(r.displayName);
            return this;
        },
        ListenerstuStormeds: function(id, signCount, studycount, r) {
            var _this = this;
            _this.charts(1.0 * signCount / studycount * 100, studycount);
            $.each(r, function(i, v) {
                var index = $.inArray(v.StuName, _this.stuNames);
                if (index < 0) {

                    var params = {
                        type: 'brainstorming_student',
                        userId: v.StuId,
                        avator: "",
                        actId: id,
                        displayName: v.StuName,
                        isFirst: true
                    }
                    var message = { "method": "params", "params": JSON.stringify(params) };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    _this.stuNames.push(v.StuName)
                    setTimeout(function() {
                        _this.bulletScreen(v.StuName);
                    }, i * 700)

                }
            });
            return this;
        },

        events: function() {
            var _this = this;
            //计算总行数
            var lines = $('.sign-list').height() / 40;
            this.tempLines = [];
            for (var i = 0; i < lines; i++) {
                this.tempLines.push(i);
            }
            this.lines = this.tempLines.concat();


            // });
            //结束头脑风暴
            $("#end").on("singleTap", function() {
                var message = { "method": "overBrainStorm" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                // plus.nativeUI.confirm('是否确认结束头脑风暴？', function(e) {
                //     if (e.index === 0) {
                //         _this.stormEnd();
                //     }
                // }, '结束头脑风暴');
            });
            return this;
        },
        getparameter: function(joinStuCount, total) {
            var _this = this;
            _this.join = Number(joinStuCount);
            _this.total = Number(total);
            _this.charts(_this.join / _this.total * 100, _this.total).events();
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        init: function() {
            var _this = this;
            // this.activityId = this.view.activityId;
            // this.courseOpenId = this.view.courseOpenId;
            // this.brainStormId = this.view.brainStormId;
            // this.docJson = this.view.docJson;
            this.join = "";
            this.total = "";
            this.lines = [];
            this.tempLines = [];
            this.speeds = [];
            this.stuNames = [];
            //this.pushsocket();
            _this.load()
            return this;
        }
    };

    storming.init();
    window.storming = storming
}(mui, Zepto));