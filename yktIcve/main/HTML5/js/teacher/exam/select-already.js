/**
 * 课堂互动，选择题目
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2016-11-2
 * @return {Object}
 */
(function($M, $) {


    var select_already = {

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();


            $('.question-info').on('singleTap', '.icon-delete', function() {
                var $elem = $(this),
                    index = $elem.data("index");
                if (_this.chooseQuestionList.length == 1) {
                    var message = { "method": "showErrorMsg", "msg": "删除失败，至少保留有一项测试题目！" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return false;
                }
                if (!index) {
                    _this.chooseQuestionList.shift();
                    _this.questionData.shift();
                } else {
                    _this.chooseQuestionList.splice(index, 1);
                    _this.questionData.splice(index, 1);
                }
                $('.question-info').html(template('question-info', { rows: _this.chooseQuestionList }));
                $M('.mui-numbox').numbox();
            });

            $('#setsorce').on('singleTap', function(e) {
                var $checked = $('[name="checkone"]:checked');
                if (!$checked.length) {
                    var message = { "method": "showErrorMsg", "msg": "未选择需要设置分数的题目" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }
                var message = { "method": "batchScore" };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });

            $('#checkAll').on('singleTap', function() {
                var elem = $('.select-btn').prop('checked');
                if (!elem) {
                    $('.select-btn').prop('checked', false);
                    $('[name="checkone"]').prop('checked', false);
                    $('.tset').addClass('check');
                } else {
                    $('.select-btn').prop('checked', true);
                    $('[name="checkone"]').prop('checked', true);
                    $('.tset').removeClass('check');
                }
            });
            //下一步
            $('#next').on('singleTap', function() {
                var message = { "method": "next", "questionData": JSON.stringify(_this.questionData) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            return this;
        },

        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            template.config('escape', false);
            template.helper('typeName', function(type) {
                var arr = ["单选题", "多选题", "判断题"];
                type = Number(type);
                return arr[type - 1];
            });

            template.helper('selectNum', function(num) {
                var str = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'];
                return str[num];
            });
            template.helper('jsontoarr', function(v) {
                var arr = JSON.parse(v),
                    html = template('tmpl-question-Answer', { answerlist: arr });
                return html;

            });
            template.helper('transferContent', function(content) {
                return content.toString().replace(/<(?!(\/?img))[^>]+>/ig, "");
            });

            return this;
        },
        batchScore: function(score) {
            var _this = this;
            $('[name="checkone"]:checked').parent().siblings().find('.test').val(score);
            $.each(_this.questionData, function(i, v) {
                _this.questionData[i].Score = score;
            });
            $.each(_this.chooseQuestionList, function(i, v) {
                _this.chooseQuestionList[i].Score = score;
            });
            return this;
        },
        /**
         * 数据加载
         * @return {this}
         */
        set: function(r) {
            var _this = this;
            _this.chooseQuestionList = r;
            $.each(_this.chooseQuestionList, function(i, v) {
                var moment = { Id: _this.testId, questionId: v.Id, Score: 5 };
                _this.questionData.push(moment);
            });
            if (_this.chooseQuestionList.length) {

                $('.question-info').html(template('question-info', { rows: _this.chooseQuestionList }));
                $M('.mui-numbox').numbox();
            }

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            this.questionData = [];
            this.chooseQuestionList = [];
            this.helper().load().events();

            return this;
        }
    };


    select_already.init();

    window.select_already = select_already

}(mui, Zepto));