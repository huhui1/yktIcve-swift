/**
 * 课堂互动，选择题目节
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  hk
 * @date  2016-11-2
 * @return {Object}
 */
(function($M, $) {

    var section = {
 
        /**
         * 事件绑定
         * @return {this}
        */
        get: function(){
            var _this = this;
 
            $http.get(app.teacherAPI.halltest.list, { courseId: _this.courseId, chapterId: _this.chapterId}, function(r){
                if(!r){
                    plus.nativeUI.toast('获取题目信息出错');
                }else if(r.code == 1){
                    $('.section-des').html(template('section-list',{list: r.list, chapterIndex: _this.chapterIndex}));
                }else{
                    plus.nativeUI.toast(r.msg);
                }
            }, function(){
                plus.nativeUI.toast('获取节信息出错，请检查您的网络设置');
            });

            return this;
        },

    	/**
         * 事件绑定
         * @return {this}
        */
      	events:function(){
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();

            // 查看节下面的题目详情
            $('.section-des').on('singleTap', '.section-info', function(){
                var sectionId = $(this).attr('data-id'),
                    count = $('.chapter-num', $(this)).text(),
                    name = $('.chapter-name', $(this)).text(),
                    index = $('.section-des .section-info').index($(this)),
                    has = $(this).attr('data-has');

                if(count == 0){
                    plus.nativeUI.toast('当前章下还未创建题目，请前往www.iclassx.com创建题目', {duration: 'long'});
                    return;
                }
                                 
                if(has == 1){
                    var view = plus.webview.getWebviewById('teacher-exam-knowleadge');
                    if(view) view.close();
                    
                    setTimeout(function(){
                        $M.openWindow({
                            url: '/view/teacher/exam/select-knowleadge.html',
                            id: 'teacher-exam-knowleadge',
                            extras: {
                                courseId: _this.courseId,
                                chapterId: _this.chapterId,
                                chapterName: _this.chapterName,
                                chapterCount: _this.chapterCount,
                                chapterIndex: _this.chapterIndex,
                                sectionName: name,
                                sectionCount: count,
                                sectionIndex: index,
                                sectionId: sectionId,
                                activityId: _this.activityId
                            }
                        });
                    }, 300);
                }else{
                    var view = plus.webview.getWebviewById('teacher-exam-selectquestion');
                    if(view) view.close();
                    
                    setTimeout(function(){
                        $M.openWindow({
                            url: '/view/teacher/exam/select-question.html',
                            id: 'teacher-exam-selectquestion',
                            extras: {
                                courseId: _this.courseId,
                                chapterId: _this.chapterId,
                                sectionId: _this.sectionId,
                                name: name,
                                activityId: _this.activityId
                            }
                        });
                    }, 300);
                }
            });
 
            //直接查看章下面的题目
            $('.chapter-info.info').on('singleTap', function(){
                var name = $('.chapter-name', $(this)).text(),
                    view = plus.webview.getWebviewById('teacher-exam-selectquestion');
                                       
                if(view) view.close();
                                       
                setTimeout(function(){
                    $M.openWindow({
                        url: '/view/teacher/exam/select-question.html',
                        id: 'teacher-exam-selectquestion',
                        extras: {
                            courseId: _this.courseId,
                            chapterId: _this.chapterId,
                            name: name,
                            activityId: _this.activityId
                        }
                    });
                }, 300);
                                       
            });
 
            //已选题目
            $('.already-select').on('singleTap', function(){
                var view = plus.webview.getWebviewById('teacher-exam-select-already'),
                    selectIds = app.data.get('selectIds') != ''? JSON.parse(app.data.get('selectIds')): [];

                if(selectIds.length == 0){
                    plus.nativeUI.toast('请添加题目');
                    return;
                }

                if(view) view.close();

                setTimeout(function(){
                    $M.openWindow({
                        url: '/view/teacher/exam/select-already.html',
                        id: 'teacher-exam-select-already',
                        extras: {
                            courseId: _this.courseId,
                            activityId: _this.activityId
                        }
                    });
                }, 300);

            });
 
            //已选题目的显示
            window.addEventListener('showNum', function(e) {
                var num = e.detail.num;
                $('.select-num').text(num);
            }, false);

            return this;
      	},
 
        /**
         * 标题章信息设置
         * @return {this}
        */
        set: function(){
            var _this = this, $info = $('.chapter-info.info');
 
            $('.mui-title').text(_this.chapterName);
            $info.find('.chapter-name').text(_this.chapterName);
            $info.find('.chapter-num').text(_this.chapterCount);
 
            $('.section-des').html(template('section-list',{list: _this.list, chapterIndex: _this.chapterIndex}));
 
            return this;
        },

        /**
         * 载入
         * @return {this}
        */
        init: function() {

            this.view = plus.webview.currentWebview();

            this.courseId = this.view.courseId;
            this.chapterId = this.view.chapterId;
            this.list = this.view.list;
            this.chapterName = this.view.chapterName;
            this.chapterCount = this.view.chapterCount;
            this.chapterIndex = this.view.chapterIndex;
 
            this.selectIds = app.data.get('selectIds')? JSON.parse(app.data.get('selectIds')): [];
            $('.select-num').text(this.selectIds.length);
 
            this.activityId = this.view.activityId || '';

            this.set().get().events();

            return this;
        }
    };

    $M.plusReady(function() {
        section.init();
    });


}(mui, Zepto));
