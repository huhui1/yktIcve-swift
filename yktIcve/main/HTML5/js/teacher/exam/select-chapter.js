/**
 * 课堂互动，选择题目章
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  hk
 * @date  2016-10-31
 * @return {Object}
 */
(function($M, $) {

    var chapter = {
 
        /**
         * 事件绑定
         * @return {this}
        */
        get: function(){
            var _this = this;
 
            //获取课程下的章节的题目信息
            $http.get(app.teacherAPI.halltest.list, {courseId: _this.courseId}, function(r){
                if(!r){
                    plus.nativeUI.toast('获取题目信息出错');
                }else if(r.code == 1){
                    $('.mui-scroll').html(template('chapter-list',r));
                }else{
                    plus.nativeUI.toast(r.msg);
                }
            }, function(){
                plus.nativeUI.toast('获取题目信息出错，请检查您的网络设置');
            });
 
            return this;
        },

    	/**
         * 事件绑定
         * @return {this}
        */
      	events:function(){
            var _this = this;
 
            $M('.mui-scroll-wrapper').scroll();
 
            $('#exam-select-chapter').on('singleTap', '.chapter-info', function(){
                var chapterId = $(this).attr('data-id'),
                    count = $('.chapter-num', $(this)).text(),
                    name = $('.chapter-name', $(this)).text(),
                    index = $('.mui-scroll .chapter-info').index($(this)),
                    has = $(this).attr('data-has');
                                         
                if(count == 0){
                    plus.nativeUI.toast('当前章下还未创建题目，请前往www.iclassx.com创建题目', {duration: 'long'});
                    return;
                }
                                         
                if(has == 1){
                    var view = plus.webview.getWebviewById('teacher-exam-section');
                    if(view) view.close();
                         
                    setTimeout(function(){
                        $M.openWindow({
                            url: '/view/teacher/exam/select-section.html',
                            id: 'teacher-exam-section',
                            extras: {
                                courseId: _this.courseId,
                                chapterId: chapterId,
                                chapterName: name,
                                chapterCount: count,
                                chapterIndex: index,
                                activityId: _this.activityId
                            }
                        });
                    }, 300);
                }else{
                    var view = plus.webview.getWebviewById('teacher-exam-selectquestion');
                    if(view) view.close();
                    
                    setTimeout(function(){
                        $M.openWindow({
                            url: '/view/teacher/exam/select-question.html',
                            id: 'teacher-exam-selectquestion',
                            extras: {
                                courseId: _this.courseId,
                                chapterId: chapterId,
                                name: name,
                                activityId: _this.activityId
                            }
                        });
                    }, 300);
                }
            });
 
            //已选题目
            $('.already-select').on('singleTap', function(){
                var view = plus.webview.getWebviewById('teacher-exam-select-already'),
                    selectIds = app.data.get('selectIds') != ''? JSON.parse(app.data.get('selectIds')): [];

                if(selectIds.length == 0){
                    plus.nativeUI.toast('请添加题目');
                    return;
                }

                if(view) view.close();

                setTimeout(function(){
                    $M.openWindow({
                        url: '/view/teacher/exam/select-already.html',
                        id: 'teacher-exam-select-already',
                        extras: {
                            courseId: _this.courseId,
                            activityId: _this.activityId
                        }
                    });
                }, 300);

            });
 
            //已选题目的显示
            window.addEventListener('showNum', function(e) {
                var num = e.detail.num;
                $('.select-num').text(num);
            }, false);
 
            return this;
      	},

        /**
         * 载入
         * @return {this}
        */
        init: function() {

            this.view = plus.webview.currentWebview();

            this.courseId = this.view.courseId;
            this.activityId = this.view.activityId || '';
 
            this.selectIds = app.data.get('selectIds')? JSON.parse(app.data.get('selectIds')): [];
            $('.select-num').text(this.selectIds.length);

            this.get().events();

            return this;
        }
    };

    $M.plusReady(function() {
        chapter.init();
    });


}(mui, Zepto));
