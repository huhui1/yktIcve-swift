/**
 * 课堂互动，选择题目
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017 -04-20
 * @return {Object}
 */
(function($M, $) {

    var select_question = {
        /**
         * 获取题目信息
         * @return {this}
         */
        get: function(r) {
            var _this = this;

            if (r.questionList.length) {
                _this.questionList = r.questionList;
                _this.arr = r.questionList;
                $('.question-info').html(template('question-info', { list: r.questionList }));
            } else {
                $('.load-more').addClass('mui-hidden');
                $('.question-info').html('<div class="no-data">暂无题目，请前往网页端添加</div>');
            }

            return this;
        },

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();


            //筛选样式渲染
            $('.filter').on('singleTap', 'li', function() {
                if ($(this).hasClass('active') && !$('.filter_wrap').hasClass('mui-hidden')) {
                    $('.already-select').css('opacity', 1);
                    $('.filter_wrap').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
                    $('.select_drop').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
                    return;
                }

                var isType = $(this).hasClass('type');

                $('.filter li').removeClass('active');
                $(this).addClass('active');

                if (isType) {
                    $('.filter_wrap .type').removeClass('mui-hidden');
                    $('.filter_wrap .difficult').addClass('mui-hidden');
                } else {
                    $('.filter_wrap .type').addClass('mui-hidden');
                    $('.filter_wrap .difficult').removeClass('mui-hidden');
                }

                $('.already-select').css('opacity', .3);
                $('.filter_wrap').removeClass('mui-hidden').removeClass('fadeOut').addClass('fadeIn');
                $('.select_drop').removeClass('mui-hidden').removeClass('fadeOut').addClass('fadeIn');
            });

            //取消筛选框
            $('.select_drop').on('singleTap', function() {
                $('.already-select').css('opacity', 1);
                $('.filter_wrap').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
                $('.select_drop').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
            });

            //筛选选择
            $('.filter_wrap').on('singleTap', 'li', function() {
                var isType = $(this).parent().hasClass('type'),
                    typestr = $(this).text();
                if ($(this).data('knowledgeid') == '') {
                    $('.haveKnowledge').removeClass('icon-check');
                } else {
                    $('.noneKnowledge').removeClass('icon-check');
                }
                if (isType) {
                    $('.filter_wrap .type li .iconfont').removeClass('icon-check');
                    $("#type").text(typestr);
                    _this.type = $(this).attr('data-type');
                } else {
                    // $('.filter_wrap .difficult li .iconfont').removeClass('icon-check');
                    // $("#difficult").text("知识点：" + typestr);

                    _this.difficulty = $(this).attr('data-knowledgeId');
                    if (_this.difficulty == '') {
                        _this.difficultyTitle = [];
                    } else {
                        var _index = $.inArray($(this).attr('data-knowledgeTitle'), _this.difficultyTitle);
                        if (_index < 0) {
                            _this.difficultyTitle.push($(this).attr('data-knowledgeTitle'));

                            $(this).find('.iconfont').addClass('icon-check');
                        } else {
                            _this.difficultyTitle.splice(_index, 1);

                            $(this).find('.iconfont').removeClass("icon-check")
                        }
                    }
                }

                // $('.nonekonwledge').removeClass('icon-check');
                // $('.already-select').css('opacity', 1);
                // $('.filter_wrap').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
                // $('.select_drop').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');

                _this.arr = [];
                if (_this.questionList) {
                    if (_this.type != "" || _this.difficulty != "") {
                        $.each(_this.questionList, function(i, v) {
                            var knowledgeArr = v.knowledgeTitle ? v.knowledgeTitle.split(",") : [];
                            if (_this.difficultyTitle.length < 1) {
                                if (v.questionType == _this.type) {
                                    if ($.inArray(v, _this.arr) < 0) {
                                        _this.arr.push(v);
                                    }
                                }
                            } else {
                                $.each(knowledgeArr, function(z, k) {
                                    if ((v.questionType == _this.type || _this.type == "") && (_this.difficultyTitle.indexOf(k) > -1 || _this.difficultyTitle.length == 0)) {
                                        if ($.inArray(v, _this.arr) < 0) {
                                            _this.arr.push(v);
                                        }
                                    }
                                })
                            }
                        });
                    } else {
                        _this.arr = _this.questionList;
                    }
                };

                if (_this.arr.length) {
                    $('.question-info').html(template('question-info', { list: _this.arr }));
                } else {
                    $('.question-info').html('<div class="no-data">暂无题目，请前往网页端添加</div>');
                }
                if (_this.chooseQuestionList) {
                    $.each(_this.chooseQuestionList, function(q, w) {
                        $.each(_this.arr, function(e, r) {
                            if (w.Id == r.Id) {
                                $('.examSelect-' + e).addClass('icon-exam_selected').removeClass('icon-exam_add');
                            }
                        });
                    });
                };
                $('.already-select').css('opacity', 1);
                $('.filter_wrap').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
                $('.select_drop').removeClass('fadeIn').addClass('fadeOut').addClass('mui-hidden');
            });

            //选择题目
            $('.question-info').on('singleTap', '.iconfont', function() {
                var $ele = $(this),
                    index = $ele.data("index");

                if ($(this).hasClass('icon-exam_add')) {
                    _this.chooseQuestionList.push(_this.arr[index]);
                    $(this).removeClass('icon-exam_add').addClass('icon-exam_selected');
                } else {
                    var ix = _this.chooseQuestionList.indexOf(_this.arr[index]);
                    _this.chooseQuestionList.splice(ix, 1);
                    $(this).removeClass('icon-exam_selected').addClass('icon-exam_add');
                }
                $('.select-num').text(_this.chooseQuestionList.length);
                // _this.fireShowNum(_this.chooseQuestionList.length);
            });

            //查看单题详情
            $('.question-info').on('singleTap', '.content-analyze', function() {
                var $elem = $(this),
                    index = $elem.data("index");

                var message = { "method": "singlePreview", "questionInfo": JSON.stringify(_this.arr[index]) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            //已选题目
            $('.already-select').on('singleTap', function() {

                var message = { "method": "next", "chooseQuestionList": JSON.stringify(_this.chooseQuestionList) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            return this;
        },
        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            template.config('escape', false);

            template.helper('typeName', function(type) {
                var arr = ["单选题", "多选题", "判断题"];
                type = Number(type);
                return arr[type - 1];
            });
            template.helper('jsontoarr', function(v) {
                try {
                    var arr = JSON.parse(v),
                        html = template('tmpl-question-Answer', { answerlist: arr });
                    return html;
                } catch (error) {
                    return "";
                }

            });
            template.helper('selectNum', function(num) {
                var str = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'];
                return str[num];
            });

            template.helper('transferContent', function(content) {
                if (content) {
                    return content.toString().replace(/<(?!(\/?img))[^>]+>/ig, "");
                }
            });

            return this;
        },
        set: function(r) {
            var _this = this;
            $('.Knowledge-point').html(template('Knowledge', { knowledgeList: r.knowledgeList }));
            $.each(r.knowledgeList, function(i, v) {
                _this.knowledgeList.push(v.knowledgeId);
            })
            return this;
        },

        loadContent: function(r) {
            var _this = this;
            if (r) {
                $.each(r, function(q, w) {
                    $.each(_this.arr, function(e, r) {
                        if (w.Id == r.Id) {
                            $('.examSelect-' + e).addClass('icon-exam_selected').removeClass('icon-exam_add');
                            _this.chooseQuestionList.push(_this.arr[e]);
                        }
                    });
                });
            };
            $('.select-num').text(r.length);
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.courseOpenId = "";
            this.openClassIds = "";
            this.questionList = [];

            this.studycount = "";
            this.difficulty = '';
            this.difficultyTitle = [];

            this.title = "";
            this.arr = [];
            this.type = '';
            this.activityId = '';
            this.testId = '';
            this.chooseQuestionList = [];
            this.knowledgeList = [];
            this.classState = 0

            // if (this.testId) {
            //     this.helper().set().get().loadContent().events();
            // } else {
            //     this.helper().set().get().events();
            // }
            this.helper().load().events();
            $('.mui-title').text(this.name);
            return this;
        }
    };


    select_question.init();

    window.select_question = select_question

}(mui, Zepto));