/**
 * 课堂互动，创建测验页面
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2016-10-22
 * @return {Object}
 */
(function($M, $) {
    $M.init({
        beforeback: function() {
            var view = plus.webview.getWebviewById('teacher-exam-create');
            view.close();
        }
    });
    var create = {
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            var callback = function(type) {
                if (!_this.questionData.length) {
                    plus.nativeUI.toast('无法创建，未选择题目');
                    return false;
                }
                var title = $("#exam-title").val();
                if (!title.length) {
                    plus.nativeUI.toast("请输入标题！");
                    return false;
                }

                _this.submit(title, type);

            };
            $('#create-exam').on('singleTap', function() {
                callback(2);
            });
            $('#save-exam').on('singleTap', function() {
                callback(1);
            });
        },
        /**
         * 推送信息
         * @return {this}
         */
        pushinfo: function(examTitle, examId) {

            var _this = this,
                userId = _this.$user.id;
            var datajson = {
                actionType: "examing",
                title: examTitle,
                actId: examId,
                creatorId: userId,
                faceId: _this.activityId,
                openClassIds: _this.openClassIds,
                courseOpenId: _this.courseOpenId
            };
            var data = JSON.stringify(datajson);
            $http.post(app.teacherAPI.GT.sendGTMsg, { data: data, userId: userId, openClassIds: _this.openClassIds }, function(r) {
                if (r.code < 0) {
                    plus.nativeUI.toast('网络异常');
                }
            });
        },
        /**
         * 获取数据
         * @return {this}
         */
        set: function() {
            var _this = this;
            document.getElementById("exam-title").focus();
            $("#exam-title").val(app.date.format(new Date().getTime() / 1000, 'yyyy-MM-dd hh:mm') + '的测验');
            return this;
        },
        /**
         * 提交数据
         * return this
         */
        submit: function(title, type) {
            var _this = this,
                info = {
                    Id: _this.testId,
                    CourseOpenId: _this.courseOpenId,
                    SchoolId: _this.$user.schoolId,
                    ActivityId: _this.activityId,
                    CreatorId: _this.$user.id,
                    CreatorName: _this.$user.displayName,
                    Title: title,
                    SourceType: _this.$user.sourceType,
                    State: type,
                    ViewAnswer: 2,
                    ClassState: _this.classState
                },
                data = JSON.stringify(info),
                questionData = JSON.stringify(_this.questionData);
            $http.post(app.teacherAPI.FaceTeach.addClassTest, { data: data, questionData: questionData }, function(r) {
                if (r.code == 1) {
                    if (type == 1) {
                        plus.nativeUI.toast('添加测验成功');
                    } else {
                        _this.pushinfo(title, r.classTestInfo.classTestId);
                        plus.nativeUI.toast('创建成功');
                        $M.openWindow({
                            url: '/view/teacher/exam/examing.html',
                            id: 'teacher-exam-examing',
                            extras: {
                                examId: r.classTestInfo.classTestId,
                                activityId: _this.activityId,
                                openClassIds: _this.openClassIds,
                                courseOpenId: _this.courseOpenId,
                                studycount: _this.studycount,
                                isExamCount: 0,
                                state: 2
                            }
                        });
                    }
                    var view_exam = plus.webview.getWebviewById('teacher-exam'),
                        view_question = plus.webview.getWebviewById('teacher-exam-select-question'),
                        view_already = plus.webview.getWebviewById('teacher-exam-select-already');
                    $M.fire(view_exam, 'reload');
                    view_already.close();
                    view_question.close();
                    _this.view.close('slide-out-right', 300);
                    //$M.back();
                } else {
                    plus.nativeUI.toast('创建失败！');
                }

            });
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.view = plus.webview.currentWebview();
            this.openClassIds = this.view.openClassIds;
            this.courseOpenId = this.view.courseOpenId
            this.$user = JSON.parse(app.data.get('$cloudClassUser'));
            this.activityId = this.view.activityId || '';
            this.testId = this.view.testId || '';
            this.title = this.view.title;
            this.studycount = this.view.studycount;
            this.questionData = this.view.questionData;
            this.classState = this.view.classState;
            if (this.questionData) {
                $("#numInfo").text(this.questionData.length);
            }
            this.set().events();
            return this;
        }
    };

    $M.plusReady(function() {
        create.init();
    });


}(mui, Zepto));