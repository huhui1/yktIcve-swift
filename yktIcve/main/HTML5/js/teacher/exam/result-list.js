/**
 * 随堂检测结果页
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-04-24
 * @return {Object}
 */
(function($M, mui) {

    $M.init({
        swipeBack: true, // 关闭侧滑
        pullRefresh: {
            container: '#pullrefresh',
            down: {
                callback: function() {
                    result.get();
                }
            }
        }
    });

    var result = {
        /**
         * 获取数据
         * @return {this}
         */
        get: function() {
            var _this = this;

            $http.post(app.teacherAPI.FaceTeach.getClassTestStuList, {
                openClassIds: _this.openClassIds,
                classTestId: _this.examId,
                activityId: _this.activityId,
                courseOpenId: _this.courseOpenId,
                schoolId: _this.$user.schoolId
            }, function(data) {
                if (data.code > 0) {
                    $('#not-result-list').html(template('result-list-tpl', { list: data.unClassTestStuList }));
                    $('#result-list').html(template('result-list-tpl', { list: data.classTestStuList }));
                    $('.no-sign > span').text(data.unClassTestStuList.length);
                    $('.signed > span').text(data.classTestStuList.length);
                }
                $M('#pullrefresh').pullRefresh().endPulldownToRefresh();
                $('#mask').addClass('mui-hidden');
            }, function() {
                $M('#pullrefresh').pullRefresh().endPulldownToRefresh();
                plus.nativeUI.closeWaiting();
                plus.nativeUI.toast('获取数据失败，请检查您的网络设置', { duration: 'long' });
            });

            return this;
        },

        /**
         * 绑定事件
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 已答未答切换
            $('.signed').on('singleTap', function() {
                $('.filter_list > li').removeClass('active');
                $(this).parent('li').addClass('active');
                $('#not-result-list').addClass('mui-hidden');
                $('#result-list').removeClass('mui-hidden');
            });

            $('.no-sign').on('singleTap', function() {
                $('.filter_list > li').removeClass('active');
                $(this).parent('li').addClass('active');
                $('#result-list').addClass('mui-hidden');
                $('#not-result-list').removeClass('mui-hidden');
            });
            //学生作答
            $('#result-list').on('singleTap', '.result', function() {
                var $elem = $(this),
                    stuId = $elem.data('stuid');
                if (!stuId) {
                    return;
                }
                setTimeout(function() {
                    $M.openWindow({
                        url: '/view/teacher/exam/report.html',
                        id: 'teacher-exam-report',
                        extras: {
                            examId: _this.examId,
                            activityId: _this.activityId,
                            openClassId: _this.openClassId,
                            courseOpenId: _this.courseOpenId,
                            stuId: stuId
                        },
                        show: {
                            aniShow: 'pop-in',
                            duration: 300
                        }
                    });
                }, 200);

            });
            return this;
        },

        /**
         * 转换时间
         * @return {this}
         * @param {Object} msd
         */
        MillisecondToDate: function(msd) {
            var time = parseFloat(msd) / 1000;

            if (null != time && "" != time) {
                if (time > 60 && time < 60 * 60) {
                    time = parseInt(time / 60.0) + "分钟" + parseInt((parseFloat(time / 60.0) -
                        parseInt(time / 60.0)) * 60) + "秒";
                } else if (time >= 60 * 60 && time < 60 * 60 * 24) {
                    time = parseInt(time / 3600.0) + "小时" + parseInt((parseFloat(time / 3600.0) -
                            parseInt(time / 3600.0)) * 60) + "分钟" +
                        parseInt((parseFloat((parseFloat(time / 3600.0) - parseInt(time / 3600.0)) * 60) -
                            parseInt((parseFloat(time / 3600.0) - parseInt(time / 3600.0)) * 60)) * 60) + "秒";
                } else {
                    time = parseInt(time) + "秒";
                }
            }

            return time;
        },

        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;

            template.helper('replaceTime', function(data) {
                if (!data) return 0;
                return _this.MillisecondToDate(Number(data) * 1000);
            });

            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            this.view = plus.webview.currentWebview();
            this.examId = this.view.examId;
            this.activityId = this.view.activityId;
            this.openClassIds = this.view.openClassIds;
            this.courseOpenId = this.view.courseOpenId;
            this.$user = JSON.parse(app.data.get('$cloudClassUser'));
            this.fromRes = false;

            if (this.view.fromRes) {
                this.fromRes = this.view.fromRes;
            }

            // 设备类型的判断
            var deviceName = navigator.userAgent.toLowerCase();
            $('#pullrefresh').css('height', (((deviceName.indexOf('iphone') > -1) ? window.screen.height : window.screen.width) - 64) + 'px');

            this.helper().get().events();

            return this;
        }
    };

    $M.plusReady(function() {
        result.init();
    });

}(mui, Zepto));