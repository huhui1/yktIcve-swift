/**
 * 随堂检测考试报告
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2015-07-28
 * @return {Object}
 */
(function($M, $) {
    var letter = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

    $M.init({
        swipeBack: true,
        beforeback: function() {
            $M.fire(plus.webview.getWebviewById('student-article-activity'), 'reload');

            plus.navigator.setFullscreen(false);

            var has = $('#overlay').hasClass('in');
            if (has) {
                report.Me && report.Me.destroy();
                return false;
            }
        }
    });

    var report = {
        /**
         * 获取数据
         * @return {this}
         */
        get: function() {
            var $mask = $('#mask'),
                _this = this;

            $http.post(app.teacherAPI.FaceTeach.getStuAnswerList, {
                stuId: _this.stuId,
                courseOpenId: _this.courseOpenId,
                schoolId: _this.$user.schoolId,
                classTestId: _this.examId
            }, function(data) {
                if (data.code > 0) {
                    if (!data.stuQuestionList.length) {
                        var view = plus.webview.currentWebview();
                        plus.nativeUI.toast('您未答题');
                        setTimeout(function() {
                            view.close();
                        }, 200);
                    }
                    var Correct = 0,
                        total = 0;

                    var momentarr_ids = [],
                        momentarr_ques = [];
                    $.each(data.stuQuestionList, function(i, v) {

                        if ($.inArray(v.Title, momentarr_ids) < 0) {
                            momentarr_ids.push(v.Title);
                            momentarr_ques.push(v);
                        } else {
                            if (v.isRight == 1) {
                                momentarr_ques[$.inArray(v.Title, momentarr_ids)] = v;
                            }
                        }
                    });
                    $.each(momentarr_ques, function(i, v) {
                        if (v.questionType === 3) {
                            v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                        }
                        v.dataJson = JSON.parse(v.dataJson);
                        if (v.isRight === 1) {
                            Correct = Correct + 1;
                            total = total + v.getScore;
                        } else {
                            _this.errorQuestionList.push(v);
                        }
                        _this.allQuestionList.push(v);
                    });
                    _this.examTitle = data.stuAnswerInfo.classTestTitle;
                    $('#report').html(template('report-tpl', { total: total, stuAnswerInfo: data.stuAnswerInfo, stuQuestionList: momentarr_ques, Correct: Correct }));
                    // if (Correct === data.count) {
                    //     $('#error-exam').remove();
                    //     $('#all-exam').width('100%');
                    // }

                } else {
                    var view = plus.webview.currentWebview();
                    plus.nativeUI.toast("暂无试卷数据");
                    setTimeout(function() {
                        view.close();
                    }, 0);
                }
                $mask.addClass('hide');
            });

            return this;
        },

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();

            // 单个题目预览
            $('#report').on('singleTap', 'div.answer-list > ul > li > a', function(e) {
                var $elem = $(this),
                    index = $elem.parent().index();

                _this.exam(1, index);
            });

            // 所有错题解析
            $('#error-exam').on('singleTap', function(e) {
                if (!_this.errorQuestionList.length) {
                    plus.nativeUI.toast("无错题解析");
                    return false;
                }
                _this.exam(2);
            });

            // 所有题目解析
            $('#all-exam').on('singleTap', function(e) {
                _this.exam(3);
            });

            return this;
        },

        /**
         * 获取题库随堂检测
         * type    1 进入单个预览， 2 进入所有错题   3，所有题目解析
         * @return {this}
         */
        exam: function(val, index) {
            var list,
                _this = this,
                $elem = $('#overlay');
            list = _this.allQuestionList;
            if (val === 2) {
                list = _this.errorQuestionList;
            }


            $elem.addClass('in');
            setTimeout(function() {
                _this.Me = Mexam({
                    title: _this.examTitle,
                    data: list,
                    wrap: '#overlay',
                    isAnalytical: true,
                    close: function() {
                        $elem.removeClass('in');
                    }
                });
                if (val === 1) _this.Me.go(index + 1);
            }, 400);

            return this;
        },

        /**
         * 载入
         * @return {null}
         */
        init: function() {
            this.view = plus.webview.currentWebview();
            this.activityId = this.view.activityId;
            this.openClassId = this.view.openClassId;
            this.courseOpenId = this.view.courseOpenId;
            this.errorQuestionList = [];
            this.allQuestionList = [];
            this.$user = JSON.parse(app.data.get('$cloudClassUser'));
            this.examId = this.view.examId;
            this.stuId = this.view.stuId || this.$user.id;
            this.examTitle = "";


            this.get().events();
        }
    };

    $M.plusReady(function() {
        report.init();
    });

}(mui, Zepto));