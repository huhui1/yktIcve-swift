/**
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  M.J
 * @date  2015-10-16
 * @return {Object}
 */
(function($M, $) {


    var result = {

        /**
         * 绑定事件
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 分析事件
            $('#analysis').on('touchend', function(e) {
                e.preventDefault();
                // 打开新窗口来
                $M.openWindow({
                    url: '/view/teacher/exam/analysis.html',
                    id: 'teacher-exam-analysis',
                    extras: {
                        classTestId: _this.examId,
                        activityId: _this.activityId,
                        openClassId: _this.openClassId,
                        courseOpenId: _this.courseOpenId,
                        fromRes: true
                    }
                });

            });
            //结束
            $("#over").on('touchend', function() {
                var callback = function() {
                    $http.post(app.teacherAPI.FaceTeach.closeClassTest, { classTestId: _this.examId }, function(data) {
                        if (data.code > 0) {
                            $('#over').addClass('mui-hidden');
                            $('#analysis').removeClass('mui-hidden');
                            var view_exam = plus.webview.getWebviewById('teacher-exam');
                            $M.fire(view_exam, 'reload');
                        } else {
                            plus.nativeUI.toast('操作失败，请重试');
                        }
                    });
                }
                plus.nativeUI.confirm('确认要结束本次测验吗？', function(e) {
                    if (e.index === 0) {
                        callback();
                    }
                }, '提示');
            });
            // 筛选
            $('#shaixuan').on('touchend', function(e) {
                e.preventDefault();
                $M.fire(plus.webview.getWebviewById('teacher-exam-result-list'), 'getclassList');
            });

            window.addEventListener('getClassId', function(index) {
                _this.classId = index.detail.classId;
            }, true);

            return this;
        },

        /**
         * 载入
         */
        muiInit: function() {
            var _this = this;

            $M.init({
                swipeBack: false, // 关闭侧滑
                subpages: [{
                    url: '/view/teacher/exam/result-list.html',
                    id: 'teacher-exam-result-list',
                    styles: {
                        top: '64px',
                        bottom: '0px'
                    },
                    extras: {
                        examId: _this.examId,
                        activityId: _this.activityId,
                        openClassIds: _this.openClassIds,
                        courseOpenId: _this.courseOpenId,
                        fromRes: _this.fromRes,
                        isEnd: _this.isEnd
                    }
                }]
            });

            return this;
        },

        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.view = plus.webview.currentWebview();
            this.examId = this.view.examId;
            this.activityId = this.view.activityId;
            this.openClassIds = this.view.openClassIds;
            this.courseOpenId = this.view.courseOpenId;
            this.subView = plus.webview.getWebviewById('member-list');
            this.fromRes = false;
            this.state = this.view.state;
            if (this.state == 3) {
                $('#over').addClass('mui-hidden');
                $('#analysis').removeClass('mui-hidden');
            }
            if (this.view.fromRes) {
                this.fromRes = this.view.fromRes;
            }

            this.muiInit().events();

            return this;
        }
    };

    $M.plusReady(function() {
        result.init();
    });

}(mui, Zepto));