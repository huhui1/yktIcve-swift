/**
 * 随堂检测统计页面
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-06-08
 * @return {Object}
 */
(function($M, mui) {

    $M.init({
        beforeback: function() {
            var view = plus.webview.getWebviewById('mine-list');
            $M.fire(view, 'socket.emit', { params: { type: 'closeRes', fromRes: true } });
        }
    });

    var analysis = {

        /**
         * 获取数据
         * @return {this}
         */
        get: function(r) {
            var _this = this;
            if (r.code > 0) {
                $('#percent').text(r.data.averageScore);
                $('#totalNum').html(r.data.averageUseTime + '<span>Sec</span>');
                _this.chart(r.data);
                _this.total = r.data.openClassStuCount;
                _this.questionList = r.data.classTestQuestionList;
                $('#analysis-list').html(template('analysis-list-tpl', { list: r.data.classTestQuestionList }));
            }
            $('#mask').addClass('mui-hidden');

            return this;
        },

        /**
         * 初始化图标
         * @return {this}
         */
        chart: function(data) {

            var arr = [];
            arr.push({ value: data.unSubmitStuCount, itemStyle: { normal: { color: '#2ecc71' } } });
            arr.push({ value: data.lessThan20StuCount, itemStyle: { normal: { color: '#f1c40f' } } });
            arr.push({ value: data.from20To40StuCount, itemStyle: { normal: { color: '#e74c3c' } } });
            arr.push({ value: data.from40To60StuCount, itemStyle: { normal: { color: '#3489db' } } });
            arr.push({ value: data.from60To80StuCount, itemStyle: { normal: { color: '#2ecc71' } } });
            arr.push({ value: data.greaterThan80StuCount, itemStyle: { normal: { color: '#f1c40f' } } });


            var setting = {
                backgroundColor: '#FFFFFF',
                grid: {
                    x: 35,
                    x2: 10,
                    y: 30,
                    y2: 25
                },
                toolbox: {
                    show: false,
                    feature: {
                        mark: {
                            show: true
                        },
                        dataView: {
                            show: true,
                            readOnly: false
                        },
                        magicType: {
                            show: true,
                            type: ['line', 'bar']
                        },
                        restore: {
                            show: true
                        },
                        saveAsImage: {
                            show: true
                        }
                    }
                },
                calculable: false,
                xAxis: [{
                    type: 'category',
                    data: ['未答题', '0-20', '20-40', '40-60', '60-80', '80-100']
                }],
                yAxis: [{
                    type: 'value',
                    data: ['未答题', '0-20', '20-40', '40-60', '60-80', '80-100']
                }],
                series: [{
                    name: '人数分布',
                    type: 'bar',
                    data: arr
                }]
            };

            var chart = echarts.init(document.getElementById('chart'));
            chart.setOption(setting);

            return this;
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 滚动
            $M('.mui-scroll-wrapper').scroll();

            // 单体解析
            $('#analysis-list').on('singleTap', 'li', function() {
                var $elem = $(this),
                    has = $elem.hasClass('data-loading'),
                    questionid = $elem.attr('data-questionid'),
                    order = $elem.attr('data-order');

                if (has) return;
                var extrasData = {
                    classTestId: _this.classTestId,
                    courseOpenId: _this.courseOpenId,
                    openClassId: _this.openClassId,
                    activityId: _this.activityId,
                    order: order,
                    questionId: questionid,
                    questionList: _this.questionList
                };
                var message = { "method": "singleAnalysis", "extrasData": JSON.stringify(extrasData), "questionId": questionid };
                window.webkit.messageHandlers.interOp.postMessage(message);
                return this;
                // 打开新窗口来
                // $M.openWindow({
                //     url: '/HTML5/src/teacher/exam/analysis-article.html',
                //     id: 'teacher-exam-analysis-article',
                //     extras: {
                //         classTestId: _this.classTestId,
                //         courseOpenId: _this.courseOpenId,
                //         openClassId: _this.openClassId,
                //         activityId: _this.activityId,
                //         order: order,
                //         questionId: questionid,
                //         fromRes: true,
                //         questionList: _this.questionList
                //     }
                // });



            });

            return this;
        },

        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;

            template.helper('replaceTime', function(data) {
                if (!data) return 0;
                return _this.MillisecondToDate(Number(data) * 1000);
            });
            template.helper('replaceToPrecent', function(data) {
                if (!data) return 0;
                return (data / _this.total * 100).toFixed(2);
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.total = 0; //人数
            this.questionList = [];
            this.helper().load().events();

            return this;
        }
    };

    analysis.init();
    window.analysis = analysis

}(mui, Zepto));