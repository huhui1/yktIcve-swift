/**
 * 随堂检测中的页面
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  M.J
 * @date  2015-09-23
 * @return {Object}
 */
(function($M, $) {

    var examing = {


        /**
         * 设置总人数
         * @return {this}
         */
        charts: function(value, number) {
            var option = {
                backgroundColor: '#04ae84',
                tooltip: {
                    formatter: "{a} <br/>{b} : {c}%"
                },
                series: [{
                    name: '参与人数',
                    type: 'gauge',
                    detail: {
                        formatter: function(value) {
                            value = Math.round(value * number / 100);
                            return value + '/' + number;
                        },
                        textStyle: {
                            color: '#fff'
                        }
                    },
                    radius: '90%',
                    data: [{
                        value: value,
                        rate: number,
                        name: ''
                    }],
                    title: {
                        textStyle: {
                            color: '#04ae84',
                            fontSize: 30
                        }
                    },
                    axisLine: { // 坐标轴线
                        lineStyle: { // 属性lineStyle控制线条样式
                            color: [
                                [0.2, '#0E8C6D'],
                                [0.8, '#82DBC5'],
                                [1, '#00FFC0']
                            ],
                            width: 8
                        }
                    },
                    axisTick: { // 坐标轴小标记
                        show: false
                    },
                    pointer: {
                        width: 5
                    }
                }]
            };

            var chart = echarts.init(document.getElementById('examing-list'));
            chart.setOption(option);

            return this;
        },

        /**
         * 弹幕
         * @return {this}
         */
        bulletScreen: function(name) {
            var _this = this;
            if (_this.tempLines.length == 0) {
                return;
            }
            if (_this.lines.length == 0) {
                _this.lines = _this.tempLines.concat();
            }

            var time = 4,
                timePlus = Math.random() * 8,
                lines = _this.lines,
                n = Math.floor(Math.random() * lines.length),
                line = lines[n],
                lastTime = _this.speeds[line] || 0,
                student = $('<div class="activity-student"></div>'),
                content = $('#show-info');

            student.html(name);

            //当这一行和上一次速度相差大于2时 结束
            while (Math.abs(timePlus - lastTime) < 5) {
                timePlus = Math.random() * 8;
            }

            time += timePlus;

            _this.speeds[line] = timePlus;

            //删除这一行
            _this.lines.splice(n, 1);
            content.append(student);

            student.css('top', line * 40);

            setTimeout(function() {
                student.css('transition', 'all ' + time + 's ' + 'cubic-bezier(0, 0, 1, 1)').css('transform', 'translateX(-' + (window.screen.width + student.width()) + 'px)');
            }, 0);

            setTimeout(function() {
                student.remove();
            }, time * 1000);

            return this;
        },

        /**
         * 绑定事件
         * @return {this}
         */
        events: function() {
            var _this = this;

            //计算总行数
            var lines = $('.examing-list').height() / 40;
            this.tempLines = [];
            for (var i = 0; i < lines; i++) {
                this.tempLines.push(i);
            }
            this.lines = this.tempLines.concat();


            // 结束签到
            $('#end').on('touchend', function() {
                var message = { "method": "examEnd" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            return this;
        },
        addEventListener: function(r) {
            var _this = this;
            _this.isExamCount++;
            _this.stuNames.push(r.displayName);
            _this.charts(1.0 * _this.isExamCount / _this.studycount * 100, _this.studycount).bulletScreen(r.displayName);
            return this;
        },
        ListenerstuStormeds: function(id, signCount, studycount, r) {
            var _this = this;
            _this.charts(1.0 * signCount / studycount * 100, studycount);
            $.each(r, function(i, v) {
                var index = $.inArray(v.stuName, _this.stuNames);
                if (index < 0) {

                    var params = {
                        type: 'examed',
                        userId: v.stuId,
                        avator: "",
                        actId: id,
                        displayName: v.stuName,
                        isFirst: true
                    }
                    var message = { "method": "params", "params": JSON.stringify(params) };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    _this.stuNames.push(v.stuName)
                    setTimeout(function() {
                        _this.bulletScreen(v.stuName);
                    }, i * 700)

                }
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        setchart: function(isExamCount, studycount) {
            var _this = this;
            _this.isExamCount = isExamCount;
            _this.studycount = studycount;
            examing.charts(studycount == 0 ? 0 : 1.0 * isExamCount / studycount * 100, studycount).events();

            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {


            this.studycount = 0;

            this.isExamCount = 0;

            this.isSend = false;
            this.fromRes = true;
            this.lines = [];
            this.tempLines = [];
            this.speeds = [];
            this.stuNames = [];
            this.fromRes = false;

            // setTimeout(function() {
            //     examing.setchart(examing.isExamCount, examing.studycount)
            // }, 200)
            this.load();
            return this;
        },
    };
    examing.init();

    window.examing = examing
}(mui, Zepto));