(function($M, $) {


    var attachmentPreview = {
        /**
         * 获取作业作答记录信息
         * @return this
         */
        get: function() {
            var _this = this;
            $http.post(app.teacherAPI.Homework.getStuFileHomeworkPreview, {
                courseOpenId: _this.courseOpenId,
                openClassId: _this.openClassId,
                homeworkId: _this.homeWorkId,
                homeworkStuId: _this.homeworkStuId ? _this.homeworkStuId : _this.homeworkStuIds[0],
                stuId: _this.stuId
            }, function(r) {
                if (r.code == 1) {
                    $('.storm_title').text(r.data.homeworkTitle);
                    var stuRemark = r.data.stuRemark;
                    _this.stuRemark = stuRemark;
                    if (stuRemark.length > 100) {
                        stuRemark = stuRemark.substr(0, 300) + '...<a class="moreramrk">查看更多</a>'
                    }
                    $('.content').html(stuRemark);
                    $('.commentary').html(r.data.commentary);
                    $('#stormContent').html(template('attachmentList', { list: r.data.questions }));
                    $('.stupic-info').html(template('stuAttachmentList', { list: r.data.stuAnswers }));
                    $('#answer').html(template('stuAttachmentList', { list: r.data.answer }));
                    $('.pic-info').html(template('commentaryList', { list: r.data.commentaryFileData }))

                } else {
                    var message = { "method": "showmsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });

            return this;
        },


        /**
         * 事件绑定
         * @return this
         */
        events: function() {
            var _this = this;
            // 模拟滚动
            $M('.mui-scroll-wrapper').scroll();
            $('.content').on('singleTap', '.moreramrk', function() {
                $(this).parent().html(_this.stuRemark);
            });

            $("#stormContent").on('singleTap', 'a.preview', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $(".stupic-info").on('singleTap', 'a.preview', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $("#answer").on('singleTap', 'a.preview', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $(".pic-info").on('singleTap', 'a.preview', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //del
            $('.pic-info').on('singleTap', '.delimg', function() {
                var $elem = $(this);
                $(".add-pic").removeClass('mui-hidden');
                $elem.parent().remove();
            });
            $('.pic-info').on('singleTap', '.seeImg', function() {
                var $elem = $(this);

                var message = { "method": "previewImg", "url": $elem.attr('src') };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });
            //查看视频
            $('.pic-info').on('singleTap', '.video', function() {
                var $elem = $(this);
                var url = $elem.data("url");
                if (url) {
                    var message = { "method": "getFileInfoByUrl", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            //template渲染附件预览
            $('.pic-info').on('singleTap', '.temp-info', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            $('.pic-info').on('singleTap', '.add-pic', function(e) {
                e.preventDefault();
                var message = { "method": "upload" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //批阅附件作业
            $('.operate-add').on('singleTap', '#marking', function() {
                var score = $('#test').val();
                var message = { "method": "readFileHomework", "score": String(score) };
                window.webkit.messageHandlers.interOp.postMessage(message);
                // if (score == 0) {
                //     plus.nativeUI.confirm("当前学生分数为0分或者您还未给学生打分,确认批阅么？", function(e) {
                //         if (e.index == 0) {
                //             _this.readFileHomework(score, commentary);
                //         }
                //     }, '提示');
                // } else {
                //     _this.readFileHomework(score, commentary);
                // };

            });
            //退回附件作业
            $('.operate-add').on('singleTap', "#reject", function() {
                var message = { "method": "reject" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $('#setScore').on('singleTap', function() {
                var score = $('#test').val(),
                    total = 0,
                    commentary = $('.commentary').text();

                try {
                    total = Number(score);
                } catch (error) {
                    var message = { "method": "showmsg", "msg": "请输入数字" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    $('#test').val(0)
                    return;
                }
                if (total == -99) {
                    var message = { "method": "showmsg", "msg": "请输入数字" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    $('#test').val(0)
                    return;
                }
                if (total > 100) {
                    var message = { "method": "showmsg", "msg": "请输入分数大于100，按照最大值设置分数" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

                if (total == 0) {
                    var message = { "method": "showmsg", "msg": "请输入大于0 的数" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    $('#test').val(0)
                    return;
                }
                _this.batchScore(total, commentary)
            });
            return this;
        },
        batchScore: function(score, commentary) {
            var _this = this;
            $http.post(app.teacherAPI.Homework.readStusFileHomework, {
                teaId: _this.$user.id,
                openClassId: _this.openClassId,
                homeworkId: _this.homeWorkId,
                homeworkStuIds: _this.homeworkStuIds.join(','),
                getScore: score,
                commentary: commentary,
                sourceType: 3
            }, function(r) {
                if (r.code == 1) {
                    var message = { "method": "done" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    var message = { "method": "showmsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
        },
        readFileHomework: function() {

            var _this = this,
                score = $('#test').val(),
                commentary = $('.commentary').text();
            var list = $("div.pic-info").find('img'),
                arr = [];
            $.each(list, function(i, v) {
                arr.push({
                    DocTitle: '评语附件',
                    DocSize: $(v).data('size'),
                    Url: $(v).data('url'),
                    Md5: $(v).data('md5'),
                    DocType: $(v).data('doctype')
                })
            });
            var commentaryFileData = JSON.stringify(arr);
            $http.post(app.teacherAPI.Homework.readFileHomework, {
                teaId: _this.$user,
                homeworkStuId: _this.homeworkStuId,
                getScore: score,
                commentary: commentary,
                commentaryFileData: commentaryFileData,
                sourceType: 3
            }, function(r) {
                if (r.code == 1) {
                    var message = { "method": "done" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    var message = { "method": "showmsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
        },
        helper: function() {
            var _this = this;
            template.config('escape', false);
            return this;
        },

        getparameter: function(data, userId) {
            var _this = this;
            var data = JSON.parse(data);
            _this.courseOpenId = data["courseOpenId"];
            _this.openClassId = data["openClassId"];
            _this.score = parseInt(data["score"]);
            _this.state = data["state"];
            _this.homeWorkId = data["homeWorkId"];
            _this.homeworkStuIds = data["homeworkStuIds"];
            _this.checked = data["checked"];
            _this.homeworkStuId = data["homeworkStuId"];
            _this.stuId = data["stuId"];
            _this.$user = userId;
            if (_this.state == 3) {
                $('.labBack').show();
            }
            $('#test').val(this.score);
            if (_this.homeworkStuIds) {
                $('.content').hide();
                $('.stupic-info').hide();
                $('#reject').hide();
                $('#marking').hide();
                $('#setScore').removeClass('mui-hidden');
                $('.pic-info').hide();
            }
            this.get().events()
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        setImg: function(t) {
            var _this = this;
            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg" width="70" height="70" data-doctype=' + 'jpg' + ' data-size=' + t.size + ' data-md5=' + t.md5 + ' data-url=' + t.url + ' src="' + t.ossOriUrl + '"><i class="iconfont delimg icon-close"></i></div>');
            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden');
                }
            }, 100);
            return this;
        },
        setVideo: function(t) {
            var _this = this;
            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic video" width="70" height="70" data-doctype=' + 'mp4' + ' data-size=' + t.size + ' data-md5=' + t.md5 + ' data-url=' + t.url + ' src="../../../img/video.jpg"><i class="iconfont delimg icon-close"></i></div>');
            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden');
                }
            }, 100);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;
            this.stuRemark = "";
            this.courseOpenId = "";
            this.openClassId = "";
            this.score = "";
            this.state = "";
            this.homeWorkId = "";
            this.checked = "";
            this.homeworkStuId = "";
            this.homeworkStuIds = "";
            this.stuId = "";
            this.$user = "";

            _this.helper().load();
            return this;
        }
    };


    attachmentPreview.init();
    window.attachmentPreview = attachmentPreview

}(mui, Zepto));