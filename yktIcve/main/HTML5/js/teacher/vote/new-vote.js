(function($M, $) {
    var newVote = {
        getVoteInfo: function(r) {
            var _this = this;

            if (r.voteInfo.voteType > 2) {
                _this.answer = [];
                $.each(JSON.parse(r.voteInfo.dataJson), function(i, v) {
                    _this.answer.push(v.content);
                });
                _this.get();
            }
            $('#create-vote-title').val(r.voteInfo.title);
            $('#content').text(r.voteInfo.voteContent);
            _this.voteType = r.voteInfo.voteType;
            var elem = $('#voteType').children();
            if (Number(r.voteInfo.voteType) == 3 && Number(r.voteInfo.selectType) == 2) {
                _this.voteType = 4;
                $(elem[Number(r.voteInfo.voteType)]).addClass('add-true').siblings().removeClass('add-true');
            } else {
                $(elem[Number(r.voteInfo.voteType) - 1]).addClass('add-true').siblings().removeClass('add-true');
            }
            $('#list-img-add').html(template('img-list-tmpl', { list: r.voteInfo.docJson }));


            return this;
        },
        /**
         * 获取投票选项
         * @return this
         */
        get: function() {
            var _this = this;
            $('#select-content').html(template('tmpl-answer-content', { list: _this.answer }));
            return this;
        },
        /**
         * 事件绑定
         * @return this
         */
        events: function() {
            var _this = this;
            // 模拟滚动
            $M('.mui-scroll-wrapper').scroll();
            //删除图片
            $('.pic-info').on('singleTap', '.delimg', function() {
                var $elem = $(this);
                $elem.parent().remove();
                $('.add-pic').removeClass('mui-hidden');
            });
            $('.pic-info').on('singleTap', '.seeImg', function() {
                var $elem = $(this);
                if ($elem.attr("src")) {
                    var message = { "method": "preview", "url": $elem.attr("src") };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            $('.add_vote').on('singleTap', '.add-pic', function(e) {
                var message = { "method": "upload" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            var data = [];
            $.each($('input'), function(i, v) {
                if ($(v).val && $(v).val() != '') {
                    data.push($(v).val());
                }
            });

            $('#voteType').on('singleTap', 'li', function() {
                var $elem = $(this),
                    voteType = $elem.data('type');
                _this.voteType = voteType;
                if (voteType == 3 || voteType == 4) {
                    $("span.voteTypeInfo").removeClass("mui-hidden");
                    $("span.selectInfo").removeClass("mui-hidden");
                    _this.get();
                } else {
                    $("span.voteTypeInfo").addClass("mui-hidden");
                    $("span.selectInfo").addClass("mui-hidden");
                    $('#select-content').html("");
                }
                $elem.removeClass('add-true').addClass('add-true').siblings().removeClass('add-true');

            });

            $('#select-content').on('singleTap', 'li > span.del', function() {
                var $elem = $(this),
                    index = $elem.parent("li").data('index');
                if (!index) {
                    _this.answer.shift();
                }
                _this.answer.splice(index, 1);
                _this.get();
            });

            $('#select-content').on('input propertychange', 'li > input', function() {
                var $elem = $(this),
                    index = $elem.parent("li").data('index');
                _this.answer[index] = $elem.val();
            });

            $('#select-content').on('singleTap', 'li.li_add_vote_add', function() {
                var $elem = $(this);
                _this.answer.length = _this.answer.length + 1;
                if (_this.answer.length > 10) {
                    $elem.hide();
                } else {
                    $elem.show();
                    _this.get();
                }
            });
        },

        addVoteTap: function(State) {
            var _this = this;
            var content = $('#content').val(),
                title = $("#create-vote-title").val(),
                content = content.replace(/(^\s+)|(\s+$)/g, "")

            if (content.length > 200) {
                var message = { "method": "showMsg", "msg": "输入内容不能超过200个字符" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                return;
            }
            if (title.length < 1) {
                var message = { "method": "showMsg", "msg": "请输入标题" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                return;
            }
            var data = [];
            $.each($('.selectVote'), function(i, v) {
                if ($(v).val && $(v).val() != '') {
                    data.push($(v).val());
                }
            });
            _this.answer = data;
            if ((_this.voteType == 3 || _this.voteType == 4) && _this.answer.length < 2) {
                var message = { "method": "showMsg", "msg": "请至少输入两个选项！" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                return;
            }
            if (_this.voteType == 3) {
                _this.selectType = 1;
            }
            if (_this.voteType == 4) {
                _this.selectType = 2;
            }
            setTimeout(function() {
                _this.submitContent(title, content, State);
            }, 200);
            return this;
        },

        /**
         * 数据提交
         */
        submitContent: function(title, content, State) {
            var _this = this,
                DocJson = [],
                elem = $("div.pic-info ").find('img');
            $.each(elem, function(i, v) {
                DocJson.push({ docTitle: "ios_img", docUrl: $(v).data('url') });
            });
            var info = {
                    CourseOpenId: _this.courseOpenId,
                    SchoolId: _this.schoolId,
                    ActivityId: _this.activityId,
                    CreatorId: _this.id,
                    Id: _this.voteId,
                    CreatorName: _this.displayName,
                    Title: title,
                    VoteContent: content,
                    VoteType: _this.voteType == 4 ? 3 : _this.voteType,
                    SourceType: 3,
                    DocJson: JSON.stringify(DocJson),
                    State: State ? State : 2,
                    SelectType: _this.selectType,
                    ClassState: _this.classState
                },
                answer = [{ "sortOrder": "正确", "content": "" }, { "sortOrder": "错误", "content": "" }],
                data = JSON.stringify(info);

            if (_this.voteType == 2) {
                answer = [{ "sortOrder": "赞成", "content": "" }, { "sortOrder": "反对", "content": "" }];
            } else if (_this.voteType == 3 || _this.voteType == 4) {
                var arr = [],
                    ary0 = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'K', 'J', 'L'];
                $.each(_this.answer, function(i, v) {
                    arr.push({ 'sortOrder': ary0[i], 'content': v });

                });
                answer = arr;
            }
            var dataJson = JSON.stringify(answer);

            var message = { "method": "addFaceTeachVote", "data": data, "dataJson": dataJson, type: String() };
            window.webkit.messageHandlers.interOp.postMessage(message);

            // $http.post(app.teacherAPI.FaceTeach.addFaceTeachVote, { data: data, dataJson: dataJson }, function(r) {
            //     if (r.code == 1) {
            //         plus.nativeUI.toast(r.msg);
            //         if (State == 2) {
            //             _this.pushinfo(r.voteInfo.voteId, content);
            //         }
            //         //  _this.view.close('slide-out-right', 300);
            //         $M.back();
            //     } else {
            //         plus.nativeUI.toast(r.msg);
            //     }

            // });
        },
        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            /**
             *状态转换
             *@return str
             **/
            template.helper('numbertochar', function(r) {
                var ary0 = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K'];
                return ary0[r];
            });
            return this;
        },
        getparameter: function(activityId, courseOpenId, voteId, classState, schoolId, displayName, id) {
            var _this = this;
            _this.activityId = activityId;
            _this.courseOpenId = courseOpenId;
            _this.voteId = voteId;
            _this.classState = classState;
            _this.schoolId = schoolId;
            _this.displayName = displayName;
            _this.id = id;

            return this;
        },
        setTitle: function() {
            var _this = this;
            $("#create-vote-title").focus().val(app.date.format(new Date().getTime() / 1000, 'yyyy-MM-dd hh:mm') + '的投票');
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        setImg: function(t) {
            var _this = this;
            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg" width="70" height="70" data-url=' + t.url + ' src="' + t.ossOriUrl + '"><i class="iconfont delimg icon-close"></i></div>');
            $('img.uploaded-pic').error(function() {
                var $img = $(this);
                setTimeout(function() {
                    $img.attr('src', $img.attr('src'));
                }, 1000);
            });
            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden');
                }
            }, 100);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;
            this.activityId = "";
            this.courseOpenId = "";
            this.voteId = "";
            this.answer = new Array(3);
            this.selectType = 1;
            this.optionNumber = 1;
            this.voteType = 1;
            this.classState = "";
            this.schoolId = "";
            this.displayName = "";
            this.id = "";
            _this.helper().load().events();

            return this;
        }
    };

    newVote.init();
    window.newVote = newVote

}(mui, Zepto));