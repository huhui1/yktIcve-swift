(function($M, $) {



    var courseware_tuwen = {
        get: function(r) {
            var _this = this;

            if (r.code == 1) {
                $('.add_content').html(r.cellInfo.CellContent);
                $('.mui-title').text(r.cellInfo.CellName);
                $('#list').html(template('tuwenlist', { list: r.cellInfo.RarJsonData }));
            }

            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        events: function() {
            $M(".mui-scroll-wrapper").scroll();
            var _this = this;
            $('.add_content').on('singleTap', 'img', function() {
                var url = $(this).attr('src');
                if (url) {
                    var message = { "method": "previewImg", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            $('#list').on('singleTap', '.title', function() {
                var elem = $(this),
                    resourceUrl = JSON.stringify(elem.data('resourceurl')),
                    num = String(elem.data('index')),
                    attachmentTitle = elem.data('doctitle');
                var message = { "method": "preview", "resourceUrl": resourceUrl, "attachmentTitle": attachmentTitle, "num": num };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });
            $('#list').on('singleTap', '.icon-xiazai2 ', function() {
                var elem = $(this),
                    num = String(elem.data('index')),
                    attachmentTitle = elem.data('doctitle'),
                    resourceUrl = JSON.stringify(elem.data('resourceurl'));
                var message = { "method": "download", "resourceUrl": resourceUrl, "attachmentTitle": attachmentTitle, "num": num };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });


            return this;
        },
        /**
         * 播放
         */
        localPlay: function(items) {
            var _this = this;

            var $user = JSON.parse(app.data.get('$cloudClassUser')),
                url = plus.io.convertLocalFileSystemURL(items.localUrl),
                data;

            if (!url) {
                plus.nativeUI.toast('当前缓存文件损坏，请删除后重新下载');
                return;
            }

            if (items.type == 'video') {
                data = {
                    id: items.id,
                    title: items.title,
                    url: url,
                    length: Number(items.length) || 0,
                    fromCache: true
                };

                // 打开新窗口
                setTimeout(function() {
                    $M.openWindow({
                        url: '/view/teacher/video-controls/video.html',
                        id: 'teacher-video',
                        extras: {
                            resourceUrl: data,
                            webview: "courserware-courseware_tuwen",
                        },
                        show: {
                            aniShow: 'slide-in-right',
                            duration: 300
                        }
                    });
                }, 0);

            } else if (items.type == 'img') {
                plus.navigator.setFullscreen(true);
                setTimeout(function() {
                    // 打开白板
                    $M.openWindow({
                        url: '/view/teacher/whiteboard/whiteboard.html',
                        id: 'teacher-whiteboard',
                        extras: {
                            fromRes: true,
                            img: url,
                            isPcLocal: false,
                            webview: "courserware-courseware_tuwen",
                        }
                    });
                }, 20);

            } else if (items.type == 'ppt') {
                data = {
                    cellId: items.id.substr(0, items.id.length - 4),
                    title: items.title,
                    urls: items.url,
                    isLocalFile: true,
                    from: 'nofromware',
                    webview: "courserware-courseware_tuwen",
                };

                setTimeout(function() {

                    $M.openWindow({
                        url: '/view/teacher/preview/preview.html',
                        id: 'teacher-preview',
                        extras: data,
                        show: {
                            aniShow: 'slide-in-right',
                            duration: 300
                        }
                    });
                }, 0);
            } else if (items.type == 'office') {

                // plus.runtime.launchApplication({
                //     action: "kingsoftofficeapp://",
                //     extra: { url: url }
                // }, function(e) {
                //     plus.nativeUI.toast("未发现适用的应用！请下载wps office");
                // });
                plus.runtime.openFile(items.localUrl, { pname: "WPS Office" }, function(e) {
                    plus.nativeUI.toast("未发现适用的应用！请下载wps office ----||   " + e.message);
                });


            } else if (items.type == 'mp3') {
                data = {
                    cellId: items.id,
                    localUrl: items.localUrl,
                    urls: url,
                    isLocalFile: true
                };

                setTimeout(function() {

                    $M.openWindow({
                        url: '/view/teacher/audio-controls/audio.html',
                        id: 'teacher-audio',
                        extras: {
                            resourceUrl: data,
                            webview: "courserware-courseware_tuwen",
                        },

                        show: {
                            aniShow: 'slide-in-right',
                            duration: 300
                        }
                    });
                }, 0);
            } else {
                plus.nativeUI.toast('当前资源不支持预览');
            }

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            var _this = this;

            this.courseOpenId = "";
            this.openClassId = "";
            this.cellId = "";
            this.title = "";
            this.resourceUrl = "";
            _this.load().events();
            return this;
        }
    };


    courseware_tuwen.init();

    window.courseware_tuwen = courseware_tuwen
}(mui, Zepto));