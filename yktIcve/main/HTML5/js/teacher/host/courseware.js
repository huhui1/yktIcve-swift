/**
 * 课件详细页面
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-02-04
 * @return {Object}
 */
(function($M, $) {


    var courseware = {

        getdata: function(userId, openClassId, courseOpenId, cellId, role) {
            var _this = this,
                index = _this.type,
                templ = ["", "evaluate-list", "bbs-list", "note-list", "error-list"],
                elem = ["", ".bbs-evaluate", ".bbs-ask", ".bbs-note", ".bbs-error"];
            _this.userId = userId;
            _this.courseOpenId = courseOpenId;
            _this.openClassId = openClassId;
            _this.cellId = cellId;
            _this.role = role;
            $http.post(app.teacherAPI.BBS.getCellBBSList, {
                courseOpenId: _this.courseOpenId,
                cellId: _this.cellId,
                userId: _this.userId,
                activeType: index
            }, function(r) {
                if (r.code == 1) {
                    _this.isMainTeacher = r.isMainTeacher;
                    $(elem[index]).removeClass('mui-hidden').html(template(templ[index], { list: r.list }));
                    if (r.list.length >= 4) {
                        $(elem[index]).parent().find('.load-more').removeClass('mui-hidden');
                    } else {
                        $(elem[index]).parent().find('.load-more').addClass('mui-hidden');
                    }
                    if (r.list.length) {
                        $(elem[index]).parent().find('.no-data').addClass('mui-hidden');
                    } else {
                        $(elem[index]).parent().find('.no-data').removeClass('mui-hidden');
                    }
                }

            });
            _this.me && _this.me.resetload();
            return this;
        },
        /**
         * 采纳
         */
        isadopt: function(Id, IsAccept) {
            var _this = this;
            $http.post(app.teacherAPI.BBS.acceptError, {
                Id: Id,
                IsAccept: IsAccept
            }, function(r) {
                if (r.code == 1) {
                    var message = { "method": "showMsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    _this.getdata(_this.userId, _this.openClassId, _this.courseOpenId, _this.cellId, _this.role);
                } else {
                    var message = { "method": "showMsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            return this;
        },

        /**
         * 事件绑定
         * @return this
         */
        events: function() {
            var _this = this;
            // 模拟滚动
            var $scroll = $M('.mui-scroll-wrapper').scroll();
            $('#mine-wrap').dropload({
                domUp: {
                    domClass: 'dropload-up',
                    domRefresh: '<div class="dropload-refresh">↓ 下拉可以刷新</div>',
                    domUpdate: '<div class="dropload-update">↑ 释放立即刷新</div>',
                    domLoad: '<div class="dropload-load"><span class="loading"></span> 正在刷新中...</div>'
                },
                loadUpFn: function(me) {
                    _this.me = me;
                    _this.load();
                    $scroll.scrollTo(0, 0);
                }
            });
            // 课件
            $('#btn-KJ').on('singleTap', function() {
                var message = { "method": "preview" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //问答 笔记 纠错 问答详情
            $('.ask-note-error').on('singleTap', '.ask-info', function(e) {
                var $elem = $(this),
                    $target = $(e.target),
                    id = $elem.data('id'),
                    isAccept = $elem.data('isaccept'),
                    userid = $elem.data('userid'),
                    avator = $elem.data('avator'),
                    dataCreated = $elem.find('.time').text(),
                    content = $elem.find('.ask-content').html(),
                    useName = $elem.find('.usename').text(),
                    docJson = $elem.attr('data-docjson');

                if ($target.hasClass("isadopt") || $target.hasClass('icon-icon')) {
                    if (_this.isMainTeacher != 1) {
                        var message = { "method": "showMsg", "msg": "很遗憾！您不能采纳或取消采纳，请确保您是主持老师！" };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                        return;
                    }
                    var _isAccept = (isAccept == 1 ? 0 : 1);
                    _this.isadopt(id, _isAccept);
                } else {
                    var bbsInfo = {
                        dataCreated: dataCreated,
                        content: content,
                        useName: useName,
                        avator: avator,
                        bbsId: id,
                        userId: userid,
                        docJson: docJson,
                        isAccept: isAccept,
                        isMainTeacher: _this.isMainTeacher
                    };
                    var message = { "method": "BBSDetails", "type": String(_this.type), "BBSId": id, "bbsInfo": JSON.stringify(bbsInfo) };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            //删除问答   评价 笔记 纠错
            $('.ask-note-error').on('singleTap', '.mui-btn-red', function() {
                var $elem = $(this),
                    replyedId = $elem.data('userid'),
                    id = $elem.data('id');
                if (_this.role == 1 && replyedId != _this.userId) {
                    var message = { "method": "showMsg", "msg": "不能删除他人的回复" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return
                }
                $http.post(app.teacherAPI.BBS.deleteComment, {
                    Id: id,
                    userId: _this.userId,
                    activeType: _this.type
                }, function(r) {
                    if (r.code == 1) {
                        var message = { "method": "showMsg", "msg": "删除成功！" };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                        _this.getdata(_this.userId, _this.openClassId, _this.courseOpenId, _this.cellId, _this.role);
                    } else {
                        var message = { "method": "showMsg", "msg": r.msg };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    }
                });

            });
            //评价 笔记 纠错
            $(".mui-control-item").on('singleTap', function() {
                var index = $(this).data('item'),
                    user = JSON.parse(app.data.get('$cloudClassUser'));
                _this.type = index;
                var elem = ["", ".bbs-evaluate", ".bbs-ask", ".bbs-note", ".bbs-error"];
                if ($(elem[index]).hasClass('mui-hidden')) {
                    _this.getdata(_this.userId, _this.openClassId, _this.courseOpenId, _this.cellId, _this.role);
                }
            });

            $("#down-KJ").on('singleTap', function() {
                var message = { "method": "download" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //学习统计
            $('.item5').on('singleTap', function() {
                var message = { "method": "studyed" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //显示更多
            $('.load-more').on('singleTap', function() {
                var message = { "method": "load-more", "type": String(_this.type) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //创建课件活动
            $('.oval-quotes').on('singleTap', function() {
                var message = { "method": "createBBS", "type": String(_this.type) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            return this;
        },
        reload: function() {
            var _this = this;
            _this.getdata(_this.userId, _this.openClassId, _this.courseOpenId, _this.cellId, _this.role);
            if (_this.type == 1) {
                $('.item1').addClass('mui-active').siblings().removeClass('mui-active');
                $('#item1').addClass('mui-active').siblings().removeClass('mui-active');
            }
            return this;
        },
        /**
         * 模版方法扩展
         * @return {this}
         */
        helper: function() {

            //对字符串进行编码
            template.config('escape', false);
            //替换img标签
            template.helper('htmlDecode', function(val) {
                return $('<div/>').html(val.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]")).text();

            });
            template.helper('isActive', function(i, v) {
                if (i <= v) {
                    return 'active'
                }
            })
            template.helper('jsontostr', function(v) {
                return JSON.stringify(v);
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;

            this.courseOpenId = "";
            this.openClassId = "";
            this.title = "";
            this.cellId = "";
            this.isAllowDownLoad = "";
            this.resourceUrl = "";
            this.externallinkurl = "";
            this.isMainTeacher = 0;
            this.type = 1;
            this.list = '';
            this.userId = "";
            this.role = 1;
            $('.mui-title').text(_this.title);
            // 打开数据库
            this.me = "";
            _this.helper().load().events();

            return this;
        }
    };

    courseware.init();

    window.courseware = courseware

}(mui, Zepto));