/**
 * 视频播放
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-02-27
 * @return {Object}
 */
(function($M, $) {



    var video = {

        /**
         * 插入播放器
         * @return {this}
         */
        play: function(progress) {

            var _this = this;

            plus.VideoPlay.palyVideo(_this.url, progress, 0, function(args) {
                if (args.indexOf("goBack") > -1) {
                    video.currentTime = parseFloat(args.split(':')[1]);

                    if (_this.cellId) {
                        video.update();
                    } else {
                        _this.view.close();
                    }
                    $M.back();
                } else if (args.indexOf("createBBs") > -1) {
                    var progress = parseFloat(args.split(':')[1]);
                    $M.openWindow({
                        // url: '/view/student/bbs/bbslist.html',
                        // id: 'student-bbslist',
                        url: '/view/student/video/video-clarity.html',
                        id: 'student-video-clarity',
                        extras: {
                            clarityIndex: _this.clarityIndex,
                            cellId: _this.cellId,
                            args: _this.args,
                            courseOpenId: _this.courseOpenId,
                            title: _this.title,
                            progress: progress,
                            type: 'preview',
                            from: 'video'
                        }
                    });
                }
            });

            return this;
        },

        /**
         * 事件绑定
         * @return {null}
         */
        events: function() {
            var _this = this;

            //重启加载
            window.addEventListener('reload', function(e) {
                if (e.detail.clarity) {
                    _this.clarityIndex = e.detail.clarityIndex;
                    _this.url = _this.url.replace("/360p.mp4", e.detail.clarity).replace("/480p.mp4", e.detail.clarity).replace("/720p.mp4", e.detail.clarity);
                }
                _this.play(e.detail.progress.toString());
            });

            return this;
        },
        /**
         * 创建数据库名
         * @return {this}
         */
        createTable: function(callback) {
            var _this = this;
            html5sql.process(
                "SELECT * FROM sqlite_master WHERE type='table' AND name = 'history'",
                function(transaction, results) {
                    if (!results.rows.length) {
                        html5sql.process(
                            "CREATE TABLE history (id TEXT, value TEXT, mark TEXT)",
                            function() {
                                callback.apply(_this);
                            },
                            function(error, failingQuery) {
                                _this.error(error, failingQuery);
                            }
                        );
                    } else {
                        callback.apply(_this);
                    }
                },
                function(error, failingQuery) {
                    _this.error(error, failingQuery);
                }
            );
            return this;
        },
        playEvents: function() {
            var _this = this;
            setTimeout(function() {
                $M.fire(_this.mineList, 'socket.emit', {
                    params: {
                        type: 'videoEvents',
                        name: 'play',
                        cellId: _this.cellId,
                        courseId: _this.courseId
                    }
                });
            }, 1000);
            plus.VideoPlay.palyVideo(this.url, "teacher", 0, function(args) {
                if (args.indexOf("goBack") > -1) {
                    _this.currentTime = parseFloat(args.split(':')[1]);
                    if (_this.cellId) {
                        video.update();
                    } else {
                        _this.view.close();
                    }
                    $M.back();
                } else if (args == "pause") {
                    $M.fire(_this.mineList, 'socket.emit', { params: { type: 'videoEvents', name: 'pause', cellId: _this.cellId, courseId: _this.courseId } });
                } else if (args == "start") {
                    $M.fire(_this.mineList, 'socket.emit', { params: { type: 'videoEvents', name: 'play', cellId: _this.cellId, courseId: _this.courseId } });
                } else if (args.indexOf("seek:") > -1) {
                    var position = args.split(':')[1];
                    $M.fire(_this.mineList, 'socket.emit', { params: { type: 'videoEvents', name: 'seek', cellId: _this.cellId, courseId: _this.courseId, position: _this.videoLength * parseFloat(position) } });
                } else if (args.indexOf("createBBs") > -1) {
                    var progress = parseFloat(args.split(':')[1]);
                    $M.openWindow({
                        // url: '/view/student/bbs/bbslist.html',
                        // id: 'student-bbslist',
                        url: '/view/teacher/video-controls/video-clarity.html',
                        id: 'student-video-clarity',
                        extras: {
                            clarityIndex: _this.clarityIndex,
                            cellId: _this.cellId,
                            args: _this.args,
                            courseOpenId: _this.courseOpenId,
                            title: _this.title,
                            progress: progress,
                            type: 'preview',
                            from: 'video'
                        }
                    });
                }

            });
        },
        /**
         * 发送指令 开始与结束
         * @return {this}
         */
        send: function(type) {
            var _this = this,
                viewMine = plus.webview.getWebviewById('mine-list');

            $M.fire(viewMine, 'socket.emit', { params: { type: type, cellId: _this.cellId } });

            return this;
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            // 屏幕旋转
        }

    };
    video.init();

    window.video = video;

}(mui, Zepto));