/**
 * 学生问答区列表页
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-02-22
 * @return {Object}
 */
(function($M, $) {

    var list = {

        /**
         * 获取数据
         * @return {this}
         */
        get: function(r) {
            var _this = this;
            if (r.replyList.length) {
                $('#list').html(template('list-tpl', { list: r.replyList, selfId: _this.selfId }));
            } else {
                if (_this.type != 4) {
                    $('#list').html('<li class="mui-table-view-cell mui-media mui-text-center data-loading"><a href="javascript:;">还没有人回复，赶紧来回复吧！</a></li>');
                }
            }

            return this;
        },
        /**
         * 采纳
         */
        isadopt: function() {
            var _this = this;
            $http.post(app.teacherAPI.BBS.acceptError, {
                Id: _this.bbsId,
                IsAccept: _this.isAccept
            }, function(r) {
                if (r.code == 1) {
                    $('#topice').html(template('topice-tpl', {
                        isAccept: _this.isAccept,
                        type: _this.type,
                        bbsdata: _this.bbsdata,
                        docJson: _this.docJson ? JSON.parse(_this.docJson) : []
                    }));
                    $('#discuss-content').html(_this.content);
                }
            });
            return this;
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 模拟滚动
            $M('.mui-scroll-wrapper').scroll();
            // 回复
            $('.reply').on('singleTap', function(e) {

                var message = { "method": "reply", "replyToUserId": _this.userId, "replyToDisplayName": _this.useName };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            $("#topice").on('singleTap', 'span.isadopt', function() {
                if (_this.isMainTeacher != 1) {
                    var message = { "method": "showmsg", "msg": "很遗憾！您不能采纳或取消采纳，请确保您是主持老师！" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }
                var _IsAccept = (isAccept == 1 ? 0 : 1);
                _this.isAccept = _IsAccept;
                _this.isadopt();
            });
            $('#list').on('singleTap', 'span.', function(e) {

            });
            // 点击留言操作
            $('#list').on('singleTap', 'li.parent', function(e) {
                if (_this.type == 4) return;
                var has, $target = $(e.target),
                    $elem = $(this),
                    id = $elem.attr('data-id'),
                    replyToDisplayName = $elem.attr('data-displayname'),
                    userid = $elem.attr('data-userid');
                if ($target.hasClass("del-bbs")) {
                    var message = { "method": "del", "Id": id, "userId": userid };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    var message = { "method": "reply", "replyToUserId": userid, "replyToDisplayName": replyToDisplayName };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            $('#topice').on('singleTap', '.ask-note-errorImg', function() {
                var $elem = $(this);
                var message = { "method": "preview", "url": $elem.data("oss") };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });

            return this;
        },

        /**
         * 增加辅助方法
         * @return {this}
         */
        helper: function() {

            //对字符串进行编码
            template.config('escape', false);
            //时间格式转化
            template.helper('dateFormat', function(date, format) {
                if (date == 0)
                    date = new Date();
                else if (date.indexOf("/Date(") > -1) {
                    var date = new Date(parseInt(date.replace("/Date(", "").replace(")/", "") - 8 * 60 * 60 * 1000, 10));
                } else
                    date = new Date(date);

                var map = {
                    "M": date.getMonth() + 1, //月份
                    "d": date.getDate(), //日
                    "h": date.getHours(), //小时
                    "m": date.getMinutes(), //分
                    "s": date.getSeconds(), //秒
                    "q": Math.floor((date.getMonth() + 3) / 3), //季度
                    "S": date.getMilliseconds() //毫秒
                };
                format = format.replace(/([yMdhmsqS])+/g, function(all, t) {
                    var v = map[t];
                    if (v !== undefined) {
                        if (all.length > 1) {
                            v = '0' + v;
                            v = v.substr(v.length - 2);
                        }
                        return v;
                    } else if (t === 'y') {
                        return (date.getFullYear() + '').substr(4 - all.length);
                    }
                    return all;
                });
                return format;
            });
            // //替换img标签
            // template.helper('replaceImg', function(val) {
            //     //  return val.replace(/<img   src=/g,'<img width="40" height="40" src=')
            //     return val.toString().replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]");
            // });
            template.helper('isActive', function(i, v) {
                if (i <= v) {
                    return 'active'
                }
            })
            return this;
        },

        setContent: function(userId, type, star, useName, isMainTeacher, avator, time, docJson, isAccept, content) {
            var _this = this;
            _this.userId = userId;
            _this.useName = useName;
            _this.isMainTeacher = isMainTeacher;
            this.bbsdata = {
                avator: avator,
                useName: useName,
                time: time,
                star: star
            };
            this.docJson = docJson;
            this.type = type;
            this.isAccept = isAccept;
            if (this.type == 4) {
                $('.reply').addClass('mui-hidden');
            }
            this.helper();
            $('#topice').html(template('topice-tpl', {
                isAccept: this.isAccept,
                type: this.type,
                bbsdata: this.bbsdata,
                docJson: this.docJson
            }));
            $('#discuss-content').html(content);
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            //被回复者的ID
            this.userId = "";
            this.useName = "";
            this.isMainTeacher = 0;
            this.isEdit = false;

            this.name = '';



            this.load().events();
        }
    };

    list.init();
    window.list = list

}(mui, Zepto));;