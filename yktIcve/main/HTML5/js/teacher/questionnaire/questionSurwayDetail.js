/**
 * 调查问卷单题题目选项统计分析
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  hx
 * @date  2018-1-11
 * @return {Object}
 */
(function($M, $) {



    var questionSurwayDetail = {
        letter: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '未答题'],
        /**
         * 设置图标
         */
        chart: function(data) {
            var _this = this,
                tozimu = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
                arr = [],
                lets = [];
            $.each(data.dataJson, function(i, v) {
                arr.push((v.StuChoiceCount / data.openClassStuCount * 100).toFixed(2));
                lets.push(tozimu[v.SortOrder]);
            });

            var setting = {
                backgroundColor: '#FFFFFF',

                grid: {
                    x: 35,
                    x2: 10,
                    y: 30,
                    y2: 25
                },
                color: ['#c0e16e', '#6aeb81', '#67c9f5', '#9081d7', '#91c7ae', '#749f83', '#ca8622', '#bda29a', '#6e7074', '#546570', '#c4ccd3'],
                toolbox: {
                    show: false,
                    feature: {
                        mark: {
                            show: true
                        },
                        dataView: {
                            show: true,
                            readOnly: false
                        },
                        magicType: {
                            show: true,
                            type: ['line', 'bar']
                        },
                        restore: {
                            show: true
                        },
                        saveAsImage: {
                            show: true
                        }
                    }
                },
                calculable: false,
                xAxis: [{
                    type: 'category',
                    data: lets
                }],
                yAxis: [{
                    type: 'value',
                    axisLabel: {
                        formatter: function(value, index) {
                            return value + '%';
                        }
                    }
                }],
                series: [{
                    name: '选项分布',
                    type: 'bar',
                    label: {
                        normal: {
                            show: true,
                            position: 'top',
                            formatter: '{c}%',
                        }
                    },
                    data: arr,

                }]
            };

            var chart = echarts.init(document.getElementById('chart'));
            chart.setOption(setting);
            return this;
        },

        /**
         * 事件
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 滚动
            $M('.mui-scroll-wrapper').scroll();


            //查看公式
            $('.Mexam-article').on('singleTap', 'img', function() {
                var url = $(this).attr('src');
                $M.openWindow({
                    // url: '/view/teacher/whiteboard/whiteboard.html',
                    // id: 'teacher-whiteboard',
                    url: '/view/teacher/preview/img.html',
                    id: 'teacher-preview-img',
                    extras: {
                        fromRes: true,
                        imgUrl: url,
                        isPcLocal: false,
                        webview: "teacher-exam-analysis-article"
                    }
                });

            });
            // 竖屏

            return this;
        },

        /**
         * 获取数据
         * @return {this}
         */
        get: function(r) {
            var _this = this;

            var arr = ['', '单选题', '多选题', '判断题'];
            $('.mui-title').text(arr[r.data.questionType]);


            r.data.title = r.data.title && r.data.title.toString().replace(/<(?!(\/?img))[^>]+>/ig, "");
            $.each(r.data.dataJson, function(index, item) {
                r.data.dataJson[index].Content = item.Content.toString().replace(/<(?!(\/?img))[^>]+>/ig, "");
            });

            $('#Mexam-list').html(template('Mexam-tpl', { data: r.data, order: _this.order }));
            _this.chart(r.data);


            return this;
        },

        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;

            template.config('escape', false);
            template.helper('isActive', function(data) {
                var str;
                $.each(_this.option, function(i, v) {
                    if (v === (data + 1)) {
                        str = 'active';
                        return false;
                    }
                });
                return str;
            });
            template.helper('replaceletter', function(v) {
                var arr = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                return arr[v];
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        init: function() {

            this.helper().load().events();
        }
    };


    questionSurwayDetail.init();
    window.questionSurwayDetail = questionSurwayDetail;

}(mui, Zepto));