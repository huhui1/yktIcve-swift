/**
 * 预览调查问卷
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  hx
 * @date  2018-1-11
 * @return {Object}
 */
(function($M, $) {

    var previewQuestion = {
        /**
         * 获取问卷调查信息
         * @return {this}
         */
        get: function(r) {
            var _this = this;
            _this.questionList = r.questionList;
            if (r.questionList.length > 0) {
                $('.question-info').html(template('question-info', { list: r.questionList }));
            } else {
                $('.question-info').html('<div class="no-data">暂无题目，请添加</div>')

            }

            return this;
        },

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();
            $('.question-info').on('singleTap', '.icon-delete', function() {
                var titleId = $(this).data('id'),
                    index = $(this).data('index');
                var message = {
                    "method": "delete",
                    "titleId": titleId,
                    "index": String(index)
                };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            return this;
        },

        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            template.config('escape', false);

            template.helper('typeName', function(type) {
                var arr = ["单选题", "多选题", "判断题"];
                type = Number(type);
                return arr[type - 1];
            });
            template.helper('jsontoarr', function(v) {
                try {
                    var html = template('tmpl-question-Answer', { answerlist: v });
                    return html;
                } catch (error) {
                    return "";
                }

            });
            template.helper('selectNum', function(num) {
                var str = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N'];
                return str[num];
            });

            template.helper('transferContent', function(content) {
                if (content) {
                    return content.toString().replace(/<(?!(\/?img))[^>]+>/ig, "");
                }
            });

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        reload: function(index) {
            var _this = this;
            _this.questionList.splice(index, 1)

            if (_this.questionList.length > 0) {
                $('.question-info').html(template('question-info', { list: _this.questionList }));
            } else {
                $('.question-info').html('<div class="no-data">暂无题目，请添加</div>')

            }

            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.helper().load().events();
            this.questionList = [];
            return this;
        }
    };


    previewQuestion.init();

    window.previewQuestion = previewQuestion

}(mui, Zepto));