(function($M, $) {

    var previewPaper = {

        /**
         * 获取试卷详情
         * @return {this}
         */
        get: function(r) {
            var _this = this;

            var numtostr = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];

            if (r.data.ztWay == 2 || r.data.ztWay == 4) {
                $.each(r.data.questions, function(i, v) {
                    if (v.dataJson == "") {
                        v.dataJson = null;
                    }
                    if (v.questionType == 3) {
                        v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                    }

                    if (v.questionType == 8 || v.questionType == 9 || v.questionType == 11) {
                        $.each(v.subQuestionList, function(childindex, childval) {
                            if (childval.dataJson === "") {
                                childval.dataJson = null;
                            }
                            var datajson = JSON.parse(childval.dataJson);
                            v.subQuestionList[childindex].dataJson = datajson;
                            v.subQuestionList[childindex].userAnswer = "";
                        });
                    }
                    if (v.questionType < 12) {
                        _this.momentList.push({
                            id: v.Id,
                            paperStuQuestionId: v.paperStuQuestionId,
                            title: v.title,
                            commentaryFileData: v.commentaryFileData,
                            content: v.questionType > 7 ? v.subQuestionList : JSON.parse(v.dataJson == '' ? null : v.dataJson),
                            answer: v.answer,
                            type: v.questionType,
                            analysis: v.resultAnalysis,
                            optionAnswer: v.questionType == 7 ? JSON.parse(v.answer) : '',
                            queTypeName: v.queTypeName
                        });
                    }
                });
            } else {
                $.each(r.data.questions, function(i, v) {
                    $.each(v.SubQuestions, function(subindex, subval) {
                        if (subval.questionType == 8 || subval.questionType == 9 || subval.questionType == 11) {
                            $.each(subval.subQuestionList, function(childindex, childval) {
                                if (childval.dataJson === "") {
                                    childval.dataJson = null;
                                }
                                var datajson = JSON.parse(childval.dataJson);
                                subval.subQuestionList[childindex].dataJson = datajson;

                            });
                        }
                        if (subval.dataJson == "") {
                            subval.dataJson = null;
                        }
                        if (subval.questionType == 3) {
                            subval.dataJson = '[{ "SortOrder": "0", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "1", "Content": "正确", "IsAnswer": "" }]';
                        }

                        if (subval.questionType < 12) {

                            _this.momentList.push({
                                // id: subval.questionId,
                                // paperStuQuestionId: subval.paperStuQuestionId,
                                answer: subval.answer,
                                title: subval.title,
                                content: subval.questionType > 7 ? subval.subQuestionList : JSON.parse(subval.dataJson == '' ? null : subval.dataJson),
                                type: subval.questionType,
                                analysis: subval.resultAnalysis,
                                optionAnswer: subval.questionType == 7 ? JSON.parse(subval.answer) : '',
                                queTypeName: subval.queTypeName
                            });
                        }

                    });
                });
            }

            $("#nowindex").text(_this.start + 1.0);
            $("#total").text(_this.momentList.length);
            if (_this.momentList.length < 1) {
                var message = { "method": "showmsg", "msg": "数据异常" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            };
            $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0), checked: _this.checked }));
            $('i.currentNUM').text(1);
            $('i.totalNUM').text(_this.momentList.length);

            // $('#mask').addClass('hide');
            return this;
        },

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this,
                DOM = $('#questioninfo');
            var $scroll = $M('.mui-scroll-wrapper').scroll();
            DOM.on('singleTap', 'img', function(e) {
                var $elem = $(this),
                    id = $elem.data('id'),
                    url = $elem.attr('src');
                if ($elem.hasClass('preview') && id) {
                    var message = { "method": "getUrlById", "Id": id };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else if ($elem.hasClass('video')) {
                    // var $elem = $(this),
                    //     resourceurl = {
                    //         preview: $elem.attr('data-videourl') + '/360p.MP4'
                    //     };
                    // setTimeout(function() {
                    //     $M.openWindow({
                    //         url: '/view/teacher/video-controls/attachHomeworkVideo.html',
                    //         vid: 'teacher-attachHomeworkVideo',
                    //         extras: {
                    //             resourceurl: resourceurl
                    //         }
                    //     });
                    // }, 300);
                } else {
                    // 打开白板
                    // $M.openWindow({
                    //     url: '/view/teacher/whiteboard/whiteboard.html',
                    //     id: 'teacher-whiteboard',
                    //     extras: {
                    //         fromRes: true,
                    //         img: url,
                    //         isPcLocal: false,
                    //         webview: "teacher-examination-examinationhandle-record"
                    //     }
                    // });
                    if (url) {
                        message = { "method": "previewImg", "url": url };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    }
                }

            });


            DOM.on('singleTap', 'a', function(e) {
                var $elem = $(this);
                if ($elem.data('url')) {
                    var message = { "method": "getFileInfoByUrl", "url": $elem.data('url') };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            $(".ui-Mexam-view").on('singleTap', '.ui-Mexam-answer', function(e) {
                var $elem = $(this),
                    selectclass = 'li.' + $elem.next('li').attr('class').trim(),
                    $elemspan = $elem.find('.arrow');
                if ($elemspan.hasClass('up')) {
                    $elemspan.removeClass('up').addClass('down');
                } else {
                    $elemspan.removeClass('down').addClass('up');
                }
                $(selectclass).toggle();
            });
            //上一题
            $('#up-question').on('singleTap', function(e) {
                if (_this.start == 0) {
                    var message = { "method": "Msg", "msg": "已经是第一题" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }
                _this.start -= 1.0;
                $("#nowindex").text(_this.start + 1.0);
                $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0) }));
                $('#down-question').removeClass('save').text('下一题');
                $scroll.scrollTo(0, 0);
                $('i.currentNUM').text(_this.start + 1.0);
                $('i.totalNUM').text(_this.momentList.length);

            });
            //下一题
            $('#down-question').on('singleTap', function(e) {
                if ((_this.start + 1.0) == _this.momentList.length) {
                    var message = { "method": "Msg", "msg": "已经是最后一题" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }
                _this.start += 1.0;
                $("#nowindex").text(_this.start + 1.0);
                $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0), checked: _this.checked }));
                $scroll.scrollTo(0, 0);
                $('i.currentNUM').text(_this.start + 1.0);
                $('i.totalNUM').text(_this.momentList.length);

            });
            return this;
        },

        helper: function() {

            var _this = this,
                letter = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
            //对字符串进行编码
            template.config('escape', false);
            //替换img标签
            template.helper('questionType', function(i) {
                var type = ['', '单选题', '多选题', '判断题', '填空题', '填空题', '问答题', '匹配题', '阅读理解', '完形填空', '文件作答题', '视听题'];
                return type[Number(i)];
            });
            template.helper('itoCharAB', function(i) {

                return letter[Number(i)];
            });
            //填空题答案处理
            template.helper('TKAswer', function(i, userAnswer) {
                try {
                    var array_userAnswer = JSON.parse(userAnswer)
                    return array_userAnswer[i]["Content"]
                } catch (error) {
                    return ""
                }
            });
            template.helper('answertoTKstr', function(val) {
                if (!val) {
                    return;
                }
                var answer = [];
                $.each(JSON.parse(val), function(i, v) {
                    answer.push(v.Content);
                });
                return answer.join();
            });
            template.helper('wenjianJson', function(val) {
                if (!val) {
                    val = null;
                }
                return JSON.parse(val)
            });
            template.helper('iscorrect', function(i, answer, userAnswer) {
                if (!userAnswer) {
                    return '';
                }
                var array_userAnswer = userAnswer.split(','),
                    array_answer = answer.split(',');
                if ($.inArray(String(i), array_userAnswer) > -1) {
                    if ($.inArray(String(i), array_answer) > -1) {
                        return 'right';
                    } else {
                        return 'error';
                    }
                }
                return "";
            });
            template.helper('answertoCharAB', function(val, type) {
                if (type == 3) {
                    return val == 1 ? "正确" : "错误";
                }
                var arr = [];
                $.each(val.split(","), function(i, v) {
                    var moometstr = letter[v];
                    arr[i] = moometstr == undefined ? v : moometstr;
                });
                return arr.join();
            });

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入 
         * @return {null}
         */
        init: function() {

            // this.courseOpenId = this.view.courseOpenId;
            // this.openClassId = this.view.openClassId;
            // this.homeWorkId = this.view.homeWorkId;
            // this.questionType = '';
            // this.$user = JSON.parse(app.data.get('$cloudClassUser'));
            this.templ = ['question-danx-duox-pand', 'question-danx-duox-pand', 'question-danx-duox-pand', 'question-danx-duox-pand', 'question-tiankong', 'question-tiankong', 'question-wenda', 'question-pipei', 'question-yuedu', 'question-yuedu', 'question-wenjian', 'question-yuedu'];
            //临时容器
            this.momentList = [];
            this.start = 0;
            this.isSend = false;
            this.helper().load().events();

            return this;
        }
    };


    previewPaper.init();
    window.previewPaper = previewPaper

}(mui, Zepto));