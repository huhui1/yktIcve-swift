/**
 * 作业详细
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-06-8
 * @return {Object}
 */
(function($M, $) {

    var homeworklist = {
        /**
         * 获取总结信息
         * @return this
         */
        get: function() {
            var _this = this;

            if (_this.index == 0) {
                $http.post(app.teacherAPI.Homework.getUnSubmitStuList, {
                    openClassId: _this.openClassId,
                    homeWorkId: _this.homeWorkId,
                    courseOpenId: _this.courseOpenId,
                    homeworkTermTimeId: _this.homeworkTermTimeId
                }, function(r) {
                    if (r.code == 1) {
                        var html = template('tmpl-check-list', { list: r.homeworkStuList });
                        $('#unsubmit-list').html(html);
                    }
                });
            } else if (_this.index == 1) {

                $http.post(app.teacherAPI.Homework.getReadStuList, {
                    openClassId: _this.openClassId,
                    homeWorkId: _this.homeWorkId,
                    courseOpenId: _this.courseOpenId,
                    homeworkTermTimeId: _this.homeworkTermTimeId,
                    state: 1
                }, function(r) {
                    if (r.code == 1) {
                        var html = template('tmpl-check-list', { list: r.homeworkStuList, ztWay: _this.ztWay });
                        $('#uncheck-list').html(html);
                        $('.select-btn').prop("checked", false);
                        _this.typeState = false;
                        if (r.homeworkStuList.length > 0) {
                            $.each(r.homeworkStuList, function(i, v) {
                                _this.stuIdList.push(v.stuId)
                            })
                        }

                    }
                });
            } else if (_this.index == 2) {
                $http.post(app.teacherAPI.Homework.getReadStuList, {
                    openClassId: _this.openClassId,
                    homeWorkId: _this.homeWorkId,
                    courseOpenId: _this.courseOpenId,
                    homeworkTermTimeId: _this.homeworkTermTimeId,
                    state: 2
                }, function(r) {
                    if (r.code == 1) {
                        var html = template('tmpl-check-list', { list: r.homeworkStuList, ztWay: _this.ztWay });
                        $('#check-list').html(html);

                        $('.select-btn').prop("checked", false);
                        _this.typeState = false;
                    }
                });
            }
            $('#mask').addClass('mui-hidden');
            return this;
        },
        /**
         * 事件绑定
         * @return this
         */
        events: function() {
            var _this = this;
            // 模拟滚动
            $M('.mui-scroll-wrapper').scroll();
            // 页面刷新
            window.addEventListener('reload', function() {
                _this.get();
            });
            $('#item_1').on('touchstart', function() {
                if (_this.ztWay == 3) {
                    $('.operates').addClass('mui-hidden');
                }
                _this.index = 0;
            });
            $('#item_2').on('touchstart', function() {

                _this.index = 1;

                if (_this.ztWay == 3) {
                    _this.type = 2;
                    $('.select-btn').prop("checked", false);
                    _this.typeState = false;
                    $('#uncheck-list .workbox').prop("checked", _this.typeState);
                    if (_this.ztWay == 3 && _this.type != 1) {
                        $('.operates').removeClass('mui-hidden');
                    }
                };
                var $elem = $("#uncheck-list");
                if (!$elem.children().length) {
                    _this.get();
                }
            });
            $('#item_3').on('touchstart', function() {
                _this.index = 2;
                var $elem = $("#check-list");
                if (_this.ztWay == 3) {
                    _this.type = 3;
                    $('.select-btn').prop("checked", false);
                    _this.typeState = false;
                    $('#check-list .workbox').prop("checked", _this.typeState);
                    if (_this.ztWay == 3 && _this.type != 1) {
                        $('.operates').removeClass('mui-hidden');
                    };
                }


                if (!$elem.children().length) {
                    _this.get()
                }

            });
            $("#uncheck-list").off('singleTap').on('singleTap', 'td.push', function() {
                var $elem = $(this).parent(),
                    homeworkStuId = $elem.data('homeworkstuid'),
                    score = $elem.data('getscore'),
                    stuId = $elem.data('stuid');
                var extras = "",
                    data = "";
                if (_this.ztWay == 3) {
                    extras = {
                        homeworkStuId: homeworkStuId,
                        homeworkTermTimeId: _this.homeworkTermTimeId,
                        homeWorkId: _this.homeWorkId,
                        courseOpenId: _this.courseOpenId,
                        openClassId: _this.openClassId,
                        stuId: stuId,
                        score: score,
                        checked: false,
                        state: 1
                    }
                } else {
                    extras = {
                        homeworkStuId: homeworkStuId,
                        homeworkTermTimeId: _this.homeworkTermTimeId,
                        homeWorkId: _this.homeWorkId,
                        courseOpenId: _this.courseOpenId,
                        openClassId: _this.openClassId,
                        stuId: stuId,
                        checked: false
                    }
                }

                data = JSON.stringify(extras)
                var message = { "method": "homeworkPreview", "data": data, "ztWay": String(_this.ztWay) };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });
            $("#check-list").off('singleTap').on('singleTap', 'td.push', function() {
                var $elem = $(this).parent(),
                    homeworkStuId = $elem.data('homeworkstuid'),
                    score = $elem.data('getscore'),
                    data = "",
                    stuId = $elem.data('stuid');
                var extras = {
                    courseOpenId: _this.courseOpenId,
                    openClassId: _this.openClassId,
                    homeWorkId: _this.homeWorkId,
                    homeworkStuId: homeworkStuId,
                    stuId: stuId,
                    homeworkTermTimeId: _this.homeworkTermTimeId,
                    ztWay: _this.ztWay,
                    checked: true
                }
                data = JSON.stringify(extras)
                var message = { "method": "assignmentRecord", "data": data, "ztWay": String(_this.ztWay) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            $('.teaching-process').on('change', 'input', function() {

                var count = 0;

                if (this.checked) {
                    if (_this.type == 2) {
                        $('#uncheck-list .workbox').each(function() {
                            if (this.checked)
                                count++;
                        });
                        if (count == $('#uncheck-list .workbox').length) {
                            $('.select-btn').prop("checked", true);
                            _this.typeState = true;
                        }
                    } else if (_this.type == 3) {
                        $('#check-list .workbox').each(function() {
                            if (this.checked)
                                count++;
                        });
                        if (count == $('#check-list .workbox').length) {
                            $('.select-btn').prop("checked", true);
                            _this.typeState = true;
                        }
                    }
                } else {
                    $('.select-btn').prop("checked", false);
                    _this.typeState = false;
                }

            });
            $('.operates').on('change', '#checkAll', function() {
                var list = [];
                if (_this.type == 2) {
                    list = $('#uncheck-list .workbox')
                } else if (_this.type == 3) {
                    list = $('#check-list .workbox')
                }
                _this.typeState = !_this.typeState;
                list.prop("checked", _this.typeState);
            });
            //批量打分
            $('#setsorce').on('singleTap', function() {
                var list = [];
                if (_this.type == 2) {
                    list = $('#uncheck-list .workbox')
                } else if (_this.type == 3) {
                    list = $('#check-list .workbox')
                }
                var check_val = [];
                $.each(list, function(i, v) {
                    if (v.checked) {
                        check_val.push(v.value);
                    }
                });
                var extras = {
                    homeworkStuIds: check_val,
                    homeworkTermTimeId: _this.homeworkTermTimeId,
                    homeWorkId: _this.homeWorkId,
                    courseOpenId: _this.courseOpenId,
                    openClassId: _this.openClassId,
                }
                var data = JSON.stringify(extras);
                var message = { "method": "setAllScore", "data": data };
                window.webkit.messageHandlers.interOp.postMessage(message);

                // if (check_val.length == 0) {
                //     plus.nativeUI.toast("请选择评分的学生");
                //     return;
                // }
                // setTimeout(function() {
                //     $M.openWindow({
                //         url: '/view/teacher/assignment/attachmentPreview.html',
                //         id: 'assignment-attachmentPreview',
                //         extras: {
                //             homeworkStuIds: check_val,
                //             homeworkTermTimeId: _this.homeworkTermTimeId,
                //             homeWorkId: _this.homeWorkId,
                //             courseOpenId: _this.courseOpenId,
                //             openClassId: _this.openClassId,
                //         }
                //     });
                // }, 200);
            });
            //预览作业试卷(head)
            $('.previewPaper').on('singleTap', function() {
                if (_this.ztWay == 3) {
                    $M.openWindow({
                        url: '/view/teacher/assignment/attachmenthomeworkPreview.html',
                        id: 'teacher-assignment-attachmenthomeworkPreview',
                        extras: {
                            homeWorkId: _this.homeWorkId,
                            courseOpenId: _this.courseOpenId,
                            openClassId: _this.openClassId,
                        }
                    });
                } else {
                    $M.openWindow({
                        url: '/view/teacher/assignment/previewPaper.html',
                        id: 'teacher-assignment-previewPaper',
                        extras: {
                            homeWorkId: _this.homeWorkId,
                            courseOpenId: _this.courseOpenId,
                            openClassId: _this.openClassId,
                        }
                    });
                }

            })
        },
        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            //对字符串进行编码
            template.config('escape', false);
            //时间格式转化
            template.helper('dateFormat', function(date, format) {
                if (date.indexOf("-") > -1) {
                    date = date.replace(new RegExp("-", "gm"), "/");
                }
                if (date == 0)
                    date = new Date();
                else if (date.indexOf("/Date(") > -1) {
                    var date = new Date(parseInt(date.replace("/Date(", "").replace(")/", "") - 8 * 60 * 60 * 1000, 10));
                } else
                    date = new Date(date);

                var map = {
                    "M": date.getMonth() + 1, //月份
                    "d": date.getDate(), //日
                    "h": date.getHours(), //小时
                    "m": date.getMinutes(), //分
                    "s": date.getSeconds(), //秒
                    "q": Math.floor((date.getMonth() + 3) / 3), //季度
                    "S": date.getMilliseconds() //毫秒
                };
                format = format.replace(/([yMdhmsqS])+/g, function(all, t) {
                    var v = map[t];
                    if (v !== undefined) {
                        if (all.length > 1) {
                            v = '0' + v;
                            v = v.substr(v.length - 2);
                        }
                        return v;
                    } else if (t === 'y') {
                        return (date.getFullYear() + '').substr(4 - all.length);
                    }
                    return all;
                });
                return format;
            });


            return this;
        },
        getparameter: function(json, courseOpenId, openClassId) {
            var _this = this;
            _this.homeWorkId = json["homeworkId"];
            _this.ztWay = json["ztWay"];
            _this.homeworkTermTimeId = json["homeworkTermTimeId"];
            _this.openClassId = openClassId;
            _this.courseOpenId = courseOpenId;
            if (_this.ztWay == 3 && _this.type != 1) {
                $('.operates').removeClass('mui-hidden');
            }

            this.get().events();
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;
            this.homeWorkId = "";
            this.openClassId = "";
            this.courseOpenId = "";
            this.ztWay = "";
            this.homeworkTermTimeId = "";
            this.title = "";
            this.typeState = false;
            this.type = 1;
            this.index = 0;
            this.stuIdList = [] //存放学生Id数组
            $('h1.mui-title').text(this.title);
            _this.helper().load();

            return this;
        }
    };


    homeworklist.init();
    window.homeworklist = homeworklist

}(mui, Zepto));