/**
 * 讨论区列表页
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-03-08
 * @return {Object}
 */
(function($M, $) {

    var bbslist = {
        pushSocket: function() {
            var _this = this;
            $M.fire(_this.Mview, 'socket.emit', {
                params: {
                    type: 'discussing',
                    discussId: _this.discussId,
                    topicId: '',
                    courseId: '',
                    classId: '',
                    cellId: '',
                    studycount: 66,
                    fromRes: _this.fromRes
                }
            });
            return this;
        },
        /**
         * 获取数据
         * @return {this}
         */
        get: function(r, userId, me) {
            var _this = this,
                arr = [];
            _this.$userid = userId;
            me && me.resetload();
            $.each(r.discussInfo.docJson, function(i, v) {
                arr.push({
                    src: v.docPreview,
                    oss: v.docOssPreview
                })
            });

            $('#topice').html(template('topice-tpl', { discussdata: r.discussInfo, imgdata: arr }));
            if (r.discussInfo.replyList.length) {
                $('#list').html(template('list-tpl', { list: r.discussInfo.replyList, userId: userId }));
            } else {
                $('#list').html('<li class="mui-table-view-cell mui-media mui-text-center data-loading"><a href="javascript:;">还没有人评论，赶紧来评论吧！</a></li>');
            };
            $('.operates, .select-btn').hide();
            _this.me && _this.me.resetload();
            return this;
        },
        /**
         * 评分
         * @return {this}
         */
        performOk: function(score) {
            bbslist.perform.find('.score').html(score);
            bbslist.perform.find('.icon-appraise').addClass('active');
        },
        //批量评分
        batchMarking: function(score) {
            var _this = this;
            var list = $('[name="checkOne"]'),
                check_val = [];
            $.each(list, function(i, v) {
                if (v.checked) {
                    check_val.push(v.value);
                }
            });
            if (check_val.length == 0) {

                var message = { "method": "showErrorMsg", "msg": "请选择评分的学生" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                return;
            }
            $http.post(app.teacherAPI.FaceTeach.saveStuDiscussScore, {
                teaId: _this.selfId,
                discussStuIds: check_val,
                score: score
            }, function(r) {
                if (r.code == 1) {
                    _this.typeState = false;
                    var message = { "method": "load" };
                    window.webkit.messageHandlers.interOp.postMessage(message);

                } else {

                    var message = { "method": "showErrorMsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 模拟滚动
            var $scroll = $M('.mui-scroll-wrapper').scroll();
            $('#content-scroll').dropload({
                domUp: {
                    domClass: 'dropload-up',
                    domRefresh: '<div class="dropload-refresh">↓ 下拉可以刷新</div>',
                    domUpdate: '<div class="dropload-update">↑ 释放立即刷新</div>',
                    domLoad: '<div class="dropload-load"><span class="loading"></span> 正在刷新中...</div>'
                },
                loadUpFn: function(me) {
                    _this.me = me;
                    _this.load();
                    $scroll.scrollTo(0, 0);
                }
            });
            // 点击留言操作
            $('#list').on('singleTap', 'li.parent', function(e) {
                var has, $target = $(e.target),
                    $elem = $(this),
                    replyid = $elem.attr('data-replyid'),
                    userid = $elem.attr('data-userid'),
                    content = $elem.attr('data-content'),
                    docJson = $elem.attr('data-docjson'),
                    dateCreated = $elem.find('.time').text(),
                    creatorName = $elem.find('.CreatorName').text(),
                    avator = $elem.find('.avator').attr('src'),
                    $frame = $elem.find('.mui-frame');

                // 评分
                if ($target.hasClass('score') || $target.hasClass('disscuss_check') || $target.hasClass('icon-appraise') || $target.hasClass('appraise')) {
                    if (userid == _this.$userid) {
                        var message = { "method": "showErrorMsg", "msg": "不能为自己评分" };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                        $('.mui-backdrop').addClass('mui-hidden');
                        $('.keyup_score').removeClass('show');
                    } else if ($target.hasClass('disscuss_check')) {

                    } else {
                        $('.mui-backdrop').removeClass('mui-hidden');
                        $('.keyup_score').addClass('show');
                        _this.perform = $elem;
                        _this.replyIds = $elem.attr('data-replyid');
                        _this.stuName = $elem.attr('data-creatorname');
                        _this.isOnly = true;
                        _this.showKey();
                    }

                    return;
                }
                var extras = {
                    parentId: replyid,
                    dateCreated: dateCreated,
                    content: content,
                    docJson: docJson,
                    creatorName: creatorName,
                    avator: avator,
                    creatorId: userid
                }
                var message = { "method": "showReplyInfo", "info": JSON.stringify(extras) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $('#list').on('change', 'input', function() {
                var count = 0;

                if (this.checked) {
                    $('#list input').each(function() {
                        if (this.checked)
                            count++;
                    });
                    if (count == $('#list input').length) {
                        $('.select-btn').prop("checked", true);
                        _this.typeState = true;
                    }
                } else {
                    $('.select-btn').prop("checked", false);
                    _this.typeState = false;
                }

            });

            //退出键盘
            $('.delete_score').on('singleTap', function() {
                $('.mui-backdrop').addClass('mui-hidden');
                $('.keyup_score').removeClass('show');

                $('.mui-bar.mui-bar-tab').removeClass('noshow');
            });

            // 隐藏评分键盘
            $('.mui-backdrop').on('touchend', function() {
                $('.mui-backdrop').addClass('mui-hidden');
                $('.keyup_score').removeClass('show');

                $('.mui-bar.mui-bar-tab').removeClass('noshow');
            });

            // 同屏翻页
            $('.pageMove').on('singleTap', 'span', function() {
                var has = $(this).hasClass('icon-page-up');


                var name = has ? 'pageUp' : 'pageDown';
                var message = { "method": "examPageMove", "name": name };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });

            // 图片预览
            $('#topice').on('singleTap', 'img', function() {
                var url = $(this).data("oss");
                if (url) {
                    message = { "method": "preview", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            //长按出现打分界面
            $('#list').off('longTap').on('longTap', 'li', function() {
                $('input').fadeToggle();
                var message = { "method": "longTap" };
                window.webkit.messageHandlers.interOp.postMessage(message);
                $('div.operates').fadeToggle();
                $('input').next().toggleClass('changeclass')
            });
            //退出遮罩层,并改变登陆初始$activity的参数
            $('.select_drop').on('singleTap', function() {
                $('.select_drop').addClass('mui-hidden');
                _this.$activityUser.Discuss = false;
                app.data.set('$activityUser', JSON.stringify(_this.$activityUser));
            });
            // 通知容器展现
            window.addEventListener('stuDiscussed', function(e) {
                var actId = e.detail.actId,
                    userId = e.detail.userId,
                    displayName = e.detail.displayName,
                    content = e.detail.content;
                if (actId == _this.discussId) {
                    _this.get();
                    $M.fire(_this.Mview, 'socket.emit', {
                        params: {
                            type: 'discussing',
                            discussId: _this.discussId,
                            topicId: '',
                            courseId: '',
                            classId: '',
                            cellId: '',
                            studycount: 66,
                            fromRes: this.fromRes
                        }
                    });
                }
            });
            // });
            // 重新加载数据
            window.addEventListener('reload', function() {
                _this.get();
                $M.fire(_this.Mview, 'socket.emit', {
                    params: {
                        type: 'discussing',
                        discussId: _this.discussId,
                        topicId: '',
                        courseId: '',
                        classId: '',
                        cellId: '',
                        studycount: 66,
                        fromRes: this.fromRes
                    }
                });
            });
            return this;
        },
        backCancel: function() {
            $('input').fadeToggle();
            $('div.operates').fadeToggle();
            $('input').next().toggleClass('changeclass')
        },
        checkAll: function() {
            var _this = this;
            var list = $('[name="checkOne"]');
            _this.typeState = !_this.typeState;
            list.prop("checked", _this.typeState);
        },
        showKey: function() {
            var _this = this;

            $('.mui-backdrop').removeClass('mui-hidden');
            $('.keyup_score').addClass('show');
            //添加评分
            $('.score_info').off('singleTap').on('singleTap', function() {
                var score = $(this).text();
                if (_this.isOnly) {
                    // _this.performOk(_this.stuName, _this.perform, score);
                    var message = { "method": "performOk", "score": score, "replyIds": _this.replyIds, "name": _this.stuName };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    _this.batchMarking(score);
                }
                $('.mui-backdrop').addClass('mui-hidden');
                $('.keyup_score').removeClass('show');
                _this.isOnly = false;
            });
            return this;
        },
        /**
         * 增加辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            template.config('escape', false);
            //时间格式转化
            template.helper('dateFormat', function(date, format) {
                if (date == 0)
                    date = new Date();
                else if (date.indexOf("/Date(") > -1) {
                    var date = new Date(parseInt(date.replace("/Date(", "").replace(")/", "") - 8 * 60 * 60 * 1000, 10));
                } else
                    date = new Date(date);

                var map = {
                    "M": date.getMonth() + 1, //月份
                    "d": date.getDate(), //日
                    "h": date.getHours(), //小时
                    "m": date.getMinutes(), //分
                    "s": date.getSeconds(), //秒
                    "q": Math.floor((date.getMonth() + 3) / 3), //季度
                    "S": date.getMilliseconds() //毫秒
                };
                format = format.replace(/([yMdhmsqS])+/g, function(all, t) {
                    var v = map[t];
                    if (v !== undefined) {
                        if (all.length > 1) {
                            v = '0' + v;
                            v = v.substr(v.length - 2);
                        }
                        return v;
                    } else if (t === 'y') {
                        return (date.getFullYear() + '').substr(4 - all.length);
                    }
                    return all;
                });
                return format;
            });
            //替换img标签
            template.helper('replaceImg', function(val) {
                return $('<div/>').html(val.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]")).text();
            });
            //替换引号标签
            template.helper('replaceUnquote', function(val) {
                return val.replace(/\"/g, "'");
            });
            template.helper('jsontostr', function(v) {
                return JSON.stringify(v);
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        start: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            this.typeState = false;
            this.$userid = "";
            this.isOnly = false
            this.perform = "";
            this.me = "";
            this.replyIds = ''; // 评论的回复的Id
            this.helper().load().events();
        }
    };
    bbslist.init();
    window.bbslist = bbslist;

}(mui, Zepto));