/**
 * 课件问答区
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name   zqyou
 * @date  2017-02-28
 * @return {Object}
 */
(function($M, $) {


    var bbslist = {
        /**
         * 获取数据
         * @return {this}
         */
        get: function() {
            var _this = this;
            $http.post(app.teacherAPI.BBS.getCellBBSList, {
                courseOpenId: _this.courseOpenId,
                openClassId: _this.openClassId,
                cellId: _this.cellId,
                userId: _this.userId,
                activeType: _this.type
            }, function(data) {

                if (data.code == 1) {
                    _this.isMainTeacher = data.isMainTeacher;
                    $('#mask').addClass('mui-hidden');
                    var html = template('tmpl-bbslist', { list: data.list, type: _this.type });
                    $('.bbs-list')['html'](html);

                }
            });

            return this;
        },
        /**
         * 采纳
         */
        isadopt: function(Id, IsAccept) {
            var _this = this;
            $http.post(app.teacherAPI.BBS.acceptError, {
                Id: Id,
                IsAccept: IsAccept
            }, function(r) {
                if (r.code == 1) {
                    _this.get()
                } else {
                    var message = { "method": "showMsg", "msg": r.msg };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            return this;
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this,
                $scroll = $M('.mui-scroll-wrapper').scroll();

            //查看讨论
            $('#bbslist-scroll').on('singleTap', 'li.assignment-list', function(e) {
                if ($(this).hasClass('no-data')) return;
                if ($(e.target).hasClass('mui-btn-red')) return;
                var $elem = $(this),
                    bbsId = $elem.attr('data-bbsid'),
                    isAccept = $elem.attr("data-isaccept"),
                    avator = $elem.attr('data-avator'),
                    userId = $elem.attr('data-userid'),
                    content = $elem.find('.describe').html(),
                    userName = $elem.find('span.user').text(),
                    docJson = $elem.attr('data-docjson'),
                    dataCreated = $elem.find('span.time').text();

                if ($(e.target).hasClass('active') || $(e.target).hasClass('icon-icon')) {
                    if (_this.isMainTeacher != 1) {
                        var message = { "method": "showMsg", "msg": "很遗憾！您不能采纳或取消采纳，请确保您是主持老师！" };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                        return;
                    }
                    isAccept = isAccept == 1 ? 0 : 1;
                    _this.isadopt(bbsId, isAccept);
                } else {
                    var bbsInfo = {
                        dataCreated: dataCreated,
                        content: content,
                        useName: userName,
                        avator: avator,
                        bbsId: bbsId,
                        userId: userId,
                        docJson: docJson,
                        isAccept: isAccept,
                        isMainTeacher: _this.isMainTeacher
                    };
                    var message = { "method": "BBSDetails", "type": String(_this.type), "BBSId": bbsId, "bbsInfo": JSON.stringify(bbsInfo) };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            $('.bbs-list').on('singleTap', '.mui-btn-red', function() {
                var $elem = $(this),
                    replyedId = $elem.data('userid'),
                    id = $elem.data('id');
                if (_this.role == 1 && replyedId != _this.userId) {
                    var message = { "method": "showMsg", "msg": "不能删除他人的回复" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return
                }
                $http.post(app.teacherAPI.BBS.deleteComment, {
                    Id: id,
                    userId: _this.userId,
                    activeType: _this.type
                }, function(r) {
                    if (r.code == 1) {
                        var message = { "method": "showMsg", "msg": "删除成功" };
                        window.webkit.messageHandlers.interOp.postMessage(message);

                        _this.get()
                    } else {
                        var message = { "method": "showMsg", "msg": r.msg };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    }
                });

            });


            return this;
        },

        /**
         * 增加辅助方法
         * @return {this}
         */
        helper: function() {

            //对字符串进行编码
            template.config('escape', false);

            //替换img标签
            template.helper('content', function(val) {
                return val.toString().replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]");
            });
            template.helper('jsontostr', function(v) {
                return JSON.stringify(v);
            });
            template.helper('isActive', function(i, v) {
                if (i <= v) {
                    return 'active'
                }
            })
            return this;
        },
        setBaseInfo: function(courseOpenId, openClassId, cellId, userId, activeType, role) {
            var _this = this;
            _this.courseOpenId = courseOpenId;
            _this.openClassId = openClassId;
            _this.cellId = cellId;
            _this.userId = userId;
            _this.type = activeType;
            _this.role = role;
            _this.get();
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 初始化
         * @return {this}
         */
        init: function() {

            this.type = "1";
            this.courseOpenId = "";
            this.openClassId = "";
            this.cellId = "";
            this.userId = "";
            this.role = 1;
            this.isMainTeacher = 0;
            this.helper().load().events();

            return this;
        }
    };


    bbslist.init();
    window.bbslist = bbslist;

}(mui, Zepto));