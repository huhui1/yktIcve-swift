/**
 * 讨论区
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  M.J
 * @date  2015-09-23
 * @return {Object}
 */
(function($M, $) {

    $M.init({
        swipeBack: true,
        beforeback: function() {
            var viewMine = plus.webview.getWebviewById('mine-list');
            $M.fire(viewMine, 'socket.emit', { params: { type: 'closeRes' } });

            $M.fire(plus.webview.getWebviewById('teacher-bbs-list'), 'reSocket');
        }
    });

    var comment = {
        setTitle: function() {
            var _this = this,
                dataJson,
                viewMine = plus.webview.getWebviewById('mine-list');
            if (_this.docJson) {
                dataJson = JSON.parse(_this.docJson);
            }
            var params = {
                type: 'discussDetail',
                name: _this.creatorName,
                content: _this.content + (dataJson.length > 2 ? "[图片]" : ""),
                color: '',
                avatar: _this.avator,
                discussId: _this.discussId,
                appreciate: 0,
                fromRes: this.fromRes
            };
            $('#comment-list-html').append(template('comment-list-tpl', {
                creatorName: _this.creatorName,
                dateCreated: _this.dateCreated,
                docJson: dataJson,
                content: _this.content,
                avator: _this.avator
            }));

            $M.fire(viewMine, 'socket.emit', { params: params });

            return this;
        },
        /**
         * 获取数据
         * @return {this}
         */
        get: function() {
            var _this = this,
                $user = JSON.parse(app.data.get('$cloudClassUser'));
            $http.post(app.teacherAPI.FaceTeach.getDiscussReply, { discussId: _this.discussId, parentId: _this.parentId }, function(r) {
                if (r.code > 0) {
                    $('#comment-list-content-html').html(template('comment-list-content-tpl', {
                        list: r.dataList,
                        userId: $user.id
                    }));
                } else {
                    plus.nativeUI.toast('您所查找的内容已不存在');
                    this.view.close();
                }
                $('#mask').addClass('mui-hidden');
            });

            return this;
        },

        /**
         * 删除评论
         * @return {this}
         */
        deleteReply: function(id, isParent) {
            if (!id) return;

            var _this = this,
                $elem = $('[data-id="' + id + '"]');
            // isParent = JSON.parse($elem.attr('data-parent'));

            $http.post(app.teacherAPI.FaceTeach.delDiscussReply, { discussReplyId: id }, function(data) {
                if (data.code > 0) {
                    $elem.remove();
                    plus.nativeUI.toast('删除成功');
                } else {
                    plus.nativeUI.toast(data.msg);
                }

                if (isParent) {
                    $M.fire(plus.webview.getWebviewById('teacher-bbs-list'), 'deReload');
                    setTimeout(function() {
                        _this.view.close();
                    }, 200)
                    return;
                } else {
                    $M.fire(plus.webview.getWebviewById('teacher-bbs-list'), 'reload');
                }

                // 判断 ul 下是否还有 li
                if (!$('#comment > li > ul > li').length) {
                    $('#comment > li > ul').html('<li class="mui-table-view-cell mui-media mui-text-center data-loading"><a href="javascript:;">还没有人评论，赶紧来评论吧！ </a></li>');
                }
            });

            return this;
        },

        /**
         * 绑定事件
         * @return {this}
         */
        events: function() {
            var _this = this;

            // 绑定滚动
            $M('#comment-scroll').scroll();

            //评论的操作
            $(".comment-oprate").on('singleTap', function() {
                var id = id = _this.parentId;

                plus.nativeUI.actionSheet({
                    cancel: "取消",
                    buttons: [{ title: '删除' }]
                }, function(e) {
                    //删除评论
                    if (e.index == 1) {
                        _this.deleteReply(id, true);
                    }
                });
            });

            // 删除按钮
            $('#comment').on('singleTap', 'li', function(e) {
                var $target = $(e.target),
                    $elem = $(this),
                    id = $elem.attr('data-id'),
                    $frame = $elem.find('.mui-frame');

                // 删除按钮事件
                if ($target.hasClass('isInlineDelete')) {
                    plus.nativeUI.confirm('确认删除此条回复吗？', function(e) {
                        if (e.index === 0) {
                            _this.deleteReply(id, false);
                        }
                        $frame.fadeOut();
                    }, '删除回复');
                    return;
                }
            });

            //教师预览图片 （类似作业预览 type为assignment标志与作业相同的处理方式）
            $('#comment-scroll').on('singleTap', 'img', function() {
                plus.navigator.setFullscreen(true);
                var url = $(this).attr('src').replace('/400_400.jpg', '');
                // 打开白板
                $M.openWindow({
                    url: '/view/teacher/whiteboard/whiteboard.html',
                    id: 'teacher-whiteboard',
                    extras: {
                        fromRes: true,
                        img: url,
                        isPcLocal: false
                    }
                });

            });

            // 回复操作
            $('.reply').on('singleTap', function() {
                if (_this.state == 3) {
                    plus.nativeUI.toast('讨论已结束，不能回复评论！');
                    return;
                }
                $M.openWindow({
                    url: '/view/teacher/bbs/reply.html',
                    id: 'teacher-bbs-reply',
                    show: {
                        duration: 300
                    },
                    extras: {
                        courseOpenId: _this.courseOpenId,
                        openClassId: _this.openClassId,
                        discussId: _this.discussId,
                        activityId: _this.activityId,
                        parentId: _this.parentId
                    }
                });
            });

            // 数据的重新加载
            window.addEventListener('reload', function(e) {
                _this.isOperate = true;
                var html = template('comment-one-content-tpl', {
                    comment: e.detail
                });
                $('#comment-list-content-html').prepend(html);
                setTimeout(function() {
                    _this.get();
                }, 100);
            });
            return this;
        },

        /**
         * 增加辅助方法
         * @return {this}
         */
        helper: function() {

            //对字符串进行编码
            template.config('escape', false);
            //时间格式转化
            template.helper('dateFormat', function(date, format) {
                if (date == 0)
                    date = new Date();
                else if (date.indexOf("/Date(") > -1) {
                    var date = new Date(parseInt(date.replace("/Date(", "").replace(")/", "") - 8 * 60 * 60 * 1000, 10));
                } else
                    date = new Date(date);

                var map = {
                    "M": date.getMonth() + 1, //月份
                    "d": date.getDate(), //日
                    "h": date.getHours(), //小时
                    "m": date.getMinutes(), //分
                    "s": date.getSeconds(), //秒
                    "q": Math.floor((date.getMonth() + 3) / 3), //季度
                    "S": date.getMilliseconds() //毫秒
                };
                format = format.replace(/([yMdhmsqS])+/g, function(all, t) {
                    var v = map[t];
                    if (v !== undefined) {
                        if (all.length > 1) {
                            v = '0' + v;
                            v = v.substr(v.length - 2);
                        }
                        return v;
                    } else if (t === 'y') {
                        return (date.getFullYear() + '').substr(4 - all.length);
                    }
                    return all;
                });
                return format;
            });

            return this;
        },

        /**
         * 载入
         * @return {this}
         */
        init: function() {

            this.view = plus.webview.currentWebview();
            this.parentView = plus.webview.getWebviewById('teacher-bbs-list');
            this.courseOpenId = this.view.courseOpenId;
            this.openClassId = this.view.openClassId;
            this.activityId = this.view.activityId || '';
            this.discussId = this.view.discussId || '';
            this.parentId = this.view.parentId || '';
            this.dateCreated = this.view.dateCreated;
            this.content = this.view.content;
            this.docJson = this.view.docJson;
            this.creatorName = this.view.creatorName;
            this.avator = this.view.avator;
            this.isOperate = false;
            this.fromRes = false;
            //单次讨论是否结束
            this.state = this.view.state;
            this.setTitle().helper().get().events();

        }
    };

    $M.plusReady(function() {
        comment.init();
    });

}(mui, Zepto));