(function($M, $) {



    var schoolList = {


        get: function(r) {
            var _this = this
            if (r.length) {
                _this.sortData(r);

            };
            return this;
        },
        sortData: function(data) {
            var _this = this;
            data.sort(function(m, n) {
                var s = m.PY2.substr(0, 1);
                var e = n.PY2.substr(0, 1);
                if (s > e) {
                    return 1
                } else if (s < e) {
                    return -1;
                } else {
                    return 0;
                }
            });
            _this.setData(data);
            _this.list = data;
        },
        setData: function(emp) {
            var html = "",
                oldChar = "";
            $.each(emp, function(index, result) {
                var c = result.PY2.substr(0, 1);
                if (c != oldChar) {
                    html += '<li data-group="' + c.toUpperCase() + '" class="mui-table-view-divider mui-indexed-list-group">' + c.toUpperCase() + '</li>';
                    oldChar = c;
                }
                html += '<li data-id="' + result.Id + '" data-nm="' + result.NM + '"  class="mui-table-view-cell mui-indexed-list-item">' + result.NM + '</li>';
            });
            //遍历结束插入数据
            document.getElementById("schoolList").innerHTML = html;
            //重新实例化索引列表，不然快速查找不生效
            mui("#list").indexedList();
            return this;
        },
        event: function() {
            var _this = this;
            $('#search').bind('input propertychange', function() {
                var $elem = $(this),
                    schoolKey = $elem.val().toLowerCase(),
                    arr = [];
                $.each(_this.list, function(i, v) {
                    if (v.NM.indexOf(schoolKey) > -1 || v.PY.indexOf(schoolKey) > -1 || v.PY2.indexOf(schoolKey) > -1) {
                        arr.push(v);
                    };
                });
                _this.setData(arr);
            });

            //选择学校
            $('#schoolList').on('singleTap', 'li', function() {
                var $elem = $(this),
                    schoolId = $elem.data('id'),
                    schoolName = $elem.data('nm');
                var message = { "method": "schoolMessage", "schoolId": schoolId, "schoolName": schoolName };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            $('.back').on('singleTap', function() {
                var message = { "method": "back" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            })

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;
            this.list = [];
            _this.load().event();
            return this;
        }
    };



    schoolList.init();
    window.schoolList = schoolList


}(mui, Zepto))