/**
 * 学生作答问卷调查
 * @param {Object} $M => mui
 * @param {Object} $  => quo
 * @name  hx
 * @date  2018-1-11
 * @return {Object}
 */
(function($M, $) {



    var questionSurway = {

        /**
         * 获取题目
         * @return {this}
         */
        get: function(r, userId, activityId, openClassId, questionnaireId) {
            var _this = this;
            _this.userId = userId;
            _this.activityId = activityId;
            _this.openClassId = openClassId;
            _this.questionnaireId = questionnaireId;
            _this.questionnaireStuId = r.questionnaireStuId;
            _this.momentList = [];
            $.each(r.questionList, function(i, v) {
                // if (v.QuestionType == 3) {
                //     // v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                // }
                _this.momentList.push({
                    id: v.Id,
                    StuQuestionId: v.StuQuestionId,
                    title: v.Title,
                    content: v.DataJson == '' ? null : v.DataJson,
                    type: v.QuestionType,
                    userAnswer: ""
                });
                _this.handleQuestinData.push({
                    id: v.Id,
                    StuQuestionId: v.StuQuestionId,
                    title: v.Title,
                    content: v.DataJson == '' ? null : v.DataJson,
                    type: v.QuestionType,
                    Answer: ""
                });
            });

            $("#nowindex").text(_this.index);
            $("#total").text(_this.momentList.length);
            $('#questioninfo').html(template('question-danx-duox-pand', { question: _this.momentList[_this.start], index: _this.index }));


            return this;
        },
        /**单题提交 */
        submit: function() {
            var _this = this,
                index = '',
                Id = _this.momentList[_this.start].StuQuestionId,
                QuestionnaireQuesId = _this.momentList[_this.start].id,
                answer = _this.momentList[_this.start].userAnswer;
            if (answer == _this.handleQuestinData[_this.start].Answer) {
                if (_this.last) {
                    _this.submitQuestion();
                } else { return; }
            } else {
                if ($.isArray(answer)) {
                    index = answer.join();
                } else {
                    index = answer;
                };
                var data = {
                    Id: Id,
                    QuestionnaireStuId: _this.questionnaireStuId,
                    QuestionnaireQuesId: QuestionnaireQuesId,
                    OpenClassId: _this.openClassId,
                    ActivityId: _this.activityId,
                    UserId: _this.userId,
                    Answer: index,
                    SourceType: 3
                };
                $http.post(app.teacherAPI.FaceTeach.saveStuQuestionAnswer, {
                    data: JSON.stringify(data)
                }, function(r) {
                    if (r.code == 1) {
                        _this.handleQuestinData[_this.start].Answer = index;
                        if ($.inArray(_this.start, _this.arr) < 0) {
                            _this.arr.push(_this.start);
                        };
                        if (_this.last) {
                            _this.submitQuestion();
                        }
                    } else {
                        _this.momentList[_this.start].userAnswer = '';
                        var message = { "method": "showMsg", "msg": r.msg };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    }
                });
            };
        },
        /**
         * return this
         * 上一题
         */
        prev: function() {

            questionSurway.start -= 1.0;
            questionSurway.index -= 1.0;
            $("#nowindex").text(questionSurway.index);
            $('#questioninfo').html(template('question-danx-duox-pand', {
                question: questionSurway.momentList[questionSurway.start],
                index: (questionSurway.index)
            }));

            $('#down-question').removeClass('save').text('下一题');
            questionSurway.$scroll.scrollTo(0, 0);

        },
        /**
         * return this
         * 下一题
         */
        next: function() {
            questionSurway.submit();
            questionSurway.start += 1.0;
            questionSurway.index += 1.0;
            if (questionSurway.index > questionSurway.momentList.length) {
                // plus.nativeUI.toast("已是最后一题");
                questionSurway.start = questionSurway.momentList.length - 1;
                questionSurway.index = questionSurway.momentList.length;
                return;
            }

            $('#questioninfo').html(template('question-danx-duox-pand', {
                question: questionSurway.momentList[questionSurway.start],
                index: (questionSurway.index)
            }));
            questionSurway.$scroll.scrollTo(0, 0);

        },
        submitQuestion: function() {
            var _this = this,
                data = {
                    Id: _this.questionnaireStuId,
                    OpenClassId: _this.openClassId,
                    ActivityId: _this.activityId,
                    QuestionnaireId: _this.questionnaireId,
                    StuId: _this.userId,
                    SourceType: 3
                };

            if (_this.arr.length != _this.momentList.length) {

                var message = { "method": "save", msg: "存在问卷题目未作答，是否提交问卷？", "data": JSON.stringify(data) };
                window.webkit.messageHandlers.interOp.postMessage(message);

            } else {
                var message = { "method": "save", msg: "确认提交问卷么？", "data": JSON.stringify(data) };
                window.webkit.messageHandlers.interOp.postMessage(message);

            }
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this,
                DOM = $('#questioninfo');

            _this.$scroll = $M('.mui-scroll-wrapper').scroll();
            $("body").swipeRight(_this.prev);
            $("body").swipeLeft(_this.next);
            DOM.on('singleTap', '.charli', function() {
                var $elem = $(this),
                    type = Number($elem.data('type'));

                switch (type) {
                    case 2:
                        _this.duox($elem);
                        break;
                    default:
                        _this.danx($elem);
                        break;
                }
            });


            return this;
        },

        /**
         * 单选处理
         */
        danx: function($elem) {
            var _this = this,
                answer = $elem.data('answer');
            $elem.addClass('right').siblings().removeClass('right');
            _this.momentList[_this.start].userAnswer = String(answer);

            return this;
        },
        /**
         * 多选
         */
        duox: function($elem) {
            var _this = this,
                answer = String($elem.data('answer')),
                userAnswer = _this.momentList[_this.start].userAnswer,
                select = userAnswer ? String(userAnswer).split(',') : [],
                index = $.inArray(String(answer), select);
            index > -1 ?
                (select.splice(index, 1)) :
                (select.push(answer));
            index > -1 ?
                ($elem.removeClass('right')) :
                ($elem.addClass('right'));
            select.sort();
            _this.momentList[_this.start].userAnswer = select.join();
            return this;
        },
        helper: function() {

            var _this = this;
            //对字符串进行编码
            template.config('escape', false);
            //替换img标签
            template.helper('questionType', function(i) {
                var type = ['', '单选题', '多选题', '判断题', '填空题', '填空题', '问答题', '匹配题', '阅读理解', '完形填空', '文件作答题', '视听题'];
                return type[Number(i)];
            });
            template.helper('itoCharAB', function(i) {
                var letter = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                return letter[Number(i)];
            });
            //选择题处理
            template.helper('isselected', function(i, userAnswer) {
                if (userAnswer === "") {
                    return '';
                }
                var array_userAnswer = String(userAnswer).split(',');
                if ($.inArray(String(i), array_userAnswer) > -1) {
                    return 'right';
                } else {
                    return "";
                }

            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入 
         * @return {null}
         */
        init: function() {


            this.activityId = "";
            this.questionnaireId = "";
            this.openClassId = "";
            this.questionnaireStuId = '';
            this.last = false;
            this.arr = [];
            this.userId = ""

            //临时容器
            this.handleQuestion = []; //已做题目
            this.momentList = [];
            this.handleQuestinData = [];
            this.start = 0; //数组下标
            this.index = 1; //题目下标
            this.$scroll = '';
            this.helper().load().events();

            return this;
        }
    };


    questionSurway.init();
    window.questionSurway = questionSurway;

}(mui, Zepto));