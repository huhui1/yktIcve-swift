/**
 * 随堂检测考试报告
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2015-07-28
 * @return {Object}
 */
(function($M, $) {
    var letter = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];

    var examreport = {
        /**
         * 获取数据
         * @return {this}
         */
        get: function(data) {
            var
                _this = this;
            if (data.code > 0) {
                _this.examTitle = data.stuAnswerInfo.classTestTitle;
                $.each(data.stuQuestionList, function(i, v) {
                    if (v.questionType === 3) {
                        v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                    }
                    v.dataJson = JSON.parse(v.dataJson);
                    if (v.isRight != 1) {
                        _this.errorQuestionList.push(v);
                    }
                    _this.allQuestionList.push(v);
                });
                $('#report').html(template('report-tpl', {
                    stuAnswerInfo: data.stuAnswerInfo,
                    stuQuestionList: data.stuQuestionList
                }));

            }

            return this;
        },

        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();

            // 单个题目预览
            $('#report').on('singleTap', 'div.answer-list > ul > li > a', function(e) {
                var $elem = $(this),
                    index = $elem.parent().index();
                var message = { "method": "singleRecord", "extrasData": JSON.stringify(_this.allQuestionList), "start": String(index) };
                window.webkit.messageHandlers.interOp.postMessage(message);
                // $M.openWindow({
                //     url: '/view/student/class/examReportRecord.html',
                //     id: 'student-class-examReportRecord',
                //     extras: {
                //         questionlist: _this.allQuestionList,
                //         type: 3,
                //         examTitle: _this.examTitle,
                //         start: index
                //     },
                //     show: {
                //         aniShow: 'pop-in',
                //         duration: 300
                //     }
                // });

            });

            // 所有错题解析Single
            $('#error-exam').on('singleTap', function(e) {
                var message = { "method": "singleTitleRecord", "extrasData": JSON.stringify(_this.errorQuestionList) };
                window.webkit.messageHandlers.interOp.postMessage(message);
                // if (!_this.errorQuestionList.length) {
                //     plus.nativeUI.toast("无错题解析");
                //     return false;
                // }
                // $M.openWindow({
                //     url: '/view/student/class/examReportRecord.html',
                //     id: 'student-class-examReportRecord',
                //     extras: {
                //         questionlist: _this.errorQuestionList,
                //         type: 2,
                //         examTitle: _this.examTitle
                //     },
                //     show: {
                //         aniShow: 'pop-in',
                //         duration: 300
                //     }
                // });
            });

            // 所有题目解析
            $('#all-exam').on('singleTap', function(e) {
                var message = { "method": "allTitleRecord", "extrasData": JSON.stringify(_this.allQuestionList) };
                window.webkit.messageHandlers.interOp.postMessage(message);
                // $M.openWindow({
                //     url: '/view/student/class/examReportRecord.html',
                //     id: 'student-class-examReportRecord',
                //     extras: {
                //         questionlist: _this.allQuestionList,
                //         type: 3,
                //         examTitle: _this.examTitle
                //     },
                //     show: {
                //         aniShow: 'pop-in',
                //         duration: 300
                //     }
                // });
            });

            return this;
        },

        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            this.courseOpenId = "";
            this.examId = "";
            this.stuId = "";
            this.examTitle = "";
            this.errorQuestionList = [];
            this.allQuestionList = [];
            this.load().events();
        }
    };


    examreport.init();
    window.examreport = examreport

}(mui, Zepto));