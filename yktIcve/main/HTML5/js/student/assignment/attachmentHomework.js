(function($M, $) {

    var attachmentHomewok = {

        get: function(me) {
            var _this = this;
            $http.get(app.studentAPI.Homework.getHomeworkPreview, {
                schoolId: _this.schoolId,
                openClassId: _this.openClassId,
                courseOpenId: _this.courseOpenId,
                homeWorkId: _this.homeWorkId,
                homeworkStuId: _this.homeworkStuId,
                stuId: _this.stuId,
                sourceType: 3
            }, function(r) {
                if (r.code == 1) {
                    $('.storm_title').text(r.data.homeworkTitle);
                    $('#content').html(r.data.answerContent);
                    $('#stormContent').html(template('attachmentList', { list: r.data.questions }));
                    $('.pic-info').html(template('imglist', { list: r.data.studentAnswer, stuAnswerPreviewUrl: r.data.stuAnswerPreviewUrl }));
                }
                me && me.resetload();
            });

            return this;
        },

        /**
         * @return {this}
         */
        send: function(isDraft) {
            var _this = this,
                content = $('.content').text(),
                list = $("div.pic-info").find('img'),
                arr = [];
            // if (content.length > 1500) {
            //     plus.nativeUI.toast("字数过多");
            //     return
            // }
            $.each(list, function(i, v) {
                arr.push({
                    docTitle: "学生答案",
                    docSize: $(v).data('size'),
                    docUrl: $(v).data('url'),
                    Md5: $(v).data('md5'),
                    docType: $(v).hasClass('seeImg') ? "jpg" : "mp4"
                });
            });
            $http.post(app.studentAPI.Homework.stuSubmitFileHomework, {
                homeworkStuId: _this.homeworkStuId,
                openClassId: _this.openClassId,
                homeworkId: _this.homeWorkId,
                homeworkTermTimeId: _this.homeWorkTermTimeId,
                answerContent: content,
                stuAnswerDocJson: JSON.stringify(arr),
                stuId: _this.stuId,
                useTime: _this.time_s,
                sourceType: 3,
                isDraft: isDraft
            }, function(r) {
                if (r.code == 1) {
                    var message = { "method": "doneSuccess" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    // plus.nativeUI.toast(r.msg);
                    // $M.fire(plus.webview.getWebviewById('student-article'), 'assignment');
                    // $M.fire(plus.webview.getWebviewById('student-assignment-record'), 'reload');
                    // _this.view.close();
                }
            });
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();


            $("#stormContent").on('singleTap', 'a', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });
            //上传图片
            $('.pic-info').on('singleTap', '.add-pic', function(e) {
                e.preventDefault();
                var message = { "method": "uploadImg" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //del
            $('.pic-info').on('singleTap', '.delimg', function() {
                var $elem = $(this);
                $elem.parent().remove();
                $('.add-pic').removeClass('mui-hidden');
                $('.add-pic').show();
            });

            $('.pic-info').on('singleTap', '.seeImg', function() {
                var $elem = $(this);

                if (!$elem.complete || typeof $elem.naturalWidth == "undefined" || $elem.naturalWidth == 0) {
                    var url = $elem.data('url');
                    var message = { "method": "getUrlByUrl", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    var url = $elem.attr('src');

                    var message = { "method": "previewImg", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            $('.pic-info').on('singleTap', '.video', function() {
                var $elem = $(this);
                var url = $elem.data("url");
                if (url) {
                    var message = { "method": "getUrlByUrl", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            return this;
        },




        /**
         * 上传图片
         * @return {this}
         */
        uploadImg: function(t) {
            var _this = this;



            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg" width="70" height="70" data-doctype="jpg" data-url=' + t.url + ' data-md5=' + t.md5 + ' data-size=' + t.size + ' src="' + t.ossOriUrl + '"><i class="delimg iconfont icon-close"></i></div>');

            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden')
                }
            }, 100);

            return this;
        },
        //上传视频
        uploadvideo: function(file) {
            var _this = this;

            $(".pic-info .add-pic").before('<div  style="display: inline-block; position: relative;"><img class="uploaded-pic video" width="70" height="70"  data-videourl=' + file.ossOriUrl + '    data-md5=' + file.md5 + ' data-size=' + file.size + ' data-url=' + file.url + ' src="../../../img/video.jpg"><i class="iconfont delimg icon-close"></i></div>');
            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden');
                }
            }, 100);
            return this;
        },
        helper: function() {
            template.helper('jsontostr', function(v) {

                return JSON.stringify(v);
            });
            template.helper('imgSrcSplicing', function(url, src) {
                return url.substr(0, url.indexOf('?')) + src;
            });

            return this;
        },
        setTime: function() {
            var _this = this;
            setInterval(function() {
                _this.time_s = _this.time_s + 1.0;
                var s = _this.time_s % 60,
                    ss = parseInt(_this.time_s / 60);
                $('#timeNum').text(ss + ':' + s);
            }, 1000);
            return this;
        },
        getparameter: function(courseOpenId, openClassId, homeWorkId, homeworkTermTimeId, stuId, schoolId, homeworkStuId) {
            var _this = this;
            _this.courseOpenId = courseOpenId;
            _this.openClassId = openClassId;
            _this.homeWorkId = homeWorkId;
            _this.homeworkStuId = homeworkStuId;
            _this.homeWorkTermTimeId = homeworkTermTimeId;
            _this.stuId = stuId;
            _this.schoolId = schoolId;
            _this.get().events();
            return this
        },
        load: function() {
            var _this = this;
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            var _this = this;
            this.time_s = 0;
            this.courseOpenId = "";
            this.openClassId = "";
            this.homeWorkId = "";
            this.homeworkStuId = "";
            this.homeWorkTermTimeId = "";
            this.stuId = "";
            this.schoolId = "";
            //上传图片配置信息存储
            this.uploadUrl = '';
            this.prefixUrl = '';
            this.setTime();
            this.helper().load();

            return this;
        }
    };


    attachmentHomewok.init();
    window.attachmentHomewok = attachmentHomewok

}(mui, Zepto));