(function($M, $) {
    var assignmenthandle = {

        /**
         * 获取题目
         * @return {this}
         */
        get: function() {
            var _this = this,
                $mask = $('#mask');
            $http.post(app.studentAPI.Homework.getHomeworkPreview, {
                openClassId: _this.openClassId,
                homeworkId: _this.homeWorkId,
                homeworkStuId: _this.homeworkStuId,
                stuId: _this.stuId,
                sourceType: 3
            }, function(r) {
                if (r.code > 0) {
                    _this.uniqueId = r.data.uniqueId;
                    _this.paperStructUnique = r.data.paperStructUnique ? r.data.paperStructUnique : "";
                    var message = { "method": "setID", "paperStructUnique": _this.paperStructUnique, "uniqueId": _this.uniqueId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    _this.momentList = [];
                    var numtostr = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
                    if (r.data.ztWay == 2 || r.data.ztWay == 4) {
                        $.each(r.data.questions, function(i, v) {
                            if (v.questionType == 3) {
                                v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                            }

                            if (v.questionType == 8 || v.questionType == 9 || v.questionType == 11) {
                                $.each(v.subQuestionList, function(childindex, childval) {
                                    if (childval.dataJson === "") {
                                        childval.dataJson = null;
                                    }
                                    var datajson = JSON.parse(childval.dataJson);
                                    v.subQuestionList[childindex].dataJson = datajson;
                                    v.subQuestionList[childindex].userAnswer = "";
                                });
                            }
                            var contentImgHtml = '';
                            if (v.questionType == 10) {
                                contentImgHtml = '<div class="add-pic"><i class="mui-icon iconfont icon-add" style="font-size: 55px;color: rgba(196, 196, 196, 0.86);padding-left: 4px;"></i> </div>';
                            }
                            if (v.questionType < 12) {
                                // _this.totalquestionlist.push(v.paperStuQuestionId);
                                _this.momentList.push({
                                    id: v.questionId,
                                    paperStuQuestionId: v.paperStuQuestionId,
                                    fullScore: v.questionScore,
                                    title: v.title,
                                    content: v.questionType > 7 ? v.subQuestionList : JSON.parse(v.dataJson == '' ? null : v.dataJson),
                                    type: v.questionType,
                                    userAnswer: "",
                                    optionAnswer: v.questionType == 7 ? JSON.parse(v.answer) : '',
                                    contentImgHtml: contentImgHtml,
                                    queTypeName: v.queTypeName
                                });
                            }
                        });
                    } else {
                        $.each(r.data.questions, function(i, v) {
                            $.each(v.SubQuestions, function(subindex, subval) {
                                if (subval.questionType == 8 || subval.questionType == 9 || subval.questionType == 11) {
                                    $.each(subval.subQuestionList, function(childindex, childval) {
                                        if (childval.dataJson === "") {
                                            childval.dataJson = null;
                                        }
                                        // _this.totalquestionlist.push(childval.subQuestionId);
                                        var datajson = JSON.parse(childval.dataJson);
                                        subval.subQuestionList[childindex].dataJson = datajson;
                                        subval.subQuestionList[childindex].userAnswer = "";
                                    });
                                }
                                var contentImgHtml = '';
                                if (subval.questionType == 10) {
                                    contentImgHtml = '<div class="add-pic"><i class="mui-icon iconfont icon-add" style="font-size: 55px;color: rgba(196, 196, 196, 0.86);padding-left: 4px;"></i> </div>';
                                }
                                if (subval.questionType == 3) {
                                    subval.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                                }

                                if (subval.questionType < 12) {
                                    _this.momentList.push({
                                        id: subval.questionId,
                                        paperStuQuestionId: subval.paperStuQuestionId,
                                        fullScore: subval.questionScore,
                                        title: subval.title,
                                        content: subval.questionType > 7 ? subval.subQuestionList : JSON.parse(subval.dataJson == '' ? null : subval.dataJson),
                                        type: subval.questionType,
                                        userAnswer: v.studentAnswerString,
                                        ztWay: 2,
                                        bigQuestionTitle: subindex == 0 ? numtostr[i] + "." + v.Title : "",
                                        totalScore: v.TotalScore,
                                        optionAnswer: subval.questionType == 7 ? JSON.parse(subval.answer) : '',
                                        contentImgHtml: contentImgHtml,
                                        queTypeName: v.queTypeName
                                    });
                                }

                            });

                        });
                    }

                    $("#nowindex").text(_this.start + 1.0);
                    $("#total").text(_this.momentList.length);
                    $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0) }));

                }
                $('i.currentNUM').text("1");
                $('i.totalNUM').text(_this.momentList.length);
                $('#mask').addClass('hide');
            });
            return this;
        },
        /**
         * 获取草稿
         * return this
         */
        getDraft: function() {
            var _this = this;
            $http.post(app.studentAPI.Homework.getStuHomeworkPreview, {
                courseOpenId: _this.courseOpenId,
                openClassId: _this.openClassId,
                homeWorkId: _this.homeWorkId,
                homeworkStuId: _this.homeworkStuId,
                stuId: _this.stuId
            }, function(r) {
                if (r.code > 0) {
                    _this.uniqueId = r.data.uniqueId;
                    _this.paperStructUnique = r.data.paperStructUnique;
                    var message = { "method": "setID", "paperStructUnique": _this.paperStructUnique, "uniqueId": _this.uniqueId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    var checked = r.data.isDisplayAnswer == 1 ? true : false,
                        numtostr = ["一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];

                    if (r.data.ztWay == 2 || r.data.ztWay == 4) {
                        $.each(r.data.questions, function(i, v) {
                            if (v.dataJson == "") {
                                v.dataJson = null;
                            }
                            if (v.questionType == 3) {
                                v.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                            }


                            if (v.questionType == 8 || v.questionType == 9 || v.questionType == 11) {
                                $.each(v.subQuestionList, function(childindex, childval) {
                                    if (childval.dataJson === "") {
                                        childval.dataJson = null;
                                    }
                                    var datajson = JSON.parse(childval.dataJson);
                                    v.subQuestionList[childindex].dataJson = datajson;
                                    v.subQuestionList[childindex].userAnswer = v.subQuestionList[childindex].studentAnswer;
                                });
                            }
                            var contentImgHtml = '';
                            if (v.questionType == 10) {
                                if (v.studentAnswer) {
                                    var studentAnswer = JSON.parse(v.studentAnswer);
                                    $.each(studentAnswer, function(i, val) {
                                        contentImgHtml += '<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg preview" data-doctype=' + val.DocType + ' data-id=' + val.Id + ' data-md5=' + val.Md5 + '  data-size=' + val.DocSize + '   data-url=' + val.Url + ' src="' + val.thumbnail + '"><i class=" iconfont delimg icon-close"></i></div>';
                                    });
                                }
                                if (v.studentAnswer && JSON.parse(v.studentAnswer).length > 8) {
                                    contentImgHtml += '<div class="add-pic mui-hidden"><i class="mui-icon iconfont icon-add" style="font-size: 55px;color: rgba(196, 196, 196, 0.86);padding-left: 4px;"></i> </div>';
                                } else {
                                    contentImgHtml += '<div class="add-pic"><i class="mui-icon iconfont icon-add" style="font-size: 55px;color: rgba(196, 196, 196, 0.86);padding-left: 4px;"></i> </div>';
                                }

                            }
                            if (v.questionType < 12) {
                                _this.momentList.push({
                                    id: v.questionId,
                                    paperStuQuestionId: v.paperStuQuestionId,
                                    fullScore: v.questionScore,
                                    title: v.title,
                                    getScore: v.getScore,
                                    checked: checked,
                                    content: v.questionType > 7 ? v.subQuestionList : JSON.parse(v.dataJson == '' ? null : v.dataJson),
                                    answer: v.answer,
                                    commentary: v.commentary,
                                    type: v.questionType,
                                    isRight: v.isRight,
                                    userAnswer: v.studentAnswer,
                                    analysis: v.resultAnalysis,
                                    optionAnswer: v.questionType == 7 ? JSON.parse(v.answer) : '',
                                    contentImgHtml: contentImgHtml,
                                    queTypeName: v.queTypeName
                                });
                            }
                        });
                    } else {
                        $.each(r.data.questions, function(i, v) {
                            $.each(v.SubQuestions, function(subindex, subval) {
                                if (subval.questionType == 8 || subval.questionType == 9 || subval.questionType == 11) {
                                    $.each(subval.subQuestionList, function(childindex, childval) {
                                        if (childval.dataJson === "") {
                                            childval.dataJson = null;
                                        }
                                        var datajson = JSON.parse(childval.dataJson);
                                        subval.subQuestionList[childindex].dataJson = datajson;
                                        subval.subQuestionList[childindex].userAnswer = subval.subQuestionList[childindex].studentAnswer;
                                    });
                                }
                                var contentImgHtml = '';
                                if (subval.questionType == 10) {
                                    if (subval.studentAnswer) {
                                        var studentAnswer = JSON.parse(subval.studentAnswer);
                                        $.each(studentAnswer, function(i, val) {
                                            contentImgHtml += '<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg preview" data-doctype=' + val.DocType + ' data-id=' + val.Id + ' data-md5=' + val.Md5 + '  data-size=' + val.DocSize + '   data-url=' + val.Url + ' src="' + val.thumbnail + '"><i class=" iconfont delimg icon-close"></i></div>';
                                        });
                                    }
                                    contentImgHtml += '<div class="add-pic"><i class="mui-icon iconfont icon-add" style="font-size: 55px;color: rgba(196, 196, 196, 0.86);padding-left: 4px;"></i> </div>';
                                }
                                if (subval.dataJson == "") {
                                    subval.dataJson = null;
                                }
                                if (subval.questionType == 3) {
                                    subval.dataJson = '[{ "SortOrder": "错误", "Content": "错误", "IsAnswer": "" }, { "SortOrder": "正确", "Content": "正确", "IsAnswer": "" }]';
                                }

                                if (subval.questionType < 12) {
                                    _this.momentList.push({
                                        id: subval.questionId,
                                        paperStuQuestionId: subval.paperStuQuestionId,
                                        fullScore: subval.questionScore,
                                        answer: subval.answer,
                                        title: subval.title,
                                        getScore: subval.getScore,
                                        content: subval.questionType > 7 ? subval.subQuestionList : JSON.parse(subval.dataJson == '' ? null : subval.dataJson),
                                        type: subval.questionType,
                                        checked: checked,
                                        commentary: subval.commentary,
                                        userAnswer: subval.studentAnswer,
                                        ztWay: 2,
                                        analysis: subval.resultAnalysis,
                                        bigQuestionTitle: subindex == 0 ? numtostr[i] + "." + v.Title : "",
                                        totalScore: v.TotalScore,
                                        optionAnswer: subval.questionType == 7 ? JSON.parse(subval.answer) : '',
                                        contentImgHtml: contentImgHtml,
                                        queTypeName: subval.queTypeName
                                    });
                                }

                            });
                        });
                    }

                    $("#nowindex").text(_this.start + 1.0);
                    $("#total").text(_this.momentList.length);
                    $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0) }));


                }
                $('i.currentNUM').text("1");
                $('i.totalNUM').text(_this.momentList.length);
                $('#mask').addClass('hide');
            });


            return this;
        },

        send: function(isDraft) {
            var _this = this;
            var message = { "method": "complete", "paperStructUnique": _this.paperStructUnique, "uniqueId": _this.uniqueId, "isDraft": String(isDraft) };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**单题提交 */
        submit: function(data, isDraft, index) {
            var _this = this;
            if (data.type == 10) {
                var $elem = $('img.uploaded-pic'),
                    imgarr = [];
                $.each($elem, function(i, v) {
                    imgarr.push({ DocType: $(v).data('doctype'), Url: $(v).data('url'), Md5: $(v).data('md5'), DocSize: $(v).data('size'), DocTitle: "iosjpg" });
                });
                data.userAnswer = JSON.stringify(imgarr);
                _this.momentList[_this.start].contentImgHtml = $('.pic-info').html()
            }
            if (data.type == 8 || data.type == 9 || data.type == 11) {
                data.paperStuSubQuestionId = data.content[Number(index)].paperStuSubQuestionId;
                data.subQuestionId = data.content[Number(index)].subQuestionId;
                data.userAnswer = data.content[Number(index)].userAnswer;
                data.fullScore = data.content[Number(index)].subQuestionScore;
            }

            if (!data.userAnswer) {
                data.userAnswer = "";
            }
            var params = {
                paperStuQuestionId: data.paperStuQuestionId,
                questionType: data.type,
                stuAnswer: data.userAnswer,
                md5: '',
                paperStuSubQuestionId: data.paperStuSubQuestionId ? data.paperStuSubQuestionId : '', //阅读理解 完形 试听
                subQuestionId: data.subQuestionId ? data.subQuestionId : '', //阅读理解 完形 试听
                subQuestionScore: data.fullScore ? data.fullScore : '',
                sourceType: 3,
                homeworkId: _this.homeWorkId
            };

            // 发送数据
            $http.post(app.studentAPI.Homework.stuSaveHomeworkQuestion, { data: JSON.stringify(params) }, function(r) {
                if (r.code == 1) {
                    if (isDraft != 2) {
                        _this.send(isDraft)
                    }
                }
            });
        },
        //文件作答题 点上一题提交
        submitWenjian: function(isDraft) {
            var _this = this;

            var $elem = $('img.uploaded-pic'),
                imgarr = [];
            $.each($elem, function(i, v) {
                imgarr.push({ DocType: $(v).data('doctype'), Url: $(v).data('url'), Md5: $(v).data('md5'), DocSize: $(v).data('size'), DocTitle: "iosjpg" });
            });
            if (_this.momentList[_this.start].userAnswer != JSON.stringify(imgarr)) {
                _this.momentList[_this.start].userAnswer = JSON.stringify(imgarr);
                _this.momentList[_this.start].contentImgHtml = $('.pic-info').html()
                _this.submit(_this.momentList[_this.start], isDraft)
            } else if (isDraft != 2) {
                _this.send(isDraft)
            }

        },

        /**
         * 上传图片
         * @return {this}
         */
        uploadImg: function(t) {

            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeImg" width="70" height="70" data-doctype="jpg" data-url=' + t.url + ' data-md5=' + t.md5 + ' data-size=' + t.size + ' src="' + t.ossOriUrl + '"><i class="delimg iconfont icon-close"></i></div>');

            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 8) {
                    $(".add-pic").addClass('mui-hidden')
                }
            }, 100);
        },
        /**
         * 上传视频
         * @return {this}
         */
        uploadvideo: function(t) {

            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic seeVideo" width="70" height="70" data-doctype="mp4" data-url=' + t.url + ' data-md5=' + t.md5 + ' data-size=' + t.size + ' src="../../../img/video.jpg"><i class="delimg iconfont icon-close"></i></div>');

            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 8) {
                    $(".add-pic").addClass('mui-hidden')
                }
            }, 100);
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this,
                DOM = $('#questioninfo');

            var $scroll = $M('.mui-scroll-wrapper').scroll();

            DOM.on('singleTap', 'img', function() {
                var $elem = $(this),
                    id = $elem.data('id'),
                    url = $elem.attr('src');
                if ($elem.hasClass('preview') && id) {
                    _this.isPushed = true;
                    var message = { "method": "getUrlById", "Id": id };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else if ($elem.hasClass('questionIndex')) {
                    return;
                } else {
                    if (url) {
                        _this.isPushed = true;
                        var message = { "method": "getFileInfoByUrl", "url": $elem.data('url') };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    }

                }
            });
            DOM.on('singleTap', 'ol>li', function(e) {
                var $elem = $(this).find('.option-li'),
                    $elemyue = $(this).find('.yue-option-li');

                var type = Number($elem.data('type'));

                if (e.srcElement.tagName == "IMG" && $(e.target).attr('src')) {
                    if (!_this.isPushed) {
                        var message = { "method": "previewImg", "url": $(e.target).attr('src') };
                        window.webkit.messageHandlers.interOp.postMessage(message);
                    } else {
                        isPushed = false;
                    }
                } else if ($elemyue.length > 0) {
                    var typey = Number($elemyue.data('type'));
                    switch (typey) {
                        case 2:
                            _this.yueDuo($elemyue);
                            break;
                        default:
                            _this.yueDan($elemyue);
                            break;
                    }
                } else {
                    switch (type) {
                        case 2:
                            _this.duox($elem);
                            break;

                        default:
                            _this.danx($elem);
                            break;
                    }
                }
            });

            //删除图片
            DOM.on('singleTap', '.delimg', function() {
                var $elem = $(this);
                $elem.parent().remove();
                $('.add-pic').removeClass('mui-hidden');
                $('.add-pic').show();
            });

            $('#down-question').on('singleTap', function(e) {
                var type = _this.momentList[_this.start].type;

                if (_this.start == _this.momentList.length - 1) {
                    var message = { "method": "showMsg", "msg": "已经是最后一题" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }

                switch (type) {
                    case 4, 5:
                        _this.tianKongDone(2);
                        break;
                    case 6:
                        _this.wendaDone(2);
                        break;
                    case 7:
                        _this.pipeiDone(2);
                        break;
                    case 10:
                        _this.submitWenjian(2)
                        break;
                    default:
                        break;
                }
                _this.start += 1.0;

                $("#nowindex").text(_this.start + 1.0);

                DOM.html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0) }));
                $('i.currentNUM').text(_this.start + 1.0);
                $('i.totalNUM').text(_this.momentList.length);
                $scroll.scrollTo(0, 0);
            });

            $('#done-question').on('singleTap', function() {
                var type = _this.momentList[_this.start].type;
                switch (type) {
                    case 4, 5:
                        _this.tianKongDone(0);
                        break;
                    case 6:
                        _this.wendaDone(0);
                        break;
                    case 7:
                        _this.pipeiDone(0);
                        break;
                    case 10:
                        _this.submitWenjian(0)
                        break;
                    default:
                        _this.send(0)
                }

            })
            $("#save-question").on('singleTap', function() {
                var type = _this.momentList[_this.start].type;
                switch (type) {
                    case 4, 5:
                        _this.tianKongDone(1);
                        break;
                    case 6:
                        _this.wendaDone(1);
                        break;
                    case 7:
                        _this.pipeiDone(1);
                        break;
                    case 10:
                        _this.submitWenjian(1)
                        break;
                    default:
                        _this.send(1)
                }
            });
            $('#up-question').on('singleTap', function(e) {
                var type = _this.momentList[_this.start].type;
                if (_this.start == 0) {
                    var message = { "method": "showMsg", "msg": "已经是第一题" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                    return;
                }

                switch (type) {
                    case 4, 5:
                        _this.tianKongDone(2);
                        break;
                    case 6:
                        _this.wendaDone(2);
                        break;
                    case 7:
                        _this.pipeiDone(2);
                        break;
                    case 10:
                        _this.submitWenjian(2)
                        break;
                    default:
                        break;
                }

                _this.start -= 1.0;
                $("#nowindex").text(_this.start + 1.0);

                $('#questioninfo').html(template(_this.templ[_this.momentList[_this.start].type], { question: _this.momentList[_this.start], index: (_this.start + 1.0) }));
                $('i.currentNUM').text(_this.start + 1.0);
                $('i.totalNUM').text(_this.momentList.length);

                $scroll.scrollTo(0, 0);
            });


            DOM.on('singleTap', 'a', function(e) {
                var $elem = $(this);
                if ($elem.data('url')) {
                    _this.isPushed = true;
                    var message = { "method": "getFileInfoByUrl", "url": $elem.data('url') };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
            });
            // 回答问答题时添加图片
            DOM.on('singleTap', '.add-pic', function(e) {
                e.preventDefault();

                _this.parentelem = e.target.parentElement.parentElement.previousElementSibling;
                var message = { "method": "uploadImg" };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });


            return this;
        },
        /**
         * 填空题处理
         */
        tianKongDone: function(isDraft) {
            var _this = this;
            var $elem = $('.TKAswerList'),
                arranswer = [];
            $.each($elem, function(i, v) {
                arranswer.push({ SortOrder: i, Content: $(v).val() });
            });
            if (_this.momentList[_this.start].userAnswer != JSON.stringify(arranswer)) {
                _this.momentList[_this.start].userAnswer = JSON.stringify(arranswer);
                _this.submit(_this.momentList[_this.start], isDraft)
            } else if (isDraft != 2) {
                _this.send(isDraft)
            }
            return this;
        },
        /**
         * 问答题处理
         */
        wendaDone: function(isDraft) {
            var _this = this;
            var $elem = $('.contentEditable');
            // _this.momentList[_this.start].contentImgHtml = $('.pic-info').html()
            if (_this.momentList[_this.start].userAnswer != $elem.text()) {
                _this.momentList[_this.start].userAnswer = $elem.text();
                _this.submit(_this.momentList[_this.start], isDraft)
            } else if (isDraft != 2) {
                _this.send(isDraft)
            }
            return this;
        },
        /**
         * 问答题处理
         */
        pipeiDone: function(isDraft) {
            var _this = this;
            var $elem = $('.select-panduan'),
                arranswer = [];
            $.each($elem, function(i, v) {
                arranswer.push($(v).val());
            });
            if (_this.momentList[_this.start].userAnswer != arranswer.join()) {
                _this.momentList[_this.start].userAnswer = arranswer.join();
                _this.submit(_this.momentList[_this.start], isDraft)
            } else if (isDraft != 2) {
                _this.send(isDraft)
            }
            return this;
        },
        /**
         * 单选处理
         */
        danx: function($elem) {
            var _this = this,
                answer = $elem.data('answer');
            $elem.parent().addClass('right').siblings().removeClass('right');
            if (_this.momentList[_this.start].userAnswer == String(answer)) {
                return;
            }
            _this.momentList[_this.start].userAnswer = String(answer);
            _this.submit(_this.momentList[_this.start], 2)
            return this;

            return this;
        },
        /**
         * 多选
         */
        duox: function($elem) {
            var _this = this,
                answer = String($elem.data('answer')),
                userAnswer = _this.momentList[_this.start].userAnswer,
                select = userAnswer ? String(userAnswer).split(',') : [],
                index = $.inArray(String(answer), select);
            index > -1 ?
                (select.splice(index, 1)) :
                (select.push(answer));
            index > -1 ?
                ($elem.parent().removeClass('right')) :
                ($elem.parent().addClass('right'));
            select.sort();
            if (_this.momentList[_this.start].userAnswer == select.join()) {
                return;
            }
            _this.momentList[_this.start].userAnswer = select.join();
            _this.submit(_this.momentList[_this.start], 2)
            return this;
        },
        /**
         * 阅读理解单选
         */
        yueDan: function($elem) {
            var _this = this,
                answer = $elem.data('answer'),
                index = $elem.data('index');
            $elem.parent().addClass('right').siblings().removeClass('right');

            if (_this.momentList[_this.start].userAnswer == String(answer)) {
                return;
            }
            _this.momentList[_this.start].content[Number(index)].userAnswer = String(answer);
            _this.submit(_this.momentList[_this.start], 2, index);
            return this;
        },
        /**
         * 阅读理解单选
         */
        yueDuo: function($elem) {
            var _this = this,
                answer = $elem.data('answer'),
                i = $elem.data('index'),
                userAnswer = _this.momentList[_this.start].content[Number(i)].userAnswer,
                select = userAnswer ? String(userAnswer).split(',') : [],
                index = $.inArray(String(answer), select);
            index > -1 ?
                (select.splice(index, 1)) :
                (select.push(answer));
            index > -1 ?
                ($elem.parent().removeClass('right')) :
                ($elem.parent().addClass('right'));
            select.sort();
            _this.momentList[_this.start].content[Number(i)].userAnswer = select.join();
            _this.submit(_this.momentList[_this.start], 2, i);
            return this;
        },
        helper: function() {

            var _this = this;
            //对字符串进行编码
            template.config('escape', false);
            //替换img标签
            template.helper('questionType', function(i) {
                var type = ['', '单选题', '多选题', '判断题', '填空题', '填空题', '问答题', '匹配题', '阅读理解', '完形填空', '文件作答题', '视听题'];
                return type[Number(i)];
            });
            template.helper('itoCharAB', function(i) {
                var letter = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'];
                return letter[Number(i)];
            });

            // 匹配题处理
            template.helper('contentPipeiSelect', function(i, index, val) {
                if (val === "") {
                    return false;
                }
                var array_userAnswer = String(val).split(',');
                if (String(i) === array_userAnswer[index]) {
                    return true
                } else {
                    false;
                }

            });
            // 文件作答题图片处理
            template.helper('wendaAnswerImg', function(val) {

                var dataUser = val.split(','),
                    $image = '';
                $.each(dataUser, function(i, v) {
                    $image += '<img class="delimg" src="' + v + '">';
                });
                return $image
            });
            //选择题处理
            template.helper('isselected', function(i, userAnswer) {
                if (userAnswer === "") {
                    return '';
                }
                var array_userAnswer = String(userAnswer).split(',');
                if ($.inArray(String(i), array_userAnswer) > -1) {
                    return 'right';
                } else {
                    return "";
                }

            });
            //填空题答案处理
            template.helper('TKAswer', function(i, userAnswer) {
                try {
                    var array_userAnswer = JSON.parse(userAnswer)
                    return array_userAnswer[i]["Content"]
                } catch (error) {
                    return ""
                }
            });
            return this;
        },
        setTime: function() {
            var _this = this;
            setInterval(function() {
                _this.time_s = _this.time_s + 1.0;
                var s = _this.time_s % 60,
                    ss = parseInt(_this.time_s / 60);
                $('#timeNum').text(ss + ':' + s);
                // if (_this.time_s > (_this.time - 600)) {
                //     $('#timeNum').css("color", "red");
                // }
            }, 1000);
            return this;
        },

        getparameter: function(courseOpenId, openClassId, homeWorkId, homeworkTermTimeId, stuId, homeworkStuId) {
            var _this = this;
            _this.courseOpenId = courseOpenId;
            _this.openClassId = openClassId;
            _this.homeWorkId = homeWorkId ? homeWorkId : "";
            _this.homeworkTermTimeId = homeworkTermTimeId;
            _this.stuId = stuId;
            _this.homeworkStuId = homeworkStuId
            if (_this.homeworkStuId) {
                _this.helper().getDraft().events().setTime();
            } else {
                _this.helper().get().events().setTime();
            }
            return this
        },
        load: function() {
            var _this = this;
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this
        },
        /**
         * 载入 
         * @return {null}
         */
        init: function() {
            var _this = this;
            this.paperStructUnique = "";
            this.openClassId = "";
            this.homeworkStuId = "";
            this.courseOpenId = "";
            this.homeWorkId = "";
            this.homeworkTermTimeId = "";
            this.stuId = "";
            this.uniqueId = '';
            this.time_s = 0.0;
            this.time = 7200;
            this.paperStructUnique = '';
            this.md5 = [];
            this.templ = ['question-danx-duox-pand', 'question-danx-duox-pand', 'question-danx-duox-pand', 'question-danx-duox-pand', 'question-tiankong', 'question-tiankong', 'question-wenda', 'question-pipei', 'question-yuedu', 'question-yuedu', 'question-wenjian', 'question-yuedu'];
            this.parentelem = '';
            //上传地址 与 拼接地址
            this.uploadUrl = "";
            this.prefixUrl = "";
            //全部题目与已做题目
            // this.totalquestionlist = [];
            // this.handledquestionlist = [];
            //临时容器
            this.momentList = [];
            this.start = 0;
            this.isPushed = false;
            this.isSend = false;
            this.resorceHomework = 1;
            this.load()


            return this;
        }
    };


    assignmenthandle.init();
    window.assignmenthandle = assignmenthandle

}(mui, Zepto));