/**
 * 小组任务
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @return {Object}
 */
(function($M, $) {

    var grouphandle = {

        get: function(r) {
            var _this = this;

            if (r.code == 1) {
                $('.mui-title').text(r.data.title);
                $('.storm_title').text(r.data.content);
                $('#content').html(r.data.stuAnswerContent);
                $('#stormContent').html(template('attachmentList', { list: r.data.questions }));
                $('.pic-info').html(template('imglist', { list: r.data.stuAnswerDocJson, stuAnswerPreviewUrl: r.data.stuAnswerPreviewUrl }));
            }

            return this;
        },

        /**
         * @return {this}
         */
        send: function() {
            var _this = this,
                content = $('.content').text(),
                list = $("div.pic-info").find('img'),
                arr = [];
            $.each(list, function(i, v) {
                arr.push({
                    docTitle: "学生答案",
                    docSize: $(v).data('size'),
                    docUrl: $(v).data('url'),
                    Md5: $(v).data('md5'),
                    docType: $(v).data("type")
                });
            });

            var message = { "method": "send", "content": content, stuAnswerDocJson: JSON.stringify(arr) };
            window.webkit.messageHandlers.interOp.postMessage(message);

            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        events: function() {
            var _this = this;

            $M('.mui-scroll-wrapper').scroll();


            $("#stormContent").on('singleTap', 'a', function() {
                var $elem = $(this),
                    id = $elem.data('id');
                var message = { "method": "getUrlById", "Id": id };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //上传图片
            $('.pic-info').on('singleTap', '.add-pic', function(e) {
                e.preventDefault();
                var message = { "method": "uploadImg" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            //del
            $('.pic-info').on('singleTap', '.delimg', function() {
                var $elem = $(this);
                $elem.parent().remove();
                $('.add-pic').removeClass('mui-hidden');

            });

            $('.pic-info').on('singleTap', 'img', function() {
                var $elem = $(this);

                if (!$elem.complete || typeof $elem.naturalWidth == "undefined" || $elem.naturalWidth == 0 || $elem.hasClass('video')) {
                    var url = $elem.data('url');
                    var message = { "method": "getUrlByUrl", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    var url = $elem.attr('src');

                    var message = { "method": "previewImg", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });
            return this;
        },



        /**
         * 上传图片
         * @return {this}
         */
        uploadImg: function(t) {
            var _this = this;

            $(".pic-info .add-pic").before('<div style="display: inline-block; position: relative;"><img class="uploaded-pic" width="70" height="70"  data-type = "jpg" data-md5=' + t.md5 + '  data-size=' + t.size + '   data-url=' + t.url + ' src="' + t.ossOriUrl + '"><i class=" iconfont icon-close delimg"></i></div>');

            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").addClass('mui-hidden');
                }
            }, 100);

            return this;
        },
        //上传视频
        uploadvideo: function(file) {
            var _this = this;

            $(".pic-info .add-pic").before('<div  style="display: inline-block; position: relative;"><img class="uploaded-pic  video" width="70" height="70" data-type = "mp4" data-md5=' + file.md5 + ' data-size=' + file.size + ' data-url=' + file.url + ' src="../../../img/video.jpg"><i class="iconfont delimg icon-close"></i></div>');
            setTimeout(function() {
                var list = $(".pic-info").find('img');
                if (list.length > 5) {
                    $(".add-pic").removeClass("mui-hidden")
                }
            }, 100);

            return this;
        },
        helper: function() {
            template.helper('jsontostr', function(v) {

                return JSON.stringify(v);
            });
            template.helper('imgSrcSplicing', function(url, src) {
                return url.substr(0, url.indexOf('?')) + src;
            });

            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            var _this = this;

            this.helper().load().events();

            return this;
        }
    };


    grouphandle.init();

    window.grouphandle = grouphandle;
}(mui, Zepto));