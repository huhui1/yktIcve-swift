/**
 * @name     MPreview.mobile.js
 * @desc     移动端图片预览插件，支持手势缩放，双击放大，缩小
 * @depend   QuoJS
 * @author   M.J
 * @date     2015-07-12
 * @URL      http://webjyh.com
 * @reutn    {MPreview}
 * @version  1.0.0
 * @license  MIT
 *
 * @PS If you have any questions, please don't look for me, I don't know anything. thank you.
 */
(function(win, $) {

    "use strict";

    var transition,
        scaleReg = /scale(?:3d)?\(([^\)]+)\)/,
        translateReg = /translate(?:3d)?\(([^\)]+)\)/,
        config = {
            url: null,
            data: null,
            title: '【浏览】',
            params: {},
            wrap: 'body',
            direction: 'top',
            placeholder: 'images/placeholder.gif',
            init: null,
            close: null,
            category: ''
        },
        innerHTML =
        '<div class="ui-MPreview-wrap">' +
        '   <div class="ui-MPreview-row">' +
        '       <div class="ui-MPreview-toolbar">' +
        '            <div class="ui-MPreview-back"><a href="javascript:;"><i class="iconfont icon-arrow-left"></i></a></div>' +
        '            <div class="ui-MPreview-title">{{title}}</div>' +
        '            <div class="ui-MPreview-pages"><span class="ui-MPreview-currentPage">00</span>/<span class="ui-MPreview-countPage">00</span></div>' +
        '        </div>' +
        '        <div class="ui-MPreview-view">' +
        '            <div class="ui-MPreview-imgbox">' +
        '                <ul class="ui-MPreview-imglist"></ul>' +
        '            </div>' +
        '			 <div class="ui-MPreview-arrowLeft"><i class="iconfont icon-arrow-left"></i></div>' +
        '            <div class="ui-MPreview-arrowRight"><i class="iconfont icon-arrow-right"></i></div>' +
        '            <div class="ui-MPreview-loading"></div>' +
        '        </div>' +
        '   </div>' +
        '</div>';

    /**
     * @name      将默认配置和选项合并
     * @param     options     {Object}     默认用户的参数
     * @return    {Object}
     */
    var cover = function(options, defaults) {
        var i, options = options || {};
        for (i in defaults) {
            if (options[i] === undefined) options[i] = defaults[i];
        }
        return options;
    };

    /**
     * 判断设备支持 transitionend 的前缀
     */
    var whichTransitionEvent = function() {
        var t,
            el = document.createElement('div'),
            transitions = {
                'WebkitTransition': 'webkitTransitionEnd',
                'OTransition': 'oTransitionEnd',
                'MozTransition': 'transitionend',
                'transition': 'transitionend'
            };
        for (t in transitions) {
            if (el.style[t] !== undefined) {
                return transitions[t];
            }
        }
    };

    /**
     * @name      格式化当前页的数字
     * @param     val     {Number}     默认用户的参数
     * @return    {String}
     */
    var formatPage = function(val) {
        return val.toString().length < 2 ? '0' + val : val;
    };

    // 构造函数
    var MPreview = function(options) {
        return new MPreview.fn.init(options);
    };

    MPreview.fn = MPreview.prototype = {
        constructor: MPreview,
        init: function(options) {
            //用户配置项
            transition = whichTransitionEvent();
            this.config = cover(options, config); // 默认配置项
            this.topics = {}; // 存放订阅内容

            //init 载入之前执行的回调
            if (typeof this.config.init == 'function') this.config.init();

            // 载入订阅内容
            this._action();

            // init 组件默认配置
            this.publish('init')
                .publish('ajax')
                .publish('touch')
                .publish('zoom')
                .publish('resize');

            return this;
        },
        /**
         * @name    订阅发布
         * @type    {Function}
         * @parmas  {key}   订阅的名称
         * @params  {val}   订阅的内容
         * @return  this
         */
        subscribe: function(key, val) {
            if (!this.topics[key]) {
                this.topics[key] = [];
            }
            this.topics[key].push(val);
            return this;
        },

        /**
         * @name    退订发布
         * @type    {Function}
         * @params  {key}    要退订的名称
         * @return  this
         */
        unsubscribe: function(key) {
            if (this.topics[key]) {
                delete this.topics[key];
            }
            return this;
        },

        /**
         * @name    发布订阅的
         * @type    {Function}
         * @return  this
         */
        publish: function(key) {
            if (!this.topics[key]) {
                return false;
            }

            var subscribers = this.topics[key],
                len = subscribers ? subscribers.length : 0,
                args = [].slice.call(arguments);

            args.shift();
            for (var i = 0; i < len; i++) {
                subscribers[i].apply(this, args);
            }

            return this;
        },

        /**
         * 获取当前元素 CSS3 属性值
         * @param {Object} elem
         * @param {Object} name
         */
        getTransform: function(e, name) {
            e = $(e);

            var val = e.css("transform") || e.css("-webkit-transform"),
                has = val === 'none',
                arr, x, y, reg;

            if (name === 'translate') {
                reg = translateReg;
                if (has || val.indexOf(name) == -1) {
                    has = true;
                    x = y = 0;
                }
            } else if (name === "scale") {
                reg = scaleReg;
                if (has || val.indexOf(name) == -1) {
                    has = true;
                    x = y = 1;
                }
            }

            if (!has) {
                arr = val.match(reg);
                arr = arr[1].split(',');
                x = parseFloat(arr[0]);
                y = parseFloat(arr[1]);
            }

            return {
                x: x,
                y: y
            };
        },

        /**
         * @name    图片等比缩放
         * @param   size
         */
        scale: function(size) {
            if (!size.width || !size.height) {
                return { width: '100%', height: '100%' };
            }

            var r, w = size.width,
                h = size.height,
                screenW = parseInt(this.offset.width),
                screenH = parseInt(this.offset.height),
                scrrenScale = screenH / screenW,
                imgScale = h / w;

            //当屏幕的宽高比例 小于 图片的宽高比例时设置图片的宽高
            if (scrrenScale < imgScale) {
                w = parseInt(w * screenH / h);
                h = screenH;
            }

            //当屏幕的宽高比例 大于 图片的宽高比例时设置图片的宽高
            if (scrrenScale > imgScale) {
                h = parseInt(h * screenW / w);
                w = screenW;
            }

            return {
                width: w,
                height: h
            };
        },

        /**
         * @name   求两点之间中间点的坐标
         * @params  {a}  点A的坐标
         * @params  {b}  点B的坐标
         * @return  两点之间的距离
         */
        distance: function(a, b) {
            if (!a || !b) return;
            var x = (a.x + b.x) / 2,
                y = (a.y + b.y) / 2;
            return { x: x, y: y };
        },
        /**
         * @name     获取点阵位置
         * @params   {e}    events 事件对象
         * @params   {val}  缩放比  如果为空采用默认指
         * @return   Boolean || Object
         */
        getOrigin: function(e, val) {
            var touchX = val === undefined ? e.touch.x : this.distance(e.touch.touches[0], e.touch.touches[1]).x, // 点击当前位置X
                touchY = val === undefined ? e.touch.y : this.distance(e.touch.touches[0], e.touch.touches[1]).y, // 点击当前位置Y
                size = {
                    width: val === undefined ? this.size[this.index - 1].width : (parseInt($(e.target).css('width')) * val),
                    height: val === undefined ? this.size[this.index - 1].height : (parseInt($(e.target).css('height')) * val)
                }, // 当前图片原大小
                currentSize = val === undefined ? (this.scale(size)) : ({ width: parseInt($(e.target).css('width')), height: parseInt($(e.target).css('height')) }), // 当前图片现大小
                screen = this.screen,
                scale = val || size.width / currentSize.width, // 最大缩放比
                imgAreaX = (screen.width - currentSize.width) / 2, // 图片与容器之间的留白区左边
                imgAreaY = (screen.height - currentSize.height) / 2, // 图片与容器之间的留白区上边
                originX = touchX - imgAreaX, //点阵位置X
                originY = touchY - imgAreaY, //点阵位置Y
                fix, maxTx, minTx, maxTy, minTy;

            if (size.width <= parseInt(this.offset.width, 10) && size.height <= parseInt(this.offset.height, 10)) {
                return false;
            }

            // 图片的宽是否大于当前屏幕宽
            if (size.width > screen.width) {
                fix = size.width - currentSize.width;
                maxTx = (fix * (originX / currentSize.width) - imgAreaX) / scale;
                minTx = 0 - (fix * ((currentSize.width - originX) / currentSize.width) - imgAreaX) / scale;
                if (maxTx < 0) {
                    maxTx = 0;
                    originX = imgAreaX / fix * currentSize.width;
                    minTx = 0 - (fix * ((currentSize.width - originX) / currentSize.width) - imgAreaX) / scale;
                }
                if (minTx > 0) {
                    minTx = 0;
                    originX = currentSize.width - imgAreaX / fix * currentSize.width;
                    maxTx = (fix * (imgAreaX / currentSize.width)) / scale;
                }
            } else {
                originX = currentSize.width / 2;
            }

            // 图片的高是否大于当前屏幕高
            if (size.height > screen.height) {
                fix = size.height - currentSize.height;
                maxTy = (fix * (originY / currentSize.height) - imgAreaY) / scale;
                minTy = 0 - (fix * ((currentSize.height - originY) / currentSize.height) - imgAreaY) / scale;
                if (maxTy < 0) {
                    maxTy = 0;
                    originY = imgAreaY / fix * currentSize.height;
                    minTy = 0 - (fix * ((currentSize.height - originY) / currentSize.height) - imgAreaY) / scale;
                }
                if (minTy > 0) {
                    minTy = 0;
                    originY = currentSize.height - imgAreaY / fix * currentSize.height;
                    maxTy = (fix * (originY / currentSize.height) - imgAreaY) / scale;
                }
            } else {
                originY = currentSize.height / 2;
            }

            return {
                scale: scale,
                x: originX + 'px',
                y: originY + 'px',
                scope: {
                    maxTx: maxTx,
                    minTx: minTx,
                    maxTy: maxTy,
                    minTy: minTy
                }
            };
        },

        /**
         * @name    关闭销毁程序
         * @return  null;
         */
        destroy: function() {
            var has;
            if (typeof this.config.close == 'function') has = this.config.close();
            if (has === false) return;

            // 清空HTML
            $(this.config.wrap).empty();
            $(this.config.wrap).removeAttr('style');
            $(document).off('touchmove');
            $(window).off(this.resizeType);

        },

        /**
         * @name    配置订阅内容
         * @params  null
         * @return  this
         */
        _action: function() {

            // 设置配置项
            this.subscribe('init', function() {
                var _this = this,
                    css = 'width: 100%; height: 100%; overflow: hidden; background: #000';

                this.data = null; //请求所获取的数据
                this.DOM = null; //当前组件的DOM元素
                this.index = 1; //当前所在第几页
                this.size = {}; //对应的图片大小
                this.isExec = false; //当前动画是否执行完成
                this.touch = null; //存储最近一次Touch的属性
                this.isScroll = false; //标识是否为当前滚动状态
                this.isScale = false; //当前图片是否放大中
                this.isZoom = false; //标识是否是双指滚动中的事件
                this.imgMoveData = null; //图片放大移动时缩放的值
                this.zoomInertia = null; // 双指缩放值以及点阵位置
                this.zoomRecord = 1; // 记录每次缩放后的缩放值，默认为1，
                this.screen = {
                    width: window.innerWidth,
                    height: window.innerHeight
                };
                this.isScaling = false;
                this.resizeType = typeof window.orientation == 'number' ? 'orientationchange' : 'resize'; //支持旋转的事件名
                this.config.direction = this.config.direction == 'left' ? true : false; //滚动方向，true 横屏幕滚动，false 竖屏滚动

                $(_this.config.wrap)[0].style.cssText = css;
                $(document).on('touchmove', function(e) { e.preventDefault(); });
            });

            // 创建DOM
            this.subscribe('init', function() {
                var elems, DOM = {},
                    html = innerHTML.replace('{{title}}', this.config.title),
                    elem = $(this.config.wrap),
                    screen = this.screen;

                elem.html(html);

                if (this.config.category == 'discuss_storm') elem.find('.ui-MPreview-discuss').addClass('mui-hidden');

                elems = elem.find('*');
                elems.each(function(i, v) {
                    if (v.className.indexOf('ui-MPreview-') > -1) {
                        var key = v.className.replace('ui-MPreview-', '');
                        DOM[key] = $(v);
                    }
                });

                var h = parseInt(DOM.toolbar.style('height'), 10);
                DOM.wrap.style('width', screen.width + 'px');
                DOM.wrap.style('height', screen.height + 'px');
                DOM.view.style('height', (screen.height - h) + 'px');
                DOM.view.style('top', h + 'px');

                // 当前容器宽高
                this.offset = {
                    width: DOM.view.style('width'),
                    height: DOM.view.style('height')
                };
                this.DOM = DOM;
            });

            // 绑定返回事件
            this.subscribe('init', function() {
                var _this = this;
                this.DOM.back.on('touch', function(e) {
                    e.preventDefault();
                    _this.destroy();
                });
            });

            // 加载图片，并对应设置Key
            this.subscribe('load', function(val, key, callback) {
                var _this = this,
                    load = function(size) {
                        if (!_this.size[key]) _this.size[key] = size;
                        callback && callback.call(_this, size, key);
                        setTimeout(function() {
                            _this.DOM.loading.addClass('ui-MPreview-hide');
                        }, 100);
                    };
                $.each(val, function(i, v) {
                    _this.DOM.loading.removeClass('ui-MPreview-hide');
                    var img = new Image();
                    img.src = v;
                    if (img.complete) {
                        load({ width: img.width, height: img.height });
                    } else {
                        img.onload = function() {
                            load({ width: img.width, height: img.height });
                            img.onload = null;
                        };
                    }
                });
            });

            // Ajax 请求
            this.subscribe('ajax', function() {
                if (!this.config.data && !this.config.url) return;

                var _this = this,
                    callback = function(data) {
                        this.data = data.imgs;
                        this.publish('load', [data.imgs[0]], 0, function(size, key) {
                            this.publish('append', size, key)
                                .publish('setPage');
                        });
                    };

                // 判断是否为自己添加数据
                if (this.config.data && this.config.data.length) {
                    callback.call(this, { imgs: this.config.data });
                    return;
                }

                // 无自己数据则发送Ajax请求
                $.ajax({
                    url: this.config.url,
                    data: this.config.params,
                    dataType: 'json',
                    success: function(data) {
                        if (data.code > 0 && data.imgs && data.imgs.length) {
                            callback.call(_this, data);
                        }
                    },
                    error: function() {
                        alert('获取数据失败');
                    }
                });
            });

            // 创建数据DOM
            this.subscribe('append', function(size, key) {
                var temp = '',
                    DOM = this.DOM,
                    tpl = '<li data-index="{{index}}" style="width: ' + this.offset.width + '; height: ' + this.offset.height + ';"><div><img src="{{src}}" style="width: {{width}}; height: {{height}}; position: absolute; left: {{left}}; top: {{top}}" /></div><canvas width="{{width1}}" height="{{height1}}"></canvas></li>',
                    len = this.data.length > 2 ? 3 : this.data.length;

                size = this.scale(size);

                //替换图片的初始大小（即在当前页面显示的大小）
                this.size[key] = size;

                //for (var i = 0; i < len; i++) {
                var src = this.data[key] ? this.data[key] : this.config.placeholder,
                    w = size.width + 'px',
                    h = size.height + 'px',
                    w1 = size.width,
                    h1 = size.height,
                    top = 0,
                    left = 0;

                if (this.screen.width > size.width) {
                    left = Math.floor((this.screen.width - size.width) / 2);
                }

                if (this.screen.height - 40 > size.height) {
                    top = Math.floor((this.screen.height - 40 - size.height) / 2);
                }

                temp += tpl.replace('{{index}}', key)
                    .replace('{{src}}', src)
                    .replace('{{width}}', w)
                    .replace('{{height}}', h)
                    .replace('{{width1}}', parseInt(this.offset.width, 10))
                    .replace('{{height1}}', parseInt(this.offset.height, 10))
                    .replace('{{top}}', top + 'px')
                    .replace('{{left}}', left + 'px');

                DOM.imglist.html(temp);
                DOM.imglist.style(this.config.direction ? 'width' : 'height', parseInt(this.offset[this.config.direction ? 'width' : 'height'], 10) * len + 'px');
                DOM.imglist.vendor('transform-origin', '50% 50% 0px');
                DOM.imgbox.addClass('ui-MPreview-show');
                DOM.loading.addClass('ui-MPreview-hide');
            });

            //设置总分页值
            this.subscribe('append', function() {
                this.DOM.countPage.text(formatPage(this.data.length));
            });

            // 显示上一页，下一页按钮
            this.subscribe('append', function() {
                var DOM = this.DOM;
                DOM.arrowLeft.style('display', this.index === 1 ? 'none' : 'block');
                DOM.arrowRight.style('display', this.index === this.data.length ? 'none' : 'block');
            });

            // 设置分页值
            this.subscribe('setPage', function() {
                this.DOM.currentPage.text(formatPage(this.index));
            });

            // 预加载
            this.subscribe('preloading', function(val, callback) {
                var li = document.createElement('li'),
                    _this = this,
                    DOM = this.DOM,
                    index = val == 'next' ? (this.index + 1) : (this.index - 1),
                    append = function(elem, src, key) {
                        _this.publish('load', [src], key, function(size) {
                            size = _this.scale(size);
                            elem.html('<img src="' + src + '" style="width: ' + size.width + 'px; height: ' + size.height + 'px" />');
                            callback && callback();
                        });
                    };

                // 检测是否预加载到达最小值或最大值
                index--;
                li.style.width = _this.offset.width;
                li.style.height = _this.offset.height;

                if (index < 0 || index > (this.data.length - 1)) return;
                if (val == 'prev' && this.index == (this.data.length - 1)) return;

                // 为第一页所预加载只重构 img;
                if (val == 'next' && _this.index < 3) {
                    append($(DOM.imglist.find('li').get(_this.index)), this.data[index], index);
                    return;
                }

                // 图片预加载处理
                li.setAttribute('data-index', index);
                DOM.imglist.find('li')[val == 'next' ? 'first' : 'last']().remove();
                DOM.imglist[val == 'next' ? 'append' : 'prepend'](li);
                append($(li), this.data[index], index);
            });

            // 设置滑动操作
            this.subscribe('touchStyle', function(duration, x, y, timing) {
                var DOM = this.DOM.imglist;
                duration = duration || 0;
                x = x || 0;
                y = y || 0;
                DOM.vendor('transition', '-webkit-transform ' + duration + 'ms ' + timing + ' 0s');
                DOM.vendor('transform', 'translate3d(' + x + 'px, ' + y + 'px, 0px)');
            });

            // 屏幕滚动
            this.subscribe('touch', function() {

                var direction, has,
                    _this = this,
                    w = parseInt(_this.offset.width, 10),
                    h = parseInt(_this.offset.height, 10),
                    DOM = this.DOM,
                    callback = function() {
                        _this.isScroll = false;
                        _this.isExec = false;

                        if (has) {
                            _this.publish('preloading', direction ? 'next' : 'prev');
                            var diff = ((_this.index - 1) * (_this.config.direction ? w : h)) - (_this.config.direction ? w : h),
                                $mark = $('[data-index="' + (_this.index - 1) + '"]'),
                                MARK;

                            if ($mark.length) {
                                if ($mark.find('canvas').length) {
                                    MARK = $mark.find('canvas')[0].mark;
                                }
                            }

                            if (_this.index == 1) diff = 0;
                            if (_this.index == _this.data.length) diff = diff - (_this.config.direction ? w : h);
                            DOM.imglist.style(_this.config.direction ? 'left' : 'top', diff < 0 ? '0px' : diff + 'px');

                            if (MARK) {
                                MARK.setMethod('brush');
                                MARK.setLineWidth(_this.penStyle.line);
                                MARK.setColor(_this.penStyle.color);

                                var $elem = $('#pen'),
                                    $panel = $('#panel-wrap'),
                                    $list = $('.rollback > ul > li > a');

                                $list.removeClass('current');
                                $elem.addClass('current');
                                $('#class-list-type').removeClass('show');
                                $('#class-add-list').removeClass('current');

                                _this.penStyle.type = 'pen';
                                $('#cancel')[MARK.historyStroker.length ? 'removeClass' : 'addClass']('disabled');
                            }
                        }
                    };

                var action = function(e, val) {
                    e.preventDefault();

                    //隐藏上一张图片 显示加载框
                    DOM.imgbox.removeClass('ui-MPreview-show')
                    DOM.loading.removeClass('ui-MPreview-hide');

                    if (val) {
                        if (_this.index === _this.data.length) return;
                    } else {
                        if ((_this.index - 1) === 0) return;
                    }

                    _this.isScale = false;
                    has = true;

                    if (val) {
                        direction = true;
                        _this.index++
                    } else {
                        direction = false;
                        _this.index--;
                    }

                    if (_this.index > _this.data.length) _this.index = _this.data.length;
                    if (_this.index < 1) _this.index = 1;

                    _this.publish('load', [_this.data[_this.index - 1]], _this.index - 1, function(size, key) {
                        _this.publish('append', size, key).publish('setPage');
                    });

                    // 下一页，下一页按钮隐藏
                    DOM.arrowLeft.style('display', _this.index === 1 ? 'none' : 'block');
                    DOM.arrowRight.style('display', _this.index === _this.data.length ? 'none' : 'block');

                    // 上一页下一页操作
                    _this.config.page && _this.config.page.apply(_this, [_this.index]);

                    // 处理已放大图片恢复默认
                    var $elem = DOM.imglist.find('img');
                    $elem.vendor('transform-origin', '50% 50% 0px');
                    $elem.vendor('transition', '-webkit-transform 0ms ease-out 0s');
                    $elem.vendor('transform', 'scale3d(1, 1, 1)');
                };

                // 上一页按钮，
                DOM.arrowLeft.off('touchend').on('touchend', function(e) {
                    var $ele = $(this);
                    $ele.css('background-color', '#4D5757');

                    setTimeout(function() {
                        action(e, false);
                        $ele.css('background-color', '#808886');
                    }, 100);
                });

                //下一页按钮
                DOM.arrowRight.off('touchend').on('touchend', function(e) {
                    var $ele = $(this);
                    $ele.css('background-color', '#4D5757');

                    setTimeout(function() {
                        action(e, true);
                        $ele.css('background-color', '#808886');
                    }, 100);
                });
            });

            // 卸载图片滚动
            this.subscribe('untouch', function() {
                var DOM = this.DOM;
                DOM.imgbox.off('touchstart');
                DOM.imgbox.off('touchmove');
                DOM.imgbox.off('touchend');
                DOM.imgbox.off(transition);
            });

            // 图片放大事件
            this.subscribe('zoom', function() {
                var DOM = this.DOM,
                    _this = this;

                // 缩放 缩小结束
                DOM.imglist.on('pinchIn', 'li', function(e) {
                    var $li = $('[data-index="' + (_this.index - 1) + '"]'),
                        $img = $li.find('img'),
                        $div = $li.find('div');

                    e.preventDefault();

                    if (_this.isScroll) return;

                    _this.zoomRecord = _this.zoomRecordTemp;
                    _this.isScaling = false;
                });

                // 缩放中
                DOM.imglist.on('pinching', 'li', function(e) {
                    e.preventDefault();
                    if (_this.isScroll) return;
                    _this.publish('zoomInertia', e);
                });

                //缩放放大结束
                DOM.imglist.on('pinchOut', 'li', function(e) {
                    var $li = $('[data-index="' + (_this.index - 1) + '"]'),
                        $img = $li.find('img'),
                        $div = $li.find('div');

                    e.preventDefault();

                    if (_this.isScroll) return;

                    _this.zoomRecord = _this.zoomRecordTemp;
                    _this.isScaling = false;
                });

                //判断是否完成缩放结束，即两手指离开屏幕
                DOM.imglist.on('touchend', 'img', function(e) {
                    if (!e.touches.length && !_this.isScale && _this.isZoom) {
                        _this.isZoom = false;
                        _this.isExec = false;
                        // 修正因直接绑定而导致重复触发 touchend 事件
                        setTimeout(function() {
                            _this.publish('touch');
                        }, 10);
                    }
                });

            });

            // 图片缩放中
            this.subscribe('zoomInertia', function(e) {
                e.preventDefault();

                var scale, nScale,
                    $elem = $(e.target), //img对象
                    left = 0, //图片的距离顶部的位置
                    top = 0,
                    scaleTopY = 0,
                    scaleLeftX = 0, //图片距离左边缘的位置
                    pointX, pointY, nPointX, nPointY, nMiddlePoint, middlePoint,
                    isMove = false, //是否为平移图片
                    $li = $('[data-index="' + (this.index - 1) + '"]'),
                    $div = $li.find('div');

                if (!this.isScaling) {
                    this.isScaling = true;

                    //缩放之前的图片的left 与 top 值
                    this.scalingLeft = parseInt($div.css('left'), 10) || 0;
                    this.scalingTop = parseInt($div.css('top'), 10) || 0;

                    //图片缩放的起始位置
                    this.startPoints = e.touch.touches;
                }

                //获取两点之间的位置
                var getPointsDistance = function(point1, point2) {
                    var x = point1.x - point2.x;
                    var y = point1.y - point2.y;

                    return Math.sqrt(x * x + y * y);
                };

                //缩放的起始位置的以及中点
                pointX = (this.startPoints[0].x + this.startPoints[1].x) / 2;
                pointY = (this.startPoints[0].y + this.startPoints[1].y) / 2;
                middlePoint = { x: pointX, y: pointY };

                //缩放后的位置以及中点
                nPointX = (e.touch.touches[0].x + e.touch.touches[1].x) / 2;
                nPointY = (e.touch.touches[0].y + e.touch.touches[1].y) / 2;
                nMiddlePoint = { x: nPointX, y: nPointY };

                var d1 = getPointsDistance(this.startPoints[0], this.startPoints[1]);
                var d2 = getPointsDistance(e.touch.touches[0], e.touch.touches[1]);

                if (d1 + 3 > d2 && d1 - 3 < d2) {
                    scale = 1;
                    isMove = true
                } else {
                    scale = d2 / d1;
                }

                //放大后的倍数
                nScale = this.zoomRecord * scale;

                if (nScale > 1) {
                    //偏移位置的计算
                    var left = pointX * (1 - scale) + (nPointX - pointX);
                    var top = pointY * (1 - scale) + (nPointY - pointY);

                    scaleLeftX = this.scalingLeft * scale + left;
                    scaleTopY = this.scalingTop * scale + top;
                } else {
                    nScale = 1;
                    this.zoomRecord = 1;
                    scaleLeftX = 0;
                    scaleTopY = 0;
                }

                //记录放大后的总的倍数
                this.zoomRecordTemp = nScale;

                $div.vendor('transition', '-webkit-transform 0ms ease 0s');
                $div.vendor('transform-origin', 'left top');
                $div.vendor('transform', 'scale(' + nScale + ')');

                $div.vendor('left', scaleLeftX + 'px');
                $div.vendor('top', scaleTopY + 'px');
            });

            // Resize
            this.subscribe('resize', function() {
                var c, DOM = this.DOM,
                    _this = this;

                var resize = function() {
                    _this.screen = {
                        width: window.innerWidth,
                        height: window.innerHeight
                    };
                    _this.isExec = false;
                    _this.isZoom = false;
                    _this.isScroll = false;
                    _this.isScale = false;

                    var h = parseInt(DOM.toolbar.style('height'), 10),
                        width = _this.screen.width,
                        height = _this.screen.height,
                        he = height - h,
                        diff = ((_this.index - 1) * (_this.config.direction ? width : he)) - (_this.config.direction ? width : he),
                        scroll = -(_this.index - 1) * (_this.config.direction ? width : he);

                    if (_this.index == 1) diff = 0;
                    if (_this.index == _this.data.length) diff = diff - (_this.config.direction ? width : he);

                    _this.offset = {
                        width: width + 'px',
                        height: he + 'px'
                    };

                    DOM.wrap[0].style.cssText = 'width: ' + width + 'px; height: ' + height + 'px;';
                    DOM.view[0].style.cssText = 'top: ' + h + 'px; height: ' + he + 'px;';
                    DOM.imglist.find('li').each(function(i, elem) {
                        var $img = $(elem).find('img'),
                            index = parseInt($(elem).attr('data-index'), 10),
                            size = _this.size[index] && _this.scale(_this.size[index]);

                        elem.style.cssText = 'width:' + _this.offset.width + '; height: ' + _this.offset.height + ';';
                        size && ($img[0].style.cssText = 'width: ' + size.width + 'px; height: ' + size.height + 'px;');
                        $img.vendor('transform-origin', '50% 50% 0px');
                        $img.vendor('transition', '-webkit-transform 0ms ease 0s');
                        $img.vendor('transform', 'scale3d(1, 1, 1) translate3d(0px, 0px, 0px);');
                        $img.off('touchstart');
                        $img.off('touchmove');
                    });
                    DOM.imglist.css(_this.config.direction ? 'left' : 'top', diff < 0 ? '0px' : diff + 'px');
                    DOM.imglist.css(_this.config.direction ? 'width' : 'height', (_this.config.direction ? width : he) * (_this.data.length > 2 ? 3 : _this.data.length) + 'px');

                    // 重新绑定滚动翻页事件
                    if (_this.config.direction) {
                        _this.publish('touchStyle', 0, scroll, 0, 'ease');
                    } else {
                        _this.publish('touchStyle', 0, 0, scroll, 'ease');
                    }
                    _this.publish('untouch').publish('touch');
                };

                //横屏，竖屏切换
                $(window).on(_this.resizeType, function() {
                    clearTimeout(c);
                    c = setTimeout(resize, 300);
                });

            });

            return this;
        }
    };

    MPreview.fn.init.prototype = MPreview.fn;

    // 扩展至全局
    win.MPreview = MPreview;

}(window, $$));