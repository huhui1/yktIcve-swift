(function($M, $) {

    var requireList = {
        /**
         * 获取数据
         * @return {this}
         */
        get: function(r, state) {
            var _this = this,
                arr = [];
            _this.state = state;
            $.each(r.requireInfo.DocJson, function(i, v) {
                arr.push({
                    src: v.docPreview,
                    oss: v.docOssPreview
                })
            });
            $('#topice').html(template('topice-tpl', { discussdata: r.requireInfo, imgdata: arr }));
            if (r.requireInfo.replyList.length) {
                $('#list').html(template('list-tpl', { list: r.requireInfo.replyList }));
            } else {
                $('#list').html('<li class="mui-table-view-cell mui-media mui-text-center data-loading"><a href="javascript:;">还没有人评论，赶紧来评论吧！</a></li>');
            }
            return this;
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this;
            $M('.mui-scroll-wrapper').scroll();
            // 图片预览
            $('#topice').on('singleTap', 'img', function() {
                var url = $(this).data('oss');
                if (url) {
                    var message = { "method": "preview", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }


            });

            //查看详情
            $('#list').on('singleTap', 'li.parent', function(e) {
                var $elem = $(this),
                    content = $elem.attr('data-content'),
                    docJson = $elem.attr('data-docjson'),
                    dateCreated = $elem.find('.time').text(),
                    creatorName = $elem.find('.CreatorName').text(),
                    avator = $elem.find('.avator').attr('src');
                var url = "";
                if (docJson) {
                    if (JSON.parse(docJson)) {
                        if (JSON.parse(docJson)[0]) {
                            url = JSON.parse(docJson)[0].docOssPreview
                        }
                    }
                }
                // 页面跳转进评论详情页
                var extras = {
                    state: _this.state,
                    dateCreated: dateCreated,
                    content: content,
                    url: url,
                    creatorName: creatorName,
                    avator: avator
                }

                var message = { "method": "details", "data": JSON.stringify(extras) };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            return this;
        },

        /**
         * 增加辅助方法
         * @return {this}
         */
        helper: function() {
            //对字符串进行编码
            template.config('escape', false);
            template.helper('jsontostr', function(v) {
                return JSON.stringify(v);
            });
            return this;

        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            var _this = this;

            _this.helper().load().events();
            _this.state = ""
            return this;
        }

    };


    requireList.init();
    window.requireList = requireList;

}(mui, Zepto));