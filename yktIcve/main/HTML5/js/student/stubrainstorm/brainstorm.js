/**
 * 课堂互动，提交头脑风暴
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-03-03
 * @return {Object}
 */
(function($M, $) {

    var submitstorm = {

        /**
         * 头脑风暴的信息设置
         * @return {this}
         */
        set: function(r) {
            var _this = this;
            if (!r) {
                //  plus.nativeUI.toast('发生未知错误');
            } else if (r.code == 1) {

                $('.storm_title').text(r.stormInfo.Title);
                var arr = [];
                $.each(r.stormInfo.DocJson, function(i, v) {
                    arr.push({
                        src: v.docPreview,
                        ossSrc: v.docOssPreview
                    });
                })
                $('#stormContent').html(template('img-list', { imgdata: arr, content: r.stormInfo.Content }));

                //status为 2进行中  3已结束
                if (_this.status == 2) {
                    $('.answer-mine').removeClass('mui-hidden');
                    $('.submit-storm').removeClass('mui-hidden');
                    if (r.brainStormStu) {
                        _this.isEdit = true;
                        $('.submit-storm').text("修改");
                        // $('.content').html(r.brainStormStu.Content.replace(/<img   src=/g, '<img width="40" height="40" src='));
                        var $elemimg = [];
                        $.each(r.brainStormStu.DocJson, function(i, v) {
                            $elemimg.push({ docPreview: v.docPreview, docUrl: v.docUrl });
                        });
                        $(".content").text(r.brainStormStu.Content);
                        $(".pic-info").html(template('imgArr-list', { src: $elemimg }));
                    }
                } else {
                    $('.mui-table-view.add').html(template('brainstorm-list', { list: r.brainStormStuList }));
                    _this.list = r.brainStormStuList;
                }
            } else {
                //   plus.nativeUI.toast(r.msg);
            }
            _this.me && _this.me.resetload();
            return this;
        },

        /**
         * 载入
         * @return {this}
         */
        events: function() {
            var _this = this;

            var $scroll = $M('.mui-scroll-wrapper').scroll();
            $('.mui-scroll-wrapper').dropload({
                domUp: {
                    domClass: 'dropload-up',
                    domRefresh: '<div class="dropload-refresh">↓ 下拉可以刷新</div>',
                    domUpdate: '<div class="dropload-update">↑ 释放立即刷新</div>',
                    domLoad: '<div class="dropload-load"><span class="loading"></span> 正在刷新中...</div>'
                },
                loadUpFn: function(me) {
                    _this.me = me;
                    _this.load();
                    $scroll.scrollTo(0, 0);
                }
            });
            //查看头脑风暴详情
            $('#brainstormListContent').on('singleTap', '.infomsg', function(e) {
                var index = $(this).data('index');

                var message = { "method": "brainDetails", "index": String(index) };
                window.webkit.messageHandlers.interOp.postMessage(message);

            });

            //预览图片
            $('#stormContent').on('singleTap', 'img', function() {
                var url = $(this).data("oss");
                if (url) {
                    var message = { "method": "previewImg", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

                // $M.openWindow({
                //     url: '/view/student/preview/img.html',
                //     id: 'student-preview-img',
                //     extras: {
                //         imgUrl: url
                //     }
                // });


            });

            return this;
        },

        /**
         * 模版的扩展方法
         * @return this
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            // template.config('escape', false);
            //替换img标签
            template.helper('replaceImg', function(val) {
                return $('<div/>').html(val.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]")).text();
            });
            template.helper('jsontostr', function(v) {
                return JSON.stringify(v);
            });
            template.helper('toclass', function(i) {
                var classarr = ["t-one", "t-two", "t-three", "t-four"];
                return classarr[Number(i) % 4];
            });
            template.helper('ispad', function() {
                return _this.deviceName.indexOf('ipad') > -1 ? "stustorminfoipad" : "stustorminfo";
            });
            return this;
        },

        // getParameter: function(courseOpenId, creatorId, actId, openClassId, activityId, status, userId) {
        //     var _this = this;
        //     _this.actId = actId;
        //     _this.courseOpenId = courseOpenId;
        //     _this.openClassId = openClassId;
        //     _this.activityId = activityId;
        //     _this.creatorId = creatorId;
        //     _this.status = status;
        //     _this.$user = userId;
        //     this.set();
        // },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {

            // this.view = plus.webview.currentWebview();
            this.actId = "";
            this.isSend = false;
            this.courseOpenId = "";
            this.openClassId = "";
            this.activityId = "";
            this.status = "";
            this.creatorId = "";
            this.list = {};
            this.$user = "";
            this.isEdit = false;
            this.me = "";
            this.deviceName = navigator.userAgent.toLowerCase();

            this.helper().load().events();

            return this;
        },

    };


    submitstorm.init();
    window.submitstorm = submitstorm;

}(mui, Zepto));