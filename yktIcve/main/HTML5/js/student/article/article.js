/**
 * 课程详情页
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  M.J
 * @date  2015-07-27
 * @return {Object}
 */
(function($M, $) {



    var article = {

        /**
         * 格式化数据
         * @return {this}
         */
        format: {
            zh: ['十', '一', '二', '三', '四', '五', '六', '七', '八', '九'],
            number: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
        },
        //课程目录信息
        course: function(data) {
            var _this = this;
            if (data.code > 0) {
                var html = template('course-list-tpl', { list: data.moduleList });
                _this.courseHtml = html;
                $('#course-scroll ul').html(html);

            } else {
                $('#course-scroll ul').html('<li class="mui-table-view-cell mui-text-center data-loading"><a href="javascript:;">暂无课件...</a></li>');
            }
        },
        setTopic: function(data) {
            var _this = this;
            var html = template('templ-course-list-topic', { list: data.topicList });
            _this.$elem.html(html);
            return this;
        },
        setCell: function(data) {
            var _this = this;
            var html = template('templ-course-list-cell', { list: data.cellList });
            _this.$elem.html(html);
            return this;
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this,
                isExec = false,
                isSend = false;

            $('#course-scroll ul').on('singleTap', '.course-list-topic', function() {
                var $elem = $(this).next(),
                    moduleId = $elem.data('moduleid');

                if (!$elem.children().length) {
                    _this.$elem = $elem;
                    var message = { "method": "getTopic", "moduleId": moduleId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });

            $('#course-scroll ul').on('singleTap', '.course-list-cell', function() {
                var $elem = $(this).next(),
                    topicId = $elem.data('topicid');

                if (!$elem.children().length) {
                    _this.$elem = $elem;
                    var message = { "method": "getCell", "topicId": topicId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                } else {
                    $elem.toggle();
                }
            });

            //课件点击事件
            $('#course-scroll ul').on('singleTap', 'a.resource', function(e) {
                var $elem = $(this),
                    isFirstModule = 0,
                    cellId = $elem.attr('data-cellid'),
                    title = $elem.attr('data-cellname'),
                    topicId = $elem.attr('data-topicsid'),
                    upTopicId = $elem.parents('.mui-table-view-chevron').attr('data-uptopicid'),
                    c_type = $(this).find('.cellNametype').text(),
                    isAllowDownLoad = $(this).data('isallowdownload'),
                    externallinkurl = $elem.attr('data-externallinkurl'),
                    moduleId = $elem.parents(".moduleId").attr('data-moduleid'),
                    index = $elem.parents(".moduleId").attr('data-index'),
                    upCellId = $elem.attr('data-upCellId');
                var type = ["其他", "视频", "音频", "图片", "文档", "ppt", "zip", "图文", "链接"],
                    doctype = $.inArray(c_type, type) > -1 ? $.inArray(c_type, type) : 0;
                if (index == 0) {
                    isFirstModule = 1;
                }

                var data = {
                    cellId: cellId,
                    title: title,
                    topicId: topicId,
                    upTopicId: upTopicId,
                    externallinkurl: externallinkurl,
                    upCellId: upCellId,
                    moduleId: moduleId,
                    isFirstModule: isFirstModule,
                    isAllowDownLoad: isAllowDownLoad
                }
                var message = { "method": "courseware", "doctype": String(doctype), "data": JSON.stringify(data) };
                window.webkit.messageHandlers.interOp.postMessage(message);


            });
            return this;
        },

        /**
         * 扩展 Template 方法
         * @return {this}
         */
        helper: function() {
            var _this = this;


            //对字符串进行编码
            template.config('escape', false);

            //替换img标签
            template.helper('content', function(val) {
                return val.toString().replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, "[图片]");
            });


            template.helper('changeStartTime', function(v) {

                return v.substring(0, 10);

            });
            template.helper('changeEndTime', function(v) {

                return v.substring(10, 16);

            });
            template.helper('subTitle', function(title, len) {

                return title.length > len ? title.substr(0, len) + '...' : title;
            });

            return this;

        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 载入
         * @return {null}
         */
        init: function() {
            var _this = this;
            this.$elem = {};
            var topoffset = '45px';
            _this.localData = {};
            _this.openClassId = '';
            _this.thumbnail = '';
            _this.cellId = '';
            _this.courseOpenId = '';
            _this.title = '';
            _this.courseHtml = "";

            _this.record = null;
            _this.count = 0;
            _this.studyElem = null;
            _this.webView = {};
            _this.index = 0;
            _this.load().events().helper();

        }
    };


    article.init();
    window.article = article

}(mui, Zepto));