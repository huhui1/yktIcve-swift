(function($M, $) {

    var vote = {
        /**
         * 获取投票信息
         * @return this
         */
        get: function(r) {
            var _this = this;
            if (r.voteInfo.voteType == 1) {
                var voteType = "正确错误";
            } else if (r.voteInfo.voteType == 2) {
                var voteType = "赞成反对";
            } else if (r.voteInfo.voteType == 3 && r.voteInfo.selectType == 1) {
                var voteType = "单选";
            } else if (r.voteInfo.voteType == 3 && r.voteInfo.selectType == 2) {
                var voteType = "多选";
            }

            _this.selectType = r.voteInfo.selectType;

            _this.voteType = r.voteInfo.voteType;

            $('.vote-title').html(template('tmpl-vote-info', { voteType: voteType, voteInfo: r.voteInfo }));
            _this.dataJson = JSON.parse(r.voteInfo.dataJson);
            var html = template('tmpl-vote-list', { list: _this.dataJson, voteInfo: r.voteInfo });
            $('#content-vote-list').html(html);
            return this;
        },

        /**
         * 事件绑定
         * @return this
         */
        events: function() {
            var _this = this;
            // 模拟滚动
            $M('.mui-scroll-wrapper').scroll();

            $('.vote-title').on('singleTap', '.discuss-img', function() {
                var url = $(this).data('url');
                if (url) {
                    var message = { "method": "previewImg", "url": url };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }

            });

            $('#content-vote-list').on('singleTap', '.vote-answer', function() {
                var $elem = $(this),
                    index = $elem.data('index'),
                    arr = _this.answer ? _this.answer : [],
                    inindex = $.inArray(_this.dataJson[index].sortOrder, arr);

                if (_this.selectType == 2) {
                    if (inindex > -1) {
                        arr.splice(inindex, 1);
                    } else {
                        arr.push(_this.dataJson[index].sortOrder);
                    }
                } else {
                    arr = [];
                    arr.push(_this.dataJson[index].sortOrder);
                }

                _this.answer = arr;
            });
            $('#btu-vote').on('singleTap', function() {
                _this.submitContent();
            });
            return this;
        },
        /**
         * 数据提交
         */
        submitContent: function() {
            var _this = this;
            if (_this.answer) {
                VoteContent = _this.answer.join();
            } else {
                var message = { "method": "showMsg", "msg": "请选择选项后在提交!" };
                window.webkit.messageHandlers.interOp.postMessage(message);
            }
            var message = { "method": "saveStudentVoteData", "VoteContent": VoteContent };
            window.webkit.messageHandlers.interOp.postMessage(message);
        },
        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            /**
             *状态转换
             *@return str
             **/
            template.helper('numbertochar', function(r) {
                var ary0 = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'K', 'J', 'L'];
                return ary0[r];
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;
            this.voteType = 1;
            this.selectType = 1;
            this.dataJson = [];
            this.answer = '';
            this.helper().load().events();
            return this;
        }
    };

    vote.init();
    window.vote = vote

}(mui, Zepto));