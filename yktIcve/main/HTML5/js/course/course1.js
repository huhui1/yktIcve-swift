/**
 * 课件
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-03-09
 * @return {Object}
 */
(function($M, $) {

    var course = {
        setData: function(data) {
            var _this = this;
            var html = template('tmpl-courseKJ', { list: data.moduleList });
            $('#mui-content').html(html);
            $('#mask').addClass('mui-hidden');
            return this;
        },
        /**
         * 绑定事件
         * @return {this}
         */
        events: function() {
            var _this = this;
            $M('.mui-scroll-wrapper').scroll();
            $('#mui-content').on('singleTap', '.courseKJ-topics', function() {
                var $elem = $(this).next(),
                    moduleId = $elem.data('moduleid');
                _this.$elem = $elem;
                var callblack = function() {
                    var message = { "method": "topic", "moduleId": moduleId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
                if (!$elem.children().length) {
                    callblack();
                }
            });

            $('#mui-content').on('singleTap', '.courseKJ-cells', function() {

                var $elem = $(this).next(),
                    topicId = $elem.data('topicid');
                _this.$elem = $elem;
                var callblack = function() {
                    var message = { "method": "cell", "topicId": topicId };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
                if (!$elem.children().length) {
                    callblack();
                } else {
                    $elem.toggle();
                }

            });
            //课件点击事件
            $('#mui-content').on('singleTap', '.cell', function(e) {
                var $child = $(this).find('i');


                var cellId = $(this).data("cellid"),
                    title = $(this).data("cellname"),
                    resourceUrl = $(this).data("resourceurl"),
                    c_type = $(this).find('.c-type').text(),
                    isAllowDownLoad = $(this).data('isallowdownload'),
                    externallinkurl = $(this).data("externallinkurl");
                if ($child.hasClass('icon-radio02')) {
                    _this.cellIds.push(cellId);
                    $child.addClass('icon-exam_selected').removeClass('icon-radio02');
                } else if ($child.hasClass('icon-exam_selected')) {
                    var index = $.inArray(cellId, _this.cellIds);
                    if (index > -1) {
                        _this.cellIds.splice(index, 1);
                    }
                    $child.addClass('icon-radio02').removeClass('icon-exam_selected');
                }

                var type = ["其他", "视频", "音频", "图片", "文档", "ppt", "zip", "图文", "链接"],
                    index = $.inArray(c_type, type) > -1 ? $.inArray(c_type, type) : 0;
                // var message = {
                //     "method": "preview",
                //     "cellId": cellId,
                //     "title": String(title),
                //     "type": String(index),
                //     "isAllowDownLoad": String(isAllowDownLoad)
                // };
                var message = {
                    "method": "getCellIds",
                    cellIds: _this.cellIds.join()
                };
                window.webkit.messageHandlers.interOp.postMessage(message);
            });
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
        },
        appendTopic: function(data) {
            var _this = this;
            var html = template('tmpl-courseKJ-topics', { list: data.topicList });
            _this.$elem.html(html);
            return this;
        },
        appendCell: function(data) {
            var _this = this;
            var html = template('tmpl-courseKJ-cells', { list: data.cellList });
            _this.$elem.html(html);
            return this;
        },
        /**
         * 载入
         * @return {this}
         */
        init: function() {
            this.$elem = "";
            this.events().load();
            this.cellIds = [];
            return this;
        },
    };


    course.init();
    window.course = course;

}(mui, Zepto));