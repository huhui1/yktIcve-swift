/**
 * 签到结果统计
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-04-12
 * @return {Object}
 */
(function($M, $) {

    var statistics = {
        /**
         * 获取签到结果信息
         * @return this
         */
        get: function(r) {
            var _this = this;

            var html = template('tmpl-sign-result', { signTitle: r.signTitle, total: r.signStuCountData.openClassStuCount, signStuCount: r.signStuCountData.signStuCount })
            $('#sign-result').html(html);
            var momentarr = [];
            momentarr.push({ name: "签到", value: r.signPercentData.signPercent.toFixed(2), count: r.signStuCountData.signStuCount });
            momentarr.push({ name: "迟到", value: r.signPercentData.signLatePercent.toFixed(2), count: r.signStuCountData.signLateStuCount });
            momentarr.push({ name: "事假", value: r.signPercentData.signLatterPercent.toFixed(2), count: r.signStuCountData.signLatterStuCount });
            momentarr.push({ name: "早退", value: r.signPercentData.signLeaveEarlyPercent.toFixed(2), count: r.signStuCountData.signLeaveEarlyStuCount });
            momentarr.push({ name: "病假", value: r.signPercentData.signIllnessPercent.toFixed(2), count: r.signStuCountData.signIllnessStuCount });
            momentarr.push({ name: "缺勤", value: r.signPercentData.signLackPercent.toFixed(2), count: r.signStuCountData.signLackStuCount });
            momentarr.push({name: "公假",value: r.signPercentData.signHolidayPercent.toFixed(2),count: r.signStuCountData.signHolidayStuCount});
            _this.charts(momentarr, r.signStuCountData);

            return this;
        },
        charts: function(ratio, data) {
            var _this = this;

            var chart = echarts.init(document.getElementById('chart'));
            var option = {
                title: {
                    text: '',
                    subtext: '',
                    x: 'center'
                },
                color: ['#388cfb', '#f42f35', '#cf3c5c', '#78ba52', '#fb8124', '#fec62e', '#937fe8'],
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                },
                legend: {
                    orient: 'horizontal',
                    x: 'center',
                    top: '8%',
                    itemGap: 10,
                    align: 'left',
                    selectedMode: false,
                    formatter: function(name) {
                        var str = 0,
                            count = 0;
                        $.each(ratio, function(i, v) {
                            if (v.name == name) {
                                str = v.value;
                                count = v.count;
                                if (count < 10) {
                                    count = "0" + count;
                                }
                                if (str < 10) {
                                    str = "0" + str;
                                }
                            }
                        });
                        return name + str + '% (' + count + '人)';
                    },
                    data: ['签到', '迟到', '事假', '早退', '病假', '缺勤','公假']
                },
                series: [{
                    name: '',
                    type: 'pie',
                    radius: ['40%', '60%'],
                    avoidLabelOverlap: false,
                    label: {
                        normal: {
                            show: true,
                            formatter: '签到结果',
                            position: 'center',
                            textStyle: {
                                fontSize: '20',
                                fontWeight: 'bold',
                                color: '#2cb692'
                            }
                        },
                        emphasis: {
                            show: false,
                            textStyle: {
                                fontSize: '40',
                                fontWeight: 'bold'
                            }
                        }
                    },
                    labelLine: {
                        normal: {
                            show: false
                        }
                    },
                    data: [
                        { value: data.signStuCount, name: '签到' },
                        { value: data.signLateStuCount, name: '迟到' },
                        { value: data.signLatterStuCount, name: '事假' },
                        { value: data.signLeaveEarlyStuCount, name: '早退' },
                        { value: data.signIllnessStuCount, name: '病假' },
                        { value: data.signLackStuCount, name: '缺勤' },
                        { value: data.signHolidayStuCount,name: '公假'}
                    ]
                }]
            };


            chart.setOption(option);
            return this;
        },
        /**
         * 扩展辅助方法
         * @return {this}
         */
        helper: function() {
            var _this = this;
            //对字符串进行编码
            template.config('escape', false);
            return this;
        },
        load: function() {
            var message = { "method": "load" };
            window.webkit.messageHandlers.interOp.postMessage(message);
        },
        /**
         * 初始化
         * @return this
         */
        init: function() {
            var _this = this;

            _this.helper().load();;

            return this;
        }
    };


    statistics.init();
    window.statistics = statistics;
}(mui, Zepto));
