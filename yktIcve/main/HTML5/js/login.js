/**
 * 登录模块
 * @param {Object} $M => mui
 * @param {Object} $  => zepto
 * @name  zqyou
 * @date  2017-02-17
 * @return app {Object}
 */
(function($M, $) {

    // 登录
    var login = {
        /**
         *获取学校列表
         *@return {this}
         */
        getSchoollist: function(r) {
            var _this = this;
            $http.get(app.url.getSchoolList, function(r) {
                if (r.code > 0) {
                    if (r.list.length) {
                        var arr = [];
                        $.each(r.list, function(i, v) {
                            r.list[i].PinYin2 = v.PinYin2.toLowerCase();
                            arr.push(r.list[i]);
                        })
                        _this.schoolList = arr;
                        $("#school-lists").html(template('templ-school-list', { list: r.list }));
                    }
                }
            }, function() {

            });
            return this
        },
        /**
         * 事件绑定
         * @return {this}
         */
        events: function() {
            var _this = this
                //获取学校列表
                // 设置退出后显示上次用户登录名
                // $('#school').val(app.data.get('$lastSchoolName'));
                // $('#account').val(app.data.get('$lastUserName'));
                //设置是否记住密码
                // if (app.data.get('$cloudClassRemember') == 'true') {
                //     $('#remember').prop('checked', true);
                //     $('#password').val(app.data.get('$lastPassword'));
                // }
                //选择学校
            $('#school').on('singleTap', function() {
                if (_this.schoolList == 1) {
                    var message = { "method": "getschoollist" };
                    window.webkit.messageHandlers.interOp.postMessage(message);
                }
                setTimeout(function() {
                    $('.school-div').removeClass("mui-hidden");
                }, 500);

            });
            $('.mui-content').on('singleTap', function(e) {
                var $elem = $(e.target);
                if (!$elem.hasClass('sname')) {
                    if ($('#school-lists').children()) {
                        $('.school-div').addClass('mui-hidden');
                    }
                }
            });
            $('#school-lists').on('singleTap', 'li.schoollist', function() {
                var $elem = $(this);
                _this.schoolId = $elem.data("schoolid");
                $('#school').val($elem.text());
                $('.school-div').addClass('mui-hidden');
            });
            $('.mui-input-group').bind('input propertychange', '#school', function() {
                var $elem = $(this),
                    schoolKey = $elem.val().toLowerCase(),
                    arr = [];
                $.each(_this.schoolList, function(i, v) {
                    if (v.Name.indexOf(schoolKey) > -1 || v.PinYin.indexOf(schoolKey) > -1 || v.PinYin2.indexOf(schoolKey) > -1 || v.Code.indexOf(schoolKey) > -1) {
                        arr.push(v);
                    };
                    if (v.Name == $elem.val()) {
                        _this.schoolId = v.Id;
                    }
                });
                $("#school-lists").html(template('templ-school-list', { list: arr }));
            });
            // 登录singleTap
            $('#login').on('singleTap', function(e) {

                e.preventDefault();
                _this.check();
            });
            //受邀注册
            $("#inviteRegister").on('singleTap', function() {
                $M.openWindow({
                    url: '/view/public/scanCode/scanCode.html',
                    id: 'teacher-scanCode',
                    extras: {

                    }
                });

            });
            // 忘记密码
            $('#forgetPassword').on('singleTap', function() {
                $M.openWindow({
                    url: '/view/public/getpass/getpass.html',
                    id: 'getpass',
                    show: {
                        autoShow: true,
                        aniShow: 'pop-in'
                    }
                });
            });
            return this;
        },
        /**
         * 移出本地用户相关数据
         * @return {this}
         */
        // remove: function() {
        //     app.data.remove('$cloudClassToken');
        //     app.data.remove('$cloudClassUser');
        //     app.data.remove('$cloudClassUserType');
        //     app.data.remove('$cloudClassRemember');
        //     app.cache.removeCache('avatar');
        //     app.cache.removeCache('$cloudClassCache');
        //     app.data.remove('$cloudClassWgtName');

        //     return this;
        // },

        /**
         * 请求成功的回调事件
         * @return {this}
         */
        // callback: function(data) {
        //     var _this = this,
        //         arr_val = ["tea001", "66024"];
        //     // 移除上次用户所相关的数据
        //     this.remove();
        //     // 存储保存密码状态
        //     app.data.set('$cloudClassRemember', $('#remember').is(":checked"));
        //     // 设置本地存储， Token
        //     app.data.set('$cloudClassToken', data.token);

        //     // 存储老师用户类型
        //     app.data.set('$cloudClassUserType', data.userType);

        //     // 缓存本地头像并设置用户信息到本地
        //     var view = plus.webview.currentWebview(),
        //         user = {
        //             id: data.userId,
        //             displayName: data.displayName,
        //             schoolName: data.schoolName,
        //             number: data.userName,
        //             avatar: data.url ? data.url.replace('/60_60.jpg', '') : '../../../img/defult_avatar.png',
        //             role: data.userType,
        //             schoolId: data.schoolId,
        //             sourceType: 3
        //                 //isAuthen: data.isAuthen
        //         };

        //     app.data.set('$cloudClassUser', JSON.stringify(user));

        //     return this;
        // },


        /**
         * 表单登录验证
         * @return {this}
         */
        check: function() {
            var _this = this,
                $user = $('#account'),
                $pwd = $('#password'),
                $school = $('#school'),
                userName = $user.val().replace(/\ +/g, ""),
                pasword = $pwd.val().replace(/\ +/g, ""),
                schoolName = $school.val();

            if (!_this.schoolId.length) {
                plus.nativeUI.toast('请选择您的学校');
                $school.focus();
                return;
            }
            if (!userName.length) {
                plus.nativeUI.toast('请填写您的账号');
                $user.focus();
                return;
            }

            if (!pasword.length) {
                plus.nativeUI.toast('请填写您的密码');
                $pwd.focus();
                return;
            }
            var data = {
                schoolId: _this.schoolId,
                userName: userName,
                userPwd: pasword,
                schoolName: schoolName

            };
            var message = { "method": "login", "data": JSON.stringify(data) };
            window.webkit.messageHandlers.interOp.postMessage(message);
            return this;
        },
        /**
         * 登录载入
         * @return null;
         */
        init: function() {
            var _this = this;
            //  this.getSchoollist();

            this.localversion = "2.0.50";
            this.schoolList = 1;
            //  this.schoolId = app.data.get('$lastSchoolId') || '';
            this.updata = false;
            this.auths = {};
            this.getSchoollist().events()
        },
    };

    // 初始化

    login.init();
    window.login = login;

}(mui, Zepto));