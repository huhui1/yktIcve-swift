//
//  doclistViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2017/11/16.
//  Copyright © 2017年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import CoreData
class doclistViewController: UIViewController,UITableViewDelegate,UITableViewDataSource,UIDocumentInteractionControllerDelegate {

    var documentController:UIDocumentInteractionController!
    var doclist = [CacheDocModel]();
    var tableView:UITableView!
    var path = "";
    var ht = 0
    override func viewDidLoad() {
        super.viewDidLoad()
        self.getCacheList()
        //rowHeight属性设置为UITableViewAutomaticDimension
        self.tableView.estimatedRowHeight = 50
        self.tableView.rowHeight = UITableViewAutomaticDimension
        
    }

    func getCacheList(){

        let cx = SQLiteManagerCache()
        self.doclist  = cx.readData(_userId: Account.defaultAccount.id!)
        self.setTableView();
    }
    func setTableView(){

        //创建表视图
        self.tableView = UITableView(frame:CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.width, height: UIScreen.main.bounds.height - 200));
        self.tableView!.delegate = self
        self.tableView!.dataSource = self
        //设置表格背景色
        self.tableView!.backgroundColor = UIColor.white;
        //去除单元格分隔线
        //self.tableView!.separatorStyle = .none
        self.tableView.register(celltableTableViewCell.self, forCellReuseIdentifier: "SwiftCell");
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
     

        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            // Fallback on earlier versions
        }
        self.view.addSubview(self.tableView!)
//        common.share.setTableFootView_noData(self.tableView, list: self.doclist)
    }

    func numberOfSections(in tableView: UITableView) -> Int {
        return 1
    }

    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat
    {
        return 60;
    }

    //返回表格行数（也就是返回控件数）
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        
        return self.doclist.count;
    }

    //创建各单元显示内容(创建参数indexPath指定的单元）
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath)
        -> UITableViewCell {
            
            let cell:celltableTableViewCell =  tableView.dequeueReusableCell(withIdentifier: "SwiftCell",for: indexPath) as! celltableTableViewCell
                let item = self.doclist[indexPath.row]
                cell.typeLabel.text = "\(common.docTypeArray[Int(item.docType)])";
                let size = common.share.formatFileSize(bytes: Float64(item.docSize));
                cell.sizeLable.text = "\(size)";
                cell.titleLable.text = "  \( item.docTitle)";
                cell.delegate = self
                cell.deleteBtn.tag = indexPath.row
            
           return cell
    }

    //点击
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {

        tableView .deselectRow(at: indexPath, animated: true)

        if(self.doclist.count < 1){
            return ;
        }
        let entry = self.doclist[indexPath.row]
        let doc : NSDictionary = ["docType":"\(entry.docType)","docTitle":entry.docTitle,"file":"\(NSHomeDirectory())/Documents/\(entry.docPath)","docPath":entry.docPath]
        NotificationCenter.default.post(name:NSNotification.Name("cache"), object: doc);
    }
    
   

    func documentInteractionControllerViewControllerForPreview(_ controller: UIDocumentInteractionController) -> UIViewController
    {

        //这个地方需要返回给一个控制器用于展现documentController在其上面，所以我们就返回当前控制器self

        return self
    }

    

      override  func viewWillAppear(_ animated: Bool) {
        if(animated){
            //解决tableview吸顶
            if(UIDevice.current.model == "iPad"){
            self.tableView.frame =  CGRect.init(x: 0, y: 100, width: UIScreen.main.bounds.width, height: UIScreen.main.bounds.height - 100);
                
            }else{
                if common.share.isX(){
                   self.tableView.frame =  CGRect.init(x: 0, y: 120, width: UIScreen.main.bounds.width, height: UIScreen.main.bounds.height - 210);
                }else{
                    //对与跳到视频返回的特别处理
                    if UIScreen.main.bounds.height < UIScreen.main.bounds.width{
                        if UIScreen.main.bounds.width == 812 {
                            self.tableView.frame =  CGRect.init(x: 0, y: 120, width: 420, height: UIScreen.main.bounds.width - 210);
                        }else{
                            self.tableView.frame =  CGRect.init(x: 0, y: 100, width: UIScreen.main.bounds.height, height: 500);
                        }
                    }else{
                            self.tableView.frame =  CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.height, height: 500);
                    }
                }
            }
        }
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
}




extension doclistViewController:celltableTableViewCellDelegate{
    
    func Delete(_ btn: UIButton) {
        let alertController = UIAlertController(title: "提示",
                                                message:"是否删除已下载的文件?", preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)

        let okAction = UIAlertAction(title: "确定", style: .destructive, handler: {
            action in
        
            let cell = self.superUITableViewCell(of: btn)
            if  let indexPath = self.tableView.indexPath(for: cell!){
                let entry = self.doclist[btn.tag]
                let de = SQLiteManagerCache()
                de.delData(Id: entry.id)
                let manager = FileManager.default
                do{
                    try manager.removeItem(atPath: "\(NSHomeDirectory())/Documents/\(entry.docPath)")
                }catch{
                    
                }
                self.doclist.remove(at: indexPath.row)
                self.tableView.deleteRows(at: [indexPath], with: UITableViewRowAnimation.fade);
                common.share.setTableFootView_noData(self.tableView, list: self.doclist as NSArray)
            }
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)

        self.present(alertController, animated: true, completion: nil)
    }
    

    //返回button所在的UITableViewCell
    func superUITableViewCell(of: UIButton) -> celltableTableViewCell? {
        for view in sequence(first: of.superview, next: { $0?.superview }) {
            if let cell = view as? celltableTableViewCell {
                return cell
            }
        }
        return nil
    }
}
