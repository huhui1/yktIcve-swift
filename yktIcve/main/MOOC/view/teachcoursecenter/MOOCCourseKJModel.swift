//
//  MOOCCourseKJ.swift
//  云课堂2
//  监听MOOC课件跳转
//  Created by 志辉教育 on 2018/8/9.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
class MOOCCourseKJModel: NSObject {
    @objc dynamic  var cellRefresh:String?
    //监听的变量
    var cellType = CellType()
    override init() {
        super.init()
        //对变量进行监听
        cellType.addObserver(self, forKeyPath: "categoryName", options: [.old, .new], context: nil)
    }
    
    func courseKJ(newValue:String){
        switch newValue {
        case "ppt","文档":
            let vc = ImagePreviewVC()
            vc.docId = cellType.cellId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.isFromKj = true
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "图片":
            let vc = PicturePreviewView()
            vc.docId = cellType.cellId!
            vc.courseOpenId = cellType.courseOpenId!;
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "视频":
            let vc = videoPlayView()
            vc.docId = cellType.cellId!
            vc.courseOpenId = cellType.courseOpenId!
            if cellType.isStudyFinish{
                vc.isStudyFinish = true
            }
            vc.isTeacher = cellType.isTeacher
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "讨论":
            let vc = courseDiscussView()
            vc.cellId = cellType.cellId!
            vc.topicId = cellType.resId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.isKJ = true
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "测验": //未记录日志
            let vc = test_homework_recordView()
            vc.workExamId = cellType.resId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.workExamType = 1
            vc.isMineClass = cellType.isMineClass
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "作业": //未记录日志
            let vc = test_homework_recordView()
            vc.workExamId = cellType.resId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.workExamType = 0
            vc.isMineClass = cellType.isMineClass
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "考试": //未记录日志
            let vc = test_homework_recordView()
            vc.workExamId = cellType.resId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.workExamType = 2
            vc.isMineClass = cellType.isMineClass
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "音频":
            self.getAudioResources(cellid: cellType.cellId!, courseOpenId: cellType.courseOpenId!)
        case "图文":
            let vc = MoocCourseware_tuWenView()
            vc.courseOpenId = cellType.courseOpenId!
            vc.cellId = cellType.cellId!
            vc.isStu = true
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "公告": //未记录日志
            let vc = noticeDetailsView()
            vc.Id = cellType.cellId!
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "讨论区": //未记录日志
            let vc = TeachDiscussInfoView()
            vc.title = cellType.resId! //title赋值给resId了
            vc.categoryId = cellType.cellId!
            vc.courseOpenId = cellType.courseOpenId!
            vc.MOOCCourseKJModel = self
            NavigatorService.navigateToPage(vc, animated: true)
        case "子节点":
            print("子节点")
        default:
            ZKProgressHUD.showMessage("该资源暂不支持手机查看，请从网页下载查看");
        }
        
    }
    func getAudioResources(cellid:String,courseOpenId:String){
        let dict = ["courseOpenId":courseOpenId,
                    "cellId":cellid,
                    "userId":Account.defaultAccount.id!] as [String : Any]
        ZKProgressHUD.show()
        Alamofire.request(MOOCAPI.Mooc_coursestudy_viewDirectory, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                ZKProgressHUD.hide()
                if json["code"] == 1{
                    let data = JSON.init(parseJSON: json["resUrl"].stringValue)
                    print(data)
                    let vc = audioViewController()
                    if data["urls"]["preview"].stringValue.isEmpty{
                        vc.audiourl = data["urls"]["preview_oss_ori"].stringValue
                    }else{
                        vc.audiourl = data["urls"]["preview"].stringValue
                    }
                    vc.isStu = true
                    vc.isNet = true
                    vc.title = json["title"].stringValue
                    
                    if(Account.defaultAccount.role == "1"){
                        vc.isStu = true
                    }
                    vc.MOOCCourseKJModel = self
                    vc.IsFromMooc = true
                    vc.courseOpenId = courseOpenId
                    vc.isAllowDownLoad = json["isDownLoad"].boolValue
                    vc.cellId = cellid
                    NavigatorService.navigateToPage(vc, animated: true)
                }else{
                    //ZKProgressHUD.showError(json["msg"].stringValue);
                }
            }else{
                ZKProgressHUD.hide()
                ZKProgressHUD.showMessage("网络环境异常请稍后再试！")
            }
        }
    }
    deinit {
        cellType.removeObserver(self, forKeyPath: "categoryName")
    }
    
}

extension MOOCCourseKJModel {
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        let newValue = change?[NSKeyValueChangeKey.newKey]
        if keyPath == "categoryName" {
            self.courseKJ(newValue: newValue as! String)
        }else{
            print("暂无")
        }
    }
}
