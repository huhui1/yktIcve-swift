//
//  TeachDiscussView.swift
//  云课堂2
//
//  Created by cc on 2018/6/12.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

class TeachDiscussView: UIViewController,UICollectionViewDelegate,UICollectionViewDataSource {

    //用来放置各个图片单元
    var collectionView:UICollectionView!
    
    //collectionView的布局
//    var collectionViewLayout: UICollectionViewFlowLayout!
    
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.colorWithHex(hexColor: 0xf2f2f2)
        
        self.setUICollectionView()
        
        // Do any additional setup after loading the view.
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func setUICollectionView(){
        //collectionView尺寸样式设置
        let layout = UICollectionViewFlowLayout()
        //间隙设置
        layout.minimumLineSpacing = 1
        layout.minimumInteritemSpacing = 1
        
        
        //横向滚动
        layout.scrollDirection = .vertical
        layout.itemSize = CGSize.init(width:(width / 3) - 2, height:110)
        let c = CGRect.init(x: 0, y: 0, width:width, height: height)
        //collectionView初始化
        collectionView = UICollectionView(frame:c ,
                                          collectionViewLayout: layout)
        collectionView.backgroundColor = UIColor.white
        
        collectionView.delegate = self
        collectionView.dataSource = self
        collectionView.isPagingEnabled = true
        collectionView.backgroundColor = UIColor.clear
        collectionView.register(TeachDiscussCollectionViewCell.self, forCellWithReuseIdentifier: "TeachDiscussCollectionViewCell")
        self.view.addSubview(collectionView)
        self.getData()
    }
    func numberOfSectionsInCollectionView(collectionView: UICollectionView) -> Int {
        
        return 1
    }
    
    func collectionView(_ collectionView: UICollectionView, cellForItemAt indexPath: IndexPath) -> UICollectionViewCell {
        let cell = collectionView.dequeueReusableCell(withReuseIdentifier: "TeachDiscussCollectionViewCell", for: indexPath) as! TeachDiscussCollectionViewCell
        let json = JSON(self.list[indexPath.row])
        if json["topicCount"].intValue > 99{
            cell.lab_icon.attributedText = shezhi(str: "\u{e70c} (99+)", colorStr: 0x28ac86)
        }else{
            cell.lab_icon.attributedText = shezhi(str: "\u{e70c} (\(json["topicCount"].stringValue))", colorStr: 0x28ac86)
        }
        cell.lab_discuss.text = json["title"].stringValue
        return cell
    }
    func collectionView(_ collectionView: UICollectionView, numberOfItemsInSection section: Int) -> Int {
        return self.list.count
    }
    
    func collectionView(_ collectionView: UICollectionView, didSelectItemAt indexPath: IndexPath) {
        let json = JSON(self.list[indexPath.row])
       
        self.MOOCCourseKJModel.cellType.cellId = json["id"].stringValue
        self.MOOCCourseKJModel.cellType.courseOpenId = self.courseOpenId
        self.MOOCCourseKJModel.cellType.resId = json["title"].stringValue
        self.MOOCCourseKJModel.cellType.isStudyFinish = false
        self.MOOCCourseKJModel.cellType.categoryName = "讨论区"
    }
    func  shezhi(str:String, colorStr:Int64) -> NSAttributedString{
        let attributeString = NSMutableAttributedString(string:str)
        attributeString.addAttribute(NSAttributedStringKey.foregroundColor, value: UIColor.colorWithHex(hexColor: colorStr),
                                     range: NSMakeRange(0,1))
        attributeString.addAttribute(NSAttributedStringKey.backgroundColor, value: UIColor.white, range: NSMakeRange(0,1))
        attributeString.addAttribute(NSAttributedStringKey.font, value: UIFont.init(name: "iconfont", size: 20)!, range: NSMakeRange(0,1))
        return attributeString
    }

    
    
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    var MOOCCourseKJModel: MOOCCourseKJModel!
    lazy var courseOpenId : String = {return ""}()
    lazy var list : NSArray = []

}


extension TeachDiscussView{
    func getData(){
        let dict = ["courseOpenId":self.courseOpenId,
                    "page":1] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(MOOCAPI.coursedetail_getDiscussNews, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.list = json["list"].arrayValue as NSArray
                    self.collectionView.reloadData()
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
}

