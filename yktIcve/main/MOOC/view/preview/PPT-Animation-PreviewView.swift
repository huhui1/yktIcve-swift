//
//  PPT-Animation-PreviewView.swift
//  云课堂2
//  带动画的PPT
//  Created by cc on 2018/6/7.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON

class PPT_Animation_PreviewView: UIViewController,WKNavigationDelegate,UIDocumentInteractionControllerDelegate {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white;
        if(self.linkStr.isEmpty){
            self.getviewDirectory()
        }else{
            self.setWebView()
        }
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        if isKJ{
            let Item = UIBarButtonItem(title:"\u{e70d}", style: .plain, target: self, action: #selector(self.Discuss))
            let DownloadItem = UIBarButtonItem(title: "\u{e730}", style: .plain, target: self, action: #selector(self.DownloadKJ))
            common.share.setteacherStudyButtonItem(item:DownloadItem)
            common.share.setdeleteButtonItem(item: Item)
            self.navigationItem.rightBarButtonItems = [Item,DownloadItem]
        }
       
        self.webView.navigationDelegate = self
        // Do any additional setup after loading the view.
        //判断是否点击过
        let cx = SQLiteManagerMask()
        let model = cx.readOneData(_userId: Account.defaultAccount.id!)
        
        if(!model.isbrowselessonH5PPTDiscuss && !cellId.isEmpty){
            self.maskView()
        }
    }
    override func viewDidDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        if(isStu){
            self.studyCellTime = common.share.returntime(timeStart: enterTime, timeEnd: common.share.getNowdate())
            self.savePlayLog()
        }
    }
    func setWebView(){
        
        let url = NSURL(string: linkStr)
        
        let request = URLRequest(url:url! as URL);
        webView.load(request as URLRequest)
        
        self.view.addSubview(self.webView)
        self.webView.snp.makeConstraints { (make) in
            make.width.equalTo(UIScreen.main.bounds.height - 60)
            make.height.equalTo(UIScreen.main.bounds.width - 40)
            make.center.equalTo(self.view.snp.center)
        }
        
        
        //禁用页面在最顶端时下拉拖动效果
        webView.scrollView.bounces = false;
        webView.scrollView.isScrollEnabled = false;
        
        self.view.addSubview(self.btn_pree)
        self.btn_pree.snp.makeConstraints { (make) in
            make.width.equalTo(35)
            make.height.equalTo(70)
            make.centerY.equalTo(self.view.snp.centerY)
            make.left.equalTo(0)
        }
        self.view.addSubview(self.btn_nextt)
        self.btn_nextt.snp.makeConstraints { (make) in
            make.width.equalTo(35)
            make.height.equalTo(70)
            make.centerY.equalTo(self.view.snp.centerY)
            make.right.equalTo(0)
        }
        self.btn_pree.setAttributedTitle(shezhi(str: "\u{e703}", colorStr: 0xf1f1f1), for: .normal)
        self.btn_nextt.setAttributedTitle(shezhi(str: "\u{e6ff}", colorStr: 0xf1f1f1), for: .normal)
    }
    //箭头
    func shezhi(str:String, colorStr:Int64) -> NSAttributedString{
        let attributeString = NSMutableAttributedString(string:str)
        attributeString.addAttribute(NSAttributedStringKey.foregroundColor, value: UIColor.gray,
                                     range: NSMakeRange(0,1))
        attributeString.addAttribute(NSAttributedStringKey.backgroundColor, value: UIColor.colorWithHex(hexColor: colorStr), range: NSMakeRange(0,1))
        attributeString.addAttribute(NSAttributedStringKey.font, value: UIFont.init(name: "iconfont", size: 30)!, range: NSMakeRange(0,1))
        return attributeString
    }
    //指示浮窗
    func maskView(){
        if(UIDevice.current.model == "iPad"){
           self.makeView.frame = CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.width, height: UIScreen.main.bounds.height)
        }else{
           self.makeView.frame = CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.height, height: UIScreen.main.bounds.width)
        }
        self.makeView.backgroundColor = UIColor(red: 0, green: 0, blue: 0, alpha: 0.3);
        let tapBtn = UIButton.init()
        tapBtn.setBackgroundImage(UIImage.init(named: "handTap.png"), for: .normal)
        
        self.makeView.addSubview(tapBtn)
        tapBtn.snp.makeConstraints { (make) in
            make.width.height.equalTo(60)
            make.top.equalTo(0)
            make.right.equalTo(2)
        }
        let Btn_title = UIButton.init()
        Btn_title.setTitle("评论，问答，笔记，纠错，请点击这里 | 下一步", for: .normal)
        Btn_title.setTitleColor(UIColor.white, for: .normal)
        self.view.addSubview( self.makeView)
        self.makeView.addSubview( Btn_title)
        
        let lw = UIScreen.main.bounds.width - 70  > 300 ? 300 :UIScreen.main.bounds.width - 70
        Btn_title.snp.makeConstraints { (make) in
            make.width.equalTo(lw)
            make.height.equalTo(30)
            make.right.equalTo(tapBtn.snp.left)
            make.centerY.equalTo(tapBtn)
        }
        Btn_title.titleLabel?.adjustsFontSizeToFitWidth = true
        tapBtn.addTarget(self, action: #selector(self.hideview), for: .touchUpInside)
        Btn_title.addTarget(self, action: #selector(self.hideview), for: .touchUpInside)
    }
    
    @objc func hideview(){
        self.makeView.isHidden = true
        let cx = SQLiteManagerMask()
        cx.updateData(isType: "isbrowselessonH5PPTDiscuss")
    }
    
    //视图显示时，横屏
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        self.enterTime = common.share.getNowdate()
        let value = UIInterfaceOrientation.landscapeRight.rawValue
        appDelegate.isEffective = true
        appDelegate.allowRotation = false
        UIDevice.current.setValue(value, forKey: "orientation")
    }
    
    //关闭横屏
    override func viewWillDisappear(_ animated: Bool) {
        super.viewWillDisappear(animated)
        
        if(!self.isPushed){
            appDelegate.allowRotation = true
            appDelegate.isEffective = true
            let value = UIInterfaceOrientation.portrait.rawValue
            
            UIDevice.current.setValue(value, forKey: "orientation")
        }
        self.isPushed = false
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    lazy var makeView:UIView = {
        let view = UIView()
        return view
    }()
    var token = "" //学习课件的token,用于记录日志
    lazy var picNum:Int = 0 //最大观看页数
    lazy var enterTime:Int = 0
    lazy var studyCellTime:Int = 0
    lazy var isTeaching:Bool = false
    lazy var courseOpenId:String = ""
    lazy var cellId:String = ""
    lazy var userId:String = ""
    var moduleId = ""
    var isStu = false
    var openClassId = "";
    var page_count:Int = 0
    lazy var linkStr :String = {
        return ""
    }()
    lazy var isPushed :Bool = {
        
        return false;
    }()
    lazy var leavepage:Int = 0    //离开时看到第几页
    lazy var stuCellPicCount:Int = 0
    lazy var cellLogId:String = ""
    var isKJ = false
    lazy var webView : WKWebView = {
        let web = WKWebView()
        return web
    }()
    var StuCourseKJModel: ZJY_StuCourseKJModel?
    var documentController:UIDocumentInteractionController!
    lazy var doctype :String = {return ""}()
    lazy  var type = ["其他", "视频", "音频", "图片", "文档", "ppt", "zip"];
    var resourcesUrl : JSON = [];
    var isAllowDownLoad:String = ""
    
    fileprivate  lazy var btn_pree : UIButton = {
        let btn = UIButton()
        btn.setTitleColor(UIColor.black, for: .normal)
        btn.addTarget(self, action: #selector(self.pree), for: .touchUpInside)
        btn.backgroundColor = UIColor.colorWithHex(hexColor: 0xf1f1f1)
        return btn
    }()
    
    fileprivate   lazy var btn_nextt :UIButton = {
        let btn = UIButton()
        btn.setTitleColor(UIColor.black, for: .normal)
        btn.addTarget(self, action: #selector(self.nextt), for: .touchUpInside)
        btn.backgroundColor = UIColor.colorWithHex(hexColor: 0xf1f1f1)
        return btn
    }()

    let appDelegate = UIApplication.shared.delegate as! AppDelegate
    
    lazy var resUrl:String = {return ""}()
}
