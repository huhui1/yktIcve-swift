//
//  courseware_tuWenView.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/7/2.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON

class MoocCourseware_tuWenView: UIViewController,UIDocumentInteractionControllerDelegate {

    @IBOutlet weak var myTableView: UITableView!
    var openClassId = "";
    var courseOpenId = "";
    var cellId = "";
    var isStu = false
    var moduleId = ""
    var MOOCCourseKJModel: MOOCCourseKJModel?
    lazy var stuCellPicCount:Int = 0
    lazy var cellLogId:String = ""
    var RarJsonData = [JSON]()
    var documentController:UIDocumentInteractionController!
    override func viewDidLoad() {
        super.viewDidLoad()
        self.setTableView()
        self.getTuwenData()
        
    }
    override func viewDidDisappear(_ animated: Bool) {
         self.savePlayLog()
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    func documentInteractionControllerViewControllerForPreview(_ controller: UIDocumentInteractionController) -> UIViewController
    {
        //这个地方需要返回给一个控制器用于展现documentController在其上面，所以我们就返回当前控制器self
        return self
    }
    func openOffice(path:CacheDocModel){
        let sandboxFilePath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
        let docUrl = URL(fileURLWithPath: sandboxFilePath);
        documentController = UIDocumentInteractionController(url:docUrl)
        documentController.delegate = self;
        //当前APP打开  需实现协议方法才可以完成预览功能
        documentController.presentPreview(animated: true);

    }
    
    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

    fileprivate lazy var headView :UIView = {
        let view = UIView()

        return view
    }()
    fileprivate lazy var labContent :UILabel = {
        let lab = UILabel()
        lab.numberOfLines = 0
        lab.textColor = UIColor.gray
        lab.sizeToFit()
        return lab
    }()

}
extension MoocCourseware_tuWenView:UITableViewDelegate,UITableViewDataSource,courseware_tuwenCellDelegate{
    
    
    func action_cache(index: Int) {
        let r =  self.RarJsonData[index]
        
        let cx = SQLiteManagerCache()
        let path = cx.readOneData(_userId: Account.defaultAccount.id!, docId: self.cellId + "\(index)")
        if(path.docPath.isEmpty){
            let vc = cacheViewController();
            vc.docId = self.cellId + "\(index)";
            vc.docUrl = r["downUrl"].stringValue;
            
            switch r["docType"] {
            case "mp4":
                vc.docType = 1
            case "mp3":
                vc.docType = 2
            case "img","jpg":
                vc.docType = 3
            case "office","docx","ppt":
                vc.docType = 4
            default:
                vc.docType = 5            }
            vc.docTitle = r["title"].stringValue
            vc.isStart = true;
            self.navigationController?.pushViewController(vc, animated: true);
        }else{
            switch path.docType {
            case 1:
                print("===")
                let vc = generalVideoPlayView()
                vc.videourls.removeAll()
                vc.localurl = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                vc.isNet = true
                self.navigationController?.pushViewController(vc, animated: true)
                
            case 2:
                print("===")
                let  vc = audioViewController();
                vc.audiourl = path.docPath;
                vc.title = "播放音频"
                vc.tittlelab.text = path.docTitle
                vc.isNet = false;
                self.navigationController?.pushViewController(vc, animated: true)
                
            case 3:
                let vc = cachePreviewImgView()
                let fullPath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                vc.file =  fullPath
                present(vc, animated: false, completion: nil)
            case 4,5:
                self.openOffice(path: path);
            default:
                print("asxa")
            }
        }
    }
    
    
    func setHeadUI(json:JSON){
        self.RarJsonData = json["rarList"].arrayValue
        self.title = json["title"].stringValue
        let t =  common.share.loadHtml(str: json["content"].stringValue)
        self.labContent.attributedText = t
        self.headView.addSubview(self.labContent)
        self.labContent.snp.makeConstraints { (make) in
            make.left.top.equalTo(0)
            make.width.equalTo(UIScreen.main.bounds.width)
        }

        let h = common.share.getHeightForView(text:t, font: UIFont.italicSystemFont(ofSize: 15), width: UIScreen.main.bounds.width)
        self.headView.frame = CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.width, height: h + 20)

        self.myTableView.tableHeaderView = self.headView
        self.myTableView.reloadData()

    }

    func setTableView(){
        self.myTableView.register(UINib.init(nibName: "courseware-tuwenCell", bundle:nil ), forCellReuseIdentifier: "courseware_tuwenCell")
        self.myTableView.delegate = self
        self.myTableView.dataSource = self
         self.myTableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
         self.myTableView.separatorInset = UIEdgeInsets.zero;

         self.myTableView.layoutMargins = UIEdgeInsets.zero;

        if #available(iOS 9.0, *) {
          self.myTableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            // Fallback on earlier versions
        }
    }
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.RarJsonData.count
    }

    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 40
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = self.myTableView.dequeueReusableCell(withIdentifier: "courseware_tuwenCell", for: indexPath) as! courseware_tuwenCell
        cell.deledate = self
        cell.setTitle(title: self.RarJsonData[indexPath.row]["title"].stringValue, _index: indexPath.row)
        return cell
    }

    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let r =  self.RarJsonData[indexPath.row]
        switch r["docType"] {
        case "mp4":
            let vc = videoPlayView()
            vc.isFromZjyErrorQuestion = true
            vc.videourls.removeAll()
            vc.videourls.append(r["preview"].stringValue)
            self.navigationController?.pushViewController(vc, animated: true)
        case "mp3":
            let  vc = audioViewController();
            vc.audiourl = r["preview"].stringValue
            vc.title = r["title"].stringValue
            vc.isNet = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "img","jpg":
            let vc = PicturePreviewView()
            vc.imgurl = r["preview"].stringValue
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
//        case "office","docx","ppt":
//            let vc = PPT_Animation_PreviewView()
//            vc.courseOpenId = self.courseOpenId
//            vc.openClassId = self.openClassId
//            vc.linkStr = r["preview"].stringValue
//            self.navigationController?.pushViewController(vc, animated: true)
        default:
            ZKProgressHUD.showError("请从网页下载查看");
        }
        
       
       
        
        
    }
}
