//
//  noticeDetailsView.swift
//  云课堂2
//
//  Created by cc on 2018/5/30.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import Alamofire 
import SwiftyJSON

class noticeDetailsView: UIViewController,UIScrollViewDelegate {
    
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = "公告"
        self.view.backgroundColor = UIColor.white
        self.setUI()
        self.getNoticeDetails()
        // Do any additional setup after loading the view.
    
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    func setUI(){
        var ht = 0
        if (common.share.isX()){
            ht = 0
        }
        self.scrollView.frame = self.view.frame
        self.scrollView.delegate = self
        self.view.addSubview(scrollView)
        
        //隐藏滚动条
        scrollView.showsVerticalScrollIndicator = false
        scrollView.showsHorizontalScrollIndicator = false
        
        
        self.scrollView.addSubview(self.lab_title)
        self.scrollView.addSubview(self.lab_time)
        self.scrollView.addSubview(self.lab_content)
       
        self.lab_title.snp.makeConstraints { (make) in
            make.width.equalTo(width - 20)
            make.height.equalTo(40)
            make.left.equalTo(10)
            make.top.equalTo(10 + CGFloat(ht))
        }

        self.lab_time.snp.makeConstraints { (make) in
            make.width.equalTo(width - 20)
            make.height.equalTo(20)
            make.left.equalTo(10)
            make.top.equalTo(self.lab_title.snp.bottom).offset(10)
        }

        self.lab_content.snp.makeConstraints { (make) in
            make.width.equalTo(width - 10)
            make.left.equalTo(0)
            make.top.equalTo(self.lab_time.snp.bottom).offset(10)
        }
        
        
        
    }
    
    //计算高度
    func heightForView(text:NSAttributedString, font:UIFont, width:CGFloat) -> CGFloat{
        
        let label:UILabel = UILabel(frame: CGRect(x: 0, y: 0, width: width, height: CGFloat.greatestFiniteMagnitude))
        label.numberOfLines = 0
        label.lineBreakMode = NSLineBreakMode.byWordWrapping
        label.font = font
        label.attributedText = text
        label.sizeToFit()
        
        return label.frame.height
    }
    
    func getNoticeDetails(){
        let paraph = NSMutableParagraphStyle()
        paraph.lineSpacing  = 10
        paraph.headIndent = 20
        paraph.firstLineHeadIndent = 50
        let attributes = [NSAttributedStringKey.font:UIFont.italicSystemFont(ofSize: 15),
                          NSAttributedStringKey.paragraphStyle: paraph]
        let dict = ["id":self.Id] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(MOOCAPI.coursedetail_getDetailCourseNews, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                var json = JSON(value)
                if json["code"] == 1{
                    //判断html正则表达式
                    let pattern = "[\\ud83c\\udc00-\\ud83c\\udfff]|[\\ud83d\\udc00-\\ud83d\\udfff]|[\\u2600-\\u27ff]|&nbsp;"
                    
                    self.lab_title.text = json["title"].stringValue
                    self.lab_time.text = json["dateCreated"].stringValue
                    let str = json["content"].stringValue.filterHTML()
                    //替换后的字符串
                    let str1 = str?.pregReplace(pattern: pattern, with: "")
                    self.lab_content.attributedText = NSAttributedString(string:str1!,attributes:attributes)
                    
                    let contenthigh = (self.heightForView(text: self.lab_content.attributedText!, font: UIFont.italicSystemFont(ofSize: 15), width: self.width))
                    self.scrollView.contentSize = CGSize.init(width: self.width, height: 220 + CGFloat(contenthigh))
                
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    
    lazy var Id : String = {return ""}()
    var MOOCCourseKJModel: MOOCCourseKJModel?
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    lazy var scrollView :UIScrollView = {
        let scrollView = UIScrollView.init(frame: self.view.bounds)
        return scrollView
    }()
    lazy var lab_title : UILabel = {
        let lab = UILabel()
        lab.font = UIFont.italicSystemFont(ofSize: 18)
        lab.textColor = UIColor.black
        lab.textAlignment = .center
        lab.backgroundColor = UIColor.white
        lab.numberOfLines = 2
        return lab
    }()
    lazy var lab_time : UILabel = {
        let lab = UILabel()
        lab.textAlignment = .center
        lab.font = UIFont.italicSystemFont(ofSize: 13)
        lab.textColor = UIColor.gray
        lab.backgroundColor = UIColor.white
        return lab
    }()
    lazy var lab_content : UILabel = {
        let lab = UILabel()
        lab.font = UIFont.italicSystemFont(ofSize: 15)
        lab.textColor = UIColor.black
        lab.backgroundColor = UIColor.white
        lab.numberOfLines = 0
        lab.sizeToFit()
        return lab
    }()
}
