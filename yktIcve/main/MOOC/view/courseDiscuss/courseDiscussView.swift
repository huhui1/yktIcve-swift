//
//  courseDiscussView.swift
//  云课堂2
//
//  Created by cc on 2018/6/4.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON

class courseDiscussView: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "讨论区"
        self.setTableView()
        self.getDiscuss()
        if isKJ{
            self.savestudentlog()
        }
        self.setFoot()
        self.textView.delegate = self
        //监听键盘弹出通知
        NotificationCenter.default
            .addObserver(self,selector: #selector(keyboardWillShow(_:)),
                         name: NSNotification.Name.UIKeyboardWillShow, object: nil)
        //监听键盘隐藏通知
        NotificationCenter.default
            .addObserver(self,selector: #selector(keyboardWillHide(_:)),
                         name: NSNotification.Name.UIKeyboardWillHide, object: nil)
        // Do any additional setup after loading the view.
        //注册点击事件
        let tapAction = UITapGestureRecognizer.init(target: self, action: #selector(self.handleTap(sender:)))
        tapAction.delegate = self
        view.addGestureRecognizer(tapAction)
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
    }
    //头部
    func setHead(){
        //富文本
        let paraph = NSMutableParagraphStyle()
        paraph.lineSpacing  = 5
        paraph.headIndent = 20
        paraph.firstLineHeadIndent = 40
        let attributes = [NSAttributedStringKey.paragraphStyle: paraph]
        //headview
        let topView = courseDiscussTopView()
        
        topView.lab_name.text = self.displayName
        topView.lab_time.text = self.dateCreated
        common.share.setSDImg(str: self.thumbnail, imgview: topView.image_View)
        topView.lab_discussTitle.attributedText = NSAttributedString(string:self.creatortitle.filterHTML()!,attributes:attributes)
        topView.lab_content.attributedText = common.share.loadHtml(str: self.content)
        topView.lab_content.font = UIFont.init(name: "HelveticaNeue-Light", size: 14)
        topView.lab_content.textColor = UIColor.gray
        
        let title = (self.heightForView(text: topView.lab_discussTitle.attributedText!, font: UIFont.italicSystemFont(ofSize: 16), width: self.width - 10))
        let content = (self.heightForView(text: topView.lab_content.attributedText!, font: UIFont.italicSystemFont(ofSize: 14), width: self.width - 10))
        topView.frame = CGRect.init(x: 0, y: 0, width: width, height: 100 + CGFloat(title) + CGFloat(content))
        self.tableView.tableHeaderView = topView
    }



    
    // 键盘显示
    @objc func keyboardWillShow(_ notification: Notification) {
        if common.share.isX(){
            ht = 30
        }
        let userInfo: NSDictionary = notification.userInfo! as NSDictionary
        let value = userInfo.object(forKey: UIKeyboardFrameEndUserInfoKey)
        let keyboardRec = (value as AnyObject).cgRectValue
        
        let height = keyboardRec?.size.height
        
        
        UIView.animate(withDuration: 0.1, animations: {
            var frame = self.footView.frame
            frame.origin.y = UIScreen.main.bounds.height - (height! + CGFloat(self.sizeHight) + 70 + CGFloat(self.ht))
            self.footView.frame = frame
            
        })
        
    }
    
    // 键盘隐藏
    @objc func keyboardWillHide(_ notification: Notification) {
        //还原tableview的contentview大小
        if common.share.isX(){
            ht = 60
        }
        UIView.animate(withDuration: 0.1, animations: {
            var frame = self.footView.frame
            frame.origin.y = UIScreen.main.bounds.height  - CGFloat(self.sizeHight) - 70 - CGFloat(self.ht)
            self.footView.frame = frame
        })
    }
    //键盘隐藏
    override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
        self.view.endEditing(true)
    }
    
    
    
    //移除监听,定时器
    override func viewDidDisappear(_ animated: Bool) {
        if !isPushed{
            NotificationCenter.default.removeObserver(self)
        }
        self.isPushed = false
    }


    @objc func dismissPraiseView(){
        self.praiseView.removeFromSuperview()
    }



    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    

    //计算label高度
    func heightForView(text:NSAttributedString, font:UIFont, width:CGFloat) -> CGFloat{
        let label:UILabel = UILabel(frame: CGRect(x: 0, y: 0, width: width, height: CGFloat.greatestFiniteMagnitude))
        label.numberOfLines = 0
        label.lineBreakMode = NSLineBreakMode.byWordWrapping
        label.font = font
        label.attributedText = text
        label.sizeToFit()
        return label.frame.height
    }

    var htmls = [HtmlRecord]()
    let htmlOperations = HtmlOperations()
    lazy var sizeHight : Int = 40
    lazy var page :Int = {return 1}()
    lazy var list : NSArray = []
    lazy var thumbnail : String = {return ""}()
    lazy var displayName : String = {return ""}()
    lazy var dateCreated : String = {return ""}()
    lazy var creatortitle : String = {return ""}()
    lazy var content : String = {return ""}()
    lazy var replyId : String = {return ""}()
    lazy var courseOpenId:String = ""
    lazy var cellId:String = ""
    lazy var topicId:String = "" 
   
    lazy var discussListcount:Int = 10
    var discussInfo = [courseDiscusscell]()
    lazy var isFirst : Bool = true
 
    lazy var btn : Int = {return 0}()
    var isPushed = false
    var isKJ = false
    var ht = 0
    let width = UIScreen.main.bounds.width
    var MOOCCourseKJModel: MOOCCourseKJModel?
    
    var tableView : UITableView!
    lazy var textView : UITextView = {
        let view = UITextView()
        view.font = UIFont.italicSystemFont(ofSize: 20)
        return view
    }()
    lazy var footView : UIView = {
        let view = UIView()
        view.backgroundColor = UIColor.colorWithHex(hexColor: 0xf2f2f2)
        return view
    }()
    lazy var toolView : ZQKeyboardTool = {
        let tool = ZQKeyboardTool()
        return tool
    }()
    lazy var btn_send :UIButton = {
        let btn = UIButton()
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.setTitle("发送", for: .normal)
        btn.setTitleColor(UIColor.bg, for: .normal)
        btn.backgroundColor = UIColor.white
        return btn
    }()
    lazy var praiseView : UIView = {
        let view = UIView()
        return view
    }()
    
}

extension courseDiscussView: UITableViewDataSource,UITableViewDelegate{
    func setTableView(){
        if common.share.isX(){
            ht = 60
        }
        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:width, height:UIScreen.main.bounds.height - 110 - CGFloat(self.ht)))

        self.tableView.register(courseDiscussTableViewCell.self, forCellReuseIdentifier: "SwiftCell")
        //除去多余的cell
        tableView.tableFooterView = UIView(frame:CGRect.zero)
        tableView.separatorInset = UIEdgeInsets.zero;
        tableView.layoutMargins = UIEdgeInsets.zero;

        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        //ipad
        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        }

        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            //重现生成数据
            self.htmls.removeAll()
            self.discussInfo.removeAll()
            self.page = 1
            self.getDiscuss();

        })
        //上拉加载
        self.tableView.mj_footer = MJRefreshBackNormalFooter(refreshingBlock: {
            self.page += 1
            self.getDiscuss()
        })

        self.view.addSubview(self.tableView);
    }


    func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }

    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return self.discussInfo.count
    }

    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 113
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell:courseDiscussTableViewCell = tableView.dequeueReusableCell(withIdentifier: "SwiftCell", for: indexPath) as! courseDiscussTableViewCell
        let reply = self.discussInfo[indexPath.row]
        cell.setReply(model: reply)
        cell.delegate = self

        //为了提示用户，将cell的accessory view设置为UIActivityIndicatorView。
        if cell.accessoryView == nil {
            let indicator = UIActivityIndicatorView(activityIndicatorStyle: .gray)
            cell.accessoryView = indicator
        }
        let indicator = cell.accessoryView as! UIActivityIndicatorView

        let html = self.htmls[indexPath.row]


        switch (html.state){
        case .done:
            indicator.stopAnimating()
            cell.lab_content.attributedText = html.htmlAttributedString
        case .new:
            indicator.startAnimating()
            self.startDownloadForRecord(html, indexPath: indexPath)
        }
        cell.btn_delete.tag = indexPath.row
        cell.btn_praise.tag = indexPath.row

        return cell
    }
    //点击
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let json = self.discussInfo[indexPath.row]
        let vc = discussDetailsView()
        vc.replyId = json.id
        vc.courseOpenId = self.courseOpenId
        self.isPushed = true
        vc.topicId = self.topicId
        self.navigationController?.pushViewController(vc, animated: true)
    }

    //执行任务
    func startDownloadForRecord(_ htmlRecord: HtmlRecord, indexPath: IndexPath){
        //判断队列中是否已有该任务
        if let _ = htmlOperations.conversionInProgress[indexPath] {
            return
        }

        //创建一个下载任务
        let conversion = StringConversion(htmlRecord: htmlRecord)
        //任务完成后重新加载对应的单元格
        conversion.completionBlock = {
            if conversion.isCancelled {
                return
            }
            DispatchQueue.main.async(execute: {
                self.htmlOperations.conversionInProgress.removeValue(forKey: indexPath)
                self.tableView.reloadRows(at: [indexPath], with: .fade)
            })
        }
        //记录当前下载任务
        htmlOperations.conversionInProgress[indexPath] = conversion
        //将任务添加到队列中
        htmlOperations.conversionQueue.addOperation(conversion)
    }

}
extension courseDiscussView:UITextViewDelegate,UIGestureRecognizerDelegate{

    //底部textView
    func setFoot(){
        if common.share.isX(){
            ht = 60
        }
        self.view.addSubview(self.footView)
        self.footView.addSubview(self.textView)
        self.footView.addSubview(self.btn_send)
        self.footView.frame = CGRect.init(x: 0, y: UIScreen.main.bounds.height - 110 - CGFloat(ht), width: width, height: 60)
        self.textView.frame = CGRect.init(x: 0, y: 3, width: width - 80, height: 40)
        self.textView.layer.masksToBounds = true
        self.textView.layer.cornerRadius = 10
        self.textView.layer.borderColor = UIColor.lightGray.cgColor

        self.textView.layer.borderWidth=0.5

        self.btn_send.snp.makeConstraints { (make) in
            make.width.equalTo(50)
            make.height.equalTo(35)
            make.centerY.equalTo(self.textView.snp.centerY)
            make.left.equalTo(self.textView.snp.right).offset(10)

        }

        self.btn_send.layer.masksToBounds = true
        self.btn_send.layer.cornerRadius = 6
        self.btn_send.addTarget(self, action: #selector(self.adddiscussDetails), for: .touchUpInside)
    }


    //textview高度
    func textViewDidChange(_ textView: UITextView) {
        let f = textView.frame
        let constrainSize = CGSize.init(width: f.size.width, height: CGFloat(MAXFLOAT))
        let size = textView.sizeThatFits(constrainSize)
        UIView.animate(withDuration: 0.1, animations: {
            var frame = self.footView.frame
            frame.size.height = CGFloat(Int(size.height) + 20)
            frame.origin.y =   frame.origin.y - CGFloat(Int(size.height) - self.sizeHight)
            self.footView.frame = frame
        })
        UITextView.animate(withDuration: 0.1, animations: {
            var frame = self.textView.frame
            frame.size.height = CGFloat(Int(size.height))
            self.textView.frame = frame
        })
        self.sizeHight = Int(size.height)
    }

    //MARK: - UIGestureRecognizerDelegate
    func gestureRecognizer(_ gestureRecognizer: UIGestureRecognizer, shouldReceive touch: UITouch) -> Bool {

        let touchClass = NSStringFromClass((touch.view?.classForCoder)!)
        if touchClass == "UIButton"{
            return false
        }
        return true
    }

    //收回键盘
    @objc func handleTap(sender: UITapGestureRecognizer) {

        if sender.state == .ended {
            print("收回键盘")
            self.view.endEditing(true)
        }
        sender.cancelsTouchesInView = false

    }
}
