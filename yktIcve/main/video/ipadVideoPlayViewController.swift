//
//  ipadVideoPlayViewController.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/7/12.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import  SwiftyJSON
import BMPlayer
import Alamofire
extension ipadVideoPlayView {

    //设置url
    func setvideoUrl(){
        let header = ["User-Agent":"BMPlayer"]
        let options = ["AVURLAssetHTTPHeaderFieldsKey":header]

        var res = [BMPlayerResourceDefinition]()
        //数组排序
        self.videourls.sort(){
            $0 < $1
        }

        for i in self.videourls{
            let res0 = BMPlayerResourceDefinition(url: URL(string: i)!,
                                                  definition: self.judgevideo(str: i), options: options)
            res.append(res0)
        }
        let asset = BMPlayerResource(name:  self.videotittle,
                                     definitions: res,
                                     cover: URL(string: "http://img.wdjimg.com/image/video/447f973848167ee5e44b67c8d4df9839_0_0.jpeg"))
        if(asset.definitions.count < 1){
            ZKProgressHUD.showMessage("视频解析出错")
            return
        }
        self.player.setVideo(resource: asset)

        if(self.leavelocation > 0){
            self.player.seek(TimeInterval(self.leavelocation))
        }
    }


    //投屏事件
    func emitToPC(dict:[String:String]){

        ZQSocketManager.share.notificationSocketManager(data: dict)
    }

    //判断视频时原画，高清
    fileprivate  func judgevideo(str:String) -> String{
        var type = "标清"
        let result = String(str.suffix(8))
        switch result{
        case "360p.mp4":
            type = "标清"
        case "480p.mp4":
            type = "高清"
        case "720p.mp4":
            type = "原画"
        default:
            type = "标清"
        }
        return type
    }
    
    
    
    func setTableView(){
        self.teaching_tableView.dataSource = self
        self.teaching_tableView.delegate = self
        
        self.teaching_tableView.register(UINib.init(nibName: "CourseTeachsCell", bundle: nil), forCellReuseIdentifier: "ipadCourseTeachsCell")
     
        
        self.teaching_tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        if #available(iOS 9.0, *) {
            self.teaching_tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        
        //下拉刷新相关设置,使用闭包Block
        self.teaching_tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.getData(isRefresh: false)
        })
        
    }
    
    func getData(isRefresh:Bool){
        let dict =
            ["userId":Account.defaultAccount.id!,
             "faceDate":"",
             "faceTimeState":0,
             "courseOpenIds":self.courseOpenId,
             "openClassIds":self.openClassId] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_getFaceActivityList, method: .post, parameters: dict).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"] == 1){
                    self.List = json["dataList"]
                    //重现加载表格数据
                    if(!isRefresh){
                        //结束刷新
                        self.teaching_tableView.mj_header.endRefreshing()
                    }
                    self.teaching_tableView!.reloadData();
                    common.share.setTableFootView_noData(self.teaching_tableView, list: json["dataList"].arrayValue as NSArray)
                }else{
                    ZKProgressHUD.showMessage(json["msg"].stringValue)
                }
                
                if(!isRefresh){
                    //结束刷新
                    self.teaching_tableView!.mj_header.endRefreshing();
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showMessage("网络开小差了")
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    
    func setSlideMenu(){
            //1.评价，2.问答，3，笔记，4.纠错
            var titles = ["评价","问答","笔记","纠错","学习统计"]
            var arr:Array<UIViewController> = [];

            let vc5 = StatisticallearningView()
        
            vc1.courseBBSAction = self.courseBBSAction
            vc1.courseOpenId = self.courseOpenId
            vc1.activeType = 1
            vc1.openClassId = self.openClassId
            vc1.cellId = self.docId
            vc2.courseBBSAction = self.courseBBSAction
            vc2.courseOpenId = self.courseOpenId
            vc2.activeType = 2
            vc2.openClassId = self.openClassId
            vc2.cellId = self.docId
            vc3.courseBBSAction = self.courseBBSAction
            vc3.courseOpenId = self.courseOpenId
            vc3.activeType = 3
            vc3.openClassId = self.openClassId
            vc3.cellId = self.docId
            vc4.courseBBSAction = self.courseBBSAction
            vc4.courseOpenId = self.courseOpenId
            vc4.activeType = 4
            vc4.openClassId = self.openClassId
            vc4.cellId = self.docId

            vc5.cellId = self.docId
            vc5.isMusicAndVideo = true
            vc5.openClassId = self.openClassId
            vc5.isFromIpadVideo = true

            if self.isStu{
                titles.remove(at: 4)
                arr.append(vc1)
                arr.append(vc2)
                arr.append(vc3)
                arr.append(vc4)
                
            }else{
                arr.append(vc1)
                arr.append(vc2)
                arr.append(vc3)
                arr.append(vc4)
                arr.append(vc5)
            }

            slideMenu = SlideMenu(frame: CGRect(x:0,y:0,width:UIScreen.main.bounds.width - 350,height:40), titles:titles, childControllers:arr)
            slideMenu?.backgroundColor = UIColor.white
            slideMenu?.bodyFrame =  CGRect.init(x: 0, y:41, width:UIScreen.main.bounds.width -  350, height: self.Bg_view.frame.height - 61)
            let f = CGRect.init(x: 0, y:0, width:UIScreen.main.bounds.width -  350, height: self.Bg_view.frame.height - 61)
             vc1.f = f
             vc2.f = f
             vc3.f = f
             vc4.f = f
            slideMenu?.selectedColor = UIColor(red: 6/255, green: 163/255, blue: 121/255, alpha: 1);
            slideMenu?.isFixed = true;
            slideMenu?.indicatorStyle = .followText;
            slideMenu?.titleStyle = .transfrom;
            slideMenu?.line.isHidden = false;
            slideMenu?.scrollToIndex(0)
            self.Bg_view.addSubview(slideMenu!)
        
        }
    
    

    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "ActionName" {

            self.actionBBSType()
        }
    }
    @objc func actionBBSType(){

        switch (self.courseBBSAction.ActionName) {
        case "create":
            let vc = createCourseBBSView()
            vc.courseOpenId = self.courseOpenId
            vc.openClassId = self.openClassId
            vc.cellId = self.docId
            vc.courseBBSAction = self.courseBBSAction
            vc.activeType = "\(self.courseBBSAction.actionType)"
            self.navigationController?.pushViewController(vc, animated: true)
        case "details":
            let vc = CourseBBSDetailsView()
            vc.activeType = (self.courseBBSAction.actionType)
            vc.cellId = self.docId
            vc.openClassId = self.openClassId
            vc.courseOpenId = self.courseOpenId
            vc.evaluation = self.courseBBSAction._evaluationModel!
            vc.courseBBSAction = self.courseBBSAction
            vc.isMainTeacher = self.courseBBSAction.isMainTeacher == true ? 1 : 0
            self.navigationController?.pushViewController(vc, animated: true)
        case "teaching":
            let vc = faceInfoView();
            vc.faceTimeStatus = self.courseBBSAction.faceTimeStatus
            vc.activityId =   self.courseBBSAction.activityId
            vc.courseOpenId =  self.courseOpenId
            vc.openClassIds =   self.courseBBSAction.openClassIds

            self.navigationController?.pushViewController(vc, animated: true);
        case "refresh":
            switch (self.courseBBSAction.actionType){
            case 1:
                vc1._BBSViewModel.getBBSData()
            case 2:
                vc2._BBSViewModel.getBBSData()
            case 3:
                vc3._BBSViewModel.getBBSData()
            case 4:
                vc4._BBSViewModel.getBBSData()
            default:
                print("")
            }
        default:
            print("_____")
        }

    }

}
