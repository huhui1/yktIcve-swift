//
//  ZykcourseDetailsView.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/7/2.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SnapKit
import SwiftyJSON
import Alamofire

class ZykcourseDetailsView: UIViewController {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        vc1.courseId = self.courseId
        vc2.courseOpenId = self.courseId
        vc3.courseId = self.courseId
//      vc1.ZykCourseKjModel = self._ZykCourseKjModel
        self.title = self.courseTitle
        self.setUI()
        self.setSlideMenu()
        self.getData()
        // Do any additional setup after loading the view.
        //添加KVO监听
        self._ZykCourseKjModel.addObserver(self, forKeyPath: "cellRefresh", options: [.old, .new], context: nil)
        
        
    }
    //移除KVO
    deinit {
        self._ZykCourseKjModel.removeObserver(self, forKeyPath: "cellRefresh")
    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func setUI(){
        let imgview = common.share.setImgshadowlayer(cornerRadius: 6, shadowOpacity: 0.15, borderWidth: 0.08, shadowPathcornerRadius: 0.6, size: CGSize(width: 0.3, height: 0.3), imgview: self.img_cover)
        self.view.addSubview(imgview)
        
        self.img_cover.snp.makeConstraints { (make) in
            make.width.equalTo(UIScreen.main.bounds.width - 20)
            make.height.equalTo(170)
            make.top.equalTo(10)
            make.left.equalTo(10)
        }
        var ht = 0
        if common.share.isX(){
            ht = 30
        }
        if DetailsType == 1{
            self.view.addSubview(self.btn_join)
            self.btn_join.snp.makeConstraints { (make) in
                make.width.equalTo(UIScreen.main.bounds.width)
                make.height.equalTo(40)
                make.bottom.equalTo(self.view.snp.bottom).offset(-CGFloat(ht))
                make.left.equalTo(0)
            }
            self.btn_join.addTarget(self, action: #selector(self.joinZYKCourse(_ :)), for: .touchUpInside)
        }
    }
    
    func setSlideMenu(){
        
        
        var arr = [UIViewController]();
        var titles = [String]()
        arr.append(vc1)
        if self.type == 1{
           titles = ["课程简介","课程目录"]
           arr.append(vc2)
           vc2.ZykCourseKjModel = self._ZykCourseKjModel
        }else{
           titles = ["微课简介","教学活动"]
           arr.append(vc3)
           vc3._ZykCourseKjModel = self._ZykCourseKjModel
        }
        var ht = 0
        if common.share.isX(){
            ht = 50
        }
        slideMenu = SlideMenu(frame: CGRect(x:0,y:185,width:view.frame.width,height:40), titles:titles, childControllers:arr)
        if DetailsType == 1{
          slideMenu?.bodyFrame = CGRect.init(x: 0, y: 225, width: view.frame.width, height: UIScreen.main.bounds.height - 330 - CGFloat(ht))
        }else{
          slideMenu?.bodyFrame = CGRect.init(x: 0, y: 225, width: view.frame.width, height: UIScreen.main.bounds.height - 290 - CGFloat(ht))
        }
        
        slideMenu?.selectedColor = UIColor(red: 6/255, green: 163/255, blue: 121/255, alpha: 1);
        slideMenu?.backgroundColor = UIColor.white
        slideMenu?.isFixed = true;
        slideMenu?.indicatorStyle = .followText;
        slideMenu?.titleStyle = .transfrom;
        slideMenu?.line.isHidden = false;
        slideMenu?.scrollToIndex(0)
        
        view.addSubview(slideMenu!)
    }
    
    var slideMenu:SlideMenu?
    lazy var img_cover : UIImageView = {
        let img = UIImageView()
        img.backgroundColor = UIColor.white
        return img
    }()

    lazy var vc1 = ZykCourseIntroductionView()
    lazy var vc2 = ZykCourseWareView()
    lazy var vc3 = ZykSmallclassCourseWare()
    lazy var btn_join : UIButton = {
        let btn = UIButton()
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        return btn
    }()
    private lazy var _ZykCourseKjModel: ZykCourseKjModel = {
        let model = ZykCourseKjModel()
        return model
    }()
    var isPushed = false
    lazy var type:Int = 1
    lazy var isHas : Int = {return 0}()
    lazy var courseId : String = {return ""}()
    lazy var DetailsType:Int = {return 1}()
    var moduleList = [JSON]()
    var courseTitle = ""
}
extension ZykcourseDetailsView {
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
//        let newValue = change?[NSKeyValueChangeKey.newKey]
        if keyPath == "cellRefresh" {
            if self._ZykCourseKjModel.isPushZykCourseWare{
                self.vc2.reloadList()
            }else{
                self.vc3.getData()
            }
        }
    }
}




