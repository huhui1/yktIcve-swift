//
//  ZykProfessionCourseView.swift
//  云课堂2
//
//  Created by cc on 2018/7/13.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

@objc protocol ZykProfessionCourseViewDategate{
    @objc optional func CourseDetails(Info:ZykAllCourseModel) -> ()
}

class ZykProfessionCourseView: UIViewController,UITableViewDelegate,UITableViewDataSource {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.setTableUI()
        self.getCourseData()
        // Do any additional setup after loading the view.
    }
    var Detegate:ZykProfessionCourseViewDategate!
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    func setTableUI(){
        var ht = 0
        if common.share.isX(){
            ht = 30
        }
        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:width, height:height - 103 - CGFloat(ht)))
        self.tableView.backgroundColor = UIColor.white
        self.tableView.register(UINib(nibName:"ZykAllCourseCell", bundle:nil),
                                forCellReuseIdentifier:"ZykAllCourseCell")
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        self.tableView.separatorInset = UIEdgeInsets.zero;
        self.tableView.layoutMargins = UIEdgeInsets.zero;
        self.tableView.delegate = self
        self.tableView.dataSource = self
        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        //去除分割线
        self.tableView.separatorStyle = UITableViewCellSeparatorStyle.none
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.list.removeAll()
            self.page = 1
            self.getCourseData()
        })
        //上拉加载
        self.tableView.mj_footer = MJRefreshBackNormalFooter(refreshingBlock: {
            self.page += 1
            self.getCourseData()
        })
        
        self.view.addSubview(self.tableView);
        
    }
    
    func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return self.list.count
    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 110
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let identifier = "ZykAllCourseCell"
        self.tableView.register(UINib(nibName:"ZykAllCourseCell", bundle:nil),
                                forCellReuseIdentifier:identifier)
        
        let cell:ZykAllCourseCell = tableView.dequeueReusableCell(withIdentifier: identifier)
            as! ZykAllCourseCell
        //去除点击cell变灰
        cell.selectionStyle = UITableViewCellSelectionStyle.none
        let model = self.list[indexPath.row]
        cell.setjson(model: model)
        return cell
    }
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let model = self.list[indexPath.row]
        self.Detegate?.CourseDetails!(Info: model)
    }
    
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    
    var tableView : UITableView!
    lazy var list = [ZykAllCourseModel]()
    lazy var Id:String = ""
    var page = 1
    
}



extension ZykProfessionCourseView{
    //获取课程数据
    func getCourseData(){
        let dict = ["projectId":self.Id,
                    "schollId":"",
                    "coursetype":1,
                    "page":self.page,
                    "type":1,
                    "likes":""] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(ZYKAPI.course_getAllCourse, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value);
                if json["code"] == 1{
                    if self.tableView.mj_footer != nil {
                        if( json["list"].count < json["pageSize"].intValue  ){
                            self.tableView.mj_footer.endRefreshingWithNoMoreData()
                        }else{
                            self.tableView.mj_footer.endRefreshing()
                        }
                    }
                    for data in json["list"]{
                        let course = ZykAllCourseModel.init(json: data.1)
                        self.list.append(course)
                    }
                    self.tableView.reloadData()
                    common.share.setTableFootView_noData(self.tableView, list: json["list"].arrayValue as NSArray)
                }else{
                    ZKProgressHUD.showMessage("网络异常请稍后再试！");
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showMessage("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
            if self.tableView.mj_header != nil{
                //结束刷新
                self.tableView.mj_header.endRefreshing()
            }
        }
    }
}




