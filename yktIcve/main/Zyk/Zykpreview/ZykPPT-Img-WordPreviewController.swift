//
//  ZykPPT-Img-WordPreviewController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/7/5.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
extension  ZykPPT_Img_WordPreview{
    func getviewDirectory(isRefresh:Bool){
        
            XLBallLoading.show(in: self.view)
            let dict = ["id": self.docId,
                        "courseId":self.courseId,
                        "type":4,
                        "token":Account.defaultAccount.token!] as [String : Any]
            Alamofire.request(ZYKAPI.course_getVideo, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    XLBallLoading.hide(in: self.view)
                    if json["code"] == 1{
                        self.pptviewDirectoryurl = json["list"][0]["url"].stringValue
                        self.getpage_count(jsonlist:json["list"][0]["url"])
                        self.ZykCourseKjModel?.sectionId = json["list"][0]["sectionId"].stringValue
                    }else{
                        ZKProgressHUD.showError(json["msg"].stringValue);
                    }
                }else{
                    XLBallLoading.hide(in: self.view)
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！")
               }
            }
        
    }
    
    
    //请求page_count
    func getpage_count(jsonlist:JSON){
      
        let strurl = JSON.init(parseJSON: jsonlist.stringValue)["urls"]["jsonUrl"].stringValue
        XLBallLoading.show(in: self.view)
        Alamofire.request("\(strurl)", method: .post, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                XLBallLoading.hide(in: self.view)
                
                    self.images = []
                    self.pagecount = json["imgs"].count
                    self.pageControl.numberOfPages = self.pagecount
                    if self.pagecount == 0{
                        self.pagecount = 1
                    }
                    let str1 = JSON.init(parseJSON: jsonlist.stringValue)["urls"]["previewUrl"].stringValue

                    if str1.isEmpty{
                         ZKProgressHUD.showError("该资源暂时不能访问,请前往网页下载查看");
                    }else{
                        for i in 0...self.pagecount - 1{
                            let imgUrl = str1.replacingOccurrences(of: "[place].png", with: "\(json["imgs"][i].stringValue)")
                            self.images.append(imgUrl)
                        }
                    }
                    self.collectionView.reloadData()
                }else{
                    XLBallLoading.hide(in: self.view)
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！")
                }
            XLBallLoading.hide(in: self.view)
            
        }
        
    }
  
    //是否继续
    func iscontinue(){
        let alertController = UIAlertController(title: "温馨提示！",
                                                message: "是否继续上次的浏览",
                                                preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: {
            action in
            //当前显示的单元格
            self.leavepage = 0
            self.isfirst = true
            self.collectionView.reloadData()
        })
        let okAction = UIAlertAction(title: "好的", style: .default, handler: {
            action in
            self.pageControl.currentPage = self.leavepage
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)
        
        self.present(alertController, animated: true, completion: nil)
    }
    
    
}










