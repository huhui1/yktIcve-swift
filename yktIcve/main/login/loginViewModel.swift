//
//  loginViewModel.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/6/13.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
class loginViewModel: NSObject {

    var userModel: User!
    @objc dynamic var schoolName: String? //swift 使用KVO监听的属性需要用dynamic关键字声明
    var schoolId: String?
    var isPushed :Bool = false
    override init() {
        super.init()
        userModel = User()
        userModel.addObserver(self, forKeyPath: "id", options: [.old, .new], context: nil)
        userModel.addObserver(self, forKeyPath: "ZHZJId", options: [.old, .new], context: nil)
    }


    //选择学校
    public func schoolList(){
        let viewCon = selectSchoolListView()
        viewCon.reloadSchoolClosure = {(SchoolId,SchoolName) in
            self.schoolName = SchoolName
            self.schoolId = SchoolId
        }
        self.isPushed = true
        viewCon.modalTransitionStyle = .crossDissolve
        NavigatorService.modelToPage(viewCon, animated: true, completion: {})
      
    }
    //更新密码
    public func updatePassword(schoolId:String,userName:String,displayName:String,oldPwd:String
        ,newPwd:String,mobile:String,smsCode:String){
        userModel.updatePassword(schoolId: schoolId, userName: userName, displayName: displayName, oldPwd: oldPwd, newPwd: newPwd, mobile: mobile, smsCode: smsCode)
    }

    //新的登录
    public func login(userName:String,userPassword:String,isRememberpassword:Bool){
        userModel.Login(userName: userName, userPassword: userPassword, isRememberpassword: isRememberpassword)
    }
  
    deinit {
        userModel.removeObserver(self, forKeyPath: "id")
        userModel.removeObserver(self, forKeyPath: "ZHZJId")
       
    }
    
}

extension loginViewModel {
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "id" {
            NavigatorService.pop(true)
            let appDelegate = UIApplication.shared.delegate as! AppDelegate
            appDelegate.window?.rootViewController = homePageTabber()
          
        }else if keyPath == "ZHZJId" {
            NavigatorService.pop(true)
            let appDelegate = UIApplication.shared.delegate as! AppDelegate
            appDelegate.window?.rootViewController = homePageTabber()
        }else{
            print("keyPath == schoolName")
        }
    }
}


