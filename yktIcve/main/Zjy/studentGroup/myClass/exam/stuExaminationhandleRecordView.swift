//
//  stuExaminationhandleRecordView.swift
//  云课堂-职教云
//
//  Created by zqy on 2018/3/29.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON
import SCLAlertView
class stuExaminationhandleRecordView : UIViewController,WKScriptMessageHandler,ZQNavigationMenuViewDelegate,WKNavigationDelegate{
    let appDelegate = UIApplication.shared.delegate as! AppDelegate
    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = self.title
        self.view.backgroundColor = UIColor.white
        self.setWebViewUI()
//        self.setUI()
        self.title = self.examTitle
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        let detailsItem = UIBarButtonItem.init(title: "错题集", style: UIBarButtonItemStyle.plain, target :self, action: #selector(self.error));
        self.navigationItem.rightBarButtonItem = detailsItem;
    }
    
    //设置H5页面
    func setWebViewUI(){
        
        let path = Bundle.main.path(forResource: "examinationhandle-record", ofType: ".html",
                                    inDirectory: "HTML5/src/student/exam");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height-60 + CGFloat(HX))
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
                theWebView.scrollView.bounces = false;
        //        theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        theWebView.navigationDelegate = self
        self.view.addSubview(theWebView);
        
    }
    
    
    
    //返回处理h5清除页面，防内存溢出
    override func viewWillDisappear(_ animated: Bool) {
        if(!self.isPushed){
            theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        }
        self.isPushed = false
    }

    func webView(_ webView: WKWebView, decidePolicyFor navigationAction: WKNavigationAction, decisionHandler: @escaping (WKNavigationActionPolicy) -> Void) {
        let url = navigationAction.request.mainDocumentURL
        if((url?.scheme?.contains("http"))! || (url?.scheme?.contains("https"))!){
            //
            print("拒绝")
            let vc = linkjumpView()
            vc.linkStr = (navigationAction.request.mainDocumentURL?.absoluteString)!
            self.isPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
//            //            UIApplication.shared.openURL(url! as URL)
            decisionHandler(.cancel);
        }else{
            decisionHandler(.allow);
        }

    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "load" ){
            self.theWebView.evaluateJavaScript("examinationhandle.getparameter('\(self.courseOpenId)','\(self.openClassId)','\(self.examId)','\(self.examTermTimeId)','\(Account.defaultAccount.id!)','\(self.examStuId)')",
                completionHandler: nil)
        }else if(sentData["method"] == "unDoExam"){
           
            //自定义提示框样式
            let appearance = SCLAlertView.SCLAppearance(
                showCloseButton: false //不显示关闭按钮
            )
            //使用自定义样式的提示框
            let alert = SCLAlertView(appearance: appearance)
            alert.addButton("确定") {
                self.close()
            }
            alert.showInfo("温馨提示！", subTitle: "未作答该试卷,暂不能查看")
            


        }else if(sentData["method"] == "showMsg"){
            ZKProgressHUD.showMessage(sentData["msg"]!)
        }else if(sentData["method"] == "previewImg"){
            self.previewImg(url:sentData["url"]!)
        }else if(sentData["method"] == "getUrlById"){
            self.getFileById(Id:sentData["Id"]!)
        }else if(sentData["method"] == "getFileInfoByUrl"){
            self.getFileInfoByUrl(url: sentData["url"]!)
        }
    }

    func close(){
           self.navigationController?.popViewController(animated: true)
    }
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()
//    func setUI(){
//        let items = ["错题集"]
//        let imageArray = NSMutableArray.init()
//        self.menu = ZQNavigationMenuView.init(frame: CGRect.init(x: UIScreen.main.bounds.width - 100, y: 0, width:200, height: 50), titles: items )
//        menu.layer.cornerRadius = 5.0
//        menu.layer.borderColor = UIColor.bg.cgColor
//        menu.layer.borderWidth = 1.0
//        menu.layer.masksToBounds = true
//        self.menu.isHidden = true
//        self.menu.delegate = self
//        self.view.addSubview(menu)
//    }
//    func showMenu(){
//        self.menu.isHidden = !self.menu.isHidden
//    }
//    func getIndex(_index: Int) {
//
//        switch _index {
//        case 0:
//            let vc = errorQuestionTableView()
//            vc.openClassId = self.openClassId;
//            vc.courseOpenId = self.courseOpenId;
//            vc.title = "错题集";
//            vc.isStu = true
//            vc.userInfo = self.userInfo
//            vc.hkIdOrExamId = self.examId
//            self.navigationController?.pushViewController(vc, animated: true)
//        default:
//            print(_index)
//        }
//
//        self.menu.isHidden = !self.menu.isHidden
//    }
    @objc func error(){
        let vc = WronghomeworkView()
        vc.openClassId = self.openClassId;
        vc.courseOpenId = self.courseOpenId;
        vc.title = "错题集";
        vc.isStu = true
        vc.hkIdOrExamId = self.examId
        self.isPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
    }
    var menu :ZQNavigationMenuView!
   
    lazy var courseOpenId: String = {
        return""
    }()
    lazy var openClassId: String = {
        return ""
    }()
    lazy var examStuId: String = {
        return ""
    }()
    lazy var examId: String = {
        return ""
    }()
    
    lazy var examTermTimeId: String = {
        return ""
    }()
    lazy var examTitle : String = {
        return ""
    }()

    lazy var isPushed:Bool = {
        return false
    }()
    let HX = common.share.returnSafeAreaLineHeight()
}

