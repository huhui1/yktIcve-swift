//
//  stuGuidanceTableViewController.swift
//  云课堂-职教云
//
//  Created by cc on 2018/3/26.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

extension stuGuidanceView{

    //下载
    @objc func download(){
        let cx = SQLiteManagerCache()
        let path = cx.readOneData(_userId: Account.defaultAccount.id!, docId: self.docId)
        if(path.docPath.isEmpty){
            let vc = cacheViewController();
            vc.docId = self.docId;
            vc.docUrl = JSON.init(parseJSON: self.navigationUrl)["urls"]["download"].string!;
            vc.docType = self.type.index(of:self.doctype)!
            vc.docTitle = self.docTitle;
            
            vc.isStart = true;
            self.navigationController?.pushViewController(vc, animated: true);
        }else{
            switch path.docType {
            case 1:
                let vc = generalVideoPlayView()
                vc.videourls.removeAll()
                vc.localurl = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                vc.isNet = true
                vc.videoName = path.docTitle
             
                self.navigationController?.pushViewController(vc, animated: true)
            case 2:
                let  vc = audioViewController();
                vc.audiourl = path.docPath
                vc.title = "播放音频"
                vc.tittlelab.text = path.docTitle
                vc.isNet = false;
                self.navigationController?.pushViewController(vc, animated: true)
            case 3:
                let vc = cachePreviewImgView()
                let fullPath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                vc.file =  fullPath
               
                self.navigationController?.pushViewController(vc, animated: true)
            case 4,5:
                self.openOffice(path: path);
            default:
               print("asxa")
                
            }
        }
    }
    public func documentInteractionControllerViewControllerForPreview(_ controller: UIDocumentInteractionController) -> UIViewController
    {
        //这个地方需要返回给一个控制器用于展现documentController在其上面，所以我们就返回当前控制器self
        return self
    }
    func openOffice(path:CacheDocModel){
        let sandboxFilePath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
        let docUrl = URL(fileURLWithPath: sandboxFilePath);
        documentController = UIDocumentInteractionController(url:docUrl)
        documentController.delegate = self;
        //当前APP打开  需实现协议方法才可以完成预览功能
        documentController.presentPreview(animated: true);
        
    }

    func refreshItemData(){
        let dict = ["courseOpenId":self.courseOpenId]
        Alamofire.request(appAPI.AssistTeacher_getCourseNavigation, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value{
                let json = JSON(value)
                if json["code"] == 1 {
                    self.docId = json["Id"].stringValue
                    self.docTitle = json["docTitle"].stringValue
                    self.imgurl = json["thumbnail"].stringValue
                    self.doctype = json["categoryName"].stringValue
                    self.navigationUrl = json["navigationUrl"].stringValue
                    common.share.setSDImg(str: self.imgurl, imgview: self.img_centent)
                    //下载
                    let downloadItem = UIBarButtonItem.init(title: "下载", style: UIBarButtonItemStyle.plain, target :self, action: #selector(self.download));
                    self.navigationItem.rightBarButtonItem = downloadItem;
                }else{
                 self.img_centent.image = UIImage.init(named: "data-none.png")
                }
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    }


    //打开观看
    @objc func pushView(sender: UITapGestureRecognizer){
        let json = JSON.init(parseJSON: self.navigationUrl)
        switch json["category"] {
        case "video":
            print("===")
//            let  vc = videoAVViewController();
//            vc.videourl =  json["urls"]["preview"].stringValue
//            vc.resourcesUrl = json
//            self.isPushed = true
//            self.navigationController?.pushViewController(vc, animated: true);
//
        case "mp3":
            print("===")
//            let  vc = audioViewController();
//            if(!json["urls"]["preview_oss_gen"].stringValue.isEmpty){
//                vc.audiourl = json["urls"]["preview_oss_gen"].stringValue
//            }else{
//                vc.audiourl = json["urls"]["preview"].stringValue
//            }
//            vc.title = "导学附件音频"
//            vc.isNet = true
//            self.isPushed = true
//            vc.hidesBottomBarWhenPushed = true
//            self.navigationController?.pushViewController(vc, animated: true)

        case "img":
            print("===")
            let vc = PicturePreviewView()
            vc.imgurl = json["urls"]["preview_oss_ori"].stringValue
            if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
                vc.imgurl = json["urls"]["preview"].stringValue
            }
            self.isPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "office","ppt","pptx","doc","docx":
            if(json["isH5"].intValue == 1){
                let vc = PPT_Animation_PreviewView()
                vc.isTeaching = false
                self.isPushed = true
                vc.isKJ = false
                vc.linkStr = json["h5PreviewUrl"].stringValue
                self.navigationController?.pushViewController(vc, animated: true)
            }else{
                let  vc = stuImage_ppt_wordPreviewVC()
                self.isPushed = true
                vc.isfirst = false
                vc.resourceUrl = self.navigationUrl.description
                self.navigationController?.pushViewController(vc, animated: true)
            }
        default:

            print("11")
        }
    }
}
