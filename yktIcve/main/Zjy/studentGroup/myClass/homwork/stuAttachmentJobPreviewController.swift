//
//  stuAttachmentJobPreviewController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/7/9.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
import SCLAlertView
extension stuAttachmentJobPreviewView {
    
    func getstuAttachmentJobPreview(){
        
        let dict = ["courseOpenId":self.courseOpenId,
                    "homeworkId":self.homeWorkId,
                    "openClassId":self.openClassId,
                    "homeworkStuId":self.homeworkStuId,
                    "stuId":Account.defaultAccount.id!] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_getStuFileHomeworkPreview, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let r = JSON(value)
                if r["code"] == 1{
                    self.setData(json: r)
                }else{
                    ZKProgressHUD.showMessage(r["msg"].string)
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showMessage("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
        
    }
    
    func setData(json:JSON){
        self.lab_title.text = json["data"]["homeworkTitle"].stringValue
        self.textComments.text = json["data"]["commentary"].stringValue
        self.stuAnswerText.text = json["data"]["stuRemark"].stringValue
        self.itemList1 = json["data"]["questions"].arrayValue
        self.itemList2 = json["data"]["stuAnswers"].arrayValue
        self.itemList3 = json["data"]["answer"].arrayValue
        self.itemList4 = json["data"]["commentaryFileData"].arrayValue
        if json["data"]["stuRemark"].stringValue.isEmpty{
            self.stuAnswerTextHt.constant = 0
        }else if self.itemList2.count <= 0{
            self.collectionAnswerHt.constant = 0
        }
        self.collectionFile.reloadData()
        self.collectionStuAnswer.reloadData()
        if json["data"]["state"].intValue != 2 {
            let lab = UILabel()
            lab.frame = CGRect(x:0, y:0, width:200,
                               height:40)
            lab.font = UIFont.systemFont(ofSize: 14)
            lab.text = "暂无参考答案"
            self.textComments.text = "暂无教师评语"
            self.collectionAnswer.addSubview(lab)
        }else{
            self.collectionAnswer.reloadData()
        }
        self.collectionComments.reloadData()
        
        
        
    }
    
    
    
    
    
    //通过附件Id
    func getFileById(Id:String){
        let dict = ["Id": Id]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_getFileHomeworkUrlById, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.pushpreviewVC(json: json)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    
    //通过URL获取
    func getFileInfoByUrl(url:String){
        let dict = ["url": url];
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.MobileLogin_getFileInfoByUrl, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    
                self.pushpreviewVC(json: json)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
        
    }
    
    //跳转到相应界面
    func pushpreviewVC(json:JSON){
        let type = json["categoryName"].stringValue
        let jsonUrl = JSON.init(parseJSON: json["url"].stringValue)
        switch type {
        case "视频":
            let vc = videoPlayView()
            vc.courseOpenId = self.courseOpenId
            vc.isFromZjyErrorQuestion = true
            vc.videourls.removeAll()
            //拼接URL
            for (key, value) in  jsonUrl["args"]{
                if jsonUrl["urls"]["preview_oss_gen"].stringValue.isEmpty{
                    if value.boolValue{
                        let videoUrl = "\(jsonUrl["urls"]["preview"].stringValue)/\(key).mp4"
                        vc.videourls.append(videoUrl)
                    }
                }else{
                    if value.boolValue{
                        let videoUrl = "\(jsonUrl["urls"]["preview_oss_gen"].stringValue)/\(key).mp4"
                        vc.videourls.append(videoUrl)
                    }
                }
                
            }
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "图片":
            let vc = PicturePreviewView()
            vc.imgurl = jsonUrl["urls"]["preview"].stringValue
            if(jsonUrl["urls"]["preview"].stringValue.isEmpty){
                vc.imgurl = json["urls"]["preview_oss_ori"].stringValue
            }
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
            //        case "图文":
            //            let vc = courseware_tuWenView()
            //            vc.courseOpenId = self.courseOpenId
            //            vc.openClassId = self.openClassId
            //            vc.hidesBottomBarWhenPushed = true
            //            self.navigationController?.pushViewController(vc, animated: true)
            //        case "压缩包":
            //            let vc = courseware_tuWenView()
            //            vc.courseOpenId = self.courseOpenId
            //            vc.openClassId = self.openClassId
            //            vc.hidesBottomBarWhenPushed = true
        //            self.navigationController?.pushViewController(vc, animated: true)
        case "音频":
            let vc = audioViewController()
            vc.courseOpenId = self.courseOpenId
            vc.openClassId = self.openClassId
            vc.isNet = true
            vc.isKJ = false
            if jsonUrl["urls"]["preview"].stringValue.isEmpty{
                let str = jsonUrl["urls"]["preview_oss_ori"].stringValue
                vc.audiourl = str.substring(toIndex: str.length - 9)
            }else{
                let str = jsonUrl["urls"]["preview"].stringValue
                vc.audiourl = str.substring(toIndex: str.length - 9)
            }
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "ppt":
            if(jsonUrl["isH5"] != 1){
                let vc = stuImage_ppt_wordPreviewVC()
                vc.courseOpenId = self.courseOpenId
                vc.openClassId = self.openClassId
                vc.isfirst = false
                vc.resourceUrl = json["url"].stringValue
                self.isPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
            }else{
                let vc = PPT_Animation_PreviewView()
                vc.courseOpenId = self.courseOpenId
                vc.openClassId = self.openClassId
                vc.linkStr = jsonUrl["h5PreviewUrl"].stringValue
                self.isPushed = true
                vc.hidesBottomBarWhenPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
            }
        case "文档":
            let vc = stuImage_ppt_wordPreviewVC()
            vc.courseOpenId = self.courseOpenId
            vc.openClassId = self.openClassId
            vc.isfirst = false
            vc.resourceUrl = json["url"].stringValue
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
            
        default:
            SCLAlertView().showInfo("温馨提示！", subTitle: "暂不支持打开,请从网页查看",closeButtonTitle: "确定")
            
        }
    
    }
    
}
