//
//  stuAttachmentHomeworkView.swift
//  云课堂-职教云
//
//  Created by zqy on 2018/3/28.
//  Copyright © 2018年 zqy. All rights reserved.
//
//
import UIKit
import WebKit
import SwiftyJSON

class stuAttachmentHomeworkView : UIViewController,WKScriptMessageHandler {
    let appDelegate = UIApplication.shared.delegate as! AppDelegate
    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = self.homeworktitle
        self.view.backgroundColor = UIColor.white
        self.setFootUI()
        self.setWebViewUI()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        
    }
    
    //设置H5页面
  fileprivate  func setWebViewUI(){
        
        let path = Bundle.main.path(forResource: "attachmentHomework", ofType: ".html",
                                    inDirectory: "HTML5/src/student/assignment");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
    
    
    
    
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:width,
                           height:UIScreen.main.bounds.height - 110 + CGFloat(2 * HX))
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //        theWebView.scrollView.bounces = false;
        //        theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
        
    }

    fileprivate func setFootUI(){
      
        self.view.addSubview(self.saveBtn)
        self.saveBtn.snp.makeConstraints { (make) in
            make.width.equalTo(width / 2)
            make.height.equalTo(50)
            make.left.equalTo(0)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
        }
        self.view.addSubview(self.submitBtn)
        self.submitBtn.snp.makeConstraints { (make) in
            make.width.equalTo(width / 2)
            make.height.equalTo(saveBtn.snp.height)
            make.centerY.equalTo(saveBtn.snp.centerY)
            make.left.equalTo(saveBtn.snp.right)
        }
    }

    override func viewWillAppear(_ animated: Bool) {
        self.tabBarController?.tabBar.isHidden = true//隐藏tabbar
    }
    
    
    //返回处理h5清除页面，防内存溢出
    override func viewWillDisappear(_ animated: Bool) {
        if(!self.isPushed){
            theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        }
        self.isPushed = false
    }
    
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "load" ){
            self.theWebView.evaluateJavaScript("attachmentHomewok.getparameter('\(self.courseOpenId)','\(self.openClassId)','\(self.homeWorkId)','\(self.homeworkTermTimeId)','\(Account.defaultAccount.id!)','\(Account.defaultAccount.id!)','\(self.homeworkStuId)')",
                completionHandler: nil)
        }else if(sentData["method"] == "doneSuccess"){
            ZKProgressHUD.showMessage("提交成功")
            self.doneSuccess()
        }else if(sentData["method"] == "getUrlById"){
            self.getFileById(Id:sentData["Id"]!)
        }else if(sentData["method"] == "uploadImg"){
            self.isPushed = true
            self.uploadImg()
        }else if(sentData["method"] == "getUrlByUrl"){
            self.getFileInfoByUrl(url: sentData["url"]!)
        }
    }
    
   
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()

    lazy  var saveBtn : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitle("保存草稿", for: .normal)
        btn.tag = 1
        btn.backgroundColor = UIColor.colorWithHex(hexColor: 0x23c397)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action:  #selector(self.saveHomework(_:)), for: .touchUpInside)
        return btn ;

    }()

    lazy  var submitBtn : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        btn.setTitle("提交作业", for: .normal)
        btn.tag = 0
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action:  #selector(self.saveHomework(_:)), for: .touchUpInside)
        return btn ;

    }()
    
   
    fileprivate let width = UIScreen.main.bounds.width;
    lazy var courseOpenId: String = {
        return""
    }()
    lazy var openClassId: String = {
        return ""
    }()
    lazy var homeWorkId: String = {
        return ""
    }()
    lazy var homeworkTermTimeId: String = {
        return ""
    }()
    lazy var homeworktitle: String = {
        return ""
    }()
    lazy var homeworkStuId: String = {
        return ""
    }()

    lazy var isPushed:Bool = {
        return false
    }()

    lazy var uploadUrl : String = {
        return ""
    }()
    let HX = common.share.returnSafeAreaLineHeight()


    
}


