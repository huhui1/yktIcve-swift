//
//  courseBBSDetailsViewController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/3/30.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension CourseBBSDetailsView {


    //获取当前主题下回复
    func getCellBBSReplyList(){
        let dict = ["Id": evaluation.Id]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.BBS_getCellBBSReplyList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.theWebView!.evaluateJavaScript("list.get(\(json))",
                                                        completionHandler: nil)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //对主题进行回复
    func reply(userId:String,userDisplyName:String){
        let vc = replyCourseBBSView()
        self.isPushed = true
        vc.openClassId = self.openClassId
        vc.courseOpenId = self.courseOpenId
        vc.cellId = self.cellId
        vc.respondToPeopleId = userId
        vc.respondToPeopleName = userDisplyName
        vc.replyId = evaluation.Id
     
        self.navigationController?.pushViewController(vc, animated: true)
    }

    func delBBS(Id:String,userId:String){
        if userId != Account.defaultAccount.id!{
            ZKProgressHUD.showMessage("不可删除他人的回复！")
            return
        }
        let dict = ["Id": Id,
                    "userId":Account.defaultAccount.id!,
                    "activeType":self.activeType,
                    "delType":2] as [String : Any]
      
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.BBS_deleteComment, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    ZKProgressHUD.showMessage(json["msg"].stringValue)
                    self.reloadParentVC()
                    self.getCellBBSReplyList()
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    //确认删除
    @objc func isDelete(){
        let alertController = UIAlertController(title: "提示",
                                                message:"是否删除？", preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style:.default, handler: {
            action in
            self.isTeachaer()
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)
        self.present(alertController, animated: true, completion: nil)
        
    }
    //删除判断
    func isTeachaer(){
        if isMainTeacher == 1{
            self.deleleBBS()
        }else{
            if evaluation.userId != Account.defaultAccount.id!{
                ZKProgressHUD.showMessage("无法删除他人创建的主题！")
                return
            }else{
                self.deleleBBS()
            }
        }
    }
    
    //删除主题
    @objc func deleleBBS(){
        
//        if evaluation.userId != Account.defaultAccount.id!{
//            ZKProgressHUD.showMessage("无法删除他人创建的主题！")
//            return
//        }else{
            let dict = ["Id": evaluation.Id,
                        "userId":Account.defaultAccount.id!,
                        "activeType":self.activeType,
                "delType":1] as [String : Any]
            XLBallLoading.show(in: self.view)
            Alamofire.request(appAPI.BBS_deleteComment, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if json["code"] == 1{
                        ZKProgressHUD.showMessage(json["msg"].stringValue)
                        self.reloadParentVC()
                        self.navigationController?.popViewController(animated: true)
                    }else{
                        ZKProgressHUD.showMessage(json["msg"].stringValue);
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！");
                    XLBallLoading.hide(in: self.view)
                }
            }
//        }
    }


    fileprivate  func reloadParentVC(){

        self.courseBBSAction?.actionType = self.activeType
        self.courseBBSAction?.ActionName = "refresh"
    }
}
