//
//  stuDisscussView.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/15.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

class stuDisscussView: UIViewController,UINavigationControllerDelegate{
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "讨论区"
        self.getDiscussReplyList(isRefresh: true)
        self.setTableView()
        self.setBtnUI()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        // Do any additional setup after loading the view.
    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func setBtnUI(){
        self.view.addSubview(self.replyBtn)
        let HX = common.share.returnSafeAreaLineHeight()
        self.replyBtn.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.left.left.equalTo(0)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
            make.height.equalTo(40)
        }
        self.replyBtn.addTarget(self, action: #selector(self.replyDiscuss), for: .touchUpInside)
        if type == 3{
            self.replyBtn.isHidden = true
        }
    }
    
    //移除监听
    override func viewWillDisappear(_ animated: Bool) {
       
        
    }
    var stuIdList  = [String]()
    var isrefreshcollectionView:Bool = true
    var socre:Int = 0
    //存储选中单元格的索引
    //用来放置各个图片单元
    var collectionView:UICollectionView!
    //collectionView的布局
    var collectionViewLayout: UICollectionViewFlowLayout!
    lazy var replyList = [JSON]()
    var data = JSON()
    var imgList = [UploadDocModel]()
    let maxImgCount = 9
    lazy var hx = (UIScreen.main.bounds.height - 400) > 310 ? 310: (UIScreen.main.bounds.height - 400)
    lazy var state : Int = {return 0}()
    lazy var openCourseId = "";
    lazy var topheight:CGFloat = 0;
    lazy var discussId:String = {
        return ""
    }()
    lazy var activityId:String = {
        return ""
    }()
    lazy var courseOpenId:String = {
        return ""
    }()
    lazy var user :String = {return ""}()
    lazy var creatorId:String = {
        return ""
    }()
    lazy var status :String = {
        return ""
    }()
    lazy var openClassId :String = {
        
        return ""
    }()
    var ht = 0
    //判断已结束还进行中，0已结束，1进行中
    var type = 1
    
    lazy var lineview : UIView = {
        let view = UIView()
        return view
    }()
    lazy var bgview : UIView = {
        let view = UIView()
        view.isHidden = true
        return view
    }()
    lazy var isPushed :Bool = {return false}()
    lazy var headView : BBSHeadView = {
        let view = BBSHeadView()
        view.deletegate = self
        return view
    }()
    lazy var replyBtn :UIButton = {
        let btn = UIButton()
        btn.setTitle("回复评论", for: .normal)
        btn.setTitleColor(UIColor.black, for: .normal)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        return btn
    }()

    var reloaddiscussListClosure :(() ->Void)?
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    var tableView : UITableView!
}
extension stuDisscussView:BBSHeadViewDelegate,UITableViewDelegate,UITableViewDataSource{
    
    func setTableView(){
        if(common.share.isX()){
            ht = 45
        }
        self.tableView = UITableView.init(frame: CGRect(x:0, y:0, width:width, height:UIScreen.main.bounds.height - 110 - CGFloat(ht)))
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        self.tableView.delegate = self
        self.tableView.dataSource = self
        tableView.separatorInset = UIEdgeInsets.zero;
        tableView.layoutMargins = UIEdgeInsets.zero;
        //ipad
        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        }
        self.tableView.estimatedRowHeight = 44.0;
        //rowHeight属性设置为UITableViewAutomaticDimension
        self.tableView.rowHeight = UITableViewAutomaticDimension;
        
        self.tableView.register(UINib.init(nibName: "DiscussInfoIngCell", bundle: Bundle.main), forCellReuseIdentifier: "DiscussCell")
        self.view.addSubview(self.tableView)
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock:{
            self.isrefreshcollectionView = false
            self.getDiscussReplyList(isRefresh: false)
        })
    }
    func numberOfSections(in tableView: UITableView) -> Int {
        return 1
    }
    
    
    
    
    //返回表格行数（也就是返回控件数）
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.replyList.count;
    }
    
    
    //创建各单元显示内容(创建参数indexPath指定的单元）
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
        let jsondata = JSON(self.replyList[indexPath.row])
        let identifier = jsondata["docJson"].count > 0 ? "cell1":"cell2"
        self.tableView.register(UINib.init(nibName: "DiscussInfoIngCell", bundle: Bundle.main), forCellReuseIdentifier: identifier)
        
        let cell : DiscussInfoIngCell =  self.tableView.dequeueReusableCell(withIdentifier: identifier, for: indexPath) as! DiscussInfoIngCell
        
        cell.setReply(reply: jsondata)
        
        cell.contentImg.tag = indexPath.row
        let taget = UITapGestureRecognizer(target:self, action:#selector(self.touchImg(gestureRecognizer:)))
        taget.numberOfTapsRequired = 1
        cell.contentImg.isUserInteractionEnabled = true
        cell.contentImg.addGestureRecognizer(taget)
        return cell
    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        self.showReplyInfo(info: self.replyList[indexPath.row].description)
    }
    
    func BBSHeadView_viewMore(height: CGFloat) {
        
        self.headView.frame = CGRect.init(x: 0, y: 0, width: width, height: self.headView.frame.size.height + height )
        self.headView.numberline = 0
        self.headView.setData(json: self.data["discussInfo"])
        self.tableView.tableHeaderView = self.headView
        
        self.tableView.reloadData()
    }
    
    func BBSHeadView_backImgUrl(str: String) {
        let vc = PicturePreviewView()
        vc.imgurl = str
        self.isPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
    }
    
}



