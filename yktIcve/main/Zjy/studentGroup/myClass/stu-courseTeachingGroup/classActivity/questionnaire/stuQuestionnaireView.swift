//
//  stuQuestionnaireView.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/4/17.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON
class stuQuestionnaireView: UIViewController,WKScriptMessageHandler {


    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.setFootUI()
        self.setWebUI()

        // Do any additional setup after loading the view.
    }

    //  设置网页
    fileprivate func  setWebUI(){

        var th = 0
        if(self.navigationController == nil){
            th = 60
        }
        let path = Bundle.main.path(forResource: "questionSurway", ofType: ".html",
                                    inDirectory: "HTML5/src/student/questionnaire");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);

        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")

        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)

        let frame = CGRect(x:0, y:CGFloat(th), width:width,
                           height:UIScreen.main.bounds.height - 110 + CGFloat(2 * HX))
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //                theWebView.scrollView.bounces = false;
        //                theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);

    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    //响应处理js那边的调用
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>

        if(sentData["method"] == "load" ){

            self.getdata()
        }else if(sentData["method"] == "showMsg"){

            ZKProgressHUD.showMessage(sentData["msg"]!)
        }else if(sentData["method"] == "save"){
            self.isSave(data: sentData["data"]!, msg: sentData["msg"]!)
        }
    }

    fileprivate func setFootUI(){


        let saveItem = UIBarButtonItem.init(title: "提交", style: UIBarButtonItemStyle.plain, target: self, action: #selector(self.save));
        self.navigationController?.navigationBar.tintColor = UIColor.white
        self.navigationItem.rightBarButtonItem = saveItem;
        self.view.addSubview(self.Btn_up)
        self.view.addSubview(self.Btn_down)
        self.Btn_up.snp.makeConstraints { (make) in
            make.width.equalTo(UIScreen.main.bounds.width / 2)
            make.height.equalTo(50)
            make.left.equalTo(0)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
        }

        self.Btn_down.snp.makeConstraints { (make) in
            make.width.height.equalTo(Btn_up)

            make.centerY.equalTo(Btn_up.snp.centerY)
            make.left.equalTo(Btn_up.snp.right)
        }
    }
    //返回处理h5清除页面，防内存溢出
    override func viewWillDisappear(_ animated: Bool) {

        theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")


    }
    
    fileprivate lazy  var Btn_up : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitle("上一题", for: .normal)
        btn.tag = 1
        btn.backgroundColor = UIColor.colorWithHex(hexColor: 0x23c397)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action: #selector(self.switchQuestion(_:)), for: .touchUpInside)
        return btn ;

    }()

    fileprivate lazy  var Btn_down : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        btn.setTitle("下一题", for: .normal)
        btn.tag = 2
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action: #selector(self.switchQuestion(_ :)), for: .touchUpInside)
        return btn ;
    }()

    lazy var theWebView:WKWebView = {
        let WK = WKWebView()

        return WK
    }()
    fileprivate lazy var width = UIScreen.main.bounds.width
    lazy var activityId = ""
    lazy var openClassId = ""
    lazy var courseOpenId = ""
    lazy var questionnaireId = ""
    lazy var creatorId = ""
    lazy var user = ""
   
    var index = 0
    var total = 1;
    let HX = common.share.returnSafeAreaLineHeight()
    fileprivate lazy var Btn_reply :UIButton = {
        let btn = UIButton()
        btn.setTitle("提交", for: .normal)
        btn.setTitleColor(UIColor.colorWithHex(hexColor: 0x333), for: .normal)
        btn.backgroundColor = UIColor.clear
        btn.setTitleColor(UIColor.white, for: .normal)
        return btn
    }()
    

    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
