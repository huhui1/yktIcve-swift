//
//  stuQuestionnaireViewController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/4/17.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import SwiftyJSON
import  Alamofire

extension stuQuestionnaireView{

  @objc  func switchQuestion(_ btn :UIButton){

        let tag = btn.tag
        if(tag == 1){
            if(self.index == 0){
                ZKProgressHUD.showMessage("已经是第一题")
            }else{
                self.index  -= 1;

                self.theWebView.evaluateJavaScript("questionSurway.prev()",
                                                   completionHandler: nil)
            }

        }else {

            if(self.index == self.total - 1){

                 ZKProgressHUD.showMessage("已经是最后一题")

            }else{
                self.index  += 1;
                self.theWebView.evaluateJavaScript("questionSurway.next()",
                                                   completionHandler: nil)
            }

        }
        self.title = "(\(self.index + 1)  / \(self.total))"

    }


   @objc func save(){
        if(self.index == self.total - 1){
            self.theWebView.evaluateJavaScript("questionSurway.next()",
                                           completionHandler: nil)
        }
        self.theWebView.evaluateJavaScript("questionSurway.submitQuestion()",
                                           completionHandler: nil)

    }

    func getdata(){

        let dict = ["activityId": self.activityId,"questionnaireId":self.questionnaireId]
//        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
//
//        ZKProgressHUD.show();
        
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_getQuestionnaireData, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

//                    ZKProgressHUD.hide()
                    self.total  = json["questionList"].count

                    self.title = "\(self.index + 1) / \(self.total)"
                    
                    self.theWebView.evaluateJavaScript("questionSurway.get(\(json),'\(Account.defaultAccount.id!)','\(self.activityId)','\(self.openClassId)','\(self.questionnaireId)');",
                        completionHandler: nil)

                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }

    //是否提交
    func isSave(data:String,msg:String){
        let alertController = UIAlertController(title: "提交问卷调查",
                                                message: msg, preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style: .default, handler: {
            action in
            self.saveStuQuestionnaire(data: data)
        })

        alertController.addAction(okAction)
        alertController.addAction(cancelAction)
        self.present(alertController, animated: true, completion: nil)

    }

    //提交问卷
  fileprivate  func  saveStuQuestionnaire(data:String){

        let dict = ["data":data]
        //        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
//
//        ZKProgressHUD.show();
            XLBallLoading.show(in: self.view)
    
        Alamofire.request(appAPI.FaceTeach_saveStuQuestionnaire, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

                   self.reloadParent()
//                    ZKProgressHUD.hide()
                    
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }


    }

    fileprivate func reloadParent(){

        let count = self.navigationController?.viewControllers.count
        if  let vc :activityTableView  = self.navigationController?.viewControllers[count! - 2] as? activityTableView {
            vc.refreshItemData(isRefresh: false)
        }
        self.navigationController?.popViewController(animated: true)
    }
    
}
