//
//  stuJoinGroupPkController.swift
//  yunketang
//
//  Created by 尤增强 on 2018/2/24.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

extension stuJoinGroupPkTableView {


 //获取数据信息
    func getGroupInfo(){

        let dict = ["stuId": Account.defaultAccount.id!,
                    "groupId":self.groupId,
                    "PKId":self.PKId]

         XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_getFaceGroupStuList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.groupStuId = json["groupStuId"].stringValue
                    self.isJoinGroup = json["isJoinGroup"].intValue
                    self.list = json["groupStuList"].arrayValue as NSArray
                    self.fetchCoverDetails()
                    self.isJoinGroups()
                    
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }


    }

    //数据处理
    func  fetchCoverDetails(){


//        for i in 0..<self.list.count {
//            let stuinfo = JSON(self.list[i])
//        }

        if(self.list.count > 0){
            self.setTableviewUI()
        }else{
            self.setNodata()
        }
        self.tableView?.reloadData();
    }

    //判断学生是加入小组还是退出
   @objc func joinOrExist(_ btn :UIButton){

        if(btn.isSelected){
            self.exist()
        }else{
            self.join()
        }

    }

    //学生退出小组
    func exist(){
        let dict = ["groupId":self.groupId,
                    "groupStuIds":self.groupStuId,
                    "userType": 1
                    ] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_delFaceGroupStu, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    ZKProgressHUD.showMessage(json["msg"].stringValue)
                    self.reloadClosure!()
                    self.getGroupInfo()
                }else{
                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //学生加入小组
    func join(){
        let studata=[ "StuId" : Account.defaultAccount.id!,
                      "StuName":Account.defaultAccount.displayName!,
                      "StuNo":Account.defaultAccount.number!,
                      "OpenClassId":self.openClassId,
                      "AvatorUrl":""]
        var list = [Dictionary<String, String>]()
        list.append(studata )
        let  jso = JSON.init(list)
        let dict = ["PKId":self.PKId,"groupId":self.groupId,"stuData":jso,"userType":1,"sourceType":3,"isJoinGroup":self.isJoinGroup] as [String : Any]
        Alamofire.request(appAPI.FaceTeach_addFaceGroupStu, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    ZKProgressHUD.showMessage(json["msg"].stringValue)
                    self.reloadClosure!()
                    self.getGroupInfo()
                }else{
                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                }
                
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
        


    }


}
