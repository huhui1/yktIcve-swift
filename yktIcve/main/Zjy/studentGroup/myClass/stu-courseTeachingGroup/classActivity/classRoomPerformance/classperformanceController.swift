//
//  classperformanceController.swift
//  云课堂-职教云
//
//  Created by 志辉教育 on 2018/4/2.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
import SnapKit
extension classperformanceView {
    
    func  getStuSummary() {
        XLBallLoading.show(in: self.view)
        let dict = ["courseOpenId": self.courseOpenId,
                    "openClassId":self.openClassId,
                    "activityId":self.activityId,
                    "stuId":Account.defaultAccount.id!] as [String:Any];
        Alamofire.request(appAPI.FaceTeach_getStuSummary, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value);
                if json["code"] == 1{
                   self.usernameAndscore = json["stuInfo"].dictionaryObject!
                   self.sumScore = json["totalScore"].intValue
                    self.setProcessInfo(list: json["list"].arrayValue as NSArray)
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    
    func setProcessInfo (list:NSArray){
        self.ProcessIn.removeAll()
        for i in 0..<list.count{
            let json = JSON(list[i])
            let pro = stuInfo(id:json["id"].stringValue,
                                      dateCreated:json["dateCreated"].stringValue,
                                      dataType:json["dataType"].stringValue,
                                      stuId:json["stuId"].stringValue,
                                      stuName:json["stuName"].stringValue,
                                      score:json["score"].stringValue,
                                      title:json["title"].stringValue)
            self.ProcessIn.append(pro)
        }
        if(list.count == 0){
        common.share.setTableFootView_noData(self.tableView, list: list)
        }
        else{
        self.lab_userName.text = "\(usernameAndscore["Name"] as! String)"
        self.lab_useId.text =  "\(usernameAndscore["StuNo"] as! String)"
        self.lab_zongfen.text = "总分:"
        self.lab_sumscore.text = "\(sumScore)"
        common.share.setSDImg(str:Account.defaultAccount.avatar!, imgview: self.img_user)
        sethandAndfootView()
        }
        self.tableView.reloadData()
    }
    func sethandAndfootView(){
        let headView = UIView.init(frame:
            CGRect(x:0, y:20, width:tableView!.frame.size.width, height:90))
        headView.addSubview(img_user)
        headView.addSubview(lab_userName)
        headView.addSubview(lab_useId)
        headView.addSubview(lab_zongfen)
        headView.addSubview(lab_sumscore)
        self.img_user.snp.makeConstraints { (make) in
            make.width.height.equalTo(70)
            make.left.equalTo(35)
            make.top.equalTo(20)
        }
        img_user.layer.cornerRadius = 35
        img_user.layer.borderWidth = 2
        img_user.layer.borderColor = UIColor.bg.cgColor
        
        self.lab_userName.snp.makeConstraints { (make) in
            make.width.equalTo(width / 2 - 50)
            make.height.equalTo(15)
            make.top.equalTo(self.img_user.snp.top).offset(20)
            make.left.equalTo(self.img_user.snp.right).offset(5)
        }
        self.lab_useId.snp.makeConstraints { (make) in
            make.width.equalTo(100)
            make.height.equalTo(20)
            make.top.equalTo(self.lab_userName)
            make.left.equalTo(self.lab_userName.snp.right).offset(5)
        }
        self.lab_zongfen.snp.makeConstraints { (make) in
            make.width.height.left.equalTo(self.lab_userName)
            make.top.equalTo(self.lab_userName.snp.bottom).offset(5)
        }
        self.lab_sumscore.snp.makeConstraints { (make) in
            make.width.height.left.equalTo(self.lab_useId)
            make.top.equalTo(self.lab_userName.snp.bottom).offset(5)
        }
        tableView?.tableHeaderView = headView
        
        let footerView = UIView.init(frame:
            CGRect(x:0, y:20, width:tableView!.frame.size.width, height:60))
        let footerlabel = UILabel()
        footerlabel.layer.masksToBounds = true
        footerlabel.layer.cornerRadius = 20
        footerlabel.textAlignment = .center
        footerlabel.font = UIFont.init(name: "iconfont", size: 40)
        footerlabel.text = "\u{e668}"
        footerlabel.textColor = .bg
        footerView.addSubview(footerlabel)
        
        let label = UILabel()
        label.font = UIFont.systemFont(ofSize: 14)
        label.text = "结束"
        footerView.addSubview(label)
        footerlabel.snp.makeConstraints { (make) -> Void in
            make.left.equalTo(50)
            make.top.equalTo(0)
            make.width.height.equalTo(40)
        }
        label.snp.makeConstraints { (make) -> Void in
            make.left.equalTo(footerlabel.snp.right).offset(5)
            make.width.height.equalTo(40)
            make.top.equalTo(0)
        }
        
        footerView.backgroundColor = UIColor.white
        tableView?.tableFooterView = footerView
    }
}


