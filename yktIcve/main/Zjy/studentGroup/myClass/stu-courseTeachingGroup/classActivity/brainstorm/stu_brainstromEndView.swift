//
//  stu_brainstromEndView.swift
//  云课堂-职教云
//  头脑风暴已结束
//  Created by 尤增强 on 2018/3/7.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON

class stu_brainstromEndView : UIViewController,WKScriptMessageHandler {
    
    let width = UIScreen.main.bounds.width;
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "头脑风暴"
        self.setWebViewUI()
        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))

        self.navigationItem.leftBarButtonItem = item


        common.share.setBackButtonItem(item:item)
        // Do any additional setup after loading the view.
    }

    @objc  func backBtnClick(){

    theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")

        self.navigationController?.popViewController(animated: true)
    }
    
    func setWebViewUI(){
        let path = Bundle.main.path(forResource: "brainstorm", ofType: ".html",
                                    inDirectory: "HTML5/src/student/stubrainstorm");
        
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self , name: "interOp")
        //将浏览器视图全屏(在内容区域全屏，不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:width, height:UIScreen.main.bounds.height)
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    //响应处理js那边的调用
    func userContentController(_ userContentController: WKUserContentController, didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        if(sentData["method"] == "load" ){
            self.getBrainStrom()
           
        }else if(sentData["method"] == "brainDetails"){

            let vc = stormDetailsView()
            let m = self.brainStormInfos[Int(sentData["index"]!)!]
            vc.brainstorm = m
            vc.isStu = true
            self.navigationController?.pushViewController(vc, animated: true)

        }else if (sentData["method"] == "previewImg"){

            let vc = PicturePreviewView()
            vc.imgurl = sentData["url"]!
            self.navigationController?.pushViewController(vc, animated: true)
        }
    }
    

    
    lazy var courseOpenId :String = {
        
        return ""
    }()
    lazy var creatorId :String = {
        
        return ""
    }()
    lazy var json : JSON =  {
        return []
    }()
    lazy var openClassId :String = {
        
        return ""
    }()
    lazy var activityId :String = {
        
        return ""
    }()
    lazy var brainStormId :String = {
        
        return ""
    }()
    var brainStormInfos = [stuBrainStormInfo]()
    
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()

    
}
