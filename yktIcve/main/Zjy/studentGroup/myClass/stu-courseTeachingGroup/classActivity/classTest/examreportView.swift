//
//  examreportView.swift
//  yunketang
//
//  Created by zqy on 2018/3/5.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON

class examreportView: UIViewController,WKScriptMessageHandler {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "测验报告"
        self.setWebViewUI()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        // Do any additional setup after loading the view.
    }
    
    //设置H5页面
    func setWebViewUI(){
        
        let path = Bundle.main.path(forResource: "examreport", ofType: ".html",
                                    inDirectory: "HTML5/src/student/class");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height-60 + CGFloat(HX))
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //              theWebView.scrollView.bounces = false;
        //                theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
        
    }
    
    
    
    //返回处理h5清除页面，防内存溢出
        override func viewWillDisappear(_ animated: Bool) {
            if(!self.isPused){
                theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
            }
            self.isPused = false
        }

    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "load" ){

            self.getStuAnswerList()
        }else if(sentData["method"] == "singleTitleRecord"){
            self.errorTitleParsing(data:sentData["extrasData"]!)
        }else if(sentData["method"] == "allTitleRecord"){
            self.errorTitleParsing(data:sentData["extrasData"]!)
        }else if(sentData["method"] == "singleRecord"){
        self.singleErrorTitleParsing(data:sentData["extrasData"]!,index:sentData["start"]!)
        }else if(sentData["method"] == "showMsg"){
            ZKProgressHUD.showMessage(sentData["msg"]!)
            return
        }
    }
    
    
    /*
     // MARK: - Navigation
     
     // In a storyboard-based application, you will often want to do a little preparation before navigation
     override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
     // Get the new view controller using segue.destinationViewController.
     // Pass the selected object to the new view controller.
     }
     */
    var list :NSMutableArray = [];
    lazy var data :String={return ""}();
    lazy var activityId = "";
    lazy var openClassId = "";
    lazy var courseOpenId = "";
    lazy var examId = "";
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()
    lazy var isPushed:Bool = {
        return false
    }()
    var stuId = Account.defaultAccount.id!
    lazy var isPused  :Bool = {return false}()
    let HX = common.share.returnSafeAreaLineHeight()
}
