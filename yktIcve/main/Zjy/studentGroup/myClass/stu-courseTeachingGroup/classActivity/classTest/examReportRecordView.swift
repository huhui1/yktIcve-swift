//
//  examReportRecordView.swift
//  yunketang
//
//  Created by zqy on 2018/3/8.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import WebKit
import Alamofire
import SwiftyJSON
class examReportRecordView: UIViewController,WKScriptMessageHandler {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "错题解析"
        self.setWebViewUI()
        
        // Do any additional setup after loading the view.
    }
    
    //设置H5页面
    func setWebViewUI(){
        
        let path = Bundle.main.path(forResource: "examReportRecord", ofType: ".html",
                                    inDirectory: "HTML5/src/student/class");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height-60 + CGFloat(HX))
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //              theWebView.scrollView.bounces = false;
        //                theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
        
    }
    
    
    
    //返回处理h5清除页面，防内存溢出
    override func viewWillDisappear(_ animated: Bool) {
        if(!self.isPushed){
        theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        }
        self.isPushed = false
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "load" ){
            self.theWebView.evaluateJavaScript("examhandle.getparameter(\(self.errorQuestionList),'\(self.index)')",
                completionHandler: nil)
        }else if(sentData["method"] == "previewIMG"){

            self.showPreviewImg(url:sentData["url"]!)
        }else if(sentData["method"] == "previewfile"){
            self.getFileByUrl(URL: sentData["url"]!)
        }else if(sentData["method"] == "showMsg"){
            ZKProgressHUD.showMessage(sentData["msg"]!)
            return
        }
    }

    //通过附件url
    func getFileByUrl(URL:String){
        let dict = ["url": URL]
        
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.MobileLogin_getFileInfoByUrl, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    
                    self.pushView(data: json["url"].stringValue)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }

    func showPreviewImg(url:String){
       let vc = PicturePreviewView()
        vc.imgurl = url
        self.isPushed = true
        self.navigationController?.pushViewController(vc, animated: true);
    }

    //打开观看
    func pushView(data:String){
        let json = JSON.init(parseJSON: data)
        switch json["category"] {
        case "video":
//            let  vc = videoAVViewController();
//            vc.videourl =  json["urls"]["preview"].stringValue
//            vc.resourcesUrl = json
//            self.isPushed = true
//            self.navigationController?.pushViewController(vc, animated: true);
            print("video")

        case "mp3":
            let  vc = audioViewController();
          
            if(!json["urls"]["preview_oss_gen"].stringValue.isEmpty){
                vc.audiourl = json["urls"]["preview_oss_gen"].stringValue
            }else{
                vc.audiourl = json["urls"]["preview"].stringValue
            }
            vc.title = "作业附件音频"
            vc.isNet = true
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)

        case "img":
//            let vc = whiteboardView()
//            vc.imgurl = json["urls"]["preview_oss_ori"].stringValue
//            if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
//                vc.imgurl = json["urls"]["preview"].stringValue
//            }
//            self.isPushed = true
//            present(vc, animated: true, completion: nil)
            let vc = PicturePreviewView()
            vc.imgurl = json["urls"]["preview_oss_ori"].stringValue
            if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
                vc.imgurl =  json["urls"]["preview"].stringValue
            }
            self.isPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "office","ppt","pptx","doc","docx":
//            let  vc = previewOfficeFromresViewController()
//            self.isPushed = true
//            vc.resourceUrl = data
//            present(vc, animated: false, completion: nil)
            if(json["isH5"].intValue == 1){
                let vc = PPT_Animation_PreviewView()
                self.isPushed = true
                vc.linkStr = json["h5PreviewUrl"].stringValue
                vc.hidesBottomBarWhenPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
            }else{
                let  vc = stuImage_ppt_wordPreviewVC()
                vc.resourceUrl = data
                vc.isfirst = false
                self.isPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
            }
        default:

            print("11")
        }
    }

    

    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()
    lazy var errorQuestionList:String = {
        return ""
    }()
    lazy var isPushed  :Bool = {return false}()
    lazy var index:Int = {
        return 0
    }()
    let HX = common.share.returnSafeAreaLineHeight()
}
