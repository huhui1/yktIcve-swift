//
//  stuPreviewVoteResultView.swift
//  云课堂职教云
//
//  Created by zqy on 2018/4/4.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import WebKit
import Alamofire
import SwiftyJSON
class stuPreviewVoteResultView: UIViewController,WKScriptMessageHandler {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.setWebViewUI()
    }
    
    //设置H5页面
    func setWebViewUI(){

        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))

        self.navigationItem.leftBarButtonItem = item

        common.share.setBackButtonItem(item:item)

        let path = Bundle.main.path(forResource: "stuPreviewVote", ofType: ".html",
                                    inDirectory: "HTML5/src/student/vote");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height-60)
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //        theWebView.scrollView.bounces = false;
        //        theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
        
    }
    

    @objc func backBtnClick(){

     theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        self.navigationController?.popViewController(animated: true)
    }
    

    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        if(sentData["method"] == "load" ){
            self.getFaceTeachVoteResult()
        }else if(sentData["method"] == "previewImg"){
            self.previewImg(url: sentData["url"]!)
        }
    }
    func previewImg (url:String){

        let vc = PicturePreviewView()
         vc.imgurl = url

        self.navigationController?.pushViewController(vc, animated: true)
    }
    func getFaceTeachVoteResult(){
        let dict = ["voteId":self.voteId,"stuId":Account.defaultAccount.id!] as [String:Any]
        Alamofire.request(appAPI.FaceTeach_getFaceTeachVoteResult, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"] == 1){
                    self.theWebView.evaluateJavaScript("stuPreviewVote.get(\(json))",
                        completionHandler: nil)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
        
    }
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()

    lazy var voteId: String = {
        return""
    }()
    lazy var openClassId: String = {
        return""
    }()
}

