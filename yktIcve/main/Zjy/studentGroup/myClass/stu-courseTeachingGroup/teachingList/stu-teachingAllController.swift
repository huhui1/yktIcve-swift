//
//  stu-teachingAllController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/30.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension stu_teachingAllView {
    func getallface(date:String,isRefresh:Bool){
        let dict =
            ["stuId":Account.defaultAccount.id!,
             "courseOpenId":self.courseOpenId,
             "openClassId":self.openClassId,
             "faceDate":""] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_getStuFaceTeachList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    
                    XLBallLoading.hide(in: self.view)
                    self.List = json["dataList"]
                    self.setUI()
                    //重现加载表格数据
                    self.tableView!.reloadData()
                    //结束刷新
                    self.tableView!.mj_header.endRefreshing()
                }else{
                    XLBallLoading.hide(in: self.view)
                }
                common.share.setTableFootView_noData(self.tableView, list: self.List.arrayValue as NSArray)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
        
    }
   
    //1课程
    func getCourseList(isCourse:Bool){
        if(self.courseList.count > 0){
            self.presentVC(isCourse: isCourse, list: self.courseList)
            return ;
        }
        let dict = ["stuId": Account.defaultAccount.id!]
        Alamofire.request(appAPI.FaceTeach_getCourseListByStuId, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.courseList = json["courseList"]
                    self.presentVC(isCourse: isCourse, list: self.courseList)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    }
    
    func getClassList(isCourse:Bool){
        
        if(self.classList.count > 0){
            self.presentVC(isCourse: isCourse, list: self.classList)
            return ;
        }
        let dict = ["stuId":Account.defaultAccount.id!]
        
        Alamofire.request(appAPI.FaceTeach_getClassListByStuId, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.classList = json["classList"]
                    self.presentVC(isCourse: isCourse, list: self.classList)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    }
    
    
    func presentVC(isCourse:Bool,list:JSON){
        let vc = stu_selectFaceByTypeView();
        vc.isCourse = isCourse
        vc.list = list;
        vc.CourseName = self.CourseName
        vc.OpenClassName = self.OpenClassName
        vc.courseOpenIds = self.courseOpenId
        vc.openClassIds = self.openClassId
        vc.reloadfacelistClosure = {(courseOpenIds,openClassIds) in
            self.courseOpenId = courseOpenIds
            self.openClassId = openClassIds
            self.getallface(date: "", isRefresh: true)
        }
        vc.CourseNameandopenClassName = {(CourseName,openClassName) in
            self.CourseName = CourseName
            self.OpenClassName = openClassName
            //\u{e607}
            if self.CourseName == "不限课程" {
                self.CourseName = "全部课程\u{e607}"
            }
            if self.OpenClassName == "不限班级" {
                self.OpenClassName = "全部班级\u{e607}"
            }
            if CourseName.isEmpty {
                self.btn_Anycourse.setTitle(self.btn_Anycourse.titleLabel?.text, for: .normal)
            }
            else {
                self.btn_Anycourse.setTitle(self.CourseName, for: .normal)
            }
            if openClassName.isEmpty {
                self.btn_Anyclass.setTitle(self.btn_Anyclass.titleLabel?.text, for: .normal)
            }
            else {
                self.btn_Anyclass.setTitle(self.OpenClassName, for: .normal)
            }
        }
        vc.modalTransitionStyle = .crossDissolve;
        vc.view.backgroundColor = UIColor(red: 0, green: 0, blue: 0, alpha: 0.2);
        self.present(vc, animated: true, completion: nil)
    }
}

