//
//  LinkView.swift
//  云课堂-职教云
//
//  Created by cc on 2018/3/28.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON
class LinkView: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.setUI()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        // Do any additional setup after loading the view.
        let paraph = NSMutableParagraphStyle()
        paraph.lineSpacing  = 8
        let attributes = [NSAttributedStringKey.font:UIFont.init(name: "iconfont", size: 15),
                          NSAttributedStringKey.paragraphStyle: paraph]
        self.setUI()
        self.lab_centent.attributedText = NSAttributedString(string:"职教云无法保证链接的安全性，请确认链接安全后点击按钮访问链接建议您不要在该网页输入账号、密码等信息", attributes: attributes)
        if isKJ{
            let Item = UIBarButtonItem(title:"\u{e70d}", style: .plain, target: self, action: #selector(self.Discuss))
            self.navigationItem.rightBarButtonItem = Item
            common.share.setdeleteButtonItem(item: Item)
        }
        
        
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    override func viewDidDisappear(_ animated: Bool) {
        if(self.isStu){
            self.studyCellTime = common.share.returntime(timeStart: enterTime, timeEnd: common.share.getNowdate())
            self.savePlayLog()
        }
    }
    //视图显示时
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        self.enterTime = common.share.getNowdate()
    }
    
    //保存学习日志
    fileprivate func savePlayLog(){
        self.studyCellTime =  self.studyCellTime > 10 ? self.studyCellTime:10
        let dict = ["openClassId":self.openClassId,
                    "courseOpenId":self.courseOpenId,
                    "cellId":self.cellId,
                    "cellLogId":self.cellLogId,
                    "sourceType":3,
                    "studyCellTime":self.studyCellTime,
                    "picNum": 0,
                    "studyNewlyTime":0,
                    "studyNewlyPicNum":0,
                    "token":self.token] as [String : Any];
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Student_stuProcessCellLog, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    //已学习
                    self.StuCourseKJModel?.zjycellRefresh = "zjycellRefresh"
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    func setUI(){
        self.view.addSubview(lab_centent)
        lab_centent.snp.makeConstraints{ (make) in
            make.width.equalTo(width - 40)
            make.left.equalTo(20)
            make.right.equalTo(-20)
            make.top.equalTo(20)
        }
        self.view.addSubview(btn_link)
        btn_link.snp.makeConstraints{ (make) in
            make.width.equalTo(100)
            make.height.equalTo(30)
            make.top.equalTo(180)
            make.left.equalTo(30)
        }
        
        btn_link.layer.masksToBounds = true
        btn_link.layer.cornerRadius = 10
        btn_link.layer.borderWidth = 1.5
        btn_link.layer.borderColor = UIColor.bg.cgColor
        
        self.btn_link.addTarget(self, action: #selector(self.tappedlink), for: .touchUpInside)
    }
    
    var token = "" //学习课件的token,用于记录日志
    lazy var enterTime:Int = 0
    lazy var studyCellTime:Int = 0
    let width = UIScreen.main.bounds.width
    lazy var lab_centent : UILabel = {
        let lab = UILabel()
        lab.font = UIFont.init(name: "iconfont", size: 15)
        lab.textColor = UIColor.colorWithHex(hexColor: 0x8a8a8a)
        lab.backgroundColor = UIColor.white
        lab.numberOfLines = 0;
        return lab
    }()
    lazy var btn_link : UIButton = {
        let btn = UIButton()
        btn.setTitle("打开链接", for: .normal)
        btn.titleLabel?.font = UIFont(name: "iconfont", size: 16)
        btn.setTitleColor(UIColor.bg, for: .normal)
        btn.backgroundColor = UIColor.white
        btn.contentHorizontalAlignment = .center;
        return btn
    }()
 
    var StuCourseKJModel: ZJY_StuCourseKJModel?
    lazy var stuCellPicCount:Int = 0
    lazy var cellLogId:String = ""
    var openClassId = "";
    var courseOpenId = "";
    var cellId = "";
    var docTitle = "";
    var previewUrl = "";
    var isStu = false
    var moduleId = ""
    lazy var linkStr :String = {
        return "";
    }()
    var isKJ = false
   @objc func tappedlink(){
    
        let vc = linkjumpView()
        vc.linkStr = self.linkStr;
        vc.hidesBottomBarWhenPushed = true;
        self.navigationController?.pushViewController(vc, animated: true);
        //self.present(vc,animated: true)
    }
    //讨论区
    @objc func Discuss(){
        let vc = courseBBSListView()
        vc.courseOpenId = self.courseOpenId
        vc.openClassId = self.openClassId
        vc.activeType = 1
        vc.docId = self.cellId
        vc.isStu = self.isStu
        self.navigationController?.pushViewController(vc, animated: true)
    }
}
