//
//  previewOfficeFromresViewController.swift
//  云课堂职教云
//
//  Created by cc on 2018/4/25.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import WebKit

class previewOfficeFromresViewController : UIViewController,WKScriptMessageHandler {
    
    var theWebView:WKWebView?;

    lazy var resourceUrl :String = {
        let str: String = String();
        return str;
    }()
    
    lazy var isPushed :Bool = {
        
        return false;
    }()
  
    override func viewDidLoad() {
        super.viewDidLoad()
        self.setUI();
        
        // Do any additional setup after loading the view.
    }
    
    func nextt(){
        
        self.theWebView?.evaluateJavaScript("Presentation.Next();",
                                            completionHandler: nil)
    }
    func setUI(){
        let path = Bundle.main.path(forResource: "previewRes", ofType: ".html",
                                    inDirectory: "HTML5/src");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        
        var frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.height,
                           height:UIScreen.main.bounds.width )
        if(UIDevice.current.model == "iPad"){
            frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height  )
            
        }
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        theWebView!.scrollView.bounces = false;
        theWebView?.scrollView.isScrollEnabled = false;
        
        //加载页面
        if #available(iOS 9.0, *) {
            theWebView?.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView?.load(request)
                
            }catch{}
        }
       // theWebView!.load(request)
        self.view.addSubview(theWebView!);
    }
    
    //响应处理js那边的调用
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        
        let sentData = message.body as! Dictionary<String,String>
        if(sentData["method"] == "back"){
            self.back();
        }else if (sentData["method"] == "loading"){
            self.theWebView!.evaluateJavaScript("preview.seturl(\(self.resourceUrl));",
                completionHandler: nil);
        }else if(sentData["method"] == "emit"){
            let dict = ["type":"office","params":sentData["params"]!]
            self.emitToPC(dict: dict)
        }else if(sentData["method"] == "next"){
            self.nextt()
        }
    }
    
    func back(){
        let value = UIInterfaceOrientation.portrait.rawValue
        (UIApplication.shared.delegate as! AppDelegate).allowRotation = false
        UIDevice.current.setValue(value, forKey: "orientation")
        let  dict = ["type":"closeRes","fromRes":"true"]
        self.emitToPC(dict: dict)
        self.presentingViewController?.dismiss(animated: false, completion: nil);
    }
    
    override  func viewWillAppear(_ animated: Bool) {
        self.view.backgroundColor = UIColor.white;
        appDelegate.isEffective = false
        appDelegate.allowRotation = false
        // 打开横屏功能
        let value = UIInterfaceOrientation.landscapeRight.rawValue
        (UIApplication.shared.delegate as! AppDelegate).allowRotation = true

        UIDevice.current.setValue(UIInterfaceOrientation.unknown.rawValue, forKey: "orientation")
        UIDevice.current.setValue(value, forKey: "orientation")
        
    }
    
    override func viewWillDisappear(_ animated: Bool) {
        self.view.backgroundColor = UIColor.white;
        if(!self.isPushed){
            theWebView?.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        }
        self.isPushed = false
    }

    //投屏事件
    func emitToPC(dict:[String:String]){

        ZQSocketManager.share.notificationSocketManager(data: dict)
    }
    
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    let appDelegate = UIApplication.shared.delegate as! AppDelegate
}
