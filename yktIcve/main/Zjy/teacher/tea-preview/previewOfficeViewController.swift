//
//  previewOfficeViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2017/12/12.
//  Copyright © 2017年 zqy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON

class previewOfficeViewController: UIViewController,WKScriptMessageHandler,WKNavigationDelegate {

    var theWebView:WKWebView?;

    lazy var resourceUrl :String = {
        let str: String = String();
        return str;
    }()
    let appDelegate = UIApplication.shared.delegate as! AppDelegate
    lazy var cellId :String = {
        let str: String = String();
        return str;
    }()
    lazy var courseOpenId :String = {
        let str: String = String();
        return str;
    }()

    lazy var openClassId :String = {
        let str: String = String();
        return str;
    }()
    lazy var isPushed :Bool = {

        return false;
    }()
    lazy var isPreviewToMS :Bool = {

        return false;
    }()
    /// 是否可以下载
    var isAllowDownLoad = false
    lazy var celltittle:String = ""
    var resourcesUrl : JSON = []; 
    lazy var doctype :String = {return ""}()
    lazy  var type = ["其他", "视频", "音频", "图片", "文档", "ppt", "zip"];
   
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.black
        self.setUI();

        // Do any additional setup after loading the view.
    }

    func nextt(){

        self.theWebView?.evaluateJavaScript("Presentation.Next();",
                                        completionHandler: nil)
    }
    func setUI(){
        let path = Bundle.main.path(forResource: "preview", ofType: ".html",
                                    inDirectory: "HTML5/src");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);

        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")

        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)

        var frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.height,
                           height:UIScreen.main.bounds.width )
        if(UIDevice.current.model == "iPad"){
            frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height  )

        }
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        theWebView!.scrollView.bounces = false;
        theWebView?.scrollView.isScrollEnabled = false;
        self.theWebView?.isHidden = true
        //加载页面
        if #available(iOS 9.0, *) {
            theWebView?.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView?.load(request)
                
            }catch{}
        }
        //theWebView!.load(request)
        theWebView?.navigationDelegate = self
        self.view.addSubview(theWebView!);
    }

    //响应处理js那边的调用
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {

        let sentData = message.body as! Dictionary<String,String>
        if(sentData["method"] == "back"){
            self.back();
        }else if (sentData["method"] == "loading"){
            self.theWebView?.isHidden = false
            self.theWebView!.evaluateJavaScript("preview.seturl(\(self.resourceUrl),'\(self.cellId)');",
                completionHandler: nil);
        }else if(sentData["method"] == "emit"){

           let dict = ["type":"whiteboard","params":sentData["params"]!]
            self.emitToPC(dict: dict)

        }else if(sentData["method"] == "loadFaceTeache"){
           self.getFaceTeach()
        }else if(sentData["method"] == "showBBS"){
            self.showBBSView()
        }else if(sentData["method"] == "next"){
            self.nextt()
        }else if(sentData["method"] == "down"){
            self.IsstartDownload()
        }
    }

    override func viewDidAppear(_ animated: Bool) {
        if(self.theWebView != nil &&  (self.theWebView?.isHidden)!){
            self.theWebView?.isHidden = false
        }
    }
    
    func back(){
            let value = UIInterfaceOrientation.portrait.rawValue
            (UIApplication.shared.delegate as! AppDelegate).allowRotation = false
            UIDevice.current.setValue(value, forKey: "orientation")
        let  dict = ["type":"closeRes","fromRes":"true"]

        self.emitToPC(dict: dict)
        self.presentingViewController?.dismiss(animated: false, completion: nil);
    }

    //投屏事件
    func emitToPC(dict:[String:String]){

        ZQSocketManager.share.notificationSocketManager(data: dict)
    }

    override  func viewWillAppear(_ animated: Bool) {
        self.view.backgroundColor = UIColor.white;
         appDelegate.isEffective = false
         appDelegate.allowRotation = false    // 打开横屏功能
        let value = UIInterfaceOrientation.landscapeRight.rawValue

        UIDevice.current.setValue(value, forKey: "orientation")
        if(self.isPreviewToMS){
            let dict = ["type":"openRes",
                        "cellId":self.cellId,
                        "fromRes":"true"]
         ZQSocketManager.share.notificationSocketManager(data: dict)
            self.theWebView!.evaluateJavaScript("preview.backShow();",
                completionHandler: nil);

        }
    }

    override func viewWillDisappear(_ animated: Bool) {
        self.view.backgroundColor = UIColor.white;
            appDelegate.isEffective = true
            // 切换到竖屏状态
            appDelegate.allowRotation = true   // 关闭横屏功能
            let value = UIInterfaceOrientation.portrait.rawValue
            UIDevice.current.setValue(value, forKey: "orientation")

        if(!self.isPushed){
             theWebView?.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        }
        self.isPushed = false
    }






    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    

    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
