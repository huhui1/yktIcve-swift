//
//  modiftyPwdViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2017/8/31.
//  Copyright © 2017年 zqy. All rights reserved.
//

import UIKit
import SnapKit
import Alamofire
import SwiftyJSON

class modiftyPwdViewController: UIViewController,UITextFieldDelegate {
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height;
    let Text_oldpwd = UITextField();
    let Text_newpwd = UITextField();
    let Text_newagain = UITextField();
    var toolBar = UIToolbar();

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.colorWithHex(hexColor: 0xf1f1f1);
        // Do any additional setup after loading the view.
        
        self.setUI();
    }
    func setUI(){
        
        toolBar = common.share.AddToolKeyboardDoneBar()
        let doneButton = UIBarButtonItem(title: "确定", style: .plain, target: self, action: #selector(self.Done));
        let spaceButton = UIBarButtonItem(barButtonSystemItem: .flexibleSpace, target: nil, action: nil)
        toolBar.setItems([spaceButton,doneButton], animated: false);
        
        let Lab_oldpwd = UILabel();
        self.view.addSubview(Lab_oldpwd);
        Lab_oldpwd.snp.makeConstraints { (make) in
            make.height.equalTo(40)
            make.width.equalTo(width)
            make.top.equalTo(10)
            
        }
        Lab_oldpwd.text = "   当前密码";
        Lab_oldpwd.textAlignment = .left;
        Lab_oldpwd.textColor = UIColor.colorWithHex(hexColor: 0x8f8f94)
        Lab_oldpwd.backgroundColor = UIColor.init(red: 0, green: 0, blue: 0, alpha: 0.1);
        
        self.view.addSubview(Text_oldpwd);
        Text_oldpwd.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(60)
            make.top.equalTo(Lab_oldpwd.snp.bottom)
        }
        Text_oldpwd.placeholder = "  请填写当前密码";
        Text_oldpwd.backgroundColor = UIColor.white;
        Text_oldpwd.setValue(NSNumber(value:10), forKey:"paddingLeft");
        Text_oldpwd.isSecureTextEntry = true;
        
        let Lab_newpwd = UILabel();
        self.view.addSubview(Lab_newpwd);
        Lab_newpwd.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(40)
            make.top.equalTo(Text_oldpwd.snp.bottom)
        }
        let msg_str = "   新密码（仅支持6 ～ 16位数字，字母，标点符号）";
        let ranStr = "（仅支持6 ～ 16位数字，字母，标点符号）"
        let attrstring:NSMutableAttributedString = NSMutableAttributedString(string:msg_str)

        let str = NSString(string: msg_str)
        
        let theRange = str.range(of: ranStr)
         Lab_newpwd.textColor = UIColor.colorWithHex(hexColor: 0x8f8f94)

        attrstring.addAttribute(NSAttributedStringKey.foregroundColor, value: UIColor.colorWithHex(hexColor: 0x83c859), range: theRange)
        
        attrstring.addAttribute(NSAttributedStringKey.font, value: UIFont.systemFont(ofSize: 14), range: theRange)
        
        Lab_newpwd.attributedText = attrstring;
        Lab_newpwd.backgroundColor = UIColor.init(red: 0, green: 0, blue: 0, alpha: 0.1);

        self.view.addSubview(Text_newpwd);
        Text_newpwd.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(60)
            make.top.equalTo(Lab_newpwd.snp.bottom)
        }
        self.view.addSubview(Text_newpwd);
        Text_newpwd.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(60)
            make.top.equalTo(Lab_newpwd.snp.bottom)
        }
        Text_newpwd.placeholder = "  请填写新的密码";
        Text_newpwd.backgroundColor = UIColor.white;
        Text_newpwd.setValue(NSNumber(value:10), forKey:"paddingLeft");
        Text_newpwd.isSecureTextEntry = true;
        
        let Lab_newagain = UILabel();
        self.view.addSubview(Lab_newagain);
        Lab_newagain.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(40)
            make.top.equalTo(Text_newpwd.snp.bottom)
        }
        Lab_newagain.text = "   确认密码"
        Lab_newagain.textColor = UIColor.colorWithHex(hexColor: 0x8f8f94)
        Lab_newagain.backgroundColor = UIColor.init(red: 0, green: 0, blue: 0, alpha: 0.1);

        self.view.addSubview(Text_newagain);
        Text_newagain.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(60)
            make.top.equalTo(Lab_newagain.snp.bottom)
        }
        self.view.addSubview(Text_newagain);
        Text_newagain.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(60)
            make.top.equalTo(Lab_newagain.snp.bottom)
        }
        Text_newagain.placeholder = "  请再次输入新的密码";
        Text_newagain.backgroundColor = UIColor.white;
        Text_newagain.setValue(NSNumber(value:10), forKey:"paddingLeft");
        Text_newagain.isSecureTextEntry = true;
        var ht = 0
        if common.share.isX(){
            ht = 30
        }
        
        let UIbtnsubmit = UIButton();
        self.view.addSubview(UIbtnsubmit);
        UIbtnsubmit.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(50)
            make.bottom.equalTo(self.view.snp.bottom).offset(-CGFloat(ht));
        }
        UIbtnsubmit.setTitle("确认修改", for: .normal);
        UIbtnsubmit.backgroundColor = UIColor.bg;
        UIbtnsubmit.setTitleColor(UIColor.white, for: .normal);
        UIbtnsubmit.contentVerticalAlignment = .center;
        UIbtnsubmit.titleLabel?.font = UIFont.init(name: "iconfont", size: 20);
        UIbtnsubmit.addTarget(self, action:#selector(tapped(_:)), for:.touchUpInside);

        Text_newagain.delegate = self
        Text_newpwd.delegate = self
        Text_oldpwd.delegate = self
        
    }
    @objc func Done(){
        self.view.endEditing(true)
    }
    func textFieldShouldBeginEditing(_ textField: UITextField) -> Bool {
        textField.inputAccessoryView = toolBar;
        return true
    }
    @objc func tapped(_ button:UIButton){
       // let password = UserDefaults.standard.value(forKey: "password") as! String!;
        let oldPassword = self.Text_oldpwd.text!
        let newPpassword = self.Text_newpwd.text!
        let confirmPassword = self.Text_newagain.text!
        if((oldPassword.isEmpty) || (newPpassword.isEmpty) || (confirmPassword.isEmpty)){
            ZKProgressHUD.showMessage("请输入有效密码!");
            return ;
        }
        if(newPpassword == "666666"){
            ZKProgressHUD.showMessage("为了您的账号安全请不要设置为初始通用密码!");
            return ;
        }
        if(newPpassword != confirmPassword){
            ZKProgressHUD.showMessage("两次输入的密码不一致!");
            return ;
        }
        let dict = ["userId":Account.defaultAccount.id!,
                    "oldPassword": oldPassword,
                    "newPassword":newPpassword];
      //  let newdict = ["data":common.share.getJSONStringFromDictionary(dictionary:dict as NSDictionary)];
        Alamofire.request(appAPI.MobileLogin_editPassword,method:.post,parameters: dict, encoding: URLEncoding.default).responseJSON{response in
            if let value = response.result.value{
                let json=JSON(value);
                if (json["code"]==1){
                    self.navigationController?.popViewController(animated: true)
                    ZKProgressHUD.showMessage("密码修改成功!");
                }else{
                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                  
                }
            }else{
                ZKProgressHUD.showMessage("网络异常!");
            }
        
        }
        
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    //键盘隐藏
    override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
        self.view.endEditing(true)
    }

    func textField(_ textField: UITextField, shouldChangeCharactersIn range: NSRange, replacementString string: String) -> Bool {

        return  !(string == " ")
    }

    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
