//
//  checkupViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2018/1/28.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension  checkupView {


    func refreshItemData(isRefresh:Bool){

        let dict = ["schoolId":Account.defaultAccount.schoolId!,
                    "userId":Account.defaultAccount.id!,
                    "inviteType":self.inviteType] as [String : Any] ;

        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Teacher_getStuOrTeaColleagueList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
//                    ZKProgressHUD.hide()
                    self.list = json["list"].arrayValue as NSArray

                    self.fetchCoverDetails(isRefresh: isRefresh)
                    common.share.setTableFootView_noData(self.tableView, list: self.list)
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }

    }

    func  fetchCoverDetails(isRefresh:Bool){
        self.checkInfos.removeAll()
        for i in 0..<self.list.count {
            let stuinfo = JSON(self.list[i])
            let selstu =  checkInfo.init(Id: stuinfo["Id"].stringValue,
                                         Name:stuinfo["DisPlayName"].stringValue ,
                                         StuNo: stuinfo["UserName"].stringValue,
                                         Mobile: stuinfo["Mobile"].stringValue,
                                         Email: stuinfo["Email"].stringValue,
                                         isChecked:false)
            checkInfos.append(selstu)
        }

        if(!isRefresh){
            //重现加载表格数据
            self.tableView.mj_header.endRefreshing();
        }
        self.tableView.reloadData();
    }

    @objc func showQrcode(){
        let data = ["flag":"ssykt",
                   "type":self.selectType,
                   "schoolId":Account.defaultAccount.schoolId!,
                   "teacherId":Account.defaultAccount.id!,
                   "teacherName":Account.defaultAccount.displayName!] as [String : Any]
        let vc = qrCodeView()
        vc.msg = " 扫描二维码,立即加入云课堂"
        vc.isHasImg = false

        vc.qrstr = JSON.init(data).description
      
        vc.view.backgroundColor = UIColor.init(red: 0, green: 0, blue: 0, alpha: 0.5)
        vc.modalTransitionStyle = .crossDissolve
        self.present(vc, animated: true, completion: nil)
    }

    
   @objc func selType(_ btn :UIButton){
        self.inviteType=btn.tag
        self._line.snp.remakeConstraints { (make) in
            make.width.equalTo(100)
            make.height.equalTo(1)
            make.centerX.equalTo(btn)
            make.top.equalTo(self.line.snp.bottom)
        }
        self.btnAllIcon.isSelected = false
        self.btnAllIcon.backgroundColor = UIColor.white
        refreshItemData(isRefresh: false)
    }
    //全选事件
    
    @objc func tap(_ btn :UIButton){
        btn.isSelected = !btn.isSelected
        self.btnAllIcon.isSelected = btn.isSelected
        if(btn.isSelected){
            self.btnAllIcon.backgroundColor = UIColor.bg
        }else{
            self.btnAllIcon.backgroundColor = UIColor.white
        }
        
        for i in 0 ..< self.checkInfos.count {
            
            let indexPath =  NSIndexPath.init(item: i, section: 0) as IndexPath
            
            
            if(btn.isSelected){
                self.tableView.selectRow(at: indexPath , animated: true, scrollPosition: UITableViewScrollPosition.none)
            }else{
                self.tableView.deselectRow(at :indexPath, animated: true)
            }
            
            self.checkInfos[i].isChecked = btn.isSelected
            
        }
    
    }

    //审核及其忽略
  @objc   func approvalStuOrColleague(_ btn:UIButton){
         self.stuIdList.removeAll()

        for i in 0 ..< self.checkInfos.count {
            let indexPath =  NSIndexPath.init(item: i, section: 0) as IndexPath
            let cell = tableView.dequeueReusableCell(withIdentifier: "SwiftCell",
                                                    for: indexPath) as! checkUpTableViewCell
            if(cell.isSelected){
                self.stuIdList.append(checkInfos[i].Id)
            }

            
        }

        if( self.stuIdList.count < 1){
            self.tableView.removeFromSuperview()
            self.setTableView()
            ZKProgressHUD.showMessage("请选择人员")
            return ;
        }

        let dict = ["userId":Account.defaultAccount.id!,
                    "ids":self.stuIdList,
                    "approvalType":self.inviteType,
                    "isPass":btn.tag == 1 ? 1 : 0] as [String : Any] ;

        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Teacher_approvalStuOrColleague, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.tableView.removeFromSuperview()
                    self.setTableView()
                    self.refreshItemData(isRefresh: true)
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    
    
    }


}
