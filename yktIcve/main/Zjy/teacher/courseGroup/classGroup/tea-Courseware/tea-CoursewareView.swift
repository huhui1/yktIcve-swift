//
//  tea-CoursewareView.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/6/29.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import SCLAlertView

class tea_CoursewareView: UIViewController {

    //自定义提示框样式
    let appearance = SCLAlertView.SCLAppearance(
        showCloseButton: false //不显示关闭按钮
    )

    let cellArray : NSMutableArray = NSMutableArray()


    //带属性监视器的普通属性
    var moduleList = [zjycourseModule]()


    var openClassId: String = "";

    var courseOpenId: String = "";
    var resourcesUrl : JSON = [];
    var previewUrl = "";
    var linkstr = ""
    var isNeedUpdate:Bool = false

    @IBOutlet weak var tableView: UITableView!
    override func viewDidLoad() {
        super.viewDidLoad()
        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))

        self.navigationItem.leftBarButtonItem = item
        let item1 = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item1
        common.share.setBackButtonItem(item:item)
        self.setUpTableview()
        self.getModuleList()
        // Do any additional setup after loading the view.
    }
    
    init() {
        super.init(nibName: "tea-CoursewareView", bundle: nil)
    }
    
    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    //返回按钮
    @objc func backBtnClick() {
        self.presentingViewController?.dismiss(animated: true, completion: nil)
    }
    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}

extension tea_CoursewareView:UITableViewDelegate,UITableViewDataSource{

    func setUpTableview(){
        self.tableView.delegate = self
        tableView.dataSource = self
        tableView.tableFooterView = UIView.init(frame: CGRect.zero)
        if #available(iOS 9.0, *) {
            self.tableView.cellLayoutMarginsFollowReadableWidth = false
        }
        tableView.separatorStyle = UITableViewCellSeparatorStyle.singleLine
        tableView.estimatedRowHeight = 200 //预设cell高度
        tableView.rowHeight = UITableViewAutomaticDimension
    }
    //MARK:-UITableViewDelegate
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        //  获取数据判断是topic 还是cell
        let courseModule = self.moduleList[indexPath.section]
        let t = self.getshowList(model:courseModule, _section: indexPath.row)
        //如果是topic 判断是否有cell 没有请求接口
        if(t.level == 2){
            t.isUnfold = !t.isUnfold
            if(t.cell.count < 1){
                self.getCellList(indexPath: indexPath, topic: t)
            }else{
                self.tableView.reloadSections(IndexSet.init(integer: indexPath.section), with: .automatic)
            }
        }else{

//            self.pushedVC(cell: t)
            self.isfileDownload(cell: t)
        }


    }
    //MARK:-UITableViewDataSource
    func numberOfSections(in tableView: UITableView) -> Int {
        return moduleList.count
    }
    func tableView(_ tableView: UITableView, heightForHeaderInSection section: Int) -> CGFloat {
        return 52
    }
    func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        let view : HelpSectionHeader = HelpSectionHeader()

        view.spreadBtn.isSelected = self.moduleList[section].isUnfold
        view.spreadBlock = {  () -> Void in
            self.moduleList[section].isUnfold = !self.moduleList[section].isUnfold
            self.getTopicList(moduleId: self.moduleList[section].moduleId,section:section)

        }
        view.titleLabel.text = self.moduleList[section].title
        return view
    }
    func tableView(_ tableView: UITableView, heightForFooterInSection section: Int) -> CGFloat {
        return 1
    }
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {

        return self.getCellNum(model:self.moduleList[section], _section: section)

    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 50
    }

    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {

        let courseModule = self.moduleList[indexPath.section]
        let courseTopicModule = self.getshowList(model:courseModule, _section: indexPath.row)

        let identifier = "cell\(courseTopicModule.id)"
        if ( courseTopicModule.level == 2){
            self.tableView.register(UINib.init(nibName: "courseWareViewTopic", bundle: Bundle.main), forCellReuseIdentifier: identifier)
            let cell : courseWareViewTopic = tableView.dequeueReusableCell(withIdentifier: identifier, for: indexPath) as! courseWareViewTopic
            cell.setZJYModel(courseTopicModule: courseTopicModule)
            print("------1------")
            return cell
        }else{
            self.tableView.register(UINib.init(nibName: "courseWareViewCell", bundle: Bundle.main), forCellReuseIdentifier: identifier)
            let cell : courseWareViewCell = tableView.dequeueReusableCell(withIdentifier: identifier, for: indexPath) as! courseWareViewCell
            cell.setZJYModel(model: courseTopicModule, isstu:false)
            print("------2------")
            return cell
        }
    }
    
}
