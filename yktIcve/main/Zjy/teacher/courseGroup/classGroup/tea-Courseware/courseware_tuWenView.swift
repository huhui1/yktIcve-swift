//
//  courseware_tuWenView.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/7/2.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON

class courseware_tuWenView: UIViewController,UIDocumentInteractionControllerDelegate {

    @IBOutlet weak var myTableView: UITableView!
    var token = "" //学习课件的token,用于记录日志
    lazy var enterTime:Int = 0
    lazy var studyCellTime:Int = 0
    var openClassId = "";
    var courseOpenId = "";
    var cellId = "";
    var isStu = false
    var moduleId = ""
    lazy var stuCellPicCount:Int = 0
    lazy var cellLogId:String = ""
    var RarJsonData = [JSON]()
    var StuCourseKJModel: ZJY_StuCourseKJModel?
    var documentController:UIDocumentInteractionController!
    override func viewDidLoad() {
        super.viewDidLoad()
        self.setTableView()
        self.getTuwenData()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        let Item = UIBarButtonItem(title:"\u{e70d}", style: .plain, target: self, action: #selector(self.Discuss))
        self.navigationItem.rightBarButtonItem = Item
        common.share.setdeleteButtonItem(item: Item)
        // Do any additional setup after loading the view.
        //判断是否点击过
        let cx = SQLiteManagerMask()
        let model = cx.readOneData(_userId: Account.defaultAccount.id!)
        
        if(!model.isbrowselessonTuwen && !cellId.isEmpty){
            
            self.maskView()
        }
    }
    //视图显示时
    override func viewWillAppear(_ animated: Bool) {
        super.viewWillAppear(animated)
        self.enterTime = common.share.getNowdate()
  
    }
    
    override func viewDidDisappear(_ animated: Bool) {
        super.viewDidDisappear(animated)
        if self.isStu{
           self.studyCellTime = common.share.returntime(timeStart: enterTime, timeEnd: common.share.getNowdate())
           self.savePlayLog()
        }
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    func documentInteractionControllerViewControllerForPreview(_ controller: UIDocumentInteractionController) -> UIViewController
    {
        //这个地方需要返回给一个控制器用于展现documentController在其上面，所以我们就返回当前控制器self
        return self
    }
    func openOffice(path:CacheDocModel){
        let sandboxFilePath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
        let docUrl = URL(fileURLWithPath: sandboxFilePath);
        documentController = UIDocumentInteractionController(url:docUrl)
        documentController.delegate = self;
        //当前APP打开  需实现协议方法才可以完成预览功能
        documentController.presentPreview(animated: true);

    }
    
    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */
    lazy var makeView:UIView = {
        let view = UIView()
        return view
    }()
    
    fileprivate lazy var headView :UIView = {
        let view = UIView()

        return view
    }()
    fileprivate lazy var labContent :UILabel = {
        let lab = UILabel()
        lab.numberOfLines = 0
        lab.textColor = UIColor.gray
        lab.sizeToFit()
        return lab
    }()
   
}
extension courseware_tuWenView:UITableViewDelegate,UITableViewDataSource,courseware_tuwenCellDelegate{


    func action_cache(index: Int) {
        let r =  self.RarJsonData[index]
        let d = JSON.init(parseJSON:  r["resourceUrl"].stringValue)
        let cx = SQLiteManagerCache()
        let path = cx.readOneData(_userId: Account.defaultAccount.id!, docId: self.cellId + "\(index)")
        if(path.docPath.isEmpty){
            let vc = cacheViewController();
            vc.docId = self.cellId + "\(index)";
            vc.docUrl = d["urls"]["download"].stringValue;

            switch d["category"] {
            case "video":
                vc.docType = 1
            case "mp3":
                vc.docType = 2
            case "img":
                vc.docType = 3
            case "office","docx","ppt":
                vc.docType = 4
            default:
               vc.docType = 5
            }

            vc.docTitle = r["docTitle"].stringValue
            vc.isStart = true;
            self.navigationController?.pushViewController(vc, animated: true);
        }else{
            switch path.docType {
            case 1:
                print("===")
            let vc = generalVideoPlayView()
            vc.videourls.removeAll()
            vc.localurl = "\(NSHomeDirectory())/Documents/\(path.docPath)"
            vc.isNet = true
            self.navigationController?.pushViewController(vc, animated: true)
                
            case 2:
                print("===")
            let  vc = audioViewController();
            vc.audiourl = path.docPath;
            vc.title = "播放音频"
            vc.tittlelab.text = path.docTitle
            vc.isNet = false;
            self.navigationController?.pushViewController(vc, animated: true)
            
            case 3:
            let vc = cachePreviewImgView()
            let fullPath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
            vc.file =  fullPath
            present(vc, animated: false, completion: nil)
            case 4,5:
                self.openOffice(path: path);
            default:
                print("asxa")

            }
        }
    }
    func setHeadUI(json:JSON){
        self.RarJsonData = json["cellInfo"]["RarJsonData"].arrayValue
        let t =  common.share.loadHtml(str: json["cellInfo"]["CellContent"].stringValue)
        self.labContent.attributedText = t
        self.headView.addSubview(self.labContent)
        self.labContent.snp.makeConstraints { (make) in
            make.left.top.equalTo(0)
            make.width.equalTo(UIScreen.main.bounds.width)
        }

        let h = common.share.getHeightForView(text:t, font: UIFont.italicSystemFont(ofSize: 15), width: UIScreen.main.bounds.width)
        self.headView.frame = CGRect.init(x: 0, y: 0, width: UIScreen.main.bounds.width, height: h + 20)

        self.myTableView.tableHeaderView = self.headView
        self.myTableView.reloadData()

    }

    func setTableView(){
        self.myTableView.register(UINib.init(nibName: "courseware-tuwenCell", bundle:nil ), forCellReuseIdentifier: "courseware_tuwenCell")
        self.myTableView.delegate = self
        self.myTableView.dataSource = self
         self.myTableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
         self.myTableView.separatorInset = UIEdgeInsets.zero;

         self.myTableView.layoutMargins = UIEdgeInsets.zero;

        if #available(iOS 9.0, *) {
          self.myTableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            // Fallback on earlier versions
        }
    }
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.RarJsonData.count
    }

    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 40
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = self.myTableView.dequeueReusableCell(withIdentifier: "courseware_tuwenCell", for: indexPath) as! courseware_tuwenCell
        cell.deledate = self
        cell.setTitle(title: self.RarJsonData[indexPath.row]["docTitle"].stringValue, _index: indexPath.row)
        return cell
    }

    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let r =  self.RarJsonData[indexPath.row]
        let d = JSON.init(parseJSON:  r["resourceUrl"].stringValue)
        switch d["category"]{
        case "video":
            let vc = videoPlayView()
           
            vc.isFromZjyErrorQuestion = true
            vc.videourls.removeAll()
            vc.videourls.append(d["urls"]["preview"].stringValue)
            self.navigationController?.pushViewController(vc, animated: true)
        case "mp3":
            let  vc = audioViewController();
           
            vc.audiourl = d["urls"]["status"].stringValue.substring(toIndex: d["urls"]["status"].stringValue.length - 7)
            vc.title = r["docTitle"].stringValue
            vc.isNet = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "img","jpg":
            let vc = PicturePreviewView()
            vc.imgurl = d["urls"]["preview"].stringValue
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)

        default:
            ZKProgressHUD.showError("请从网页下载查看");
        }
    }
}
