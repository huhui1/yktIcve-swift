//
//  audioBBSAreaViewModel.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/7/13.
//  Copyright © 2018年 zqyou. All rights reserved.
//
import UIKit
import SwiftyJSON
import Alamofire

class BBSAreaViewModel: NSObject {

    var courseOpenId = ""
    var openClassId = ""
    var cellId = ""
    var activeType = 0 //1.评价，2.问答，3，笔记，4.纠错
    var isMainTeacher = false

    var list = [evaluationModel]()
    var courseBBSAction : CourseBBSAction?
    @objc dynamic var isReload = false //swift 使用KVO监听的属性需要用dynamic关键字声明

    override init() {
        super.init()

    }

    //获取数据
    func getBBSDataByActionType(courseOpenId:String,openClassId:String,cellId:String,activeType:Int){

        self.activeType = activeType
        self.openClassId = openClassId
        self.courseOpenId = courseOpenId
        self.cellId = cellId
        self.getBBSData()
    }



    /// 是否采纳
    ///
    /// - Parameters:
    ///   - Id: 纪录id
    ///   - IsAccept: 是否
    func acceptError(Id:String,IsAccept:Bool){
        if isMainTeacher == false{
            ZKProgressHUD.showMessage("您不是主持老师，无法采纳！")
            return
        }
        let dict = ["Id":Id,
                    "IsAccept":IsAccept] as [String : Any]

        Alamofire.request(appAPI.BBS_acceptError, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let r = JSON(value)
                if r["code"] == 1{

                    for v in self.list {
                        if (v.Id == Id) {
                          v.isAccept = !IsAccept
                        }
                      self.isReload = true
                    }
                }else{
                    ZKProgressHUD.showMessage(r["msg"].string)
                }

            }else{
                ZKProgressHUD.showMessage("网络异常请稍后再试！");

            }
        }
    }
    //获取数据通过类型
    func getBBSData(){

        let dict = ["courseOpenId":self.courseOpenId,
                    "cellId":self.cellId,
                    "activeType":self.activeType,
                    "userId":Account.defaultAccount.id!] as [String : Any]

        Alamofire.request(appAPI.BBS_getCellBBSList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let r = JSON(value)
                if r["code"] == 1{
                    self.list.removeAll()
                    for i in r["list"]{
                        let m =  evaluationModel.init(i: i.1)
                        self.list.append(m)
                    }
                    self.isMainTeacher = r["isMainTeacher"].boolValue
                    self.isReload = true

                }else{
                    //ZKProgressHUD.showMessage(r["msg"].string)
                }

            }else{
                ZKProgressHUD.showMessage("网络异常请稍后再试！");

            }
        }
    }

    public func  BBSDetails(m: evaluationModel){

        self.courseBBSAction?.actionType = self.activeType
        self.courseBBSAction?._evaluationModel = m
        self.courseBBSAction?.isMainTeacher = self.isMainTeacher
        self.courseBBSAction?.ActionName = "details"

//        let dict = ["type":"details","actionType":self.activeType,"model":m,"isMainTeacher":self.isMainTeacher] as [String : Any]
//        NotificationCenter.default.post(name:NSNotification.Name("BBSAction"), object: dict);
    }

    public func  BBSCreate(){

        self.courseBBSAction?.actionType = self.activeType
        self.courseBBSAction?.ActionName = "create"

//        let dict = ["type":"create","actionType":self.activeType] as [String : Any]
//            NotificationCenter.default.post(name:NSNotification.Name("BBSAction"), object: dict);
    }
}


