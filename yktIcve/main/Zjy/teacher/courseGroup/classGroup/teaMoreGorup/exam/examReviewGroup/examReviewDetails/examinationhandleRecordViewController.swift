//
//  examinationhandleRecordViewController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/4/1.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON
import SCLAlertView
extension examinationhandleRecordView {

    func markingStuExam(){

//        courseOpenId: _this.courseOpenId,
//        openClassId: _this.openClassId,
//        examId: _this.examId,
//        examTermTimeId: _this.examTermTimeId,
//        examStuId: _this.examStuId,
//        stuId: _this.stuId,
//        teaId: _this.$user.id,
//        sourceType: _this.$user.sourceType

        let jsondata = JSON.init(parseJSON: self.data);
        let dict = ["courseOpenId":jsondata["courseOpenId"],
                    "openClassId":jsondata["openClassId"],
                    "examId":jsondata["examId"],
                    "examTermTimeId":jsondata["examTermTimeId"],
                    "examStuId":jsondata["examStuId"],
                    "stuId":jsondata["stuId"],
                    "teaId":Account.defaultAccount.id!,
                    "sourceType":3] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.OnlineExam_markingStuExam, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.reloadParentVC()
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //批阅后刷新上一页
    func reloadParentVC(){
        let count = self.navigationController?.viewControllers.count
        if let vc:examReviewView = self.navigationController?.viewControllers[count! - 2] as? examReviewView {
            if HasReview{
                vc.reloadExamReview(m: 2)
            }else{
                vc.reloadExamReview(m: 1)
            }
        }
        self.navigationController?.popViewController(animated: true);
    }


    //查看图片
    func previewImg (url:String){
        let vc = whiteboardView()
        vc.file = url
        self.isPushed = true
        present(vc, animated: true, completion: nil)
    }

    //通过附件Id
    func getFileById(Id:String){

        let dict = ["Id": Id]
         XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_getFileHomeworkUrlById, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.pushView(data: json["url"].stringValue)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //退回
    func returnHomework() {
        let alertController = UIAlertController(title: "提示",
                                                message:"确定退回该学生考试吗？", preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style:.default, handler: {
            action in

            let jsondata = JSON.init(parseJSON: self.data);
            let dict = ["examStuId":jsondata["examStuId"]]
            XLBallLoading.show(in: self.view)
            Alamofire.request(appAPI.OnlineExam_rejectExam, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if(json["code"]>0){
                        self.reloadParentVC()
                        ZKProgressHUD.showMessage(json["msg"].stringValue)

                    }else{
                        ZKProgressHUD.showMessage(json["msg"].stringValue);
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！");
                    XLBallLoading.hide(in: self.view)
                }
            }
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)
        self.present(alertController, animated: true, completion: nil)
    }

    //通过URL获取
    func getFileInfoByUrl(url:String){

        let dict = ["url": url];
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.MobileLogin_getFileInfoByUrl, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.pushView(data: json["url"].stringValue)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //打开观看
    func pushView(data:String){
        let json = JSON.init(parseJSON: data)
        switch json["category"] {
        case "video":
            let vc = videoPlayView()
            vc.isFromZjyErrorQuestion = true
            vc.videourls.removeAll()
            vc.videourls.append(json["urls"]["preview"].stringValue)
            self.isPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "mp3":
            let  vc = audioViewController();
            if(!json["urls"]["preview_oss_gen"].stringValue.isEmpty){
                vc.audiourl = json["urls"]["preview_oss_gen"].stringValue
            }else{
                vc.audiourl = json["urls"]["preview"].stringValue
            }
            vc.title = "考试附件音频"
            vc.isNet = true
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)

        case "img":
            let vc = whiteboardView()
            vc.file = json["urls"]["preview_oss_ori"].stringValue
            if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
                vc.file = json["urls"]["preview"].stringValue
            }
            self.isPushed = true
            present(vc, animated: true, completion: nil)
        case "office","ppt","pptx","doc","docx":
            if(json["isH5"].intValue == 1){
                let vc = teacherPPTOffficeViewViewController()
                vc.isTeaching = false
                self.isPushed = true
                vc.resourceUrl = data
                self.present(vc, animated: false, completion: nil)
            }else{
                let  vc = previewOfficeFromresViewController()
                self.isPushed = true
                vc.resourceUrl = data
                self.isPushed = true
                self.present(vc, animated: false, completion: nil)
            }
        default:

            print("11")
        }
    }
}
