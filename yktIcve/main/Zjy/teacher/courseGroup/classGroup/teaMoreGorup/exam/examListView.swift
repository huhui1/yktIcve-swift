//
//  examListView.swift
//  云课堂2
//
//  Created by cc on 2018/6/26.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
class examListView: UIViewController,UITableViewDelegate,UITableViewDataSource  {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.settableview()
        self.title = "考试"
        self.view.backgroundColor = UIColor.colorWithHex(hexColor: 0xfafafa)
        // Do any additional setup after loading the view.
        
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        self.refreshItemData(isRefresh: true)
    }

    override func viewWillAppear(_ animated: Bool) {
        if isPushReview{
            self.refreshItemData(isRefresh: false)
        }
        self.isPushReview = false
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.list.count
    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 170
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
        let cell:HomeworkCell = tableView.dequeueReusableCell(withIdentifier: "HomeworkCell")
            as! HomeworkCell
        cell.selectionStyle = UITableViewCellSelectionStyle.none
        let json = self.list[indexPath.row]
  
        //编辑
        cell.editor.tag = indexPath.row
        cell.editor.addTarget(self, action: #selector(self.tap(_:)), for: .touchUpInside)
        
        cell.setexamjson(json: json)
        return cell
    }

    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let json = self.list[indexPath.row]
        if json["examType"].intValue == 1{
            let vc = examReviewView()
            vc.openClassId = self.openClassId
            vc.courseOpenId = self.courseOpenId
            vc.examId = json["examId"].stringValue
            vc.examTermTimeId = json["examTermTimeId"].stringValue
            vc.examTitle = json["title"].stringValue
            self.isPushReview = true
            self.navigationController?.pushViewController(vc, animated: true)
        }else{
            print("登分考试")
            let vc = examMakeScoreView()
            vc.openClassId = self.openClassId
            vc.courseOpenId = self.courseOpenId
            vc.examId = json["examId"].stringValue
            vc.examTermTimeId = json["examTermTimeId"].stringValue
            vc.examTitle = json["title"].stringValue
            self.isPushReview = true
            self.navigationController?.pushViewController(vc, animated: true)
        }
        
    }
    
    func settableview(){
        
        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:self.view.bounds.width, height:self.view.bounds.height - 60))
        let cellXIB = UINib.init(nibName: "HomeworkCell", bundle: Bundle.main)
        self.tableView.register(cellXIB,
                                forCellReuseIdentifier:"HomeworkCell")
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        self.tableView.backgroundColor = UIColor.colorWithHex(hexColor: 0xfafafa)
        // 设置分割线的样式为None.
        self.tableView.separatorStyle = UITableViewCellSeparatorStyle.none
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.refreshItemData(isRefresh: false)
        })
        self.view.addSubview(self.tableView)
        
    }
    
    @objc func tap(_ btn:UIButton){
        let json = self.list[btn.tag]
        let vc = setexamTimeView()
        vc.examTitle = json["title"].stringValue
        vc.examId = json["examId"].stringValue
        vc.openClassId = self.openClassId
        vc.examTermTimeId = json["examTermTimeId"].stringValue
//        vc.reloadClosure = {() in
//            self.refreshItemData(isRefresh: false)
//        }
        vc.hidesBottomBarWhenPushed = true;
        self.navigationController?.pushViewController(vc, animated: true);
    }
    
    
    lazy var courseOpenId:String = ""
    lazy var openClassId:String = ""
    lazy var list : JSON =  {
        return []
    }()
    var isPushReview = false
    var tableView :UITableView!
}
