//
//  examUnmakeScoreView.swift
//  云课堂2
//
//  Created by cc on 2018/7/16.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
import SCLAlertView

class examUnmakeScoreView: UIViewController,UITableViewDelegate,UITableViewDataSource,UITextFieldDelegate {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.setTableView()
        self.getUnmakeScoreData(isRefresh: true)
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            //重现生成数据
            self.unmakeScoreList = []
            self.getUnmakeScoreData(isRefresh: false)
        })
        // Do any additional setup after loading the view.
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func  setTableView(){
        var ht = 0
        if common.share.isX(){
            ht = 30
        }
        //创建表视图
        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:width, height:height - 104 - CGFloat(ht)))
        
        self.tableView.delegate = self
        self.tableView.dataSource = self
        //        创建一个重用的单元格
        self.tableView.register(HomeworkReviewCell.self, forCellReuseIdentifier: "SwiftCell");
        
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        
        if #available(iOS 9.0, *) {
            self.tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        self.view.addSubview(self.tableView);
        
        
    }
    func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat
    {
        return 60;
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return self.unmakeScoreList.count;
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell:HomeworkReviewCell = tableView.dequeueReusableCell(withIdentifier: "SwiftCell") as! HomeworkReviewCell
        let json = self.unmakeScoreList[indexPath.row]
       cell.setUnmakeScoreExam(json: json)
        cell.selectionStyle = UITableViewCellSelectionStyle.none
        return cell
    }
    
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let json = self.unmakeScoreList[indexPath.row]
        self.makeScore(Info: json)
    }
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    var tableView :UITableView!
    lazy var courseOpenId:String = ""
    lazy var openClassId:String = ""
    lazy var examTermTimeId:String = ""
    lazy var examId:String = ""
    var unmakeScoreList = [examModel]()
    var textField = UITextField()
}


extension examUnmakeScoreView{
    //获取数据
    func getUnmakeScoreData(isRefresh:Bool){
            let dict = ["courseOpenId":courseOpenId,
                        "openClassId":openClassId,
                        "examId":examId,
                        "examTermTimeId":examTermTimeId,
                        "state":1] as [String : Any]
            XLBallLoading.show(in: self.view)
            Alamofire.request(appAPI.OnlineExam_getReadStuList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if(json["code"]>0){
                        self.getList(isRefresh: isRefresh, json: json["examStuList"])
                        if(!isRefresh){
                            //结束刷新
                            self.tableView.mj_header.endRefreshing()
                        }
                    }else{
                        ZKProgressHUD.showMessage(json["msg"].stringValue);
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！");
                    XLBallLoading.hide(in: self.view)
                }
            }
    }
    func getList(isRefresh:Bool,json:JSON){
        for i in json {
            let Info = examModel.init(data: i.1)
            self.unmakeScoreList.append(Info)
        }
        self.tableView.reloadData()
        common.share.setTableFootView_noData(self.tableView, list: self.unmakeScoreList as NSArray)
    }
    //打分
    func makeScore(Info:examModel){
        let alert = SCLAlertView()
        //添加第一个输入框
        self.textField = alert.addTextField("输入分数")
        self.textField.delegate = self
        textField.keyboardType = .numberPad
        alert.addButton("确定") {
            let dict = ["teaId":Account.defaultAccount.id!,
                        "courseOpenId":self.courseOpenId,
                        "openClassId":self.openClassId,
                        "examId":self.examId,
                        "examTermTimeId":self.examTermTimeId,
                        "examStuId":Info.examStuId.description,
                        "stuId":Info.stuId.description,
                        "getScore":self.textField.text!,
                        "sourceType":3] as [String : Any]
            XLBallLoading.show(in: self.view)
            Alamofire.request(appAPI.OnlineExam_markingStuExam, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON {  response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if(json["code"]>0){
                        print("成功")
                        ZKProgressHUD.showMessage(json["msg"].stringValue)
                        self.unmakeScoreList.removeAll()
                        self.getUnmakeScoreData(isRefresh: false)
                    }else{
                        ZKProgressHUD.showMessage(json["msg"].stringValue)
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    XLBallLoading.hide(in: self.view)
                    ZKProgressHUD.showMessage("网络环境异常请稍后再试！");
                }
            }
        }
        alert.showEdit("", subTitle: "请输入设置的分数", closeButtonTitle: "取消")
    }
}
