//
//  guidanceViewController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/30.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension guidanceView{
    
    func refreshItemData(isRefresh:Bool){
        XLBallLoading.show(in: self.view)
        let dict = ["courseOpenId":self.courseOpenId]
        Alamofire.request(appAPI.AssistTeacher_getCourseNavigation, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value{
                let json = JSON(value)
                if json["code"] == 1 {
                    self.docId = json["Id"].stringValue
                    self.docTitle = json["docTitle"].stringValue
                    self.imgurl = json["thumbnail"].stringValue
                    self.doctype = json["categoryName"].stringValue
                    self.navigationUrl = json["navigationUrl"].stringValue
                    common.share.setSDImg(str: self.imgurl, imgview: self.img_centent)
                    //下载
                    let downloadItem = UIBarButtonItem.init(title: "下载", style: UIBarButtonItemStyle.plain, target :self, action: #selector(self.download));
                    self.navigationItem.rightBarButtonItem = downloadItem;
                    
                }
                XLBallLoading.hide(in: self.view)
                self.img_centent.image = UIImage.init(named: "data-none.png")
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    //打开观看
   @objc  func pushView(sender: UITapGestureRecognizer){
        let json = JSON.init(parseJSON: self.navigationUrl)
        switch json["category"] {
//        case "video":
//            print("video")
//                        let  vc = videoAVViewController();
//                        vc.videourl =  json["urls"]["preview"].stringValue
//                        vc.resourcesUrl = json
//                        self.isPushed = true
//                        self.navigationController?.pushViewController(vc, animated: true);
//
//        case "mp3":
//            print("mp3")
//                        let  vc = audioViewController();
//                        if(!json["urls"]["preview_oss_gen"].stringValue.isEmpty){
//                            vc.audiourl = json["urls"]["preview_oss_gen"].stringValue
//                        }else{
//                            vc.audiourl = json["urls"]["preview"].stringValue
//                        }
//
//                        vc.title = "导学附件音频"
//                        vc.isNet = true
//                        self.isPushed = true
//                        vc.hidesBottomBarWhenPushed = true
//                        self.navigationController?.pushViewController(vc, animated: true)
//
        case "img":
            print("img")
                        let vc = PicturePreviewView()
                        vc.imgurl = json["urls"]["preview_oss_ori"].stringValue
                        if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
                            vc.imgurl = json["urls"]["preview"].stringValue
                        }
                        self.isPushed = true
                    self.navigationController?.pushViewController(vc, animated: true)
        case "office","ppt","pptx","doc","docx":

            if(json["isH5"].intValue == 1){
//                print("isH5")
//                let vc = teacherPPTOffficeViewViewController()
//                vc.isTeaching = false
//                self.isPushed = true
//                vc.resourceUrl = self.navigationUrl.description
//                present(vc, animated: false, completion: nil)
                let vc = PPT_Animation_PreviewView()
                vc.isTeaching = false
                self.isPushed = true
                vc.isKJ = false
                vc.linkStr = json["h5PreviewUrl"].stringValue
                self.navigationController?.pushViewController(vc, animated: true)
            }else{
                let  vc = stuImage_ppt_wordPreviewVC()
                self.isPushed = true
                vc.isKJ = false
                vc.isfirst = false
                vc.resourceUrl = self.navigationUrl.description
                self.navigationController?.pushViewController(vc, animated: true)
            }
        default:
            print("11")
        }
    }

    //下载
    @objc func download(){
        let cx = SQLiteManagerCache()
        let path = cx.readOneData(_userId: Account.defaultAccount.id!, docId: self.docId)
        if(path.docPath.isEmpty){
            let vc = cacheViewController();
            vc.docId = self.docId;
            vc.docUrl = JSON.init(parseJSON: self.navigationUrl)["urls"]["download"].string!;
            vc.docType = self.type.index(of:self.doctype)!
            vc.docTitle = self.docTitle;
            vc.isStart = true;
            self.navigationController?.pushViewController(vc, animated: true);
        }else{
           switch path.docType {
            case 1:
            print("===")
//                let  vc = videoAVViewController()
//                vc.videourl = path.docPath;
//                vc.isNet = false;
//                present(vc, animated: false, completion: nil)
            case 2:
            print("===")
//                let  vc = audioViewController();
//                vc.audiourl = path.docPath;
//                vc.title = "播放音频"
//                vc.tittlelab.text = path.docTitle
//                vc.isNet = false;
//                present(vc, animated: false, completion: nil)
            case 3:
                //                let vc = whiteboardView();
                //                let sandboxFilePath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                //                vc.file = sandboxFilePath
                //                present(vc, animated: false, completion: nil)
                let vc = cachePreviewImgView()
                let fullPath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
                vc.file =  fullPath
                present(vc, animated: false, completion: nil)
            case 4,5:
                self.openOffice(path: path);
            default:
                print("asxa")

            }
        }
    }
    func documentInteractionControllerViewControllerForPreview(_ controller: UIDocumentInteractionController) -> UIViewController
    {
        //这个地方需要返回给一个控制器用于展现documentController在其上面，所以我们就返回当前控制器self
        return self
    }
    func openOffice(path:CacheDocModel){
        let sandboxFilePath = "\(NSHomeDirectory())/Documents/\(path.docPath)"
        let docUrl = URL(fileURLWithPath: sandboxFilePath);
        documentController = UIDocumentInteractionController(url:docUrl)
        documentController.delegate = self;
        //当前APP打开  需实现协议方法才可以完成预览功能
        documentController.presentPreview(animated: true);
        
    }
    
    
    
    
}
