//
//  stuGradeController.swift
//  云课堂-职教云
//
//  Created by zqy on 2018/3/23.
//  Copyright © 2018年 zqy. All rights reserved.
//

import Foundation
import SwiftyJSON
import Alamofire
import SCLAlertView

extension stuResultsView{
    func getClassStuScoreList(){

        XLBallLoading.show(in: self.view)
        let dict = ["courseOpenId":self.courseOpenId,
                    "openClassId":self.openClassId]
        Alamofire.request(appAPI.AssistTeacher_getClassStuScoreList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)

                if(json["code"]>0){
                    self.tableView.isHidden = false
                    if json["classStuScorelist"].count > 0{
                        self.list = json["classStuScorelist"].array! as NSArray;
                        self.lab_online.text = "线上(\(json["testPercent"]["onLinePercent"])%)"
                        self.lab_offline.text = "线下(\(json["testPercent"]["offLinePercent"])%)"
                        self.lab_homework.text = "作业(\(json["testPercent"]["homeWorkPercent"])%)"
                        self.lab_exam.text = "考试(\(json["testPercent"]["examPercent"])%)"
                        self.fetchCoverDetails()
                    }
                }else{
//                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                    //自定义提示框样式
                    let appearance = SCLAlertView.SCLAppearance(
                        showCloseButton: false //不显示关闭按钮
                    )
                    //使用自定义样式的提示框
                    let alert = SCLAlertView(appearance: appearance)
                    alert.addButton("确定") {
                        self.navigationController?.popViewController(animated: true)
                    }
                    alert.showInfo("温馨提示！", subTitle: json["msg"].stringValue)
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    func  fetchCoverDetails(){
        self.selStuInfos.removeAll()
        self.reservedInfo.removeAll()
        self.searchBar.text = ""
        for i in 0..<self.list.count {
        let stuinfo = JSON(self.list[i])
        let selstu = StuInfo.init(stuId:stuinfo["stuId"].stringValue,
                                  stuName:stuinfo["stuName"].stringValue ,
                                  stuNo: stuinfo["stuNo"].stringValue,
                                  homeworkScore: stuinfo["homeworkScore"].stringValue,
                                  examScore: stuinfo["examScore"].stringValue,
                                  onlineScore: stuinfo["onlineScore"].stringValue,
                                  offLineScore: stuinfo["offLineScore"].stringValue,
                                  groupTaskScore: stuinfo["groupTaskScore"].stringValue,
                                  statisScore: stuinfo["statisScore"].doubleValue,
                                  totalScore: stuinfo["totalScore"].doubleValue)
            selStuInfos.append(selstu)
        }
        self.reservedInfo = self.selStuInfos
        //重现加载表格数据
        self.tableView!.reloadData();
    }

   @objc func orderBytype (_ btn : UIButton){
        
        if self.btn_stuName != btn {
            self.btn_stuName.isSelected = false
        }
        if self.btn_stuNum != btn {
            self.btn_stuNum.isSelected = false
        }
        let tag = btn.tag
        btn.isSelected = !btn.isSelected
        self.sortByType(tag: tag,isAsc:btn.isSelected)

    }
    func sortByType(tag:Int,isAsc:Bool){
        if(tag == 1){
            self.selStuInfos.sort(by: {(stu1, stu2) in
                if(isAsc){
                    return stu1.stuName > stu2.stuName
                }else{
                    return stu1.stuName < stu2.stuName
                }
            });
        }else{
            self.selStuInfos.sort(by: {(stu1, stu2) in
                if(isAsc){
                    return stu1.stuNo > stu2.stuNo
                }else{
                    return stu1.stuNo < stu2.stuNo
                }
            });
        }
        self.tableView.reloadData()
    }
}
