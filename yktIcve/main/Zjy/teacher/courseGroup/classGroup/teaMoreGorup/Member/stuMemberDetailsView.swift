//
//  stuMemberDetailsView.swift
//  云课堂2
//
//  Created by cc on 2018/6/25.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
import SCLAlertView

class stuMemberDetailsView: UIViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.title = "成员信息"
        self.setUI()
        self.navigationController?.navigationBar.setBackgroundImage(UIImage(), for: UIBarMetrics.default)
        self.navigationController?.navigationBar.shadowImage = UIImage()
        // Do any additional setup after loading the view.
    }
   
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    func setUI(){
        self.view.addSubview(self.headView)
        self.headView.addSubview(self.image_head)
        self.view.addSubview(self.lab_Name)
        self.view.addSubview(self.lab_qq)
        self.view.addSubview(self.btn_tel)
        self.view.addSubview(self.btn_reset)
        self.headView.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(150)
            make.top.left.equalTo(0)
        }
        self.image_head.snp.makeConstraints { (make) in
            make.width.equalTo(70)
            make.height.equalTo(70)
            make.centerX.equalTo(self.headView.snp.centerX)
            make.bottom.equalTo(self.headView.snp.bottom).offset(35)
        }
        self.image_head.layer.masksToBounds = true
        self.image_head.layer.cornerRadius = 35
        common.share.setSDImg(str: self.stuInfo.imgurl, imgview: self.image_head)
        
        self.lab_Name.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(30)
            make.centerX.equalTo(self.headView.snp.centerX)
            make.top.equalTo(self.image_head.snp.bottom).offset(15)
        }
        self.lab_qq.snp.makeConstraints { (make) in
            make.width.equalTo(width / 3 * 2)
            make.height.equalTo(40)
            make.centerX.equalTo(self.headView.snp.centerX)
            make.top.equalTo(self.lab_Name.snp.bottom).offset(30)
        }
        self.lab_qq.layer.borderWidth = 1
        self.lab_qq.layer.borderColor = UIColor.colorWithHex(hexColor: 0xE0E0E0).cgColor
        
        self.btn_tel.snp.makeConstraints { (make) in
            make.width.height.equalTo(self.lab_qq)
            make.centerX.equalTo(self.headView.snp.centerX)
            make.top.equalTo(self.lab_qq.snp.bottom).offset(15)
        }
        self.btn_tel.layer.borderWidth = 1
        self.btn_tel.layer.borderColor = UIColor.colorWithHex(hexColor: 0xE0E0E0).cgColor

        self.btn_reset.snp.makeConstraints { (make) in
            make.width.equalTo(self.lab_qq)
            make.height.equalTo(40)
            make.centerX.equalTo(self.headView.snp.centerX)
            make.top.equalTo(self.btn_tel.snp.bottom).offset(15)
        }
        self.btn_reset.layer.borderWidth = 1
        self.btn_reset.layer.borderColor = UIColor.colorWithHex(hexColor: 0xE0E0E0).cgColor
        
        self.lab_Name.text = self.stuInfo.name
        
        if (self.stuInfo.qq.isEmpty){
            self.lab_qq.attributedText = shezhi(str: "  \u{e728}  暂无", colorStr: 0x27BE71)
        }else{
            self.lab_qq.attributedText = shezhi(str: "  \u{e728}  " + (self.stuInfo.qq), colorStr: 0x27BE71)
        }

        if (self.stuInfo.tel.isEmpty){
            self.btn_tel.setAttributedTitle(shezhi(str: "  \u{e719}  暂无", colorStr: 0x27BE71), for: .normal)
        }else{
            self.btn_tel.setAttributedTitle(shezhi(str: "  \u{e719}  " + self.stuInfo.tel, colorStr: 0x27BE71), for: .normal)
        }

        self.btn_reset.setAttributedTitle(shezhi(str: "  \u{e729}  重置密码", colorStr: 0x27BE71), for: .normal)
        self.btn_reset.addTarget(self, action: #selector(self.confirmShow(_ :)), for: .touchUpInside)
        self.btn_tel.addTarget(self, action: #selector(self.confirmShow(_ :)), for: .touchUpInside)
        self.btn_reset.tag = 1
        self.btn_reset.contentHorizontalAlignment = .left
    }
    //重置密码
    @objc func Reset(){
            XLBallLoading.show(in: self.view)
            let dict = ["schoolId":Account.defaultAccount.schoolId!,
                        "stuIds":self.stuInfo.id
                ]as [String:Any]
            Alamofire.request(appAPI.AssistTeacher_resetStuPassword, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if json["code"] == 1{
                        SCLAlertView().showSuccess("重置成功", subTitle: "已将\(self.stuInfo.name)的登陆密码设为666666",closeButtonTitle: "确定")
                    }else{
                        ZKProgressHUD.showError("重置失败");
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showError("网络环境异常请稍后再试！");
                    XLBallLoading.hide(in: self.view)
                }
            }
    }



    /// confirm
    ///
    /// - Parameter type: <#type description#>
    @objc func  confirmShow(_ btn :UIButton){
        if(btn.tag == 2 && self.stuInfo.tel.isEmpty)
        {
            ZKProgressHUD.showMessage("电话信息不完善无法识别")        ;
            return
        }
        let _title = btn.tag == 1 ? "重置密码" :"拨打电话"
        let _msg = btn.tag == 1 ? "您确定要重置密码吗？" :"是否要拨打此电话"

        let alertController = UIAlertController(title: _title,
                                                message: _msg, preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style: .default, handler: {
            action in
            if(btn.tag == 1){
                self.Reset()
            }else{
                self.cellTel()
            }
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)
        self.present(alertController, animated: true, completion: nil)

    }



    /// 电话号码
    ///
    /// - Parameter tel: <#tel description#>
    func cellTel(){


        //自动打开拨号页面并自动拨打电话
        let urlString = "tel://" + self.stuInfo.tel
        if let url = URL(string: urlString) {
            //根据iOS系统版本，分别处理
            if #available(iOS 10, *) {
                UIApplication.shared.open(url, options: [:],
                                          completionHandler: {
                                            (success) in
                })
            } else {
                UIApplication.shared.openURL(url)
            }
        }
    }
    
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    
    lazy var headView : UIView = {
        let view = UIView()
        view.backgroundColor = UIColor.cg
        return view
    }()
    lazy var image_head : UIImageView = {
        let img = UIImageView()
        img.backgroundColor = UIColor.cg
        return img
    }()
    lazy var lab_Name : UILabel = {
        let lab = UILabel()
        lab.font = UIFont.init(name: "iconfont", size: 20)
        lab.textColor = UIColor.black
        lab.backgroundColor = UIColor.white
        lab.textAlignment = .center
        return lab
    }()
    lazy var btn_tel : UIButton  = {
        let btn = UIButton()
         btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        btn.setTitleColor(UIColor.colorWithHex(hexColor: 0x8F8F8F), for: .normal)
        btn.backgroundColor = UIColor.white
        btn.setTitle("  \u{e719}  暂无", for: .normal)
         btn.tag = 2
        btn.contentHorizontalAlignment = .left
        return btn
    }()
    lazy var lab_qq : UILabel = {
        let lab = UILabel()
        lab.font = UIFont.init(name: "iconfont", size: 14)
        lab.textColor = UIColor.colorWithHex(hexColor: 0x8F8F8F)
        lab.backgroundColor = UIColor.white
        return lab
    }()
    lazy var btn_reset : UIButton = {
        let btn = UIButton()
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        btn.setTitleColor(UIColor.black, for: .normal)
        btn.tag = 1
        return btn
    }()

    //    字体图标
    func shezhi(str:String, colorStr:Int64) -> NSAttributedString{
        let attributeString = NSMutableAttributedString(string:str)
        attributeString.addAttribute(NSAttributedStringKey.foregroundColor, value: UIColor.colorWithHex(hexColor: colorStr),
                                     range: NSMakeRange(0,3))
        attributeString.addAttribute(NSAttributedStringKey.backgroundColor, value: UIColor.white, range: NSMakeRange(0,3))
        attributeString.addAttribute(NSAttributedStringKey.font, value: UIFont.init(name: "iconfont", size: 18)!, range: NSMakeRange(0,3))
        return attributeString
    }

    var stuInfo = stuBaseInfo.init(id: "", name: "", tel: "", qq: "", imgurl: "", stuNO: "", letter: "")
   
}
