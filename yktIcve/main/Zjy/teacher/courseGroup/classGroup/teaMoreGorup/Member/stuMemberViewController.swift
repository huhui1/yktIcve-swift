//
//  memberController.swift
//  云课堂-职教云
//
//  Created by 志辉教育 on 2018/3/21.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension stuMemberView{
    //获取数据
    func getMemberList(){
        let dict = ["openClassId":openClassId,"stu":""
                ]as [String:Any]
        Alamofire.request(appAPI.AssistTeacher_getClassMemberList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    if json["dataList"].count > 0{
                        self.list = json["dataList"].arrayValue as NSArray;
                      
                    }
                     self.setData()
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                }
            
            }
        }
    }
    func setData(){
        for i in 0..<self.list.count {
            let j = JSON(self.list[i])
            let l = self.getLetter(strInput: j["Name"].stringValue )
            let s = stuBaseInfo.init(id: j["StuId"].stringValue, name:  j["Name"].stringValue, tel:  j["Mobile"].stringValue, qq:  j["QQ"].stringValue, imgurl:  j["Avator"].stringValue, stuNO: j["StuNo"].stringValue, letter: l)
            self.stuMemberList.append(s)
            self.MemberList.append(s)
           
        }
        self.Headers = []
        for serch in self.stuMemberList {
            if !self.Headers.contains(serch.letter){
                self.Headers.append(serch.letter)
            }
        }
        //排序
        self.Headers = self.Headers.sorted{ $0 < $1 }
        self.settableUI()
    }
    // 搜索代理UISearchBarDelegate方法，每次改变搜索内容时都会调用
    func searchBar(_ searchBar: UISearchBar, textDidChange searchText: String) {
        //去前后空格
         let searchText = searchText.trimmingCharacters(in: .whitespaces)
         // 没有搜索内容时显示全部组件
        if searchText == "" {
            searchBar.text = ""
            self.selStuInfos = self.stuMemberList
            self.stuMemberList = MemberList
            for serch in self.stuMemberList {
                if !self.Headers.contains(serch.letter){
                    self.Headers.append(serch.letter)
                }
            }
            self.Headers = self.Headers.sorted{ $0 < $1 }
            self.footView.isHidden = false
            self.tableView.reloadData()
        }else{// 匹配用户输入内容(不区分大小写)
            self.Headers = []
            self.selStuInfos = []
            for stu in self.MemberList {
                if (stu.name.lowercased().contains(searchText.lowercased())
                    || stu.stuNO.lowercased().contains(searchText.lowercased())){
                    print(stu)
                    self.selStuInfos.append(stu)
                }
                self.stuMemberList = self.selStuInfos
            }
            self.footView.isHidden = true
        }
        for serch in self.selStuInfos {
            if !self.Headers.contains(serch.letter)
            {
                self.Headers.append(serch.letter)
            }
        }
        self.Headers = self.Headers.sorted{ $0 < $1 }
        self.tableView.reloadData()
    }
   
}
