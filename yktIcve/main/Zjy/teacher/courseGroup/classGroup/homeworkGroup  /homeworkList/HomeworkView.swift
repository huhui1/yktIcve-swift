//
//  HomeworkView.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/25.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
class HomeworkView: UIViewController,UITableViewDelegate,UITableViewDataSource {
    
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.colorWithHex(hexColor: 0xfafafa)
        self.title = "作业"
        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))
        self.navigationItem.leftBarButtonItem = item
        let item1 = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item1
        common.share.setBackButtonItem(item:item)
        self.settableview()
        self.refreshItemData(isRefresh: true)
        
        // Do any additional setup after loading the view.
    }
    override func viewWillAppear(_ animated: Bool) {
        if isPushPeview{
            self.refreshItemData(isRefresh: false)
        }
        self.isPushPeview = false
    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.list.count
    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 185
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {

        let cell:HomeworkCell = tableView.dequeueReusableCell(withIdentifier: "HomeworkCell")
            as! HomeworkCell
        cell.selectionStyle = UITableViewCellSelectionStyle.none
        let json = self.list[indexPath.row]
        //查看更多
        cell.IsMoreBtn.tag = indexPath.row
        cell.IsMoreBtn.addTarget(self, action: #selector(self.viewMore(_:)), for: .touchUpInside)
        //编辑
        cell.editor.tag = indexPath.row
        cell.editor.addTarget(self, action: #selector(self.tap(_:)), for: .touchUpInside)
        
        cell.setjson(json: json)
        return cell
    }
    //跳转到活动
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
            let data = self.list[indexPath.row]
            if(data["isSetTime"].intValue == 0){
                ZKProgressHUD.showMessage("未设置作业时间!")
                return
            }
            if data["homeworkType"].intValue == 1{
                //题库作业
                let vc = HomeworkReviewListView()
                vc.openClassId = self.openClassId
                vc.courseOpenId = self.courseOpenId
                vc.homeworkTermTimeId = data["homeworkTermTimeId"].stringValue
                vc.homeWorkId = data["homeworkId"].stringValue
                vc.ztWay = data["ztWay"].intValue
                vc.homeworkType = data["homeworkType"].intValue
                vc.homeworktitle = data["title"].stringValue
                self.isPushPeview = true
                vc.hidesBottomBarWhenPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
            }else if data["homeworkType"].intValue == 2{
                let vc = HomeworkMakeScoreListView()
                vc.openClassId = self.openClassId
                vc.courseOpenId = self.courseOpenId
                vc.homeworkTermTimeId = data["homeworkTermTimeId"].stringValue
                vc.homeWorkId = data["homeworkId"].stringValue
                vc.homeworkTitle = data["title"].stringValue
                self.isPushPeview = true
                vc.hidesBottomBarWhenPushed = true
                self.navigationController?.pushViewController(vc, animated: true)
                //登分作业
            }else if data["homeworkType"].intValue == 3{
                //外部作业
            }else if data["homeworkType"].intValue == 4{
                //附件作业
                if data["ztWay"].intValue == 3{
                    //附件个人作业
                    let vc = HomeworkReviewListView()
                    vc.openClassId = self.openClassId
                    vc.courseOpenId = self.courseOpenId
                    vc.homeworkTermTimeId = data["homeworkTermTimeId"].stringValue
                    vc.homeWorkId = data["homeworkId"].stringValue
                    vc.ztWay = data["ztWay"].intValue
                    vc.homeworkType = data["homeworkType"].intValue
                    vc.homeworktitle = data["title"].stringValue
                    self.isPushPeview = true
                    vc.hidesBottomBarWhenPushed = true
                    self.navigationController?.pushViewController(vc, animated: true)
                }else if data["ztWay"].intValue == 5{
                    print("附件小组作业")
                    let vc = HomeworkReviewListView()
                    vc.openClassId = self.openClassId
                    vc.courseOpenId = self.courseOpenId
                    vc.homeworkTermTimeId = data["homeworkTermTimeId"].stringValue
                    vc.homeWorkId = data["homeworkId"].stringValue
                    vc.ztWay = data["ztWay"].intValue
                    vc.homeworkType = data["homeworkType"].intValue
                    vc.homeworktitle = data["title"].stringValue
                    self.isPushPeview = true
                    vc.hidesBottomBarWhenPushed = true
                    self.navigationController?.pushViewController(vc, animated: true)
                }
            }
        }
    
    func settableview(){

        let cellXIB = UINib.init(nibName: "HomeworkCell", bundle: Bundle.main)

        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:self.view.bounds.width, height:self.view.bounds.height - 80))
        self.tableView.register(cellXIB,
                                forCellReuseIdentifier:"HomeworkCell")
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        self.tableView.backgroundColor = UIColor.colorWithHex(hexColor: 0xfafafa)
        // 设置分割线的样式为None.
        self.tableView.separatorStyle = UITableViewCellSeparatorStyle.none
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.refreshItemData(isRefresh: false)
        })
        self.view.addSubview(self.tableView)
        
    }
    
    @objc func viewMore(_ btn :UIButton){
        let json = self.list[btn.tag]
        let vc = homeworkAndExamRemarkView()
        vc.Htitle = json["title"].stringValue
        vc.content = json["remark"].stringValue
        vc.hidesBottomBarWhenPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
        
    }
    @objc func tap(_ btn:UIButton){
        let json = JSON(self.list[btn.tag]);
        let vc = setTimeView()
        vc.IsunGrouped = json["IsGrouped"].intValue == 0 ? true : false
        vc.homeworkTitle = json["title"].stringValue
        vc.homeWorkId = json["homeworkId"].stringValue
        vc.openClassId = self.openClassId
        vc.homeworkTermTimeId = json["homeworkTermTimeId"].stringValue
//        vc.reloadClosure = {() in
//            self.refreshItemData(isRefresh: false)
//        }
        self.isPushPeview = true
        vc.hidesBottomBarWhenPushed = true;
        self.navigationController?.pushViewController(vc, animated: true);
    }
    
    //返回按钮
    @objc func backBtnClick() {
        self.presentingViewController?.dismiss(animated: true, completion: nil)
    }
    lazy var courseOpenId:String = ""
    lazy var openClassId:String = ""
    lazy var list : JSON =  {
        return []
    }()
    var tableView :UITableView!
    var ztWay = 1
    var isPushPeview = false
}

