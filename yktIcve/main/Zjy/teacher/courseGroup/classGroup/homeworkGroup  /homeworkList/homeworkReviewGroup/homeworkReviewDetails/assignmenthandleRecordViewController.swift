 //
//  assignmenthandleRecordViewController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/4/1.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

extension assignmenthandleRecordView {

    //是否退回作业
    func isRejected(msg:String){
       
        let alertController = UIAlertController(title: "作业批改",
                                                message: msg, preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style: .destructive, handler: {
            action in
            self.rejected()
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)

        self.present(alertController, animated: true, completion: nil)
    }

    //退回
    func rejected(){
        let jsondata = JSON.init(parseJSON: self.data)
        let dict = ["homeworkStuId": jsondata["homeworkStuId"].stringValue,
                    "teaId": Account.defaultAccount.id!] ;
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_rejectHomework, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.reloadParentVC()
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    }


    //是否要提交批阅
    func isSubmitCorrecting(msg:String){
        let alertController = UIAlertController(title: "作业批阅",
                                                message: msg, preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style: .destructive, handler: {
            action in
            self.SubmitCorrecting()
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)

        self.present(alertController, animated: true, completion: nil)

    }

    //批阅
    func SubmitCorrecting(){
//
//        teaId: _this.userId,
//        courseOpenId: _this.courseOpenId,
//        openClassId: _this.openClassId,
//        homeworkId: _this.homeWorkId,
//        homeworkTermTimeId: _this.homeworkTermTimeId,
//        homeworkStuId: _this.homeworkStuId,
//        stuId: _this.$user,
//        sourceType: 3
        let jsondata = JSON.init(parseJSON: self.data)
        let dict = ["teaId": Account.defaultAccount.id!,
                    "courseOpenId":jsondata["courseOpenId"].stringValue,
                    "openClassId":jsondata["openClassId"].stringValue,
                    "homeworkId":jsondata["homeWorkId"].stringValue,
                "homeworkTermTimeId":jsondata["homeworkTermTimeId"].stringValue,
                    "homeworkStuId":jsondata["homeworkStuId"].stringValue,
                    "stuId":jsondata["stuId"].stringValue,
                    "sourceType":3
            ] as [String : Any]
         XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_markingStuHomework, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

                    self.reloadParentVC()

                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //批阅后刷新上一页
    func reloadParentVC(){
        if HasReview == false{
            let count = self.navigationController?.viewControllers.count
            if let vc:HomeworkReviewListView = self.navigationController?.viewControllers[count! - 2] as? HomeworkReviewListView {
                    vc.reloadHomeworkReview(m: 1)
            }
        }else{
            let count = self.navigationController?.viewControllers.count
            if let vc:HomeworkReviewListView = self.navigationController?.viewControllers[count! - 3] as? HomeworkReviewListView {
                    vc.reloadHomeworkReview(m: 2)
                }
            self.navigationController?.viewControllers.remove(at: count! - 2)
        }
        
        self.navigationController?.popViewController(animated: true);
    }

    //查看图片
    func previewImg (url:String){
//        let vc = previewLeafletImgViewController()
//        vc.isNet = true
//        vc.leafletUrl = url
//        self.isPushed = true
//        self.present(vc, animated: true, completion: nil)
//        let vc = DetailViewController()
//        vc.imageURL = NSURL.init(string: url)! as URL
//        self.isPushed = true
//          vc.hidesBottomBarWhenPushed = true
//        self.navigationController?.pushViewController(vc, animated: true)
        let vc = PicturePreviewView()
        vc.imgurl = url
        self.isPushed = true
        vc.hidesBottomBarWhenPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
    }

    //通过附件Id
    func getFileById(Id:String){

        let dict = ["Id": Id]
         XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.Homework_getFileHomeworkUrlById, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

                   self.pushView(data: json["url"].stringValue)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //通过URL获取
    func getFileInfoByUrl(url:String){

        let dict = ["url": url];
         XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.MobileLogin_getFileInfoByUrl, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

                    self.pushView(data: json["url"].stringValue)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }

    }

    //打开观看
    func pushView(data:String){
          let json = JSON.init(parseJSON: data)
        switch json["category"] {
        case "video":
            let vc = videoPlayView() 
            vc.isFromZjyErrorQuestion = true
            vc.videourls.removeAll()
            vc.videourls.append(json["urls"]["preview"].stringValue)
            self.isPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "mp3":
            let  vc = audioViewController();
            if(!json["urls"]["preview_oss_gen"].stringValue.isEmpty){
                vc.audiourl = json["urls"]["preview_oss_gen"].stringValue
            }else{
                vc.audiourl = json["urls"]["preview"].stringValue
            }
            vc.title = "作业附件音频"
            vc.isNet = true
            self.isPushed = true
            vc.hidesBottomBarWhenPushed = true
            self.navigationController?.pushViewController(vc, animated: true)
        case "img":
            let vc = whiteboardView()
            vc.file = json["urls"]["preview_oss_ori"].stringValue
            if(json["urls"]["preview_oss_ori"].stringValue.isEmpty){
                vc.file = json["urls"]["preview"].stringValue
            }
            self.isPushed = true
            present(vc, animated: true, completion: nil)
       case "office","ppt","pptx","doc","docx":
        if(json["isH5"].intValue == 1){
            let vc = teacherPPTOffficeViewViewController()
            vc.isTeaching = false
            self.isPushed = true
            vc.resourceUrl = data
            self.present(vc, animated: false, completion: nil)
        }else{
            let  vc = previewOfficeFromresViewController()
            self.isPushed = true
            vc.resourceUrl = data
            self.isPushed = true
            self.present(vc, animated: false, completion: nil)
        }
        default:

            print("11")
        }
    }


}
