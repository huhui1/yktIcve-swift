//
//  setTimeController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/26.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension setTimeView {
    func getHomeworkTimeInfo(){
        //        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
        //
        //        ZKProgressHUD.show();
        XLBallLoading.show(in: self.view)
        let dict = ["openClassId":self.openClassId,"homeWorkId":self.homeWorkId,"homeworkTimeId":self.homeworkTermTimeId] as [String:Any]
        Alamofire.request(appAPI.Homework_getHomeworkTimeInfo, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                //                ZKProgressHUD.hide(delay: 0);
                if(json["code"]>0){
                    self.text_timeBeginDate.text = json["homeworkTimeInfo"]["StuStartDate"].stringValue
                    self.text_timeOverDate.text = json["homeworkTimeInfo"]["StuEndDate"].stringValue
                    //                    self.text_checktime.text = json["homeworkTimeInfo"]["ReadEndDate"].stringValue
                    if(json["homeworkTimeInfo"]["IsForbid"] == 1){
                        self.isOnSwitch.setOn(false, animated: true)
                        self.state = 1
                    }else{
                        self.isOnSwitch.setOn(true, animated: true)
                        self.state = 0
                    }
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
        
    }
    
    @objc func btnTap(_ btn :UIButton ){
        if self.IsunGrouped{
            let alertController = UIAlertController(title: "温馨提示！",
                                                    message:"请先对该班级进行学生分组！", preferredStyle: .alert)
            let okAction = UIAlertAction(title: "确定", style: .cancel, handler: nil)
            alertController.addAction(okAction)
            self.present(alertController, animated: true, completion: nil)
            return
        }
        
        let StuStartDate = self.text_timeBeginDate.text!
        let StuOverDate = self.text_timeOverDate.text!
        //        let ReadEndDate = self.text_checktime.text as! String
        let dateFormatter = DateFormatter();
        dateFormatter.dateFormat = "yyyy-MM-dd HH:mm:ss";
        let sDate = dateFormatter.date( from: StuStartDate)
        let eDate = dateFormatter.date( from: StuOverDate)
        //        let aDate = dateFormatter.date( from: ReadEndDate)
        if(StuStartDate.count == 0){
            ZKProgressHUD.showMessage("请选择开始时间!")
            return
        }
        if(StuOverDate.count == 0){
            ZKProgressHUD.showMessage("请选择结束时间!")
            return
        }
        //        if(ReadEndDate.count == 0){
        //            ZKProgressHUD.showMessage("请选择查看答案时间!")
        //            return
        //        }
        
        let startTimeInterval = (sDate?.timeIntervalSince1970)!
        let endTimeInterval = (eDate?.timeIntervalSince1970)!
        //        let ReadEndDateInterval = (aDate?.timeIntervalSince1970)!
        
        
        
        if(endTimeInterval < startTimeInterval){
            ZKProgressHUD.showMessage("结束时间不能比开始时间早!")
            return
        }
        
        let dict  = [ "Id":self.homeworkTermTimeId,
                      "CreatorId":Account.defaultAccount.id!,
                      "OpenClassId":self.openClassId,
                      "HomeWorkId":self.homeWorkId,
                      "StuStartDate":StuStartDate,
                      //                    "ReadEndDate":ReadEndDate,
            "StuEndDate":StuOverDate,
            "IsForbid":self.state,
            "SourceType":3] as [String : Any]
        let data = ["data":JSON.init(dict)]
        Alamofire.request(appAPI.Homework_saveHomeworkTimeInfo, method: .post, parameters: data, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"]>0){
//                    self.reloadClosure!();
                    self.navigationController?.popViewController(animated: true)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
    }
    @objc func pickStartDate(_ textField : UITextField){
        self.datePicker.backgroundColor = UIColor.white;
        let dateFormatter = DateFormatter();
        dateFormatter.dateFormat = "yyyy-MM-dd HH:mm:ss";
        let minDate = dateFormatter.date(from: "1900-01-01 00:00:00");
        let maxDate = dateFormatter.date(from: "2030-01-01 00:00:00");
        datePicker.minimumDate = minDate;
        datePicker.maximumDate = maxDate;
        textField.inputView = self.datePicker;
        // ToolBar
        let toolBar = UIToolbar();
        toolBar.barStyle = .default;
        toolBar.isTranslucent = true;
        toolBar.tintColor = UIColor(red: 92/255, green: 216/255, blue: 255/255, alpha: 1);
        toolBar.sizeToFit();
        
        
        // Adding Button ToolBar
        let doneButton = UIBarButtonItem(title: "确定", style: .plain, target: self, action: #selector(self.doneClick(_ :)));
        doneButton.tag =  textField.tag
        let spaceButton = UIBarButtonItem(barButtonSystemItem: .flexibleSpace, target: nil, action: nil)
        let cancelButton = UIBarButtonItem(title: "取消", style: .plain, target: self, action: #selector(self.cancelClick(_ :)));
        cancelButton.tag =  textField.tag
        toolBar.setItems([cancelButton, spaceButton, doneButton], animated: false);
        toolBar.isUserInteractionEnabled = true;
        textField.inputAccessoryView = toolBar;
        
    }
    @objc func doneClick( _ btn:UIButton) {
        let formatter = DateFormatter();
        //日期样式
        formatter.dateFormat = "yyyy-MM-dd HH:mm:ss";
        if(btn.tag == 1){
            
            self.text_timeBeginDate.text = formatter.string(from: self.datePicker.date);
            self.text_timeBeginDate.resignFirstResponder();
        }
        //        if(btn.tag == 3){
        //
        //            self.text_checktime.text = formatter.string(from: self.datePicker.date);
        //            self.text_checktime.resignFirstResponder();
        //        }
        if(btn.tag == 2){
            self.text_timeOverDate.text = formatter.string(from: self.datePicker.date);
            self.text_timeOverDate.resignFirstResponder();
        }
    }
    @objc func cancelClick(_ btn:UIButton) {
        if(btn.tag == 1){
            self.text_timeBeginDate.resignFirstResponder();
        }
            //        if(btn.tag == 3){
            //            self.text_checktime.resignFirstResponder();
            //        }
        else {
            self.text_timeOverDate.resignFirstResponder();
        }
        
    }
}

