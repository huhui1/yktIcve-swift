//
//  linkclassController.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/20.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension linkclassView {
    func getCourseClassList(isRefresh:Bool){
        let dict = ["userId": Account.defaultAccount.id!,
                    "courseOpenId":self.courseOpenId,
                    "openClassState":self.classState] as [String : Any];
        Alamofire.request(appAPI.AssistTeacher_getCourseClassList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value);
                if json["code"] == 1{
                    if json["isMainTeacher"] == 1{
                        let Item = UIBarButtonItem.init(title: "新建", style: UIBarButtonItemStyle.plain, target: self, action: #selector(self.newClass));
                        self.navigationItem.rightBarButtonItem = Item
                    }
                    self.isMainTeacher = json["isMainTeacher"].intValue
                    if self.classState == 1{
                        self.unGuiDangList = json["classList"]
                    }else{
                        self.GuiDangList = json["classList"]
                    }
                    self.tableView.reloadData()
                    if(!isRefresh){
                        //结束刷新
                        self.tableView.mj_header.endRefreshing()
                    }
                    common.share.setTableFootView_noData(self.tableView, list: json["classList"].arrayValue as NSArray)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
    //点击切换
    @objc func segmentChange(segmented:UISegmentedControl){
        //获得选项的索引
        print(segmented.selectedSegmentIndex)
        if (segmented.selectedSegmentIndex == 0) {
            //进行中
            self.classState = 1
            if unGuiDangList.count == 0{
                self.getCourseClassList(isRefresh: false)
            }else{
                self.tableView.reloadData()
                common.share.setTableFootView_noData(self.tableView, list: self.unGuiDangList.arrayValue as NSArray)
            }
        }else{
            //已归档
            self.classState = 2
            if GuiDangList.count == 0{
                self.getCourseClassList(isRefresh: false)
            }else{
                self.tableView.reloadData()
                common.share.setTableFootView_noData(self.tableView, list: self.GuiDangList.arrayValue as NSArray)
            }
        }
    }
    //删除课程
    func deleteOpenClass(openClassId:String,index:Int){
        let alertController = UIAlertController(title: "提示",
                                                message:"确定删除该班级？", preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style:.default, handler: {
            action in
        
            let dict = ["openClassId":openClassId]
            Alamofire.request(appAPI.DesignTeacher_deleteOpenClass, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value);
                    if json["code"] == 1{
                        self.getCourseClassList(isRefresh: false)
                        var arr = self.unGuiDangList.arrayValue
                        arr.remove(at: index)
                        self.unGuiDangList = JSON(arr)
                        let indexPath =  NSIndexPath.init(item: index, section: 0) as IndexPath
                        self.tableView.deleteRows(at: [indexPath], with: .automatic);
                        
                    }else{
                        ZKProgressHUD.showError(json["msg"].stringValue);
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showError("网络异常请稍后再试！");
                    XLBallLoading.hide(in: self.view)
                }
            }
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)
        self.present(alertController, animated: true, completion: nil)
    }
}


