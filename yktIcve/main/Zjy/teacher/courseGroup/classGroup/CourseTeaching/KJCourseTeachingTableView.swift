//
//  KJCourseTeachingTableView.swift
//  云课堂2
//  教师课件下的教学列表
//  Created by cc on 2018/7/7.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

class KJCourseTeachingTableView: UIViewController,UITableViewDelegate,UITableViewDataSource {

    var courseBBSAction : CourseBBSAction?
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.getData()
        self.setTableUI()
    }
    
    func setTableUI(){
        if isMusicAndVideo{
            ht += 150
        }
        self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:self.view.bounds.width, height:self.view.bounds.height  - CGFloat(ht)))
        self.tableView.backgroundColor = UIColor.white
        self.tableView.register(CourseTeachsCell.self, forCellReuseIdentifier: "SwiftCell");
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        self.tableView.separatorInset = UIEdgeInsets.zero;
        self.tableView.layoutMargins = UIEdgeInsets.zero;
        self.tableView.delegate = self
        self.tableView.dataSource = self
        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.getData()
        })
        
        self.view.addSubview(self.tableView);
        
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    // MARK: - Table view data source

     func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }
    
     func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return self.List.count
    }
     func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 142
    }
    
     func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
//        let cell:CourseTeachsCell = tableView.dequeueReusableCell(withIdentifier: "SwiftCell", for: indexPath) as! CourseTeachsCell
        let identifier = "CourseTeachsCell"
        self.tableView.register(UINib(nibName:"CourseTeachsCell", bundle:nil),
                                forCellReuseIdentifier:identifier)
        
        let cell:CourseTeachsCell = tableView.dequeueReusableCell(withIdentifier: identifier)
            as! CourseTeachsCell
        let data = JSON(self.List[indexPath.row])
        //去除点击cell变灰
        cell.selectionStyle = UITableViewCellSelectionStyle.none

        cell.ishaddencourseName = false
        cell.setjson(json: data)
        cell.btn_editor.tag = indexPath.row
        cell.btn_editor.addTarget(self, action: #selector(self.edittapped(_:)), for: .touchUpInside)
        return cell
    }

    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
          let json = JSON(self.List[indexPath.row])

        self.courseBBSAction?.activityId = json["Id"].stringValue
        self.courseBBSAction?.faceTimeStatus = json["State"].intValue
        self.courseBBSAction?.openClassIds = json["OpenClassIds"].stringValue
        self.courseBBSAction?.ActionName = "teaching";
    }

    @objc func edittapped(_ btn: UIButton){
        let json = JSON(self.List[btn.tag])
        self.courseBBSAction?.activityId = json["Id"].stringValue
        self.courseBBSAction?.textTitle = json["Title"].stringValue
        self.courseBBSAction?.textPlace = json["Address"].stringValue
        self.courseBBSAction?.startDtae = json["StartTime"].stringValue
        self.courseBBSAction?.ClassSection = json["ClassSection"].stringValue
        self.courseBBSAction?.ActionName = "edit"
    }
    
    lazy var List : JSON =  {
        return []
    }()
    lazy var courseOpenId = ""
    lazy var openClassId = ""
    var tableView : UITableView!
    var isMusicAndVideo = false
    var ht = 103
    var activeType = 5
}

extension KJCourseTeachingTableView{
    func getData(){
        let dict =
            ["userId":Account.defaultAccount.id!,
             "faceDate":"",
             "faceTimeState":0,
             "courseOpenIds":self.courseOpenId,
             "openClassIds":self.openClassId] as [String : Any]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_getFaceActivityList, method: .post, parameters: dict).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"] == 1){
                    self.List = json["dataList"]
                    self.tableView!.reloadData();
                    common.share.setTableFootView_noData(self.tableView, list: json["dataList"].arrayValue as NSArray)
                }else{
                    ZKProgressHUD.showMessage(json["msg"].stringValue)
                }

                if self.tableView.mj_header != nil{
                     //结束刷新
                    self.tableView!.mj_header.endRefreshing();
                }

                XLBallLoading.hide(in: self.view)
            }else{
                //ZKProgressHUD.showMessage("网络开小差了")
                XLBallLoading.hide(in: self.view)
            }
        }
    }
}
