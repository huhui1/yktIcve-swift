//
//  AllthefaceView.swift
//  云课堂2
//  全部面授
//  Created by 志辉教育 on 2018/6/25.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
class AllthefaceView: UIViewController,UITableViewDelegate,UITableViewDataSource {
 
    

    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = "课堂教学"
        self.view.backgroundColor = UIColor.colorWithHex(hexColor: 0xfafafa)
        if !self.isFromcourse{
            self.setTopUI()
        }
        self.getallface(date: "", isRefresh: true)
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        // Do any additional setup after loading the view.
    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.List.count;
    }
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 142
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        
       
        let identifier = "CourseTeachsCell"
        self.tableView.register(UINib(nibName:"CourseTeachsCell", bundle:nil),
                                forCellReuseIdentifier:identifier)
        
        let cell:CourseTeachsCell = tableView.dequeueReusableCell(withIdentifier: identifier)
            as! CourseTeachsCell
        cell.selectionStyle = UITableViewCellSelectionStyle.none
        let json = self.List[indexPath.row]
        
        if self.isFromcourse{
           cell.ishaddencourseName = true
           cell.setdata(json: json)
        }else{
           cell.ishaddencourseName = false
           cell.setjson(json: json)
        }
        cell.btn_editor.tag = indexPath.row
        cell.btn_editor.addTarget(self, action: #selector(self.edittapped(_:)), for: .touchUpInside)
        return cell
    }
  
    //跳转到活动
    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        let json = self.List[indexPath.row];
        let vc = faceInfoView();
        vc.faceTimeStatus = json["State"].intValue
        vc.activityId = json["Id"].stringValue;
        vc.courseOpenId =  json["CourseOpenId"].stringValue;
        vc.openClassIds = json["OpenClassIds"].stringValue
        
        vc.hidesBottomBarWhenPushed = true
        self.navigationController?.pushViewController(vc, animated: true);
        
    }
    
  
    
    //返回编辑类型，滑动删除
    func tableView(_ tableView: UITableView, editingStyleForRowAt indexPath: IndexPath) -> UITableViewCellEditingStyle {
        return UITableViewCellEditingStyle.delete
        
    }
    
    //在这里修改删除按钮的文字
    func tableView(_ tableView: UITableView, titleForDeleteConfirmationButtonForRowAt indexPath: IndexPath) -> String? {
        return "删除"
        
    }
    //点击删除按钮的响应方法，在这里处理删除的逻辑
    func tableView(_ tableView: UITableView, commit editingStyle: UITableViewCellEditingStyle, forRowAt indexPath: IndexPath) {
        
        if editingStyle == UITableViewCellEditingStyle.delete {
            let alertController = UIAlertController(title: "提示！",
                                                    message:"是否删除本次课堂教学?", preferredStyle: .alert)
            let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
            let okAction = UIAlertAction(title: "确定", style: .destructive, handler: {
                action in
                self.delFaceActivity(activityId: self.courseList[indexPath.row]["Id"].stringValue, tableView, forRowAt: indexPath)
            })
            alertController.addAction(cancelAction)
            alertController.addAction(okAction)
            
            self.present(alertController, animated: true, completion: nil)
        }
        
    }
    //编辑
    @objc func edittapped(_ button:UIButton){
        let tag = button.tag;
        let json = JSON(self.List[tag])
        let vc = createFaceView()
        vc.title = "编辑课堂教学"
        vc.activityId = json["Id"].stringValue;
        vc.openClassId = json["OpenClassIds"].stringValue;
        vc.courseOpenId = json["CourseOpenId"].stringValue;
        vc.textTitle.text = json["Title"].stringValue;
        vc.textPlace.text = json["Address"].stringValue;
        vc.startDtae.text = json["StartTime"].stringValue;
        vc.ClassSection.text = json["ClassSection"].stringValue
        vc.reloadViewClosure = { () in
            // self.getCourseClassList(isRefresh: false,date: "")
        };
        vc.hidesBottomBarWhenPushed = true
        self.navigationController?.pushViewController(vc, animated: true);
    }
    func setTopUI(){
        self.view.addSubview(top_View)
        self.top_View.addSubview(btn_Anyclass)
        self.top_View.addSubview(btn_Anycourse)
        self.top_View.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(40)
            make.centerX.equalTo(self.view.snp.centerX)
            make.top.equalTo(0)
        }
        self.btn_Anycourse.snp.makeConstraints { (make) in
            make.width.equalTo(width/2)
            make.height.equalTo(40)
            make.centerY.equalTo(self.top_View.snp.centerY)
            make.left.equalTo(0)
        }
        self.btn_Anycourse.addTarget(self, action: #selector(self.tap(_:)), for:.touchUpInside)
        self.btn_Anyclass.snp.makeConstraints { (make) in
            make.width.height.centerY.equalTo(self.btn_Anycourse)
            make.left.equalTo(self.btn_Anycourse.snp.right).offset(0)
        }
        self.btn_Anyclass.addTarget(self, action: #selector(self.tap(_:)), for:.touchUpInside)
    }
    func setUI(){
        if self.isFromcourse{
            self.tableView = UITableView.init(frame:  CGRect(x:0, y:0, width:self.view.bounds.width, height:self.view.bounds.height))
        }else{
            self.tableView = UITableView.init(frame:  CGRect(x:0, y:40, width:self.view.bounds.width, height:self.view.bounds.height - 40))
        }
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        // 设置分割线的样式为None.
        self.tableView.separatorStyle = UITableViewCellSeparatorStyle.none
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            self.getallface(date: "", isRefresh: false)
        })
     
        
        self.view.addSubview(self.tableView)
    }
    //不限课程，班级
    @objc func tap(_ btn : UIButton){
        btn.isSelected = true;
        if(btn.tag == 4){
           self.getCourseList(isCourse: true)
        }else{
           self.getClassList(isCourse: false)
        }
    }
    
    
    
    lazy var courseOpenIds :String = {
        return ""
    }()
    lazy var openClassIds :String = {
        return ""
    }()
    lazy var OpenClassName :String = {
        return ""
    }()
    lazy var CourseName :String = {
        return ""
    }()
    var isFromcourse :Bool = false
    var tableView :UITableView!
    lazy var List : JSON =  {
        return []
    }()
    lazy var courseList : JSON =  {
        return []
    }()
    lazy var classList : JSON =  {
        return []
    }()

    let width = UIScreen.main.bounds.width
    lazy var top_View:UIView = {
        let view = UIView()
        view.backgroundColor = UIColor.white
        return view
    }()
    //不限课程
    lazy var btn_Anycourse:UIButton = {
        let btn = UIButton()
        btn.setTitle("全部课程 \u{e607}", for:.normal)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        btn.titleLabel?.textAlignment = .center
        btn.setTitleColor(UIColor.colorWithHex(hexColor: 0x646464), for:.normal)
        btn.setTitleColor(UIColor.bg, for:.selected)
        btn.tag = 4
        return btn
    }()
    
    //不限班级
    lazy var btn_Anyclass:UIButton = {
        let btn = UIButton()
        btn.setTitle("全部班级 \u{e607}", for:.normal)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 14)
        btn.titleLabel?.textAlignment = .center
        btn.setTitleColor(UIColor.colorWithHex(hexColor: 0x646464), for:.normal)
        btn.setTitleColor(UIColor.bg, for:.selected)
        btn.tag = 5
        return btn
    }()

}

    

    
    
    
    
    
    
    
    
    
    

