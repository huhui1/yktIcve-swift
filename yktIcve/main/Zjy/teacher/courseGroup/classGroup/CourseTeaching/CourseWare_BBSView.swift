//
//  CourseWare_BBSView.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/7/31.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit

class CourseWare_BBSView: UIViewController {
    lazy var courseOpenId:String = ""
    lazy var docId:String = ""
    var openClassId = "";
    var slideMenu:SlideMenu?
    var isPushed = false
    var courseBBSRefresh = CourseBBSAction.init(ActionName: "")

    let vc1 = courseBBSEvaluationView()

    let vc2 = courseBBSQuestionView()
    let vc3 = courseBBSNoteView()
    let vc4 = courseBBSErrorView()

    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = "讨论区"

        self.courseBBSRefresh.addObserver(self, forKeyPath: "ActionName", options: [.new, .old], context: nil)
        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))
        self.navigationItem.leftBarButtonItem = item
          common.share.setBackButtonItem(item:item)
        let Item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = Item
        self.view.backgroundColor = UIColor.white
        self.setSlideMenu()
        // Do any additional setup after loading the view.
    }

    //返回按钮
    @objc func backBtnClick() {
        self.presentingViewController?.dismiss(animated: true, completion: nil)
    }

    //添加监听后,使用完必须移除监听(一个add 对应一个 remove)
    deinit {
        self.courseBBSRefresh.removeObserver(self, forKeyPath: "ActionName", context: nil)
    }

    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "ActionName" {

            self.actionBBSType()
        }
    }
    func setSlideMenu(){
        var ht = 0
        if common.share.isX(){
            ht = 60
        }
        
        //1.评价，2.问答，3，笔记，4.纠错
        let titles = ["评价","问答","笔记","纠错","学习统计"]
        var arr:Array<UIViewController> = [];
        let vc5 = StatisticallearningView()


        vc1.courseOpenId = self.courseOpenId
        vc1.activeType = 1
        vc1.openClassId = self.openClassId
        vc1.cellId = self.docId
        vc1.courseBBSAction = self.courseBBSRefresh
        vc2.courseOpenId = self.courseOpenId
        vc2.activeType = 2
        vc2.openClassId = self.openClassId
        vc2.cellId = self.docId
        vc2.courseBBSAction = self.courseBBSRefresh
        vc3.courseOpenId = self.courseOpenId
        vc3.activeType = 3
        vc3.openClassId = self.openClassId
        vc3.cellId = self.docId
        vc3.courseBBSAction = self.courseBBSRefresh
        vc4.courseOpenId = self.courseOpenId
        vc4.activeType = 4
        vc4.openClassId = self.openClassId
        vc4.cellId = self.docId
        vc4.courseBBSAction = self.courseBBSRefresh
        vc5.cellId = self.docId
        vc5.openClassId = self.openClassId


        arr.append(vc1)
        arr.append(vc2)
        arr.append(vc3)
        arr.append(vc4)
        arr.append(vc5)

        slideMenu = SlideMenu(frame: CGRect(x:0,y:0,width:UIScreen.main.bounds.width,height:40), titles:titles, childControllers:arr)
        slideMenu?.backgroundColor = UIColor.white
        slideMenu?.bodyFrame =  CGRect.init(x: 0, y:40, width:UIScreen.main.bounds.width, height: UIScreen.main.bounds.height - 100 )

        let f = CGRect.init(x: 0, y:0, width:UIScreen.main.bounds.width, height: UIScreen.main.bounds.height - 100 - CGFloat(ht) )
        vc1.f = f
        vc2.f = f
        vc3.f = f
        vc4.f = f
        slideMenu?.selectedColor = UIColor(red: 6/255, green: 163/255, blue: 121/255, alpha: 1);
        slideMenu?.isFixed = true;
        slideMenu?.indicatorStyle = .followText;
        slideMenu?.titleStyle = .transfrom;
        slideMenu?.line.isHidden = false;
        slideMenu?.scrollToIndex(0)
        self.view.addSubview(slideMenu!)

    }

    @objc func actionBBSType(){

        switch (self.courseBBSRefresh.ActionName) {
        case "create":
            let vc = createCourseBBSView()
            vc.courseOpenId = self.courseOpenId
            vc.openClassId = self.openClassId
            vc.cellId = self.docId
            vc.courseBBSAction = self.courseBBSRefresh
            vc.activeType = "\(self.courseBBSRefresh.actionType)"
            self.navigationController?.pushViewController(vc, animated: true)
        case "details":
            let vc = CourseBBSDetailsView()
            vc.activeType = (self.courseBBSRefresh.actionType)
            vc.cellId = self.docId
            vc.openClassId = self.openClassId
            vc.courseOpenId = self.courseOpenId
            vc.evaluation = self.courseBBSRefresh._evaluationModel!
            vc.courseBBSAction = self.courseBBSRefresh
            vc.isMainTeacher = self.courseBBSRefresh.isMainTeacher == true ? 1 : 0
            self.navigationController?.pushViewController(vc, animated: true)
        case "teaching":
            let vc = faceInfoView();
            vc.faceTimeStatus = self.courseBBSRefresh.faceTimeStatus
            vc.activityId =   self.courseBBSRefresh.activityId
            vc.courseOpenId =  self.courseOpenId
            vc.openClassIds =   self.courseBBSRefresh.openClassIds
            self.navigationController?.pushViewController(vc, animated: true);
        case "refresh":
            switch (self.courseBBSRefresh.actionType){
                case 1:
                    vc1._BBSViewModel.getBBSData()
                case 2:
                    vc2._BBSViewModel.getBBSData()
                case 3:
                    vc3._BBSViewModel.getBBSData()
                case 4:
                    vc4._BBSViewModel.getBBSData()
                default:
                    print("")
            }
        default:
           print("_____")
        }

    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }


    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
