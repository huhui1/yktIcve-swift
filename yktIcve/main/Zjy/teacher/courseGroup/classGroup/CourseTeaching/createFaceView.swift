//
//  createFaceView.swift
//  云课堂2
//  在班级下新建面授
//  Created by 志辉教育 on 2018/6/24.
//  Copyright © 2018年 zqyou. All rights reserved.
//
import UIKit
import Alamofire
import SwiftyJSON

//重命名一个闭包
typealias reloadView = () -> Void
class createFaceView: UIViewController,UITextFieldDelegate {
    
    var courseBBSAction : CourseBBSAction?
    //创建一个闭包属性
    var reloadViewClosure : reloadView?
    
    var openClassId: String = "";
    var courseOpenId: String = "";
    var activityId :String = "";
    var actStartTime: String = "";
    var actStartDate : String = "";
    var actEndTime: String = "";
    var actAddress :String = "";
    var actTitle: String = "";
    var classSection: String = "";
    var startStamp = 0;
    var endStamp = -1;
  
    var ToolBar = UIToolbar();
    var state:Int = {
        return 0
    }()
    var video = false
    
    let HX = common.share.returnSafeAreaLineHeight()
    let width = UIScreen.main.bounds.width;
    let height = UIScreen.main.bounds.height;
    let startDtae  = UITextField(frame: CGRect(x:0, y:20, width:UIScreen.main.bounds.width, height:60));
    let textTitle  = UITextField(frame: CGRect(x:0, y:120, width:UIScreen.main.bounds.width, height:60));
    
    var datePicker : UIDatePicker!;
    var startdatePicker : UIDatePicker!;
    var enddatePicker : UIDatePicker!;
    
    let  textPlace = UITextField(frame:CGRect(x:0,y:220, width:UIScreen.main.bounds.width, height:60));
    let ClassSection = UITextField(frame: CGRect(x:0, y:320, width:UIScreen.main.bounds.width, height:60));
    lazy var pushbtu : UIButton = {
        let btn = UIButton()
        return btn
    }()
    lazy var isfrist :Bool = {
        return true
    }()

    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.setUI();
        self.view.backgroundColor = UIColor.init(red: 237/255, green: 237/255, blue: 237/255, alpha: 1);
        
        //监听键盘弹出通知
        NotificationCenter.default
            .addObserver(self,selector: #selector(keyboardWillShow(_:)),
                         name: NSNotification.Name.UIKeyboardWillShow, object: nil)
        //监听键盘隐藏通知
        NotificationCenter.default
            .addObserver(self,selector: #selector(keyboardWillHide(_:)),
                         name: NSNotification.Name.UIKeyboardWillHide, object: nil)
    }
    //去除一进来键盘的显示
    override func viewDidAppear(_ animated: Bool) {
        self.isfrist = false
        Done()
    }
   
    @objc func Done(){
        self.view.endEditing(true)
    }
    // 键盘显示
    @objc func keyboardWillShow(_ notification: Notification) {
        if(!self.isfrist){
            let userInfo = (notification as NSNotification).userInfo!
            //键盘尺寸
            let keyboardSize = (userInfo[UIKeyboardFrameBeginUserInfoKey]
                as! NSValue).cgRectValue
            var contentInsets:UIEdgeInsets
            contentInsets = UIEdgeInsetsMake(64.0, 0.0, (keyboardSize.height), 0.0);
            self.view.frame = CGRect.init(x:0, y: -64, width:self.view.bounds.width, height: self.view.bounds.height);
        }
    }
    
    // 键盘隐藏
    @objc func keyboardWillHide(_ notification: Notification) {
        if(!self.isfrist){
            //还原tableview的contentview大小
            let _:UIEdgeInsets = UIEdgeInsetsMake(64.0, 0.0, 0, 0.0);
            self.view.frame = CGRect.init(x:0, y: 64, width:self.view.bounds.width, height: self.view.bounds.height);
        }
    }
    //键盘隐藏
    override func touchesEnded(_ touches: Set<UITouch>, with event: UIEvent?) {
        self.view.endEditing(true)
    }
    //移除监听
    override func viewDidDisappear(_ animated: Bool) {
        NotificationCenter.default.removeObserver(self)
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func setUI(){
        ToolBar = common.share.AddToolKeyboardDoneBar()
        let doneButton = UIBarButtonItem(title: "确定", style: .plain, target: self, action: #selector(self.Done));
        let spaceButton = UIBarButtonItem(barButtonSystemItem: .flexibleSpace, target: nil, action: nil)
        ToolBar.setItems([spaceButton,doneButton], animated: false);
        
        textTitle.backgroundColor = UIColor.white;
        textTitle.tag = 2
        textTitle.borderStyle = UITextBorderStyle.none;
        textTitle.setValue(NSNumber(value:10), forKey:"paddingLeft")
        textTitle.placeholder = "  请输入标题（最多可输入50个字符）";
        textTitle.adjustsFontSizeToFitWidth=true ; //当文字超出文本框宽度时，自动调整文字大小
        textTitle.minimumFontSize = 12 ; //最小可缩小的字号
        textTitle.becomeFirstResponder();
        textTitle.returnKeyType = UIReturnKeyType.next //表示继续下一步
        textTitle.delegate = self ;
        
        textPlace.backgroundColor = UIColor.white;
        textPlace.tag = 3
        textPlace.borderStyle = UITextBorderStyle.none;
        textPlace.setValue(NSNumber(value:10), forKey:"paddingLeft");
        textPlace.placeholder = "  请输入教学地点（最多可输入50个字符）";
        textPlace.adjustsFontSizeToFitWidth=true ; //当文字超出文本框宽度时，自动调整文字大小
        textPlace.minimumFontSize = 12 ; //最小可缩小的字号
        textPlace.delegate = self
        
        ClassSection.backgroundColor = UIColor.white;
        ClassSection.tag = 4
        ClassSection.borderStyle = UITextBorderStyle.none;
        ClassSection.setValue(NSNumber(value:10), forKey:"paddingLeft");
        ClassSection.placeholder = "  请输入节次(例如1，2)";
        ClassSection.adjustsFontSizeToFitWidth=true ; //当文字超出文本框宽度时，自动调整文字大小
        ClassSection.minimumFontSize = 12 ; //最小可缩小的字号
        ClassSection.delegate = self
        
        self.view.addSubview(textTitle);
        self.view.addSubview(textPlace);
        self.view.addSubview(ClassSection);
        
        startDtae.backgroundColor = UIColor.white;
        let startdateLab =  UILabel(frame:CGRect(x:0,y:0,width:120,height:60));
        startdateLab.backgroundColor = UIColor.white;
        startdateLab.text = " 开始日期 :";
        startdateLab.textColor = UIColor.black;
        startDtae.tag = 1
        startDtae.leftView = startdateLab;
        startDtae.leftViewMode = UITextFieldViewMode.always;
        self.view.addSubview(startDtae);
        self.view.addSubview(pushbtu);
        self.pushbtu.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(50)
            make.left.equalTo(0)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
        }
        pushbtu.setTitleColor(UIColor.white, for: .normal);
        pushbtu.titleLabel?.font = UIFont.init(name: "iconfont", size: 18);
        pushbtu.backgroundColor = UIColor.bg;
        pushbtu.setTitle("确定", for:.normal);
        pushbtu.tag = 2;
        pushbtu.titleLabel?.baselineAdjustment = .alignCenters;
        pushbtu.addTarget(self, action:#selector(tapped(_:)), for:.touchUpInside);
        //        self.view.addSubview(savebtu);
        
        
    }
    
    @objc func tapped(_ button:UIButton){
        self.actTitle = self.textTitle.text!.trimmingCharacters(in:.whitespaces);
        self.actAddress = self.textPlace.text!.trimmingCharacters(in:.whitespaces);
        self.classSection = self.ClassSection.text!.trimmingCharacters(in:.whitespaces);
        self.actStartDate = self.startDtae.text!;
        
        if(actTitle.isEmpty){
            ZKProgressHUD.showMessage("请输入课堂教学标题！")
            return;
        }
        if(actStartDate.isEmpty){
            ZKProgressHUD.showMessage("未选择时间或！")
            return;
        }
        self.create(State: button.tag);
    }
    
    //保存／发布面授
    func create (State:Int){
        let dict = ["Id": activityId,
                    "CreatorId":Account.defaultAccount.id!,
                    "CourseOpenId":courseOpenId,
                    "OpenClassIds":openClassId,
                    "State":State,
                    "SourceType":3,
                    "Address":self.actAddress,
                    "EndTime":"",
                    "IsEvaluation": 1,
                    "StartTime":self.actStartDate,
                    "ClassSection":classSection,
                    "Title":self.actTitle] as [String : Any] ;
        XLBallLoading.show(in: self.view)
        let newdict = ["data":JSON.init(dict)]
        Alamofire.request(appAPI.FaceTeach_addFaceTeach, method: .post, parameters: newdict, encoding: URLEncoding.default).responseJSON { response in
            
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    if(self.reloadViewClosure != nil){
                       self.reloadViewClosure!();
                        
                    }
                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                    if self.video {
                        self.courseBBSAction?.actionType = 5
                        self.courseBBSAction?.ActionName = "refresh"
                    }
                    self.navigationController?.popViewController(animated: true);
                    
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
            }
        }
        
    }
    func textFieldDidBeginEditing(_ textField: UITextField) {
        self.pickStartDate(self.startDtae);
    }
    //MARK:- Function of datePicker
    func pickStartDate(_ textField : UITextField){
        
        self.datePicker = UIDatePicker(frame:CGRect(x: 0, y: height-220, width: width, height: 216));
        self.datePicker.locale = Locale(identifier: "zh_CN");
        self.datePicker.backgroundColor = UIColor.white;
        self.datePicker.datePickerMode = UIDatePickerMode.date;
        let dateFormatter = DateFormatter();
        dateFormatter.dateFormat = "yyyy-MM-dd";
        let minDate = dateFormatter.date(from: "2017-01-01");
        datePicker.minimumDate = minDate;
        textField.inputView = self.datePicker;
        // ToolBar
        let toolBar = UIToolbar();
        toolBar.barStyle = .default;
        toolBar.isTranslucent = true;
        toolBar.tintColor = UIColor(red: 92/255, green: 216/255, blue: 255/255, alpha: 1);
        toolBar.sizeToFit();
        
        // Adding Button ToolBar
        let doneButton = UIBarButtonItem(title: "确定", style: .plain, target: self, action: #selector(createFaceView.doneClick));
        let spaceButton = UIBarButtonItem(barButtonSystemItem: .flexibleSpace, target: nil, action: nil)
        let cancelButton = UIBarButtonItem(title: "取消", style: .plain, target: self, action: #selector(createFaceView.cancelClick));
        toolBar.setItems([cancelButton, spaceButton, doneButton], animated: false);
        toolBar.isUserInteractionEnabled = true;
        textField.inputAccessoryView = toolBar;
        
    }
    
    func textFieldShouldBeginEditing(_ textField: UITextField) -> Bool {
        textField.inputAccessoryView = ToolBar;
        return true
    }
    override func touchesBegan(_ touches: Set<UITouch>, with event: UIEvent?) {
        self.view.endEditing(true)
    }
    
    // MARK:- Button Done and Cancel
    @objc func doneClick() {
        let formatter = DateFormatter();
        //日期样式
        formatter.dateFormat = "yyyy-MM-dd";
        startDtae.text = formatter.string(from: self.datePicker.date);
        
        startDtae.resignFirstResponder();
        if(textTitle.text?.count == 0){
            self.textTitle.text = formatter.string(from: self.datePicker.date) as String
        }
    }
    @objc func cancelClick() {
        startDtae.resignFirstResponder();

    }
    // MARK:- Button Done and Cancel
    func done1Click() {
        let formatter = DateFormatter();
        //日期样式
        formatter.dateFormat = "yyyy-MM-dd";
        startDtae.text = formatter.string(from: self.datePicker.date);
        startDtae.resignFirstResponder();
        
    }
    func done2Click() {
        let formatter = DateFormatter();
        //日期样式
        formatter.dateFormat = "HH:mm";
        endStamp = Int(self.enddatePicker.date.timeIntervalSince1970);
 
    }
    
    
    /*
     // MARK: - Navigation
     
     // In a storyboard-based application, you will often want to do a little preparation before navigation
     override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
     // Get the new view controller using segue.destinationViewController.
     // Pass the selected object to the new view controller.
     }
     */
    
}

