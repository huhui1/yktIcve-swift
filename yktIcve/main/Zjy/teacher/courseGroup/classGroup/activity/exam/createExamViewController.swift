//
//  createExamViewController.swift
//  云课堂职教云
//
//  Created by cc on 2018/4/18.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension createExamView{
    //保存考试
   @objc func saveExam(){
        for i in 0 ..< self.list.count {
            let json = JSON(self.list[i]);
            let indexPath =  NSIndexPath.init(item: i, section: 0) as IndexPath
            let cell = tableView.dequeueReusableCell(withIdentifier: "SwiftCell",
                                                     for: indexPath) as! createHomeworkTableViewCell
            if(cell.isSelected){
                //NS array adding  不能添加数据
                self.examIds.append(json["Id"].stringValue)
            }
        }
        
        if( self.examIds.count < 1){
            self.tableView.removeFromSuperview()
            self.setTableview()
            ZKProgressHUD.showMessage("未选择考试")
            return ;
        }

        XLBallLoading.show(in: self.view)
        let dict = ["activityId":self.activityId,
                    "courseOpenId":self.courseOpenId,
                    "classState":self.classState,
                    "sourceType":3,
                    "examIds":self.examIds] as [String:Any]
        Alamofire.request(appAPI.FaceTeach_saveFaceTeachExam, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"] == 1){
                    self.reloadClosure!()
                     ZKProgressHUD.showMessage(json["msg"].stringValue)
                    self.navigationController?.popViewController(animated: true)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
          }
    }
    
    //获取作业列表
    func getExam(isRefresh: Bool){
        XLBallLoading.show(in: self.view)
        let dict = ["courseOpenId":self.courseOpenId] as [String:Any]
        Alamofire.request(appAPI.FaceTeach_getOnlineExamList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if(json["code"]>0){
                        self.list = json["list"].arrayValue as NSArray 
                    //重现加载表格数据
                    self.tableView.reloadData();
                    if(!isRefresh){
                        //结束刷新
                        self.tableView.mj_header.endRefreshing();
                    }
                     common.share.setTableFootView_noData(self.tableView, list: self.list)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                XLBallLoading.hide(in: self.view)
                ZKProgressHUD.showError("网络异常请稍后再试！");
            }
        }
    }
}
