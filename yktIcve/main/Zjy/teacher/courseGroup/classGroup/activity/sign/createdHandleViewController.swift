//
//  createdHandleViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2017/7/14.
//  Copyright © 2017年 zqy. All rights reserved.
//

import UIKit
import WebKit

//重命名一个闭包
typealias signListreloadViewByHandle = () -> Void

class createdHandleViewController: UIViewController,WKScriptMessageHandler {
     var theWebView:WKWebView?;
    
    var openClassIds: String = "";
    
    var courseOpenId: String = "";
    
    var activityId :String = "";
    
    var gestrue = "";
    
    var handleRelodClosure : signListreloadViewByHandle?;
    override func viewDidLoad() {
        super.viewDidLoad()
        
        let path = Bundle.main.path(forResource: "locker", ofType: ".html",
                                    inDirectory: "HTML5/src")
        let url = URL(fileURLWithPath:path!)
        //let request = URLRequest(url:url)

        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height)
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        theWebView!.scrollView.bounces = true;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView?.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView?.load(request)
                
            }catch{}
        }
        //theWebView!.load(request)
        self.view.addSubview(theWebView!);
        
        // Do any additional setup after loading the view.
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
    }

    //响应处理js那边的调用
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        print(message.body)
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "tapSign"){
            
             self.gestrue = sentData["gestrue"]!
             create();
        }
    }

    override func viewWillDisappear(_ animated: Bool) {
        theWebView?.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
    }

    func create (){
        let vc = createdOneKeyView();
        vc.activityId = activityId;
        vc.courseOpenId = courseOpenId;
        vc.openClassIds = self.openClassIds
        vc.gestrue = self.gestrue;
        vc.SignType = 2;
        vc.signListClosure = { () -> Void in
            self.handleRelodClosure!();
        }
        self.navigationController?.pushViewController(vc, animated: true);
        let count = self.navigationController?.viewControllers.count;
        self.navigationController?.viewControllers.remove(at: count!-2)
    }

   
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
   
    
    
    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
