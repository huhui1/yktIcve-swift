//
//  signResultViewController.swift
//  66iclasscloud
//
//  Created by 尤增强 on 2017/7/7.
//  Copyright © 2017年 zqy. All rights reserved.
//

import UIKit

import SwiftyJSON

class signResultView: UIViewController {

    var openClassIds: String = "";

    var courseOpenId: String = "";
    
    var activityId :String = "";
    
    var signId :String = "";
    
    var signList  : NSArray = [];
    
    var unsignList  : NSArray = [];
    
    var list  : NSArray = [];
    
    var SignResultType = ["缺勤","已签到","迟到","事假","早退","病假","公假"];
    
    var tableView:UITableView!
    
    var slideMenu:SlideMenu?


    var state : signResultModel?

    var socketarr = [Dictionary<String,String>]()

    var isPushed = false
    lazy var vc1 = unSignStuListTableView();
    lazy var vc2 = signedStuListViewTableView();
    

    let width  = UIScreen.main.bounds.width;
    let height = UIScreen.main.bounds.height;

    override func viewDidLoad() {
        super.viewDidLoad()
        self.state = signResultModel.init(changeState: false)
        self.state?.addObserver(self, forKeyPath: "changeState", options: [.new, .old], context: nil)
        self.view.backgroundColor = UIColor.white
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        let statistics = UIBarButtonItem.init(title: "统计", style: UIBarButtonItemStyle.plain, target: self, action: #selector(self.openStatisticsView));

        self.navigationItem.rightBarButtonItem = statistics;
       
        self.getData(isfirst:true)
       
        // Do any additional setup after loading the view.
    }

   
    func setSlideMenu(){

        let titles = ["未签到","已签到"]
        var arr:Array<UIViewController> = [];

        vc1.list = self.unsignList
        vc1.courseOpenId = self.courseOpenId
        vc1.activityId = self.activityId
        vc1.signId = self.signId
        vc1.state = self.state

        vc2.courseOpenId = self.courseOpenId
        vc2.activityId = self.activityId
        vc2.signId = self.signId
        vc2.list = self.signList
        vc2.state = self.state

        arr.append(vc1)
        arr.append(vc2)
      
        slideMenu = SlideMenu(frame: CGRect(x:0,y:0,width:view.frame.width,height:40), titles:titles, childControllers:arr)
        slideMenu?.bodyFrame = CGRect.init(x: 0, y: 40, width: view.frame.width, height: view.frame.height - 40)
        slideMenu?.selectedColor = UIColor(red: 6/255, green: 163/255, blue: 121/255, alpha: 1);

        slideMenu?.isFixed = true;
        slideMenu?.indicatorStyle = .followText;
        slideMenu?.titleStyle = .transfrom;
        slideMenu?.line.isHidden = false;
        slideMenu?.scrollToIndex(0)
        view.addSubview(slideMenu!)

    }
    //添加监听后,使用完必须移除监听(一个add 对应一个 remove)
    deinit {
        self.state?.removeObserver(self, forKeyPath: "changeState", context: nil)
    }
    
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "changeState" {
            self.getData(isfirst:false)
        }
    }

    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    override func viewDidDisappear(_ animated: Bool) {
        if(!self.isPushed){
            let dict = ["type":"closeRes"];
            self.emitToPC(dict: dict)
        }
        
        navigationController?.interactivePopGestureRecognizer?.isEnabled = true
        self.isPushed = false
    }

    override func  viewWillAppear(_ animated: Bool) {
        let params = ["type":"signResult","notSignUser":self.socketarr] as [String : Any];
        let dict = ["type":"face","params":JSON.init(params).description ];
        self.emitToPC(dict: dict)
        navigationController?.interactivePopGestureRecognizer?.isEnabled = false
    }

    ///    投屏事件
    ///
    /// - Parameter dict: [String:String]

    func emitToPC(dict:[String:String]){

        ZQSocketManager.share.notificationSocketManager(data: dict)
    }
    /*
    // MARK: - Navigation

    // In a storyboard-based application, you will often want to do a little preparation before navigation
    override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
        // Get the new view controller using segue.destinationViewController.
        // Pass the selected object to the new view controller.
    }
    */

}
