//
//  createhomeworkTableView.swift
//  云课堂职教云
//
//  Created by cc on 2018/4/12.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import SwiftyJSON


class createHomeworkView : UIViewController,UITableViewDelegate,UITableViewDataSource {
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = "作业"
        self.view.backgroundColor = UIColor.white
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        self.setUI()
        self.setTableview()
        self.getHomework(isRefresh: true)
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            //重现生成数据
            self.getHomework(isRefresh: false);
            
        })
    }
    
    
    func setTableview(){
        self.tableView = UITableView.init(frame: CGRect(x:0, y:0, width:width, height:height - 113))
        if common.share.isX(){
            self.tableView = UITableView.init(frame: CGRect(x:0, y:0, width:width, height:height - 165))
        }
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        
        self.tableView.allowsMultipleSelectionDuringEditing = true
        
        self.tableView.setEditing(true, animated:true)
        
        
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        
        self.tableView.backgroundColor = UIColor.white
        self.tableView.register(createHomeworkTableViewCell.self, forCellReuseIdentifier: "SwiftCell");
        
        if #available(iOS 9.0, *) {
            self.tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        
        self.view.addSubview(tableView)
    }
    
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    // MARK: - Table view data source
    
    func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return  self.list.count
    }
    
    func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 100
    }
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell:createHomeworkTableViewCell  = tableView.dequeueReusableCell(withIdentifier: "SwiftCell") as! createHomeworkTableViewCell
        
        var data = JSON(self.list[indexPath.row])
        let arr = ["","题库作业","登分作业","外部作业","附件作业"]
        cell.lab_name.text = data["Title"].stringValue
        cell.lab_type.text = "作业类型:\(arr[data["homeworkType"].intValue])";
        
        if(data["Remark"].stringValue != ""){
            //计算字的宽度
            let messtr = "\(data["Remark"].stringValue)" as NSString
            let width = messtr.size(withAttributes: [NSAttributedStringKey.font:UIFont.systemFont(ofSize: 12)]).width
            cell.lab_remark.text = ("作业要求:\(data["Remark"].stringValue)")
            if width > self.width - 120{
                cell.btn_more.isHidden = false
            }else{
                cell.btn_more.isHidden = true
            }
        }else{
            cell.lab_remark.text = "作业要求:暂无作业要求"
            cell.btn_more.isHidden = true
        }
        cell.btn_more.tag = indexPath.row
        cell.btn_more.addTarget(self, action: #selector(self.viewMore(_:)), for: .touchUpInside)

        //预览
        cell.btn_preview.tag = indexPath.row
        cell.btn_preview.addTarget(self, action: #selector(self.preview(_:)), for: .touchUpInside)
        return cell
    }
    
    @objc func viewMore(_ btn :UIButton){
        let data = JSON(self.list[btn.tag])
        let vc = homeworkAndExamRemarkView()
        vc.Htitle = data["Title"].stringValue
        vc.content = data["Remark"].stringValue
        vc.hidesBottomBarWhenPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
        
    }
    
    func setUI(){
        self.view.addSubview(self.btn_preserve)
        let HX = common.share.returnSafeAreaLineHeight()
        self.btn_preserve.snp.makeConstraints { (make) in
            make.width.equalTo(width)
            make.height.equalTo(50)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
            make.left.equalTo(0)
        }
        
    }
    //预览
    @objc func preview(_ btn:UIButton){
        let json = JSON(self.list[btn.tag]);
        if(json["homeworkType"].intValue == 4){
            let vc = correctingFileHomeWorkView()
            vc.openClassId = self.openClassId
            vc.courseOpenId = self.courseOpenId
            vc.homeWorkId = json["Id"].stringValue
            vc.isPreview = true
            vc.homeworkTitle = json["Title"].stringValue
            self.navigationController?.pushViewController(vc, animated: true)
        }else if(json["homeworkType"].intValue == 2){
            ZKProgressHUD.showMessage("登分作业，不可预览")
        }else{
            let vc = previewPaperView()
            vc.homeWorkId = json["Id"].stringValue
            vc.courseOpenId = self.courseOpenId
            vc.openClassId = self.openClassId
            vc.homeworkTitle = json["Title"].stringValue
            self.isPused = true
            self.navigationController?.pushViewController(vc, animated: true)
        }
    }
    var tableView:UITableView!
    //保存
    lazy var btn_preserve : UIButton = {
        let btn = UIButton()
        btn.setTitle("保存", for: .normal)
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        btn.contentVerticalAlignment = .center
        btn.titleLabel?.font = UIFont.italicSystemFont(ofSize: 18)
        btn.addTarget(self, action: #selector(self.saveHomework), for: .touchUpInside)
        return btn
    }()
    
    let width = UIScreen.main.bounds.width
    let height = UIScreen.main.bounds.height
    lazy var openClassId :String = {return ""}()
    lazy var courseOpenId :String = {return ""}()
    lazy var activityId : String = {return ""}()
    lazy var classState:Int = {return 0 }()
    lazy var list : NSArray = []
    
    var userInfo :User!
    var reloadClosure :(() ->Void)?
    lazy var homeworkIds : Array = {
        return []
    }()
    fileprivate lazy var isPused:Bool = {
        return false
    }()
}

