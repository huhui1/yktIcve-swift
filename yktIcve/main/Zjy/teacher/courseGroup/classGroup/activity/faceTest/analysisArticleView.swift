//
//  analysisArticleView.swift
//  yunketang
//
//  Created by zqy on 2018/3/5.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import WebKit
import SwiftyJSON
class analysisArticleView: UIViewController,WKScriptMessageHandler {

    override func viewDidLoad() {
        super.viewDidLoad()

        self.view.backgroundColor = UIColor.white
        self.setWebViewUI()
        self.setFootUI()

        self.index = JSON.init(parseJSON: self.data)["order"].intValue

        self.total = JSON.init(parseJSON: self.data)["questionList"].count
        self.title = "(\(self.index)  / \(self.total))"
        let detailsItem = UIBarButtonItem.init(title: "详情", style: UIBarButtonItemStyle.plain, target :self, action: #selector(self.analysisdetails));
        self.navigationItem.rightBarButtonItem = detailsItem;
        // Do any additional setup after loading the view.
    }

    fileprivate func setFootUI(){
        let item = UIBarButtonItem(title: "\u{e6f7} 返回", style: .plain, target: self, action: #selector(self.backBtnClick))

        self.navigationItem.leftBarButtonItem = item

        common.share.setBackButtonItem(item:item)

        let item1 = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item1

        self.view.addSubview(self.Btn_up)
        self.view.addSubview(self.Btn_down)
        let HX = common.share.returnSafeAreaLineHeight()
        self.Btn_up.snp.makeConstraints { (make) in
            make.width.equalTo(UIScreen.main.bounds.width / 2)
            make.height.equalTo(50)
            make.left.equalTo(0)
            make.bottom.equalTo(self.view.snp.bottom).offset(HX)
        }

        self.Btn_down.snp.makeConstraints { (make) in
            make.width.height.equalTo(Btn_up)

            make.centerY.equalTo(Btn_up.snp.centerY)
            make.left.equalTo(Btn_up.snp.right)
        }
    }


    @objc func backBtnClick(){
        let params = ["type":"questionAnalysisBack",
                      "courseId":"",
                      "cellId":"",
                      "examId":"",
                      "classId":"",
                      "fromRes":false] as [String : Any];

        let dict = ["type":"face","params":JSON.init(params).description ];

        ZQSocketManager.share.notificationSocketManager(data: dict)
        theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")
        self.navigationController?.popViewController(animated: true)
    }

    //设置H5页面
    func setWebViewUI(){
        
        let path = Bundle.main.path(forResource: "analysis-article", ofType: ".html",
                                    inDirectory: "HTML5/src/teacher/exam");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);
        
        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")
        
        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)
        let frame = CGRect(x:0, y:0, width:UIScreen.main.bounds.width,
                           height:UIScreen.main.bounds.height - 110)
        theWebView = WKWebView(frame:frame, configuration: theConfiguration)

        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);
        
    }
    
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>
        
        if(sentData["method"] == "load" ){
            self.theWebView.evaluateJavaScript("article.getparameter(\(self.data),'\(self.activityId)','\(self.classTestId)')",
                completionHandler: nil)
        }else if(sentData["method"] == "previewImg"){
            self.previewImg(url:sentData["url"]!)

        }else if(sentData["method"] == "getFileInfoByUrl"){
            self.getFileInfoByUrl(url: sentData["url"]!)
        }else if(sentData["method"] == "analysis"){
            self.addEventListener(data:JSON.init(parseJSON: sentData["data"]!))
        }else if(sentData["method"] == "examPageMove"){
            let params = ["type":"control",
                          "name":sentData["name"]!
                ] as [String : Any];

            let dict = ["type":"face",
                        "params":JSON.init(params).description ];
           ZQSocketManager.share.notificationSocketManager(data: dict)
        }
    }

    @objc func switchQuestion(_ btn :UIButton){
        let tag = btn.tag
        if(tag == 1){
            if(self.index == 1){
                ZKProgressHUD.showMessage("已经是第一题")
            }else{
                   // $M.fire(view, 'socket.emit', { params: { type: 'questionAnalysis', courseId: _this.courseId, classId: _this.classId, cellId: _this.cellId, examId: _this.examId, order: _this.order } });
                 self.index  -= 1;

                self.questionId = JSON.init(parseJSON: self.data)["questionList"][self.index - 1]["questionId"].stringValue
                self.theWebView.evaluateJavaScript("article.prevquestion()",
                    completionHandler: nil)
            }

        }else {
            if(self.index == self.total){
                ZKProgressHUD.showMessage("已经是最后一题")
            }else{
                 // $M.fire(view, 'socket.emit', { params: { type: 'questionAnalysis', courseId: _this.courseId, classId: _this.classId, cellId: _this.cellId, examId: _this.examId, order: _this.order } });
                self.index  += 1;

                self.questionId = JSON.init(parseJSON: self.data)["questionList"][self.index - 1]["questionId"].stringValue
                self.theWebView.evaluateJavaScript("article.nextquestion()",
                                                   completionHandler: nil)
            }
        }
        let params = ["type":"questionAnalysis",
                      "courseId":"",
                      "cellId":"",
                      "examId":self.classTestId,
                      "classId":"",
                      "order": self.index ,
                      "fromRes":false] as [String : Any];

        let dict = ["type":"face","params":JSON.init(params).description ];
        ZQSocketManager.share.notificationSocketManager(data: dict)
        self.title = "(\(self.index)  / \(self.total))"

    }

   fileprivate lazy  var Btn_up : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.setTitle("上一题", for: .normal)
        btn.tag = 1
        btn.backgroundColor = UIColor.colorWithHex(hexColor: 0x23c397)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action: #selector(self.switchQuestion(_:)), for: .touchUpInside)
        return btn ;

    }()

   fileprivate lazy  var Btn_down : UIButton = {
        let btn = UIButton()
        btn.contentMode = .center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        btn.setTitle("下一题", for: .normal)
        btn.tag = 2
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action: #selector(self.switchQuestion(_ :)), for: .touchUpInside)
        return btn ;
    }()
    /*
     // MARK: - Navigation
     
     // In a storyboard-based application, you will often want to do a little preparation before navigation
     override func prepare(for segue: UIStoryboardSegue, sender: Any?) {
     // Get the new view controller using segue.destinationViewController.
     // Pass the selected object to the new view controller.
     }
     */
    var list :NSArray = [];
    lazy var data :String={return ""}();
    lazy var questionId :String={return ""}();
    lazy var activityId = "";
    lazy var classTestId = ""
    lazy var courseOpenId = ""
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()
        
        return WK
    }()
     lazy var index :Int = {return 1}()
    fileprivate lazy var total :Int = {return 1}()

}
