//
//  respondingTableView.swift
//  云课堂-职教云
//
//  Created by 尤增强 on 2018/3/8.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON

class respondingTableView: UITableViewController {

    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white
        self.addEventListener()

         self.setUI()
        tableView.register(batchScorseTableCell.self, forCellReuseIdentifier: "batchScorseCell")
        tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        if #available(iOS 9.0, *) {
            tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            // Fallback on earlier versions
        }

        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            //重现生成数据
            self.refreshItemData(isRefresh:false);

        })
        self.setTime()
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
    }

    func setUI(){
        self.view.addSubview(self.btn_over)
//        self.btn_over.snp.makeConstraints { (make) in
//            make.width.equalTo(UIScreen.main.bounds.width)
//           // make.centerX.equalTo(self.view.snp.centerX)
//            make.height.equalTo(40)
//            make.left.equalTo(0)
//            make.bottom.equalTo(self.view.snp.bottom)
//        }
          self.btn_over.frame = CGRect.init(x: 0, y: UIScreen.main.bounds.height-110, width: UIScreen.main.bounds.width, height: 50)
        if common.share.isX(){
                self.btn_over.frame = CGRect.init(x: 0, y: UIScreen.main.bounds.height-165, width: UIScreen.main.bounds.width, height: 50)
        }
    }
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    // MARK: - Table view data source

    override func numberOfSections(in tableView: UITableView) -> Int {
        // #warning Incomplete implementation, return the number of sections
        return 1
    }

    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        // #warning Incomplete implementation, return the number of rows
        return  self.stuInfos.count
    }

    override func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat {
        return 60
    }

    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {


        let cell:batchScorseTableCell = tableView.dequeueReusableCell(withIdentifier: "batchScorseCell") as! batchScorseTableCell


        cell.imgView_avatar.snp.makeConstraints { (make) in
            make.width.height.equalTo(40)
            make.left.equalTo(10)
            make.centerY.equalTo(cell.snp.centerY)
        }

        let stuInfo = stuInfos[indexPath.row]
        cell.lab_Name.text = stuInfo.name
        cell.lab_num.text = stuInfo.no
        if(stuInfo.socre != 0 ){
            cell.lab_socre.text = "\u{e67c}\(stuInfo.socre)"
            cell.lab_socre.textColor = UIColor.bg
        }else{
            cell.lab_socre.text = "\u{e67c}"
        }
        common.share.setSDImg(str: stuInfo.url, imgview: cell.imgView_avatar)

        return cell
    }

    override func viewWillDisappear(_ animated: Bool) {
        let dict = ["type":"closeRes"];
       ZQSocketManager.share.notificationSocketManager(data: dict)
    }


    //点击
 override   func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {

        tableView .deselectRow(at: indexPath, animated: true)
        // let stuInfo = stuInfos[indexPath.row]

        let vc = keyBoardView()
        vc.modalTransitionStyle = .crossDissolve
        vc.view.backgroundColor = UIColor(red: 0, green: 0, blue: 0, alpha: 0.1);
        vc.setSocreClosure = {(score) in
            if(score < 99){
                self.stuInfos[indexPath.row].socre = score
                self.checkScore(ask: self.stuInfos[indexPath.row], indexPath: indexPath)
            }
            self.navigationController?.dismiss(animated: true, completion: nil)

        }
        self.present(vc, animated: true, completion: nil)


    }

    override func viewDidDisappear(_ animated: Bool) {
         self.codeTimer?.cancel()
        
    }

    var codeTimer: DispatchSourceTimer?


    lazy var courseOpenId :String = {return ""}()
    lazy var openClassIds :String = {return ""}()
    lazy var activityId: String = {return ""}()
    lazy var askId: String = {return ""}()
    lazy var askType: Int = {return 1}()
     var list :NSArray = [];
    var stuInfos = [askQuestionStuInfo]()

    var refreshCount:Int = 0
    {

        didSet
        {
            if refreshCount<10
            {
                self.refreshItemData(isRefresh: false)
            }else{
                self.codeTimer?.cancel()
            }

        }
    }
    lazy  var btn_over : UIButton = {
        let btn = UIButton()
        btn.contentHorizontalAlignment = UIControlContentHorizontalAlignment.center
        btn.setTitleColor(UIColor.white, for: .normal)
        btn.backgroundColor = UIColor.bg
        btn.setTitle("结束抢答", for: .normal)
        btn.titleLabel?.font = UIFont.init(name: "iconfont", size: 16)
        btn.addTarget(self, action:  #selector(self.closeAsk), for: .touchUpInside)
        return btn ;
      

    }()
}
