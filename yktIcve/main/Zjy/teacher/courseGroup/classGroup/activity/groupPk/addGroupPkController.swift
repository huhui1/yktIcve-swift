//
//  addGroupPkController.swift
//  66iclasscloud
//
//  Created by zqy on 2018/1/22.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

extension addGroupPkView {
    
   @objc func editgroupPK(_ button:UIButton){
        let Title = pkTitle.text!
        let num = pkNum.text!
        var type = 1
        if(Title.characters.count < 1){
            ZKProgressHUD.showMessage("请输入小组pk标题");
            return;
        }
        if(!self.switchBtn.isOn){
            type=0
        }
//        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
//        ZKProgressHUD.show();
        XLBallLoading.show(in: self.view)
        let arr = ["Id":self.pkId,
                   "CreatorId":Account.defaultAccount.id!,
                   "CourseOpenId":self.courseOpenId,
                   "ActivityId":self.activityId,
                   "Title":Title,
                   "State":button.tag,
                   "SourceType":3]as [String : Any]

        let dict=["PKData":JSON.init(arr),
                  "groupCount":num,
                  "IsAddGroupStu":type]as [String : Any]
        
        if !common.share.isPurnInt(string: num){
            ZKProgressHUD.showError("小组个数只能设置为整数！");
            XLBallLoading.hide(in: self.view)
            return
        }
        
        if num != "" {
            if (Int(num)! > self.activityOpenClassStuCount){
                ZKProgressHUD.showError("小组个数不能大于面授班级学生人数！");
                XLBallLoading.hide(in: self.view)
                return
            }
        }
        Alamofire.request(appAPI.FaceTeach_addGroupPKAndGroup, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
//                ZKProgressHUD.hide(delay: 0);
                let json = JSON(value)
                if(json["code"]>0){
                    self.pkId = json["PKId"].stringValue
                    self.isSendAct(tag: button.tag)
                NotificationCenter.default.post(name:NSNotification.Name("reloadgroupPKList"), object: dict);
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
        
    }
   


    //发布还是保存
    func isSendAct(tag:Int){

        if (self.reloadPkListClosure != nil){
            self.reloadPkListClosure!()
        }

        if(tag == 2){
            self.sendGroupInfo()
            let vc = groupPKInfoView()
            vc.PKId = self.pkId
            vc.state = 2
            vc.activityOpenClassStuCount = self.activityOpenClassStuCount
            vc.GroupCount = pkNum.text!
            self.navigationController?.pushViewController(vc, animated: true)
            let count = self.navigationController?.viewControllers.count
            self.navigationController?.viewControllers.remove(at: count! - 2)
        }else{
            self.navigationController?.popViewController(animated: true)
        }
    }

    //个推信息

    func sendGroupInfo(){

//        var datajson = {
//            actionType: "PKing",
//            title: title,
//            actId: PKId,
//            creatorId: _this.$user.id,
//            faceId: _this.activityId,
//            openClassIds: _this.openClassIds,
//            courseOpenId: _this.courseOpenId
//        };

        let dict = ["actionType":"PKing",
                    "title":pkTitle.text ?? "",
                    "actId":self.pkId,
                    "creatorId":Account.defaultAccount.id!,
                    "faceId":self.activityId,
                    "openClassIds":self.openClassIds,
                    "courseOpenId":self.courseOpenId] as [String : Any];

        geTuiSendController.share.sendGTMSG(str: JSON.init(dict).description, userId:Account.defaultAccount.id!, openClassIds: self.openClassIds)
    }
    
}
