//
//  stuSummarizeListView.swift
//  66iclasscloud
//
//  Created by zqy on 2018/2/1.
//  Copyright © 2018年 zqy. All rights reserved.
//


import UIKit
import SwiftyJSON

class stuSummarizeListView: UITableViewController{
    
    
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.tableView.backgroundColor = UIColor.white
        self.refreshItemData(isRefresh: true)
        let item = UIBarButtonItem(title: "返回", style: .plain, target: self, action: nil)
        self.navigationItem.backBarButtonItem = item
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        // Do any additional setup after loading the view.
    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }
    
    
    func  fetchCoverDetails(isRefresh:Bool){
        self.covers.removeAll()
        self.selStuInfos.removeAll()
        self.reservedInfo.removeAll()
        for i in 0..<self.list.count {
            let stuinfo = JSON(self.list[i])
            let url = URL(string:stuinfo["AvatorUrl"].stringValue)
            if url != nil {
                let movieRecord = CoverRecord(name:"", url:url!)
                self.covers.append(movieRecord)
            }
            let selstu = stusummarizeStuInfo.init(Id: stuinfo["StuId"].stringValue,
                                                  Name:stuinfo["StuName"].stringValue,
                                                  StuNo: stuinfo["StuNo"].stringValue,
                                                  OpenClassId: stuinfo["OpenClassId"].stringValue,
                                                  Star:stuinfo["Star"].intValue,
                                                  AvatorUrl: stuinfo["AvatorUrl"].stringValue,
                                                  PerformanceScore:stuinfo["PerformanceScore"].intValue)
            selStuInfos.append(selstu)
        }
        self.reservedInfo = self.selStuInfos
        if(!isRefresh){
            //结束刷新
            //重现加载表格数据
            self.tableView.mj_header.endRefreshing();
            self.tableView.reloadData();
        }else{
            self.setTableView()
        }
        
    }
    
    func  setTableView(){
        
        self.tableView.delegate = self;
        self.tableView.dataSource = self;
        //创建一个重用的单元格
        self.tableView.register(stuSummaryListTableViewCell.self, forCellReuseIdentifier: "SwiftCell");
        
        self.tableView.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        
        if #available(iOS 9.0, *) {
            self.tableView.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        
        
        
        topview.frame.size = CGSize.init(width: self.view.bounds.width, height: 50)
        self.tableView.tableHeaderView = topview
        
        //rowHeight属性设置为UITableViewAutomaticDimension
        self.tableView.rowHeight = UITableViewAutomaticDimension;
        
        //下拉刷新相关设置,使用闭包Block
        self.tableView.mj_header = MJRefreshNormalHeader(refreshingBlock: {
            //重现生成数据
            self.refreshItemData(isRefresh:false);
            
        })
        
    }
    
    override func numberOfSections(in tableView: UITableView) -> Int {
        return 1
    }
    
    override func tableView(_ tableView: UITableView, heightForRowAt indexPath: IndexPath) -> CGFloat
    {
        return 70;
    }
    
    //返回表格行数（也就是返回控件数）
    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        
        return self.selStuInfos.count;
        
    }
    
    //创建各单元显示内容(创建参数indexPath指定的单元）
    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath)
        -> UITableViewCell {
            
            let stuinfo = selStuInfos[indexPath.row]
            //为了提供表格显示性能，已创建完成的单元需重复使用
            let identify:String = "SwiftCell"
            //同一形式的单元格重复使用，在声明时已注册
            let cell = tableView.dequeueReusableCell(withIdentifier: identify,
                                                     for: indexPath) as! stuSummaryListTableViewCell
            cell.lab_Index.text = String(indexPath.row + 1)
            cell.lab_Name.text = stuinfo.Name
            common.share.setSDImg(str: stuinfo.AvatorUrl, imgview: cell.imgView_avatar)
            cell.lab_Num.text = stuinfo.StuNo
            cell.setScoreUI(score: Float(stuinfo.Star))
            
            return cell
    }

    //点击
    override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        tableView .deselectRow(at: indexPath, animated: true)
        let json = JSON(self.list[indexPath.row]);
        let vc = stuSummarizeInfoView()
            vc.stuName = json["StuName"].stringValue
            vc.activityId=self.activityId
            vc.courseOpenId=self.courseOpenId
            vc.stuId=json["StuId"].stringValue
            vc.Star=json["Star"].intValue
            vc.performScore=json["PerformanceScore"].intValue
            vc.openClassId=json["OpenClassId"].stringValue
            vc.summarizeListClosure={()in
            self.refreshItemData(isRefresh: true)
            }
        self.navigationController?.pushViewController(vc, animated: true);
        
    }
    lazy var courseOpenId :String = {return ""}()
    lazy var activityId: String = {return ""}()

    
    lazy var list :NSArray = {
        return []
    }()
    var selStuInfos = [stusummarizeStuInfo]()
    var reservedInfo = [stusummarizeStuInfo]()

    let width = UIScreen.main.bounds.width;
    
    lazy var topview:stuSummaryListTopView = {
        let view = stuSummaryListTopView()
        return view
    }()
     var covers = [CoverRecord]()
}

struct  stusummarizeStuInfo {
    let Id:String
    let Name:String
    let StuNo:String
    let OpenClassId:String
    let Star:Int
    let AvatorUrl:String
    var PerformanceScore:Int
    
}
