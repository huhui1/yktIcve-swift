//
//  questionnaireQuestionPreviewTableView.swift
//  云课堂-职教云
//
//  Created by cc on 2018/4/3.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import WebKit

class questionnaireQuestionPreviewView: UIViewController ,WKScriptMessageHandler{

    override func viewDidLoad() {
        super.viewDidLoad()
        self.title = "问卷调查预览"
        self.setWebUI()
        self.setbackitem()
    }

    func setbackitem(){
        let item = UIBarButtonItem(title: "\u{e6f7}返回", style: .plain, target: self, action: #selector(self.back))
        self.navigationItem.leftBarButtonItem = item
        
        self.navigationItem.leftBarButtonItem?.setTitleTextAttributes([NSAttributedStringKey.font: UIFont(name: "iconfont", size: 18.0) as Any], for:.normal)
        self.navigationItem.leftBarButtonItem?.setTitleTextAttributes([NSAttributedStringKey.font: UIFont(name: "iconfont", size: 18.0) as Any], for:.selected)
    }
    @objc func back(){
        self.navigationController?.popViewController(animated: true)
    }
    //  设置网页
    fileprivate func  setWebUI(){

        let path = Bundle.main.path(forResource: "previewQuestion", ofType: ".html",
        inDirectory: "HTML5/src/teacher/questionnaire");
        let url = URL(fileURLWithPath:path!);
        //let request = URLRequest(url:url);

        //创建供js调用的接口
        let theConfiguration = WKWebViewConfiguration()
        theConfiguration.userContentController.add(self, name: "interOp")

        //将浏览器视图全屏(在内容区域全屏,不占用顶端时间条)

        theWebView = WKWebView(frame:self.view.frame, configuration: theConfiguration)
        //禁用页面在最顶端时下拉拖动效果
        //                theWebView.scrollView.bounces = false;
        //                theWebView.isUserInteractionEnabled = false;
        //加载页面
        if #available(iOS 9.0, *) {
            
            theWebView.loadFileURL(url, allowingReadAccessTo: url)
        } else {
            
            do{
                
                let url1 = try common.share.fileURLForBuggyWKWebView8(fileURL:url as NSURL)
                let request = URLRequest(url:url1 as URL);
                theWebView.load(request)
                
            }catch{}
        }
        //theWebView.load(request)
        self.view.addSubview(theWebView);

    }

    //响应处理js那边的调用
    func userContentController(_ userContentController:WKUserContentController,
                               didReceive message: WKScriptMessage) {
        let sentData = message.body as! Dictionary<String,String>

        if(sentData["method"] == "load" ){
            self.getDataForPreview()
        }else if(sentData["method"] == "delete" ){
            self.delete(id: sentData["titleId"]!,index:Int(sentData["index"]!)!)
        }
    }

    //返回处理h5清除页面，防内存溢出
    override func viewWillDisappear(_ animated: Bool) {

    theWebView.configuration.userContentController.removeScriptMessageHandler(forName: "interOp")


    }

    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
        // Dispose of any resources that can be recreated.
    }

    lazy var activityId :String = {
        return ""
    }()
    lazy var questionnaireId :String = {
        return ""
    }()
    lazy var theWebView:WKWebView = {
        let WK = WKWebView()

        return WK
    }()
    


}
