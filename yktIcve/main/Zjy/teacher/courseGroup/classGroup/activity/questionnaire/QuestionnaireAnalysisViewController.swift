//
//  QuestionnaireAnalysisViewController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/4/16.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import Alamofire
import SwiftyJSON

extension QuestionnaireAnalysisView {

   //获取数据统计
    func getquestionnaireStatis(){

        let dict = ["activityId": self.activityId,"questionnaireId":self.questionnaireId]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_questionnaireStatis, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{

                    self.theWebView.evaluateJavaScript("  questionSurwayAnalysis.get(\(json));",
                        completionHandler: nil)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }


    }


    @objc func  isover(){

        let alertController = UIAlertController(title: "结束问卷调查",
                                                message: "确定要结束问卷调查吗？", preferredStyle: .alert)
        let cancelAction = UIAlertAction(title: "取消", style: .cancel, handler: nil)
        let okAction = UIAlertAction(title: "确定", style: .destructive, handler: {
            action in
            self.overQuestion()
        })
        alertController.addAction(cancelAction)
        alertController.addAction(okAction)

        self.present(alertController, animated: true, completion: nil)
    }
    //结束问卷
  fileprivate  func overQuestion(){

        let dict = ["Id": self.questionnaireId,"state":3] as [String : Any]
        //        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
//
//        ZKProgressHUD.show();
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.FaceTeach_changeQuestionnaireState, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in

            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.reloadParent()
                    ZKProgressHUD.showMessage(json["msg"].stringValue);
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }


    }


    fileprivate func reloadParent(){
        let count = self.navigationController?.viewControllers.count
        if let vc :questionnaireView = self.navigationController?.viewControllers[count! - 2] as? questionnaireView {
            vc.refreshItemData(isRefresh: false)
        }
        
        self.navigationItem.rightBarButtonItem = nil;
        
    }

    // 查看详情
    func questionDeatils(index:Int,questions:String){
        let l = JSON.init(parseJSON: questions).arrayValue
        let vc = questionnaireAnalysisDetailsView()
        vc.activityId = self.activityId
        vc.courseOpenId = self.courseOpenId
        vc.questionlist = l
        vc.questionnaireId = self.questionnaireId
        vc.index = index;
        vc.questionId = l[index]["questionId"].stringValue
        vc.total = JSON.init(parseJSON: questions).count
        self.isPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
        
    }

    func stuParticipateIn(type:Int){
        let vc = stuAttendQuestinaireView()
        vc.num = type
        vc.courseOpenId = self.courseOpenId
        vc.activityId = self.activityId
        vc.title = "学生参与情况"
        vc.questionnaireId = self.questionnaireId
        self.isPushed = true
        self.navigationController?.pushViewController(vc, animated: true)
    }
}
