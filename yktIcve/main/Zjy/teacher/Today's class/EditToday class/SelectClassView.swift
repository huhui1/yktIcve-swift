//
//  selectClassView.swift
//  云课堂2
//
//  Created by 志辉教育 on 2018/6/29.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON



class selectClassView:  UIViewController, UITableViewDelegate, UITableViewDataSource,
UIGestureRecognizerDelegate  {
    var setOpenClassNmaesClosure:(([String],[String]) -> Void)?
   
    var courseOpenId = "";
    var tableView:UITableView?
    var list :NSArray = [];
    let width = UIScreen.main.bounds.width;
    let height = UIScreen.main.bounds.height;
    var openClassIds:[String] = [];
    var openClassNames:[String] = [];
    var termId = "";
    
    override func loadView() {
        super.loadView()
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        self.view.backgroundColor = UIColor.white;
        
        self.getClass();
    }
    
    func setUI(){
        var ht = 0
        if common.share.isX(){
            ht = 60
        }
        let btn_done = UIButton.init(frame: CGRect.init(x:0, y: height - 110 - CGFloat(ht), width: width , height: 50));
        self.view.addSubview(btn_done);
        btn_done.setTitle("完成", for: .normal);
        btn_done.titleLabel?.font = UIFont.init(name: "iconfont", size: 16);
        btn_done.titleLabel?.textAlignment = .center;
        btn_done.setTitleColor(UIColor.white, for: .normal);
        btn_done.backgroundColor = UIColor.colorWithHex(hexColor: 0x04ae84);
        btn_done.addTarget(self, action:#selector(donetapped(_:)), for:.touchUpInside);
        
    }
    
    
    //  done selected table cell
    @objc func donetapped(_ button:UIButton){
        //获取选中项索引
        
        self.openClassIds = [];
        self.openClassNames = [];
        var isExist = false;
        if let selectedItems = tableView!.indexPathsForSelectedRows {
            for indexPath in selectedItems {
                let json = JSON(self.list[indexPath.row])
                
                self.openClassIds.append(json["Id"].stringValue)
                self.openClassNames.append(json["name"].stringValue)
                if(self.termId.isEmpty){
                    self.termId = json["termId"].stringValue;
                    
                }else if(self.termId != json["termId"].stringValue){
                    isExist = true;
                    break;
                }
            }
        }
        if(isExist){
            self.termId = "";
            ZKProgressHUD.showError("暂不支持跨学期班级");
            isExist = false;
            return ;
        }
        self.setOpenClassNmaesClosure!(self.openClassIds,self.openClassNames);
        self.navigationController?.popViewController(animated: true);
    }
    
    func setTable(){
        
        //创建表视图
        self.tableView = UITableView(frame: self.view.frame, style:.plain)
        
        self.tableView!.delegate = self
        self.tableView!.dataSource = self
        //创建一个重用的单元格
        self.tableView!.register(UITableViewCell.self,
                                 forCellReuseIdentifier: "SwiftCell")
        self.view.addSubview(self.tableView!)
        
        self.tableView?.separatorInset = UIEdgeInsets.zero;
        
        self.tableView?.layoutMargins = UIEdgeInsets.zero;
        
        self.tableView?.tableFooterView = UIView(frame:CGRect.zero)//除去多余的cell
        
        if #available(iOS 9.0, *) {
            self.tableView?.cellLayoutMarginsFollowReadableWidth = false
        } else {
            
        }
        
        //rowHeight属性设置为UITableViewAutomaticDimension
        self.tableView?.rowHeight = UITableViewAutomaticDimension;
        
        let nn = common.share.setFootView(msg:"我是有底线的");
        
        if(self.list.count>8){
            self.tableView?.tableFooterView = nn;
        }
        
        self.tableView!.setEditing(true, animated:true);
        
        //表格在编辑状态下允许多选
        self.tableView?.allowsMultipleSelectionDuringEditing = true
        
        //        //绑定对长按的响应
        //        let longPress = UILongPressGestureRecognizer(target:self,
        //                                                     action:#selector(selectClassViewController.tableviewCellLongPressed(gestureRecognizer:)))
        //        //代理
        //        longPress.delegate = self
        //        longPress.minimumPressDuration = 1.0
        //        //将长按手势添加到需要实现长按操作的视图里
        //        self.tableView!.addGestureRecognizer(longPress)
    }
    
    
    //单元格长按事件响应
    //    func tableviewCellLongPressed(gestureRecognizer:UILongPressGestureRecognizer)
    //    {
    //        if (gestureRecognizer.state == .ended)
    //        {
    //            print("UIGestureRecognizerStateEnded");
    //            //在正常状态和编辑状态之间切换
    //            if(self.tableView!.isEditing == false) {
    //                self.tableView!.setEditing(true, animated:true)
    //            }
    //            else {
    //                self.tableView!.setEditing(false, animated:true)
    //            }
    //        }
    //    }
    
    //在本例中，只有一个分区
    func numberOfSections(in tableView: UITableView) -> Int {
        return 1;
    }
    
    //返回表格行数（也就是返回控件数）
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return self.list.count
    }
    
    //创建各单元显示内容(创建参数indexPath指定的单元）
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath)
        -> UITableViewCell {
            //为了提供表格显示性能，已创建完成的单元需重复使用
            let identify:String = "SwiftCell";
            //同一形式的单元格重复使用，在声明时已注册
            let cell = tableView.dequeueReusableCell(withIdentifier: identify,
                                                     for: indexPath);
            
            cell.textLabel?.text = JSON(self.list)[indexPath.row]["name"].stringValue
            
            return cell;
    }
    //点击
    //    func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
    //
    //        print("1111");
    //        let json = JSON(self.list[indexPath.row]);
    //        if(self.termId.isEmpty){
    //            self.termId = json["termId"].stringValue
    //        }
    //    }
    
    override func didReceiveMemoryWarning() {
        super.didReceiveMemoryWarning()
    }
}


