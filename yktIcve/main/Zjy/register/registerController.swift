//
//  registerController.swift
//  云课堂-职教云
//
//  Created by 志辉教育 on 2018/3/20.
//  Copyright © 2018年 zqy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire
import SCLAlertView
extension registerView{
  
    //邮箱验证,qq号破
    enum Validate {
        case emailvalue(_: String)
        case qqvalue(_: String)
        var isRight: Bool {
            var predicateStr:String!
            var currObject:String!
            switch self {
            case let .emailvalue(str):
                predicateStr = "^([A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,4})$"
                currObject = str
            case let .qqvalue(str):
                predicateStr = "[1-9][0-9]{4,14}";
                currObject = str
            }
            let predicate =  NSPredicate(format: "SELF MATCHES %@" ,predicateStr)
            return predicate.evaluate(with: currObject)

        }
    }

    //是否符合标准
    @objc func isOK(){
        let userName = self.userNameText.text as! String
        let studentId = self.studentIdText.text as! String//学号
        let phone = self.phoneText.text as! String
        let qq = self.qqText.text as! String
        let email = self.emailText.text as! String
        let code = self.codeText.text
        
        if userName.count == 0{
            ZKProgressHUD.showMessage("请输入姓名!")
            return
        }
        if studentId.count == 0{
            if(self.inviteType == 1){
                ZKProgressHUD.showMessage("请输入工号!")
            }else{
                ZKProgressHUD.showMessage("请输入学号!")
            }
            return
        }
        if(phone.count != 11 ){
            ZKProgressHUD.showMessage("请输入正确的手机号码")
            return
        }
        if phone.count > 0{
            let index = phone.index(phone.startIndex, offsetBy:1)
            let result = phone.substring(to: index)//从起始截取到索引的所有字符串
            let value = Int(result)!
            if(phone.count != 11  || value != 1){
                ZKProgressHUD.showMessage("请输入正确的手机号码")
                return
            }
        }
        if (code?.count)! < 1{
            ZKProgressHUD.showMessage("请输入验证码!")
            return
        }
        if !qq.isEmpty{
            if !Validate.qqvalue(qq).isRight{
                ZKProgressHUD.showMessage("请输入正确的qq号!")
                return
            }
        }
        if !email.isEmpty{
            if !Validate.emailvalue(email).isRight {
                ZKProgressHUD.showMessage("请输入正确的邮箱!")
                return
            }
        }

        self.regis(userName: userName, studentId: studentId, phone: phone, qq: qq, email: email,code: code!)

    }
    
    func regis(userName:String,studentId:String,phone:String,qq:String,email:String,code:String){
        let alert = SCLAlertView()
        alert.addButton("确定") {
            self.register(userName: userName,studentId: studentId ,phone: phone,qq: qq,email: email,code: code)
        }
        if(self.inviteType == 1){
            alert.showInfo("请确认你的个人信息", subTitle: "账号类型: 老师 \n 姓名: \(userName) \n 工号: \(studentId) \n 手机号: \(phone) \n QQ号: \(qq) \n Email: \(email)",closeButtonTitle: "取消")
        }else{
            alert.showInfo("请确认你的个人信息", subTitle: "账号类型: 学生 \n 姓名: \(userName) \n 学号: \(studentId) \n 手机号: \(phone) \n QQ号: \(qq) \n Email: \(email)",closeButtonTitle: "取消")
        }
        
    }

   
    //注册账号
    func register (userName:String ,studentId:String ,phone:String,qq:String,email:String,code:String){
        
           let dict =
            ["inviteType":self.inviteType,
             "dataType":1,
             "schoolId":self.data["schoolId"],
             "userNum":studentId,
             "teacherId":data["teacherId"],
             "name":userName,
             "mobile":phone,
             "QQ":qq,
             "Email":email,
             "sourceType":3,
             "smsCode":code] as [String:Any]
        
                Alamofire.request(appAPI.MobileLogin_inviteRegister, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
                    if let value = response.result.value {
                        let json = JSON(value)
                        if json["code"] == 1 {
                            ZKProgressHUD.showMessage("等待邀请人审核通过后即使用默认密码登录！")
                            //self.dismiss(animated: true, completion: nil)
                            //获取根VC
                            var rootVC = self.presentingViewController
                            while let parent = rootVC?.presentingViewController {
                                rootVC = parent
                            }
                            //释放所有下级视图
                            rootVC?.dismiss(animated: true, completion: nil)
                        }else{
                            ZKProgressHUD.showError(json["msg"].stringValue);
                        }
                    }else{
                        ZKProgressHUD.showError("网络环境异常请稍后再试！");
                    }

            }
        }
    //获取验证码
    @objc func getCode(){
        if self.phoneText.text == ""{
            ZKProgressHUD.showMessage("请输入手机号码")
            return
        }else if self.userNameText.text == ""{
            ZKProgressHUD.showMessage("请输入姓名")
            return
        }else{
            let Mobile = self.phoneText.text!
            let result = Mobile.substring(toIndex: 1)//从起始截取到索引的所有字符串
            let value = Int(result)!
            if(Mobile.description.count != 11  || value != 1){
                ZKProgressHUD.showMessage("请输入正确的手机号码")
                return
            }else{
                self.isCounting = true//开启倒计时
            }
        }
        let dict = ["userName":userNameText.text!,
                    "mobile":self.phoneText.text!,
                    "sourceType":3] as [String : Any]
        ZKProgressHUD.setAnimationStyle(.chrysanthemum);
        ZKProgressHUD.show()
        Alamofire.request(appAPI.MobileLogin_sendMessage, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let data = JSON(value)
                if data["code"] == 1{
                    //成功发送验证码
                    print("成功发送验证码")
                }else{
                    ZKProgressHUD.showMessage(data["msg"].stringValue)
                }
                ZKProgressHUD.hide()
            }else{
                ZKProgressHUD.showError("网络异常请稍后再试！");
                ZKProgressHUD.hide()
            }
        }
    }
}


