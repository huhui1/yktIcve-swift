//
//  homePageTabber.swift
//  云课堂2
//
//  Created by 尤增强 on 2018/6/27.
//  Copyright © 2018年 zqyou. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

class homePageTabber: UITabBarController {
    var myNews : myNewsModel?
    
    override func viewDidLoad(){
        super.viewDidLoad()

        self.myNews = myNewsModel.init(isRead: false)
        self.myNews?.addObserver(self, forKeyPath: "isRead", options: [.new, .old], context: nil)
        self.view.backgroundColor = UIColor.white
        let stuHoom = UINavigationController(rootViewController:studyView());
        stuHoom.tabBarItem.image = UIImage(named:"zjy");
       
        stuHoom.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        stuHoom.title = " 职教云 ";
        
        let teaHoom = UINavigationController(rootViewController:zjyTeaHoomPageView());
        teaHoom.tabBarItem.image = UIImage(named:"zjy");
        teaHoom.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        teaHoom.title = " 职教云 ";
        
        
        let ipadTeaHoom = UINavigationController(rootViewController:zjyIpadTeaHoomPageView());
        ipadTeaHoom.tabBarItem.image = UIImage(named:"zjy");
        ipadTeaHoom.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        ipadTeaHoom.title = " 职教云 ";
        
        let mooc = UINavigationController(rootViewController:CoursecenteView());
        mooc.tabBarItem.image = UIImage(named:"MOOC3");
        mooc.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        mooc.title = " MOOC ";
       
       
        let mine = UINavigationController(rootViewController:Myvc);
        mine.tabBarItem.image = UIImage(named:"mine1");
        mine.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        mine.title = " 我 ";
        
        let zykHoom = UINavigationController(rootViewController:ZykHoomPageView());
        zykHoom.tabBarItem.image = UIImage(named:"zyk1");
        zykHoom.tabBarItem.setTitleTextAttributes([NSAttributedStringKey.font : UIFont.systemFont(ofSize: 13)], for: .normal)
        zykHoom.title = " 资源库 ";
        
        if(Account.defaultAccount.role == "1"){
            self.viewControllers = [stuHoom,mooc,zykHoom,mine];
        }else{
            if(UIDevice.current.model == "iPad"){
              self.viewControllers = [ipadTeaHoom,mooc,zykHoom,mine];
            }else{
              self.viewControllers = [teaHoom,mooc,zykHoom,mine];
            }
        }
        //默认选中
        self.selectedIndex = 0;
        self.tabBar.tintColor = UIColor.bg
        self.tabBar.isTranslucent = false
        vc = mine
        self.getNewsCount(mine: mine, vc: Myvc)
        
        if Account.defaultAccount.id != nil{
            common.share.isCreatTable()
            common.share.getIOSAppVersion()
        }

        do{

            try common.share.fileURLForBuggyWKWebViewDirectory()
            try common.share.fileURLForBuggyWKWebViewFile()

        }catch{}

        
    }
    
    //添加监听后,使用完必须移除监听(一个add 对应一个 remove)
    deinit {
        self.myNews?.removeObserver(self, forKeyPath: "isRead", context: nil)
    }
    
    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "isRead" {
           
            self.getNewsCount(mine: vc, vc: Myvc)
            print("消息人数改变")
        }
    }
    
    func getNewsCount(mine:UINavigationController,vc:MyViewController){
        
        do {
            if Account.defaultAccount.id == nil{
                return
            }
            if Account.defaultAccount.role == nil{
                return
            }
        }catch{
            print("====")
        }
        if Account.defaultAccount.role! == "1"{
            self.userType = "1"
        }else{
            self.userType = "2"
        }
            let dict = ["userId": Account.defaultAccount.id!,
                        "userType":self.userType]
            XLBallLoading.show(in: self.view)
            Alamofire.request(appAPI.News_getUserNewsCount, method: .post, parameters: dict).responseJSON { response in
                if let value = response.result.value {
                    let json = JSON(value)
                    if(json["code"] == 1){
                        if json["newsCount"].intValue > 0{
                            if json["newsCount"].intValue > 99{
                                mine.tabBarItem.badgeValue = "99+"
                            }else{
                                mine.tabBarItem.badgeValue = json["newsCount"].stringValue
                            }
                        }else{
                            mine.tabBarItem.badgeValue = nil
                        }

                        UIApplication.shared.applicationIconBadgeNumber = Int(json["newsCount"].intValue);
                        vc.count = json["newsCount"].intValue
                        vc.myNews = self.myNews
                    }else{
                        ZKProgressHUD.showMessage(json["msg"].stringValue)
                    }
                    XLBallLoading.hide(in: self.view)
                }else{
                    ZKProgressHUD.showMessage("网络开小差了")
                    XLBallLoading.hide(in: self.view)
                }
            }
    }
    
    var userType:String = ""
    let Myvc = MyViewController()
    var vc = UINavigationController()
    
}

