//
//  schoolListController.swift
//  云课堂职教云
//
//  Created by 尤增强 on 2018/3/19.
//  Copyright © 2018年 jcjy. All rights reserved.
//

import UIKit
import SwiftyJSON
import Alamofire

extension  selectSchoolListView {

   
    //获取学校列表
    @objc func getschoolList(){
        let dict = ["versionCode": "1"]
        XLBallLoading.show(in: self.view)
        Alamofire.request(appAPI.MobileLogin_getSchoolList, method: .post, parameters: dict, encoding: URLEncoding.default).responseJSON { response in
            if let value = response.result.value {
                let json = JSON(value)
                if json["code"] == 1{
                    self.setData(json:json)
                }else{
                    ZKProgressHUD.showError(json["msg"].stringValue);
                }
                 XLBallLoading.hide(in: self.view)
            }else{
                ZKProgressHUD.showError("网络环境异常请稍后再试！");
                XLBallLoading.hide(in: self.view)
            }
        }
    }
   
    
    func setData(json:JSON){
        var Blist = [Dictionary<String,String>]()
        for da in json["list"] {
            let l = da.1["PY2"].stringValue[da.1["PY2"].stringValue.startIndex].description
            let school = ["NM": da.1["NM"].stringValue, "PY": da.1["PY"].stringValue, "Id": da.1["Id"].stringValue, "PY2": da.1["PY2"].stringValue, "letter": l]
            Blist.append(school)
           
           
        }
        NSArray(array: Blist).write(toFile: path, atomically: true)
        self.schoolList = Blist
        self.Mlist = Blist
        self.tableView.reloadData()
    }
   
    // 搜索代理UISearchBarDelegate方法，每次改变搜索内容时都会调用
    func searchBar(_ searchBar: UISearchBar, textDidChange searchText: String) {
        //去前后空格
        let searchText = searchText.trimmingCharacters(in: .whitespaces)
        print(searchText)
        // 没有搜索内容时显示全部组件
        if searchText == "" {
            self.Mlist = self.schoolList
            searchBar.text = ""
            self.SchoolHeaders = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","#"]
            self.tableView.reloadData()
        }
        else { // 匹配用户输入内容(不区分大小写)
            self.SchoolHeaders = []
            self.Mlist = []
            for sch in self.schoolList {
                if ((sch["NM"]!.contains(searchText))||(sch["PY"]?.lowercased().contains(searchText.lowercased()))!||(sch["PY2"]?.lowercased().contains(searchText.lowercased()))!){
                    self.Mlist.append(sch)
                    }
                }
            }
            for serch in self.Mlist {
                if !self.SchoolHeaders.contains(serch["letter"]!)
                {
                  self.SchoolHeaders.append(serch["letter"]!)
                }
            }
            print(SchoolHeaders)
            self.tableView.reloadData()
        }
    
   
}
